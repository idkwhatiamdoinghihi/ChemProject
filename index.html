<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <title>ChemScope</title>
<style>
/* --- 1. 基礎設定 --- */
    :root {
        --bg-radial-inner: #070707; 
        --bg-radial-outer: #000000;
        --panel-glass: rgba(20, 20, 20, 0.9);
        --panel-border: rgba(255, 255, 255, 0.15);
        --card-glass: rgba(255, 255, 255, 0.05);
        --text-main: #ffffff;
        --text-sub: #c2a70c;
        --text-highlight: #e0d01f;
        --accent-yellow: #f59e0b;
        --accent-blue: var(--accent-yellow);
    }

    /* Light mode override: toggled by adding `light-mode` to <body> */
    body.light-mode {
        --bg-radial-inner: #fbfbfc;
        --bg-radial-outer: #f1f5f9;
        --panel-glass: rgba(255, 255, 255, 0.92);
        --panel-border: rgba(15, 23, 42, 0.06);
        --card-glass: rgba(2, 6, 23, 0.03);
        --text-main: #0f172a;
        --text-sub: #92400e;
        --text-highlight: #92400e;
        --accent-yellow: #f59e0b;
        --accent-blue: var(--accent-yellow);
    }
    /* Additional light-mode surface tweaks */
    /* Make the 3D viewport area pure white in light mode */
    body.light-mode .viewport-area { background: #ffffff !important; background-image: none !important; }
    body.light-mode .viewport-header h1 { color: #0f172a; text-shadow: none; }
    /* molecule-display-info removed */
    body.light-mode .creator-credit { background: #ffffff !important; color: #0f172a !important; text-shadow: none; border: none; }
    /* Make the divider between viewport and controls a simple solid medium-dark grey */
    body.light-mode .controls-area { border-left: 1px solid #6b7280; box-shadow: none; }

     /* Controls content: light yellow background; inner cards white/light-grey with black text */
     /* Make the overall controls area pale yellow and force inner cards to white
         (use !important to override occasional inline styles used on specific cards) */
     body.light-mode .controls-area { background: #fffbeb; }
     body.light-mode .controls-content { background: transparent; }
    body.light-mode .controls-content .card { background: #ffffff !important; color: #0f172a; border: 1px solid #000 !important; }
     body.light-mode .controls-content .card .card-title { color: #0f172a; }
     body.light-mode .controls-content .card .data-label, body.light-mode .controls-content .card .data-value { color: #0f172a; }
    body.light-mode .controls-content .input-group input, body.light-mode .controls-content .input-group button { color: #0f172a; }
    /* Ensure switch/toggle containers don't keep a dark background inside white cards */
    body.light-mode .controls-content .switch-container { background: transparent; }
    /* Data rows: use lighter grey separators (more subtle) and remove the last (beneath 分子量) */
    body.light-mode #data-card .data-row { border-bottom: 1px solid #D1D5DB !important; }
    body.light-mode #data-card .data-row:last-child { border-bottom: none !important; }

    /* Load button: lighter yellow (match active switch color) with dark text for contrast */
    body.light-mode .controls-content .input-group button, body.light-mode #load-btn { background: #facc15 !important; color: #000 !important; border: 1px solid rgba(0,0,0,0.08) !important; }

    /* Make checkboxes/radios use a lighter yellow accent in light mode for visual parity */
    body.light-mode .controls-content .switch-container input,
    body.light-mode input[type="checkbox"],
    body.light-mode input[type="radio"] { accent-color: #facc15 !important; }

    /* Formula input: white background with dark grey border in light mode */
    body.light-mode .input-group input { background: #ffffff !important; border: 1px solid #374151 !important; color: #0f172a !important; }

    /* Theme toggle: yellow background with black text */
    body.light-mode #theme-toggle { background: #facc15 !important; color: #000 !important; border-color: #000 !important; }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

    /* --- [修改] 上下標與正負號 分離控制區 --- */
    
    /* 1. 下標設定 (控制原子數量，如 H2 的 2) */
    sub {
        font-size: 0.7em;      /* 下標字體大小 */
        line-height: 1;
        position: relative;
        vertical-align: baseline;
        bottom: -0.2em;        /* 下標位置：越負越往下 */
    }

    /* 2. 上標設定 (控制電荷的"數字"，如 3- 的 3) */
    sup {
        font-size: 0.7em;      /* 上標字體大小 */
        line-height: 1;
        position: relative;
        vertical-align: baseline;
        top: -0.5em;          /* 上標位置：越負越往上 */
        font-weight: bold;     /* 上標加粗bold，正常為normal */
        margin-left: 1px;      /* 與主文字的距離 */
    }

    /* 3. 正負號設定 (專門控制 + 與 -，如 3- 的 -) */
    .charge-sign {
        font-size: 1.4em;      /* 正負號可以設大一點，比較清楚 */
        font-weight: bold;     /* 正負號加粗 */
        position: relative;
        top: 0.05em;           /* 正負號微調：正值往下，負值往上 */
        margin-left: 0px;      /* 正負號與數字的距離 */
    }

    body {
        margin: 0;
        font-family: 'Noto Serif TC', serif;
        background: radial-gradient(circle at center, var(--bg-radial-inner) 0%, var(--bg-radial-outer) 100%);
        color: var(--text-main);
        height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        overscroll-behavior: none;
    }

    .app-container { display: flex; width: 100%; height: 100%; flex-direction: row; }

/* --- 3D 顯示區 --- */
    .viewport-area {
        flex: 0 0 60%; width: 60%; position: relative;
        background-image: 
            linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), 
            linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
        background-size: 60px 60px; 
        background-position: center center;
        overflow: hidden; cursor: grab;
        touch-action: none; 
        -webkit-user-select: none;
        will-change: transform;
        transform: translateZ(0);
    } 

    .viewport-header { 
        position: absolute; top: 70px; left: 25px; z-index: 10; pointer-events: none; 
        max-width: 80%;
    }

    /* hide per-viewport title to avoid duplication with global header */
    .viewport-header h1 {
        margin: 0;
        font-size: 1.6rem;
        color: #ffffff;
        text-shadow: 0 0 5px rgba(255, 245, 137, 0.519);
        margin-bottom: 5px;
        display: none; /* hide duplicate title (global header shows tool name) */
        align-items: baseline;
        gap: 8px;
    }

    /* .molecule-display-info and related styles removed */

    @media (max-width: 768px) {
        .viewport-header { top: 15px; left: 15px; }
        .viewport-header h1 { display: none; font-size: 0.9rem; letter-spacing: normal; }
    }

    #viewport-subtitle { display: none; }
    #molecule-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    #molecule-svg * { pointer-events: none; }

    .atom-label-text {
        font-family: 'Noto Serif TC', serif; font-weight: 700; 
        text-anchor: middle; dominant-baseline: central; 
        fill: #ffffff; text-shadow: 0 0 4px #000;
    }

/* --- 控制面板 --- */
    .controls-container {
        position: absolute; top: 25px; right: 25px; z-index: 50; 
        display: flex; gap: 15px; align-items: center; pointer-events: auto;
    }

    .control-button {
        padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;
        border: 1px solid var(--panel-border); cursor: pointer; transition: all 0.3s;
        background: rgba(0, 0, 0, 0.4); color: var(--text-main);
        backdrop-filter: blur(4px); box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .control-button.active { background: var(--accent-yellow); border-color: var(--accent-yellow); box-shadow: 0 0 15px var(--accent-yellow); }

    /* App switch / dropdown */
    .app-switch { position: relative; display: inline-block; }
    #app-switch-btn { display: inline-flex; align-items: center; gap: 8px; }
    .app-switch-arrow { display: inline-block; transform: rotate(90deg); transition: transform 0.22s ease; font-weight: 900; }
    .app-switch.open .app-switch-arrow { transform: rotate(270deg); }
    .app-switch-menu {
        position: absolute; right: 0; top: calc(100% + 8px); min-width: 180px; display: flex; flex-direction: column; gap: 8px;
        background: rgba(10,10,10,0.95); border: 1px solid rgba(255,255,255,0.06); padding: 10px; border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.6); z-index: 500; opacity: 0; transform-origin: top right; transform: translateY(-6px) scale(0.98); pointer-events: none; transition: all 0.18s ease;
    }
    /* Ensure dropdown menu items use the same font-family as the title */
    .app-switch-menu .app-switch-item { font-family: inherit; }
    .app-switch.open .app-switch-menu { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
    .app-switch-menu .app-switch-item { text-align: left; padding: 8px 12px; border-radius: 10px; background: transparent; border: 1px solid rgba(255,255,255,0.03); }
    .app-switch-menu .app-switch-item:hover, .app-switch-menu .app-switch-item:focus { background: rgba(255,255,255,0.03); outline: none; }

    /* Title-based app switch adjustments */
    .app-switch-root { position: relative; display: inline-block; }
    .app-switch-root .title-btn { background: transparent; border: none; color: inherit; font-family: inherit; font-size: 1.6rem; font-weight: 700; padding: 0; cursor: pointer; display: inline-flex; align-items: baseline; gap: 8px; }
    .app-switch-root .app-switch-arrow { transform: rotate(90deg); font-size: 0.9rem; }
    .app-switch-root.open .app-switch-arrow { transform: rotate(270deg); }
    .app-switch-root .app-switch-menu { right: auto; left: 0; top: calc(100% + 8px); transform-origin: top left; }
    .app-switch-root.open .app-switch-menu { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }

    /* Tool panels (single-page views) */
    .tool-panel { display: none; }
    .tool-panel.active { display: block; }

    /* Allow interactive elements in the header (viewport-header uses pointer-events:none globally) */
    .viewport-header .app-switch-root, .viewport-header .title-btn, .viewport-header .input-note { pointer-events: auto; }

    .card { 
        background: var(--card-glass); border: 1px solid var(--panel-border); 
        border-radius: 16px; padding: 20px; margin-bottom: 20px; 
    }
    .card-title { 
        font-size: 1rem; font-weight: 700; color: var(--text-highlight); 
        margin-bottom: 15px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 1px;
    }
    /* Preserve title-case for specific control headings (override global uppercase) */
    #card-title-input, #data-card-title { text-transform: none; }
    .card-title.large-title { font-size: 1.15rem; }
    .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .data-label { font-size: 1rem; color: var(--text-sub); }
    .data-value { font-size: 1.15rem; color: var(--text-main); font-weight: 500; }
    /* --- 平衡係數與詳解面板樣式 --- */
    #balance-result {
        display: flex; flex-wrap: wrap; align-items: center; justify-content: center;
        padding: 20px; font-family: 'Noto Serif TC', serif;
    }
    .eqn-item { display: flex; align-items: center; margin: 0 4px; }
    .coeff { 
        color: #facc15; font-weight: 900; font-size: 1.6rem; 
        margin-right: 4px; font-style: italic;
        text-shadow: 0 0 15px rgba(250, 204, 21, 0.5);
    }
    .eqn-op { color: rgba(255,255,255,0.4); font-size: 1.2rem; margin: 0 10px; font-weight: bold; }
    .reaction-arrow { color: var(--accent-yellow); font-size: 1.8rem; margin: 0 15px; font-weight: bold; }
    #balance-result sup { top: -0.6em; font-size: 0.75em; margin-left: 1px; vertical-align: baseline; position: relative; }
    #balance-result sub { bottom: -0.2em; font-size: 0.75em; vertical-align: baseline; position: relative; }
    .step-box { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .step-title { color: #facc15; font-weight: bold; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; font-size: 1.05rem; }
    .step-formula-box { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin: 8px 0; font-family: 'Noto Serif TC', serif; font-size: 1.15rem; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
    .highlight-atom { color: var(--accent-yellow); font-weight: bold; border-bottom: 2px solid var(--accent-yellow); padding: 0 2px; }
    
    .input-group { display: flex; gap: 8px; font-family: 'Noto Serif TC', serif; align-items: center; width: 100%; }
    .input-group input { 
        flex: 1 1 auto; min-width: 0; padding: 12px; border: 1px solid var(--panel-border); border-radius: 8px; 
        background: rgba(0,0,0,0.3); color: white; transition: border 0.3s; outline: none; font-size: 1.1rem; 
        font-family: inherit; height: 44px; box-sizing: border-box;
    }
    .input-group button { 
        flex: 0 0 auto; padding: 10px 20px; background: var(--accent-yellow); color: white; border: none; border-radius: 8px; 
        cursor: pointer; font-weight: bold; font-family: inherit; height: 44px; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;
    }

    /* Make mode/theme buttons match load button appearance and remove shadow
       Also ensure load button text is black for contrast in both themes */
    #mode-toggle, #theme-toggle, #load-btn, #lang-toggle {
        background: var(--accent-yellow) !important;
        color: #000 !important;
        border: 1px solid rgba(0,0,0,0.08) !important;
        font-family: inherit !important;
        font-weight: 700 !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }
    /* Remove the black border specifically for the mode-switch button and make its shape similar to the load button */
    #mode-toggle {
        border: none !important;
        border-radius: 8px !important;
        padding: 10px 16px !important;
    }

    /* In light mode specifically ensure no black border and make the button match load-button sizing */
    body.light-mode #mode-toggle {
        border: none !important;
        border-radius: 8px !important;
        height: 44px !important;
        padding: 8px 14px !important;
        box-shadow: none !important;
        background: var(--accent-yellow) !important;
        color: #000 !important;
    }

    /* legacy container kept for compatibility; new inline switch styles below */
    .switch-container { display: none; }

    /* Row that holds multiple switch items side-by-side */
    .switch-row { display: flex; gap: 12px; margin-top: 12px; align-items: center; }
    .switch-item { display: inline-flex; align-items: center; gap: 10px; background: transparent; padding: 0; cursor: pointer; }

    /* Switch control appearance */
    .switch-input { position: absolute; opacity: 0; width: 0; height: 0; }
    .switch-item { position: relative; }
    .switch-item .slider { position: relative; display: inline-block; width: 44px; height: 24px; background: #e5e7eb; border-radius: 999px; border: 1px solid rgba(0,0,0,0.06); transition: background 0.18s ease; }
    .switch-item .slider::before { content: ""; position: absolute; left: 3px; top: 3px; width: 18px; height: 18px; background: #ffffff; border-radius: 50%; transition: left 0.18s ease, background 0.18s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .switch-item input:checked + .slider { background: #facc15; border-color: rgba(0,0,0,0.08); }
    .switch-item input:checked + .slider::before { left: 23px; background: #000000; }
    .switch-label { font-size: 0.95rem; color: var(--text-main); font-weight: 600; }

    #variant-selector {
        display: none; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2);
        padding: 15px; border-radius: 12px; margin-bottom: 15px;
    }
    .variant-option { padding: 5px 0; display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--accent-blue); }

    #variant-selector.acid-theme { background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.3); }
    #variant-selector.acid-theme .variant-header { color: #fbbf24; }
    #variant-selector.acid-theme .variant-option { color: #fbbf24; }
    #variant-selector.acid-theme .variant-option:hover { background: rgba(245, 158, 11, 0.15); }

    #reaction-container { margin-bottom: 30px; width: 100%; }
    .reaction-row { display: flex; gap: 12px; width: 100%; flex-wrap: wrap; justify-content: center; }
    .reaction-btn {
        flex: 1 0 42%; max-width: 48%; min-width: 140px; height: 50px;
        padding: 0 10px; font-size: 0.95rem; font-weight: 600; color: white;
        border: none; border-radius: 50px; cursor: pointer;
        transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        display: none; align-items: center; justify-content: center; white-space: nowrap;
    }
    .reaction-btn:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 6px 16px rgba(0,0,0,0.3); }
    .reaction-btn:active { transform: translateY(1px); }

    .btn-h2o { background: linear-gradient(135deg, #3b82f6 0%, #2dd4bf 100%); }
    .btn-cl2 { background: linear-gradient(135deg, #fbbf24 0%, #b38728 100%); }
    .btn-h2  { background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); }
    .btn-hcl { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .btn-kmno4 { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); }
    
    @keyframes blurOutEffect { 0% { opacity: 1; filter: blur(0px); transform: scale(1); } 100% { opacity: 0; filter: blur(8px) brightness(1.5); transform: scale(1.05); } }
    @keyframes blurInEffect { 0% { opacity: 0; filter: blur(8px); transform: scale(0.95); } 100% { opacity: 1; filter: blur(0px); transform: scale(1); } }
    .scene-blur-out { animation: blurOutEffect 1.5s forwards ease-in; }
    .scene-blur-in { animation: blurInEffect 1.5s forwards ease-out; }

    .reset-btn {
        flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--panel-border); color: var(--text-sub); border-radius: 12px;
        font-weight: bold; cursor: pointer; transition: all 0.2s;
    }
    .reset-btn:hover { background: rgba(255, 255, 255, 0.2); color: white; }

    /* 手機版樣式 */
    body.simulate-mobile .app-container { flex-direction: column; }
    body.simulate-mobile .controls-container { display: none !important; }
    body.simulate-mobile .viewport-area { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    body.simulate-mobile .controls-area {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 98vh; max-height: 98vh;
        border-left: none; border-top: 1px solid rgba(255,255,255,0.15);
        border-radius: 20px 20px 0 0; background-color: #1a1a1a; padding: 0; z-index: 100;
        transform: translateY(0); transition: transform 0.3s; will-change: transform;
    }
    body.simulate-mobile #mobile-panel-handle {
        display: flex; width: 100%; height: 40px; justify-content: center; align-items: center;
        cursor: pointer; flex-shrink: 0; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .controls-area { 
        flex: 0 0 40%; width: 40%;
        background-color: var(--panel-glass);
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        border-left: 1px solid #6b7280; /* simple solid medium-to-dark grey */
        display: flex; flex-direction: column; 
        padding: 25px; overflow-y: auto; 
        box-shadow: none; 
        z-index: 20;
    }
    .controls-content { margin: auto 0; width: 100%; }
    #mobile-panel-handle { display: none; }

    .input-note { font-size: 0.8rem; color: var(--text-sub); margin-top: 10px; line-height: 1.4; }
    .clickable-label { cursor: pointer; font-weight: bold; }
    .variant-header { font-weight: bold; color: var(--accent-blue); margin-bottom: 5px; }

/* --- 手機版極速優化 (iOS Native Like) --- */
@media (max-width: 768px), (max-height: 500px) { 
    .app-container { flex-direction: column; height: 100vh; width: 100vw; overflow: hidden; position: relative; }
    .controls-container { display: none !important; } 
    .viewport-area { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    
    .controls-area {
        position: fixed; 
        left: 0; 
        bottom: 0; 
        width: 100%; 
        height: 98vh; 
        max-height: 98vh;
        background-color: rgba(26, 26, 26, 0.96); 
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-radius: 20px 20px 0 0; 
        border-top: 1px solid rgba(255,255,255,0.15);
        box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
        z-index: 100;
        display: flex; flex-direction: column;
        padding: 0;
        transform: translateY(calc(100% - 45px)); /* 確保把手永遠露出一點 */
        will-change: transform;
        transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    }

    #mobile-panel-handle { 
        display: flex; width: 100%; height: 40px; 
        justify-content: center; align-items: center;
        cursor: grab; flex-shrink: 0; 
        /* 把手背景 */
        background: rgba(255,255,255,0.02);
        border-bottom: 1px solid rgba(255,255,255,0.05); 
        touch-action: none; /* 重要：鎖定瀏覽器預設滑動 */
    }
    
    /* 修改這裡：把手的樣式 */
    .handle-bar {
        width: 36px; 
        height: 5px; 
        background-color: rgba(255, 255, 255, 0.3); 
        border-radius: 10px;
        /* 加入過渡動畫，讓變大變小很滑順 */
        transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    /* 新增這裡：當把手被按住 (active) 時的效果 */
    #mobile-panel-handle:active .handle-bar,
    #mobile-panel-handle.active .handle-bar {
        width: 55px; /* 變寬 */
        background-color: rgba(255, 255, 255, 0.7); /* 變亮 */
        box-shadow: 0 0 10px rgba(255,255,255,0.3); /* 加一點發光 */
    }
    
    .controls-content { 
        flex: 1; 
        padding: 20px; 
        overflow-y: auto; 
        overscroll-behavior: contain;
        padding-bottom: 15px; /* 全開的底部留白 */
        transition: padding-bottom 0.4s ease;
    }

    .controls-area.half-open .controls-content {
        padding-bottom: 45vh; /* 半開的底部留白 */
    }
}

    .hybrid-tooltip {
        position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); 
        background: rgba(0, 0, 0, 0.9); color: #fff; padding: 15px 25px;
        border-radius: 12px; border: 2px solid var(--accent-blue);
        font-family: 'Noto Serif TC', serif; font-size: 1.4rem; font-weight: bold;
        pointer-events: none; opacity: 0; transition: opacity 0.2s;
        z-index: 9999; white-space: nowrap; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8); text-shadow: 0 2px 4px #000;
        max-width: 90vw; 
    }
    
    /* --- 知識小百科卡片樣式 --- */
    .knowledge-card {
        border: 1px solid rgba(251, 191, 36, 0.3); /* 金黃色邊框 */
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, rgba(0, 0, 0, 0.2) 100%);
        transition: all 0.3s ease;
    }

    .knowledge-card .card-title {
        color: #fbbf24; cursor: pointer; justify-content: space-between; margin-bottom: 0; 
    }

    .toggle-icon { font-size: 0.8rem; transition: transform 0.3s; color: #fbbf24; }
    .knowledge-card.expanded .toggle-icon { transform: rotate(180deg); }
    .knowledge-card.expanded .card-title { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(251, 191, 36, 0.2); }
    .knowledge-content { display: none; font-size: 0.95rem; line-height: 1.6; color: #e2e8f0; text-align: justify; }
    .knowledge-content strong { color: var(--accent-yellow); }
    .knowledge-card.expanded .knowledge-content { display: block; animation: fadeIn 0.4s ease; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    /* 統一高亮紫色玻璃風格 */
    .glass-toggle-btn {
        width: 100%; height: 46px; margin-bottom: 12px;
        background: rgba(139, 92, 246, 0.25); 
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(139, 92, 246, 0.7); 
        color: #fff; font-size: 1rem; font-weight: 600; border-radius: 23px;
        cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px;
        transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .glass-toggle-btn:hover { background: rgba(139, 92, 246, 0.35); border-color: #fff; }

    .glass-content-panel {
        display: none; padding: 12px; border-radius: 20px;
        background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(139, 92, 246, 0.3);
        margin-top: -6px; margin-bottom: 15px;
    }
    /* 子選單專用樣式 */
    .sub-panel-btn {
        height: 40px !important;
        font-size: 0.95rem !important;
        background: rgba(255, 255, 255, 0.05) !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
        margin-bottom: 6px !important;
    }
    
    .sub-content {
        background: rgba(0, 0, 0, 0.4) !important;
        border-radius: 15px !important;
        margin-left: 10px;
        margin-right: 10px;
        padding: 15px !important;
        border: 1px solid rgba(255, 255, 255, 0.05) !important;
    }

    /* 輸入框適配 */
    .sub-content .input-group input {
        padding: 8px;
        font-size: 0.9rem;
    }

    .panel-wrapper.expanded > .glass-content-panel { display: block; animation: fadeIn 0.3s ease; }
    .panel-wrapper.expanded > .glass-toggle-btn { border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; }

    .glass-content-panel .glass-toggle-btn {
        height: 40px; font-size: 0.95rem;
        background: rgba(139, 92, 246, 0.15); border-color: rgba(139, 92, 246, 0.4);
    }
    .info-section { margin-bottom: 15px; }
    .info-title { font-weight: bold; color: #4ade80; margin-bottom: 8px; font-size: 1.05rem; border-left: 3px solid #4ade80; padding-left: 10px; letter-spacing: 1px; }
    .info-body { padding-left: 6px; font-size: 0.95rem; color: #f1f5f9; line-height: 1.7; text-align: justify; }
    .info-body strong { color: inherit; font-weight: 700; }
    .highlight-title { color: var(--accent-yellow); font-weight: bold; display: inline-block; margin-right: 4px; }
    .hybrid-tooltip.show { opacity: 1; }
    .flow-card {
        width: 100%;
        max-width: 500px;
        padding: 20px;
        border-radius: 16px;
        border: 2px solid;
        position: relative;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .branch-card { max-width: 300px; }
    .step-badge {
        position: absolute;
        top: -12px;
        left: 20px;
        padding: 2px 12px;
        border-radius: 20px;
        color: #000;
        font-size: 0.75rem;
        font-weight: 900;
        text-transform: uppercase;
    }
    .flow-title { font-weight: bold; font-size: 1.1rem; color: #fff; }
    .flow-body { margin-top: 10px; color: #94a3b8; line-height: 1.6; }
    .flow-arrow { color: #334155; font-size: 1.5rem; margin: -5px 0; }
    .pg-tag { color: var(--accent-yellow); font-weight: bold; margin: 0 4px; font-family: 'Noto Serif TC', serif; }
    .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
    .res-box {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 15px 5px;
        border-radius: 12px;
        font-size: 0.85rem;
        transition: all 0.3s;
    }
    .res-box:hover { background: rgba(250, 205, 21, 0.08); border-color: var(--accent-yellow); transform: translateY(-5px); }
    .pg-final { display: block; margin-top: 8px; font-size: 1.3rem; font-weight: bold; color: var(--accent-yellow); font-family: 'Noto Serif TC', serif; }

    /* 電子閃爍動畫 */
    @keyframes spark-flicker {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.4; transform: scale(0.6); }
    }
    .electron-spark { animation: spark-flicker 0.15s linear infinite; }
    /* ========== [請插入這段 CSS] 電子組態表樣式 ========== */
    #config-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 200; justify-content: center; align-items: center; }
    .config-panel { background: #0f172a; border: 1px solid #334155; display: flex; flex-direction: column; width: 500px; height: 85vh; border-radius: 16px; box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @media (max-width: 600px) { .config-panel { width: 100%; height: 100%; border-radius: 0; border: none; } }
    
    .config-header { padding: 15px; background: rgba(30,41,59,0.9); border-bottom: 1px solid #334155; display: flex; gap: 10px; align-items: center; }
    .config-close { background: transparent; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; padding: 0 10px; transition: 0.2s; } .config-close:hover { color: #fff; }
    .config-search { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #475569; color: #f1f5f9; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none; }
    .config-list { flex: 1; overflow-y: auto; padding: 15px; }
    
    .element-card { background: rgba(30,41,59,0.4); border: 1px solid rgba(255,255,255,0.1); border-left: 3px solid var(--accent-yellow); border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; }
    .ec-header { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .ec-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .ec-sym-box { display: flex; align-items: center; gap: 25px; }
    .ec-sym { font-size: 3.8rem; font-weight: 900; color: #fff; line-height: 1; min-width: 80px; text-align: center; text-shadow: 0 0 10px rgba(255,255,255,0.5), 0 0 30px rgba(255,255,255,0.2); }
    .ec-info { display: flex; flex-direction: column; gap: 2px; }
    .ec-name { font-size: 0.95rem; font-weight: bold; color: #fff; }
    .ec-meta { font-size: 0.75rem; color: #94a3b8; font-family: 'Noto Serif TC', serif; }
    .ec-tag { font-size: 0.75rem; color: #a78bfa; font-weight: 500; background: rgba(139, 92, 246, 0.15); padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(139, 92, 246, 0.3); width: fit-content; }
    .ec-config-row { width: 100%; display: flex; justify-content: flex-end; background: rgba(0,0,0,0.3); padding: 6px 10px; border-radius: 6px; }
    .ec-config { font-family: 'Noto Serif TC', serif; color: #a5f3fc; font-weight: bold; font-size: 1.1rem; letter-spacing: -0.5px; word-spacing: -2px; white-space: nowrap; }
    .ec-config sup { color: var(--accent-yellow); font-size: 0.75em; vertical-align: super; }
    /* [修改] 開啟水平捲軸並美化樣式 */
    .ec-scroll { 
        width: 100%; 
        overflow-x: auto; /* 允許橫向捲動 */
        padding-top: 5px; 
        padding-bottom: 8px; /* 增加底部空間給捲軸 */
        border-top: 1px solid rgba(255,255,255,0.05); 
        scrollbar-width: thin; /* Firefox: 細捲軸 */
        scrollbar-color: #475569 #0f172a; /* Firefox: 顏色 */
    }
    
    /* Chrome/Edge/Safari 捲軸樣式 */
    .ec-scroll::-webkit-scrollbar { height: 6px; display: block; } /* 設定高度並顯示 */
    .ec-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 3px; }
    .ec-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .ec-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent-yellow); } /* 滑鼠移過去變亮 */

    .ec-row { display: flex; gap: 8px; width: max-content; padding-right: 10px; }
    .ec-sub { display: flex; flex-direction: column; align-items: center; background: rgba(255,255,255,0.03); padding: 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); }
    .ec-boxes { display: flex; gap: 2px; }
    .ec-box { width: 32px; height: 32px; border: 1px solid #555; background: #000; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: #facc15; font-weight: bold; }
    .ec-label { margin-top: 4px; font-size: 0.75rem; color: #64748b; font-family: 'Noto Serif TC', serif; }

    /* ========== [新增] 離子按鈕互動樣式 ========== */
    .ion-btn {
    opacity: 0.8;
    border-width: 1px !important;
    font-weight: normal;
}

.ion-btn:active {
    opacity: 0.6; 
}

.ion-btn.active {
    opacity: 1;
    font-weight: bold;
    border-width: 2px !important;
    z-index: 2;
}

.ion-btn.active[data-type="neutral"] { background: #f1f5f9 !important; color: #000 !important; border-color: #fff !important; }
.ion-btn.active[data-type="pos"]     { background: #fca5a5 !important; color: #000 !important; border-color: #fca5a5 !important; }
.ion-btn.active[data-type="neg"]     { background: #93c5fd !important; color: #000 !important; border-color: #93c5fd !important; }


/* --- [新增] 共振結構主題 (紫色系) --- */
#variant-selector.resonance-theme { 
    background: rgba(139, 92, 246, 0.05); 
    border: 1px solid rgba(139, 92, 246, 0.3); 
}
#variant-selector.resonance-theme .variant-header { 
    color: #a78bfa; /* 淺紫色 */
}
#variant-selector.resonance-theme .variant-option { 
    color: #a78bfa; 
}
#variant-selector.resonance-theme .variant-option:hover { 
    background: rgba(139, 92, 246, 0.15); 
    color: #fff;
}
#variant-selector.resonance-theme input[type="radio"] {
    accent-color: #8b5cf6; /* 紫色選框 */
}

/* --- [新增] 結構/晶體切換主題 (藍色系) --- */
#variant-selector.structure-theme { 
    background: rgba(56, 189, 248, 0.05); /* 天藍色背景 */
    border: 1px solid rgba(56, 189, 248, 0.3); 
}
#variant-selector.structure-theme .variant-header { 
    color: var(--accent-yellow); /* was 天藍色文字 */
}
#variant-selector.structure-theme .variant-option { 
    color: var(--accent-yellow);
}
#variant-selector.structure-theme .variant-option:hover { 
    background: rgba(56, 189, 248, 0.15); 
    color: #fff;
}
#variant-selector.structure-theme input[type="radio"] {
    accent-color: var(--accent-yellow); /* was 藍色選框 */
}


/* Orbital-related styles removed (orbital UI was deleted). */

/* 手機版特別優化：位置更緊湊 */
@media (max-width: 768px) {}

@keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

.creator-credit {
    position: fixed;
    left: 20px;
    bottom: 18px;
    z-index: 60;
    color: #ffffff;
    font-weight: 700;
    font-size: 13px;
    text-shadow: 0 0 8px rgba(56,189,248,0.2);
    background: rgba(0,0,0,0.25);
    padding: 6px 10px;
    border-radius: 8px;
    pointer-events: none;
}
@media (max-width: 768px) {
    .creator-credit { display: none; }
}


</style>
<style>
/* Restore ChemScope molecule-display-info appearance (scoped) */
.viewport-area[data-tool="ChemScope"] .molecule-display-info {
    margin-top: 5px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    padding: 10px 15px;
    border-radius: 12px;
    border-left: none;
    margin-left: -8px;
    pointer-events: auto;
    display: inline-block;
}
.viewport-area[data-tool="ChemScope"] .info-formula {
    font-size: 2.2rem; font-weight:700; color:#fff; line-height:1.1; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}
.viewport-area[data-tool="ChemScope"] .info-name { font-size:1.2rem; color: var(--text-highlight); font-weight:500; margin-top:4px; }

/* Elements page - periodic table styles (scoped) */
.viewport-panel[data-tool="Elements"] {
    --pt-border-color: transparent;
    --pt-bg-color: #f9f9f9;
    --pt-highlight: #e0f7fa;
    font-family: 'Noto Serif TC', serif;
}

/* Force hide controls when Elements or Equation Balancer is active */
body:has(.viewport-panel.active[data-tool="Elements"]) .controls-area,
body:has(.viewport-panel.active[data-tool="Equation Balancer"]) .controls-area {
    display: none !important;
}

/* Force full width for Elements and Equation Balancer viewports */
.viewport-area[data-tool="Elements"],
.viewport-area[data-tool="Equation Balancer"] {
    flex: 0 0 100% !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* Fallback for older browsers */
.viewport-panel.active[data-tool="Elements"] ~ .controls-area,
.viewport-panel.active[data-tool="Equation Balancer"] ~ .controls-area {
    display: none !important;
}

.viewport-panel[data-tool="Elements"] .elements-container {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    padding-top: 0; /* Remove padding-top to allow true centering */
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

    .viewport-panel[data-tool="Elements"] .periodic-table {
    display: grid;
    grid-template-columns: 30px repeat(18, 65px);
    /* Added two extra rows at the end for lanthanides & actinides */
    grid-template-rows: 30px 85px 85px 85px 85px 85px 85px 85px 85px 85px 85px;
    gap: 4px;
    /* Remove max-width/overflow from here, let container handle it via transform */
    padding-bottom: 0; /* Remove padding-bottom */
    justify-content: center;
    margin-top: 12vh; /* Move downward slightly */
    transform-origin: center center;
}

.viewport-panel[data-tool="Elements"] .element {
    border: 1px solid var(--pt-border-color);
    background-color: var(--pt-bg-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 4px 2px;
    cursor: pointer;
    transition: transform 0.1s, background-color 0.2s;
    user-select: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    color: #000;
}

/* Shift the lanthanide/actinide f-block rows down by 20px without altering box design */
.viewport-panel[data-tool="Elements"] .periodic-table .element.f-block {
    position: relative;
    top: 20px;
}

/* Shift f-block rows right by 50px (visual only) */
.viewport-panel[data-tool="Elements"] .periodic-table .element.f-block {
    left: 50px;
}

.viewport-panel[data-tool="Elements"] .element:hover {
    transform: scale(1.05);
    background-color: var(--pt-highlight);
    z-index: 2;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    border-color: #000;
}

.viewport-panel[data-tool="Elements"] .at-mass { font-size: 11px; font-weight: bold; color: #555; }
.viewport-panel[data-tool="Elements"] .symbol { font-size: 22px; font-weight: bold; margin: -2px 0; color: #000; }
.viewport-panel[data-tool="Elements"] .name { font-size: 10px; text-align: center; line-height: 1; color: #333; text-transform: lowercase; }
.viewport-panel[data-tool="Elements"] .at-num { font-size: 12px; color: #555; }

.viewport-panel[data-tool="Elements"] .key-box-container {
    grid-column: 4 / 10;
    grid-row: 3 / 5;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    pointer-events: none;
}

.viewport-panel[data-tool="Elements"] .key-box {
    border: 1px solid var(--pt-border-color);
    padding: 10px;
    text-align: center;
    background: white;
    width: 220px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    color: #000;
}
.viewport-panel[data-tool="Elements"] .key-label { font-size: 10px; color: #555; }
.viewport-panel[data-tool="Elements"] .key-title { font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #000; }

.viewport-panel[data-tool="Elements"] .col-header {
    text-align: center;
    font-weight: bold;
    display: flex;
    align-items: end;
    justify-content: center;
    padding-bottom: 5px;
    font-size: 18px;
    color: #fff;
}

.viewport-panel[data-tool="Elements"] .period-header {
    text-align: center;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #fff;
}

.viewport-panel[data-tool="Elements"] .modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(2px);
}

.viewport-panel[data-tool="Elements"] .info-card {
    background: white;
    padding: 30px;
    border-radius: 8px;
    width: 550px;
    max-width: 95vw;
    text-align: left;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    position: relative;
    animation: popIn 0.3s ease;
    color: #000;
    font-family: 'Noto Serif TC', serif;
}

@keyframes popIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.viewport-panel[data-tool="Elements"] .close-btn {
    position: absolute;
    top: 10px; right: 15px;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    z-index: 10;
}
.viewport-panel[data-tool="Elements"] .close-btn:hover { color: red; }

.viewport-panel[data-tool="Elements"] .card-header { 
    text-align: center; 
    border-bottom: 2px solid rgba(0,0,0,0.1); 
    padding-bottom: 10px; 
    margin-bottom: 10px; 
}
.viewport-panel[data-tool="Elements"] .card-header h2 { margin: 0; font-size: 24px; color: #000; font-family: 'Noto Serif TC', serif; }
.viewport-panel[data-tool="Elements"] .cn-name { font-size: 20px; margin-left: 10px; color: #444; font-weight: bold; font-family: 'Noto Serif TC', serif; }

.viewport-panel[data-tool="Elements"] .card-symbol { 
    font-size: 80px; 
    font-weight: bold; 
    color: #333; 
    text-align: center; 
    margin: 5px 0 15px 0; 
    font-family: 'Noto Serif TC', serif;
    line-height: 1;
}

.viewport-panel[data-tool="Elements"] .card-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0 30px;
}

.viewport-panel[data-tool="Elements"] .detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    font-size: 13px;
    color: #333;
    font-family: 'Noto Serif TC', serif;
}
.viewport-panel[data-tool="Elements"] .detail-row strong { color: #000; flex-shrink: 0; margin-right: 10px; }
.viewport-panel[data-tool="Elements"] .detail-val { text-align: right; }

.viewport-panel[data-tool="Elements"] .orbital-diagram {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 5px;
}
.viewport-panel[data-tool="Elements"] .orb-group {
    display: flex;
    flex-direction: column;
    align-items: center;
}
.viewport-panel[data-tool="Elements"] .orb-boxes {
    display: flex;
}
.viewport-panel[data-tool="Elements"] .orb-box {
    width: 20px;
    height: 20px;
    border: 1px solid #444;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    line-height: 1;
    margin-left: -1px;
    background: rgba(255,255,255,0.6);
    color: #000;
}
.viewport-panel[data-tool="Elements"] .orb-box:first-child { margin-left: 0; }
.viewport-panel[data-tool="Elements"] .orb-label { font-size: 10px; margin-top: 2px; color: #555; }

/* Equation Balancer Styles */
.viewport-panel[data-tool="Equation Balancer"] .balancer-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    padding: 20px;
    padding-top: 80px; /* Clear header */
    padding-bottom: 60px; /* Move upward */
}

.viewport-panel[data-tool="Equation Balancer"] .balancer-card {
    background: rgba(40, 40, 40, 0.6);
    padding: 5vh 5vh 1.5vh 5vh;
    border-radius: 24px;
    width: 80vw;
    height: 55vh;
    min-width: 360px;
    min-height: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    font-family: 'Noto Serif TC', serif;
    color: var(--text-main);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
}

.viewport-panel[data-tool="Equation Balancer"] .balancer-instruction {
    margin-top: 0;
    margin-bottom: 2.5vh;
    font-size: 3.5vh;
    color: var(--accent-yellow);
    text-align: center;
    font-weight: bold;
}

.viewport-panel[data-tool="Equation Balancer"] .input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 2.5vh;
}

.viewport-panel[data-tool="Equation Balancer"] #eq-input {
    flex: 1;
    padding: 12px;
    font-size: 2.5vh;
    border: 1px solid var(--panel-border);
    border-radius: 8px;
    outline: none;
    font-family: 'Noto Serif TC', serif;
    background: rgba(0,0,0,0.3);
    color: white;
    transition: border 0.3s;
    height: 5.5vh;
}

.viewport-panel[data-tool="Equation Balancer"] #eq-input:focus {
    border-color: var(--accent-yellow);
}

.viewport-panel[data-tool="Equation Balancer"] #btn-balance {
    padding: 0 30px;
    font-size: 2.2vh;
    font-weight: bold;
    font-family: 'Noto Serif TC', serif;
    background: var(--accent-yellow);
    color: #000;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    height: 5.5vh;
    transition: filter 0.2s;
}

.viewport-panel[data-tool="Equation Balancer"] #btn-balance:hover {
    filter: brightness(1.1);
}

.viewport-panel[data-tool="Equation Balancer"] .eq-msg {
    min-height: 24px;
    margin-bottom: 10px;
    font-weight: bold;
}

.viewport-panel[data-tool="Equation Balancer"] .eq-msg.error {
    color: #ff4d4d;
}

.viewport-panel[data-tool="Equation Balancer"] .eq-msg.type {
    color: var(--accent-yellow);
    margin-top: 2vh;
    font-size: 3.5vh;
    text-align: center;
}

.viewport-panel[data-tool="Equation Balancer"] .eq-result {
    font-size: 4.5vh;
    text-align: center;
    margin-top: 10px;
    padding: 10px 20px;
    background: transparent;
    border-radius: 12px;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    flex-wrap: wrap;
    line-height: 1.5;
    overflow-y: auto;
}

.viewport-panel[data-tool="Equation Balancer"] .balanced-eq {
    font-family: 'Cambria Math', 'Cambria', serif;
    font-style: normal;
    margin-bottom: 25px;
}

.viewport-panel[data-tool="Equation Balancer"] .chem-formula {
    display: inline-block;
}

.viewport-panel[data-tool="Equation Balancer"] .chem-coeff {
    color: #87CEEB;
    font-weight: 900;
    margin-right: 6px;
}


</style>
</style>
</head>
<body>

<div class="app-container">
    <!-- Global header: persistent app switch (moves the title dropdown out of individual viewports) -->
    <div class="global-header" style="position:absolute;top:20px;left:25px;z-index:70;pointer-events:auto;">
        <div class="app-switch-root">
            <button id="title-switch-btn" class="title-btn" aria-haspopup="true" aria-expanded="false">
                <span class="app-switch-label">ChemScope</span>
                <span class="app-switch-arrow">&gt;</span>
            </button>
            <div class="app-switch-menu" id="titleSwitchMenu" role="menu" aria-hidden="true">
                <button class="control-button app-switch-item" data-tool="ChemScope" role="menuitem">ChemScope</button>
                <button class="control-button app-switch-item" data-tool="Elements" role="menuitem">Elements</button>
                <button class="control-button app-switch-item" data-tool="Equation Balancer" role="menuitem">Equation Balancer</button>
            </div>
        </div>
    </div>
    <div class="viewport-area viewport-panel active" id="viewport" data-tool="ChemScope">
        <!-- 標題與資訊顯示區 -->
        <div class="viewport-header">
            <h1 class="title">ChemScope</h1>
            
            <div class="molecule-display-info" id="molecule-display-info">
                <div class="info-formula" id="info-formula"></div>
                <div class="info-name" id="info-name"></div>
            </div>

            <!-- 猜你想看功能 -->
            <span class="input-note" id="viewport-subtitle"></span>
        </div>
        
        <div class="controls-container">
            <button id="mode-toggle" class="control-button active">模式: 複合</button>
            <button id="lang-toggle" class="control-button" title="切換語言">EN</button>
        </div>

        <script>
            (function(){
                const root = document.querySelector('.app-switch-root');
                const btn = document.getElementById('title-switch-btn');
                const menu = document.getElementById('titleSwitchMenu');
                if(!btn || !menu || !root) return;

                function openMenu(){ root.classList.add('open'); btn.setAttribute('aria-expanded','true'); menu.setAttribute('aria-hidden','false'); }
                function closeMenu(){ root.classList.remove('open'); btn.setAttribute('aria-expanded','false'); menu.setAttribute('aria-hidden','true'); }
                function toggleMenu(){ root.classList.contains('open') ? closeMenu() : openMenu(); }

                btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); btn.focus(); });
                btn.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleMenu(); } else if(e.key === 'Escape') closeMenu(); });

                function switchTool(toolName){
                    // hide all control/tool panels, show target control panel
                    document.querySelectorAll('.tool-panel').forEach(p=>{ p.classList.remove('active'); p.style.display = 'none'; });
                    const controlTarget = document.querySelector(`.tool-panel[data-tool="${toolName}"]`);
                    if(controlTarget){ controlTarget.classList.add('active'); controlTarget.style.display = ''; }

                    // hide all viewport panels and show the one for selected tool
                    document.querySelectorAll('.viewport-panel').forEach(v=>{ v.classList.remove('active'); v.style.display = 'none'; });
                    const viewTarget = document.querySelector(`.viewport-panel[data-tool="${toolName}"]`);
                    if(viewTarget){ viewTarget.classList.add('active'); viewTarget.style.display = ''; }

                    // mark menu active
                    menu.querySelectorAll('.app-switch-item').forEach(b=> b.classList.toggle('active', b.dataset.tool === toolName));

                    // update title label if needed
                    const label = root.querySelector('.app-switch-label');
                    if(label && toolName) label.textContent = toolName === 'ChemScope' ? 'ChemScope' : toolName;
                }

                menu.addEventListener('click', (e)=>{
                    const t = e.target.closest('.app-switch-item'); if(!t) return; const tool = t.dataset.tool; if(!tool) return; e.stopPropagation(); closeMenu(); switchTool(tool);
                });

                // close on outside click or Escape
                document.addEventListener('click', (e)=>{ if(!root.contains(e.target)) closeMenu(); });
                document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeMenu(); });

                // initialize default tool
                switchTool('ChemScope');
            })();
        </script>

        <svg id="molecule-svg" viewBox="-400 -300 800 600" preserveAspectRatio="xMidYMid slice">
            <defs>
                <filter id="soft-glow" x="-300%" y="-300%" width="700%" height="700%" filterUnits="objectBoundingBox" color-interpolation-filters="sRGB">
                    <feGaussianBlur in="SourceGraphic" stdDeviation="3.5" />
                </filter>
            </defs>
            <g id="scene-root"></g>
        </svg>
        <div id="hybrid-label" class="hybrid-tooltip"></div>
    </div>

    <!-- Elements viewport panel (single-page) -->
    <div class="viewport-area viewport-panel" data-tool="Elements" style="display:none">
        <div class="viewport-header">
            <h1 class="title">Elements</h1>
            <!-- molecule-display-info removed -->
        </div>

        <div class="elements-container">
            <div class="periodic-table" id="table-container">
                <!-- Javascript will populate the boxes -->
                
                <!-- The Key Box -->
                <div class="key-box-container">
                    <h3 class="key-title">Key</h3>
                    <div class="key-box">
                        <div class="key-label">relative atomic mass</div>
                        <div style="font-weight: bold; font-size: 20px; margin: 2px 0; color: #000;">atomic symbol</div>
                        <div class="key-label">name</div>
                        <div class="key-label" style="border-top: 1px solid #ccc; margin-top: 4px; padding-top:2px;">atomic (proton) number</div>
                    </div>
                </div>
            </div>

            <!-- The Information Card Modal -->
            <div class="modal-overlay" id="modal">
                <div class="info-card">
                    <span class="close-btn" onclick="closeModal()">&times;</span>
                    <div class="card-header">
                        <h2 id="card-name">Element Name</h2>
                    </div>
                    <div class="card-symbol" id="card-symbol">Sy</div>
                    
                    <div class="card-detail">
                        <span>Atomic Number:</span>
                        <strong id="card-num">0</strong>
                    </div>
                    <div class="card-detail">
                        <span>Relative Mass:</span>
                        <strong id="card-mass">0</strong>
                    </div>
                    <div class="card-detail">
                        <span>Category:</span>
                        <strong id="card-cat">Unknown</strong>
                    </div>
                    <p id="card-desc" style="font-size: 13px; color: #666; margin-top: 20px;">
                        Description
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Equation Balancer viewport panel (single-page) -->
    <div class="viewport-area viewport-panel" data-tool="Equation Balancer" style="display:none">
        <div class="viewport-header">
            <h1 class="title">Equation Balancer</h1>
        </div>
        
        <div class="balancer-container">
            <div class="balancer-card">
                <p class="balancer-instruction">Unbalanced Chemical Equation (use "=" for → or ⇌)</p>
                <div class="input-row">
                    <input type="text" id="eq-input" placeholder="e.g. H2 + O2 = H2O" autocomplete="off" spellcheck="false">
                    <button id="btn-balance">Balance</button>
                </div>
                <div id="eq-error" class="eq-msg error"></div>
                <div id="eq-result" class="eq-result"></div>
                <div id="eq-type" class="eq-msg type"></div>
            </div>
        </div>
    </div>
    <div id="config-modal">
        <div class="config-panel">
            <div class="config-header">
                <button class="config-close" onclick="closeConfigModal()">✕</button>
                <input type="text" class="config-search" id="configSearchInput" placeholder="搜尋元素 (Ex: Fe, 26, Carbon)..." onkeyup="renderConfigList()">
            </div>
            <div class="config-list" id="configListContainer"></div>
        </div>
    </div>

    <div class="controls-area" id="controls-panel">
        <div id="mobile-panel-handle"><div class="handle-bar"></div></div>
        
        <div class="controls-content">
            <div class="tool-panel active" data-tool="ChemScope" style="display:block">
            <!-- 1. 核心輸入 -->
            <div class="card">
                <div class="card-title large-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="card-title-input">Input Formula</span>
                </div>
                <div class="input-group">
                    <input type="text" id="formula-input" placeholder="eg: H2O, SO4 2-, C60, ..." value="H2O">
                    <button id="load-btn" style="background: var(--accent-yellow) !important; color: #000 !important; border: 1px solid rgba(0,0,0,0.08) !important;">載入</button>
                </div>
                <!-- Inline switches placed under the input, in the same card -->
                <div class="switch-row">
                    <label class="switch-item">
                        <input type="checkbox" id="toggle-lp" class="switch-input" checked>
                        <span class="slider"></span>
                        <span class="switch-label" id="lbl-lp">顯示孤對電子</span>
                    </label>
                    <label class="switch-item">
                        <input type="checkbox" id="toggle-auto-rotate" class="switch-input" checked>
                        <span class="slider"></span>
                        <span class="switch-label" id="lbl-auto-rotate">自動旋轉</span>
                    </label>
                </div>
            </div>

            <!-- 3. 🛠️ 其他擴充功能 (已移除) -->
            <!-- 已從此檔移除「其他擴充功能」面板及其內建子功能。若需還原，請從原始備份還原該區塊。 -->

            <!-- 4. 🟢 異構物選擇區 (確保在功能面板下方) -->
            <div id="variant-selector"></div>

            <!-- 5. 🧪 反應按鈕區 (已移除) -->
            <!-- Reaction buttons removed per user request -->

            <!-- 6. 小百科 -->
            <!-- 小知識卡片已移除 -->
            
            
            <div class="card" id="data-card">
                <div class="card-title large-title" id="data-card-title">Substance Data</div>
                <div class="data-row"><span class="data-label" id="lbl-formula">化學式</span><span class="data-value" id="disp-formula"></span></div>
                <div class="data-row"><span class="data-label" id="lbl-name">中文名稱</span><span class="data-value" id="disp-center"></span></div>
                <!-- 混成軌域 已移除 -->
                <div class="data-row"><span class="data-label" id="lbl-shape">形狀</span><span class="data-value" id="disp-shape"></span></div>
                <div class="data-row"><span class="data-label" id="lbl-angle">鍵角</span><span class="data-value" id="disp-angle"></span></div>
                <div class="data-row"><span class="data-label" id="lbl-mp">熔點 (MP)</span><span class="data-value" id="disp-mp"></span></div>
                <div class="data-row"><span class="data-label" id="lbl-bp">沸點 (BP)</span><span class="data-value" id="disp-bp"></span></div>
                <div class="data-row"><span class="data-label" id="lbl-bonds">鍵結統計</span><span class="data-value" id="disp-bonds"></span></div>
                <div class="data-row"><span class="data-label" id="lbl-mass">分子量</span><span class="data-value" id="disp-mass"></span></div>
            </div>
            <div class="spacer-60"></div>
            </div>

            <div class="tool-panel" data-tool="Elements" style="display:none">
                <!-- Elements control panel removed to allow full-screen periodic table -->
            </div>

            <div class="tool-panel" data-tool="Equation Balancer" style="display:none">
                <div class="card"><div class="card-title">Equation Balancer</div><div class="card">Equation Balancer control panel placeholder (input equation / options).</div></div>
            </div>

        </div>
    </div>
</div>

<!-- [修正版] 隱藏的流量計數器 (使用 Hits.sh) -->
<!-- ID 已修正為網域格式以符合服務要求: weiwei-molecular-lab.app -->
<div style="display:none;">
    <img id="site_counter_img" 
         src="https://hits.sh/weiwei-molecular-lab.app.svg?label=Views&color=10b981&labelColor=2d3748" 
         alt="Page Views">
</div>

<div class="creator-credit">F6S 22 35</div>

<!-- ★★★ 請在中間插入以下代碼 (Modal 視窗) ★★★ -->

<script>
/*
 ==========================================================================
 ★ 視覺鍵長標準參考表 (Visual Bond Length Standards) v16.2
 ==========================================================================
 基準：以 1,2-二氯丙烷為錨點 (C-C ~ 70, C-H ~ 50, C-Cl ~ 75)
 
 [1] 原子視覺半徑貢獻 (Base Radius Contribution)
 --------------------------------------------------------------------------
  - H (氫) .................... 15  (最小，確保緊湊)
  - Row 2 (C, N, O, F) ........ 35  (基準)
  - Row 3 (Si, P, S, Cl) ...... 40  (略大)
  - Row 4 (Br) ................ 45
  - Row 5 (I, Xe) ............. 50  (最大)

 [2] 鍵級修正係數 (Bond Order Multiplier)
 --------------------------------------------------------------------------
  - 單鍵 (Single) ............. x 1.00
  - 雙鍵 (Double) ............. x 0.90
  - 參鍵 (Triple) ............. x 0.85

 [3] 常見鍵長計算範例 (Calculated Examples)
 --------------------------------------------------------------------------
  Type      Calc (R1 + R2) * Multiplier      Final Value
  -------   ---------------------------      -----------
  H-H       (15 + 15) * 1.0                  30
  C-H       (35 + 15) * 1.0                  50  (基準)
  N-H       (35 + 15) * 1.0                  50
  O-H       (35 + 15) * 1.0                  50
  P-H       (40 + 15) * 1.0                  55

  C-C       (35 + 35) * 1.0                  70  (基準)
  C=C       (35 + 35) * 0.9                  63
  C≡C       (35 + 35) * 0.85                 60
  
  C-O       (35 + 35) * 1.0                  70
  C=O       (35 + 35) * 0.9                  63

  S-O       (40 + 35) * 1.0                  75
  S=O       (40 + 35) * 0.9                  68  (SO4, SO3)
  
  P-Cl      (40 + 40) * 1.0                  80  (PCl3)
  Xe=O      (50 + 35) * 0.9                  76  (XeO3)
  
  F-F       (35 + 35) * 1.0                  70
  Cl-Cl     (40 + 40) * 1.0                  80
  I-I       (50 + 50) * 1.0                  100
 ==========================================================================
*/


const ELEMENT_PROPS = {
    // --- 第 1 週期 ---
    "H":  { ve: 1, c3d: "#F0F0F0", r3d: 12, lp: 0, mass: 1.008, en: 2.20 }, // [保留] 白灰
    "He": { ve: 2, c3d: "#A5F3FC", r3d: 11, lp: 1, mass: 4.002, en: 0 },    // [保留] 淡青

    // --- 第 2 週期 (半徑漸小: Li > Be > B > C > N > O > F) ---
    "Li": { ve: 1, c3d: "#E879F9", r3d: 26, lp: 0, mass: 6.94, en: 0.98 },  // [保留] 粉紫
    "Be": { ve: 2, c3d: "#C2F970", r3d: 22, lp: 0, mass: 9.012, en: 1.57 }, // [保留] 萊姆綠
    "B":  { ve: 3, c3d: "#FDBA74", r3d: 20, lp: 0, mass: 10.81, en: 2.04 }, // [保留] 蜜桃橘 (您喜歡的顏色)
    "C":  { ve: 4, c3d: "#94A3B8", r3d: 19, lp: 0, mass: 12.011, en: 2.55 },// [保留] 藍灰
    "N":  { ve: 5, c3d: "#3B82F6", r3d: 18, lp: 1, mass: 14.007, en: 3.04 },// [保留] 亮藍
    "O":  { ve: 6, c3d: "#EF4444", r3d: 17, lp: 2, mass: 15.999, en: 3.44 },// [保留] 紅
    "F":  { ve: 7, c3d: "#90E050", r3d: 16, lp: 3, mass: 18.998, en: 3.98 },// [保留] 鮮綠
    "Ne": { ve: 8, c3d: "#67E8F9", r3d: 15, lp: 4, mass: 20.180, en: 0 },   // [保留] 青

    // --- 第 3 週期 (半徑漸小: Na > Mg > Al > Si > P > S > Cl) ---
    "Na": { ve: 1, c3d: "#C084FC", r3d: 30, lp: 0, mass: 22.990, en: 0.93 },// [保留] 紫
    "Mg": { ve: 2, c3d: "#10B981", r3d: 26, lp: 0, mass: 24.305, en: 1.31 },// [保留] 翡翠綠
    "Al": { ve: 3, c3d: "#E2E8F0", r3d: 24, lp: 0, mass: 26.982, en: 1.61 },// [保留] 淺灰
    "Si": { ve: 4, c3d: "#CBD5E1", r3d: 22, lp: 0, mass: 28.085, en: 1.90 },// [保留] 灰
    "P":  { ve: 5, c3d: "#F97316", r3d: 21, lp: 0, mass: 30.974, en: 2.19 },// [保留] 橘
    "S":  { ve: 6, c3d: "#FACC15", r3d: 20, lp: 0, mass: 32.06, en: 2.58 }, // [保留] 黃
    "Cl": { ve: 7, c3d: "#22C55E", r3d: 19, lp: 3, mass: 35.45, en: 3.16 }, // [保留] 深綠 (比F深，符合視覺邏輯)
    "Ar": { ve: 8, c3d: "#38BDF8", r3d: 18, lp: 4, mass: 39.948, en: 0 },   // [保留] 天藍

    // --- 第 4 週期 (K > Ca > Sc ... > Br) ---
    "K":  { ve: 1, c3d: "#8B5CF6", r3d: 36, lp: 0, mass: 39.098, en: 0.82 },// [保留] 靛紫
    "Ca": { ve: 2, c3d: "#4ADE80", r3d: 32, lp: 0, mass: 40.078, en: 1.00 },// [保留] 淺綠
    "Sc": { ve: 3, c3d: "#E6E6E6", r3d: 28, lp: 0, mass: 44.96, en: 1.36 }, // [新增] CPK 銀白
    "Ti": { ve: 4, c3d: "#BFC2C7", r3d: 26, lp: 0, mass: 47.87, en: 1.54 }, // [新增] CPK 鈦灰
    "V":  { ve: 5, c3d: "#A6A6AB", r3d: 25, lp: 0, mass: 50.94, en: 1.63 }, // [新增] 灰
    "Cr": { ve: 6, c3d: "#94A3B8", r3d: 24, lp: 0, mass: 51.996, en: 1.66 },// [保留] 鉻灰
    "Mn": { ve: 7, c3d: "#D946EF", r3d: 24, lp: 0, mass: 54.938, en: 1.55 },// [保留] 紫紅 (很適合Mn)
    "Fe": { ve: 8, c3d: "#EA580C", r3d: 24, lp: 0, mass: 55.845, en: 1.83 },// [保留] 鐵鏽橘
    "Co": { ve: 9, c3d: "#F472B6", r3d: 23, lp: 0, mass: 58.93, en: 1.88 }, // [新增] CPK 粉紅 (鈷)
    "Ni": { ve: 10, c3d: "#50D050", r3d: 23, lp: 0, mass: 58.69, en: 1.91 },// [新增] CPK 綠 (鎳)
    "Cu": { ve: 11, c3d: "#D97706", r3d: 23, lp: 0, mass: 63.546, en: 1.90 },// [保留] 銅色
    "Zn": { ve: 12, c3d: "#78716C", r3d: 23, lp: 0, mass: 65.38, en: 1.65 },// [保留] 鋅灰
    "Ga": { ve: 3, c3d: "#C28F8F", r3d: 23, lp: 0, mass: 69.72, en: 1.81 }, // [新增] 紅褐
    "Ge": { ve: 4, c3d: "#668F8F", r3d: 23, lp: 0, mass: 72.63, en: 2.01 }, // [新增] 灰綠
    "As": { ve: 5, c3d: "#BD80E3", r3d: 22, lp: 0, mass: 74.92, en: 2.18 }, // [修正] 紫色 (區分 Na)
    "Se": { ve: 6, c3d: "#FFA100", r3d: 22, lp: 0, mass: 78.96, en: 2.55 }, // [修正] 深橘 (區分 P)
    "Br": { ve: 7, c3d: "#B91C1C", r3d: 21, lp: 3, mass: 79.904, en: 2.96 },// [保留] 深紅
    "Kr": { ve: 8, c3d: "#5CB8D1", r3d: 20, lp: 4, mass: 83.80, en: 3.00 }, // [新增] 青

    // --- 其他常用元素 (第 5, 6 週期) ---
    "Rb": { ve: 1, c3d: "#702EB0", r3d: 38, lp: 0, mass: 85.47, en: 0.82 }, // CPK 紫
    "Sr": { ve: 2, c3d: "#00FF00", r3d: 34, lp: 0, mass: 87.62, en: 0.95 }, // CPK 綠
    "Ag": { ve: 11, c3d: "#F1F5F9", r3d: 25, lp: 0, mass: 107.87, en: 1.93 },// [保留] 銀白
    "Sn": { ve: 4, c3d: "#668080", r3d: 25, lp: 0, mass: 118.7, en: 1.96 }, // 灰
    "Sb": { ve: 5, c3d: "#A855F7", r3d: 25, lp: 0, mass: 121.76, en: 2.05 },// [保留] 紫
    "Te": { ve: 6, c3d: "#EA580C", r3d: 25, lp: 0, mass: 127.60, en: 2.10 },// [保留] 橘褐
    "I":  { ve: 7, c3d: "#A855F7", r3d: 24, lp: 3, mass: 126.90, en: 2.66 },// [保留] 紫
    "Xe": { ve: 8, c3d: "#818CF8", r3d: 24, lp: 3, mass: 131.29, en: 2.60 },// [保留] 藍紫
    "Cs": { ve: 1, c3d: "#57178F", r3d: 42, lp: 0, mass: 132.9, en: 0.79 }, // CPK 深紫
    "Ba": { ve: 2, c3d: "#00C900", r3d: 38, lp: 0, mass: 137.3, en: 0.89 }, // CPK 深綠
    "Pt": { ve: 10, c3d: "#D0D0E0", r3d: 25, lp: 0, mass: 195.1, en: 2.28 },// 鉑
    "Au": { ve: 11, c3d: "#F59E0B", r3d: 25, lp: 0, mass: 196.97, en: 2.54 },// [保留] 金黃
    "Hg": { ve: 12, c3d: "#B8B8D0", r3d: 24, lp: 0, mass: 200.6, en: 2.00 },// 汞
    "Pb": { ve: 4, c3d: "#575961", r3d: 26, lp: 0, mass: 207.2, en: 2.33 }, // 鉛

    // --- [補齊] 金屬與放射性元素 (滿足晶體結構需求) ---
    "Po": { ve: 6, c3d: "#AB5C00", r3d: 26, lp: 0, mass: 209, en: 2.0 },    // [新增] 釙 (金屬) - 深橘褐
    "Fr": { ve: 1, c3d: "#420066", r3d: 44, lp: 0, mass: 223, en: 0.7 },    // [新增] 鍅 (1A) - 極深紫
    "Ra": { ve: 2, c3d: "#006400", r3d: 40, lp: 0, mass: 226, en: 0.9 },    // [新增] 鐳 (2A) - 深綠
// --- 電子軌域專用材質 (無文字版) ---
    // 技巧：使用不同數量的空白鍵作為 ID，這樣畫面上就不會有文字，但能區分顏色
    " ":      { ve: 0, c3d: "#3B82F6", r3d: 0 }, // s (藍)
    "  ":     { ve: 0, c3d: "#10B981", r3d: 0 }, // p (備用)
    "   ":    { ve: 0, c3d: "#F59E0B", r3d: 0 }, // d (橘)
    
    // --- 座標軸系統 ---
    "Origin": { ve: 0, c3d: "#000000", r3d: 0,    lp: 0, mass: 0, en: 0 }, // 隱藏原點
    "Axis":   { ve: 0, c3d: "#444444", r3d: 1.0,  lp: 0, mass: 0, en: 0 }, // 極細深灰軸
    "X":      { ve: 0, c3d: "#EF4444", r3d: 0,    lp: 0, mass: 0, en: 0 }, // 紅色 X
    "Y":      { ve: 0, c3d: "#22C55E", r3d: 0,    lp: 0, mass: 0, en: 0 }, // 綠色 Y
    "Z":      { ve: 0, c3d: "#3B82F6", r3d: 0,    lp: 0, mass: 0, en: 0 }  // 藍色 Z
};

// Elements UI: build periodic table and popup (scoped, minimal)
(function(){
    function buildTable(){
        const table = document.getElementById('periodicTable'); if(!table) return;
        table.innerHTML = '';
        const lanth = [], actin = [];
        ELECTRON_DATA.forEach(el=>{
            const btn = document.createElement('button');
            btn.className = 'element-cell';
            btn.setAttribute('data-z', el.z);
            btn.setAttribute('data-sym', el.s);
            const displayName = el.cn || el.n || '';
            // Determine mass to display: prefer ELEMENT_PROPS, then ELECTRON_DATA's el.mass, else fallback to atomic number
            let rawMass = '';
            if (typeof ELEMENT_PROPS !== 'undefined' && ELEMENT_PROPS[el.s] && ELEMENT_PROPS[el.s].mass) rawMass = ELEMENT_PROPS[el.s].mass;
            else if (el.mass) rawMass = el.mass;
            else rawMass = el.z;
            // format numeric masses to 2 decimals, else use as-is
            let massVal = rawMass;
            const n = Number(rawMass);
            if (!Number.isNaN(n)) {
                massVal = n >= 100 ? n.toFixed(0) : n.toFixed(2);
            }
            const nameVal = el.n || el.cn || '';
            btn.innerHTML = `<div class=\"mass\">${massVal}</div><div class=\"sym\">${el.s}</div><div class=\"name\">${nameVal}</div><div class=\"num\">${el.z}</div>`;
            btn.addEventListener('click', ()=> showPopup(el));

            // place by IUPAC group (1-18) and period p
            if(typeof el.iupac === 'number' && el.iupac >= 1 && el.iupac <= 18){
                btn.style.gridColumn = el.iupac;
                btn.style.gridRow = el.p;
                table.appendChild(btn);
            } else {
                // collect lanth/actinides for separate rows
                if(el.z >= 57 && el.z <= 71) lanth.push(btn);
                else if(el.z >= 89 && el.z <= 103) actin.push(btn);
                else {
                    // fallback: try placing by period
                    btn.style.gridColumn = 1;
                    btn.style.gridRow = el.p || 1;
                    table.appendChild(btn);
                }
            }
        });

        // place lanthanides and actinides in dedicated rows near the bottom
        const lanthRow = 8, actinRow = 9, colStart = 3;
        lanth.forEach((btn,i)=>{ btn.style.gridColumn = (colStart + i); btn.style.gridRow = lanthRow; table.appendChild(btn); });
        actin.forEach((btn,i)=>{ btn.style.gridColumn = (colStart + i); btn.style.gridRow = actinRow; table.appendChild(btn); });
    }

    function showPopup(el){
        const popup = document.getElementById('elementPopup');
        const content = document.getElementById('popupContent');
        if(!popup||!content) return;
        const mass = (typeof ELEMENT_PROPS !== 'undefined' && ELEMENT_PROPS[el.s] && ELEMENT_PROPS[el.s].mass) ? ELEMENT_PROPS[el.s].mass : (el.mass || '');
        content.innerHTML = `<div class=\"popup-row\"><div class=\"popup-sym\">${el.s}</div><div class=\"popup-meta\"><strong>${el.n} ${el.cn?('('+el.cn+')'):''}</strong><div>Atomic number: ${el.z}</div><div>Mass: ${mass}</div><div>Type: ${el.type||''}</div><div>State: ${el.state||''}</div></div></div>`;
        popup.classList.add('show'); popup.setAttribute('aria-hidden','false');
    }

    function closePopup(){ const p=document.getElementById('elementPopup'); if(!p) return; p.classList.remove('show'); p.setAttribute('aria-hidden','true'); }

    document.addEventListener('DOMContentLoaded', ()=>{ buildTable(); document.getElementById('popupClose')?.addEventListener('click', closePopup); document.addEventListener('click', (e)=>{ const p=document.getElementById('elementPopup'); if(!p) return; if(p.classList.contains('show') && !p.contains(e.target) && !e.target.closest('.element-cell')) closePopup(); }); });

    // rebuild when user switches to Elements view
    document.addEventListener('click', (e)=>{ const t = e.target.closest('.app-switch-item'); if(t && t.dataset.tool === 'Elements'){ setTimeout(buildTable, 80); } });
})();

// ========== [每日運勢資料庫：最終修訂版]
    const ELECTRON_DATA = [
    // Period 1
    { z: 1, s: "H", n: "Hydrogen", cn: "氫", type: "非金屬", state: "氣體", mp: "-259°C", bp: "-253°C", p: 1, g: "1A", iupac: 1, c: "1s1", noble: "1s1" },
    { z: 2, s: "He", n: "Helium", cn: "氦", type: "非金屬", state: "氣體", mp: "-272°C", bp: "-269°C", p: 1, g: "8A", iupac: 18, c: "1s2", noble: "1s2" },
    // Period 2
    { z: 3, s: "Li", n: "Lithium", cn: "鋰", type: "金屬", state: "固體", mp: "180°C", bp: "1342°C", p: 2, g: "1A", iupac: 1, c: "1s2 2s1", noble: "[He] 2s1" },
    { z: 4, s: "Be", n: "Beryllium", cn: "鈹", type: "金屬", state: "固體", mp: "1287°C", bp: "2469°C", p: 2, g: "2A", iupac: 2, c: "1s2 2s2", noble: "[He] 2s2" },
    { z: 5, s: "B", n: "Boron", cn: "硼", type: "類金屬", state: "固體", mp: "2076°C", bp: "3927°C", p: 2, g: "3A", iupac: 13, c: "1s2 2s2 2p1", noble: "[He] 2s2 2p1" },
    { z: 6, s: "C", n: "Carbon", cn: "碳", type: "非金屬", state: "固體", mp: "3550°C", bp: "4027°C", p: 2, g: "4A", iupac: 14, c: "1s2 2s2 2p2", noble: "[He] 2s2 2p2" },
    { z: 7, s: "N", n: "Nitrogen", cn: "氮", type: "非金屬", state: "氣體", mp: "-210°C", bp: "-196°C", p: 2, g: "5A", iupac: 15, c: "1s2 2s2 2p3", noble: "[He] 2s2 2p3" },
    { z: 8, s: "O", n: "Oxygen", cn: "氧", type: "非金屬", state: "氣體", mp: "-218°C", bp: "-183°C", p: 2, g: "6A", iupac: 16, c: "1s2 2s2 2p4", noble: "[He] 2s2 2p4" },
    { z: 9, s: "F", n: "Fluorine", cn: "氟", type: "非金屬", state: "氣體", mp: "-220°C", bp: "-188°C", p: 2, g: "7A", iupac: 17, c: "1s2 2s2 2p5", noble: "[He] 2s2 2p5" },
    { z: 10, s: "Ne", n: "Neon", cn: "氖", type: "非金屬", state: "氣體", mp: "-249°C", bp: "-246°C", p: 2, g: "8A", iupac: 18, c: "1s2 2s2 2p6", noble: "[He] 2s2 2p6" },
    // Period 3
    { z: 11, s: "Na", n: "Sodium", cn: "鈉", type: "金屬", state: "固體", mp: "98°C", bp: "883°C", p: 3, g: "1A", iupac: 1, c: "1s2 2s2 2p6 3s1", noble: "[Ne] 3s1" },
    { z: 12, s: "Mg", n: "Magnesium", cn: "鎂", type: "金屬", state: "固體", mp: "650°C", bp: "1090°C", p: 3, g: "2A", iupac: 2, c: "1s2 2s2 2p6 3s2", noble: "[Ne] 3s2" },
    { z: 13, s: "Al", n: "Aluminium", cn: "鋁", type: "金屬", state: "固體", mp: "660°C", bp: "2519°C", p: 3, g: "3A", iupac: 13, c: "1s2 2s2 2p6 3s2 3p1", noble: "[Ne] 3s2 3p1" },
    { z: 14, s: "Si", n: "Silicon", cn: "矽", type: "類金屬", state: "固體", mp: "1414°C", bp: "3265°C", p: 3, g: "4A", iupac: 14, c: "1s2 2s2 2p6 3s2 3p2", noble: "[Ne] 3s2 3p2" },
    { z: 15, s: "P", n: "Phosphorus", cn: "磷", type: "非金屬", state: "固體", mp: "44°C", bp: "280°C", p: 3, g: "5A", iupac: 15, c: "1s2 2s2 2p6 3s2 3p3", noble: "[Ne] 3s2 3p3" },
    { z: 16, s: "S", n: "Sulfur", cn: "硫", type: "非金屬", state: "固體", mp: "115°C", bp: "445°C", p: 3, g: "6A", iupac: 16, c: "1s2 2s2 2p6 3s2 3p4", noble: "[Ne] 3s2 3p4" },
    { z: 17, s: "Cl", n: "Chlorine", cn: "氯", type: "非金屬", state: "氣體", mp: "-101°C", bp: "-34°C", p: 3, g: "7A", iupac: 17, c: "1s2 2s2 2p6 3s2 3p5", noble: "[Ne] 3s2 3p5" },
    { z: 18, s: "Ar", n: "Argon", cn: "氬", type: "非金屬", state: "氣體", mp: "-189°C", bp: "-186°C", p: 3, g: "8A", iupac: 18, c: "1s2 2s2 2p6 3s2 3p6", noble: "[Ne] 3s2 3p6" },
    // Period 4
    { z: 19, s: "K", n: "Potassium", cn: "鉀", type: "金屬", state: "固體", mp: "63°C", bp: "759°C", p: 4, g: "1A", iupac: 1, c: "1s2 2s2 2p6 3s2 3p6 4s1", noble: "[Ar] 4s1" },
    { z: 20, s: "Ca", n: "Calcium", cn: "鈣", type: "金屬", state: "固體", mp: "842°C", bp: "1484°C", p: 4, g: "2A", iupac: 2, c: "1s2 2s2 2p6 3s2 3p6 4s2", noble: "[Ar] 4s2" },
    { z: 21, s: "Sc", n: "Scandium", cn: "鈧", type: "金屬", state: "固體", mp: "1541°C", bp: "2836°C", p: 4, g: "3B", iupac: 3, c: "1s2 2s2 2p6 3s2 3p6 3d1 4s2", noble: "[Ar] 3d1 4s2" },
    { z: 22, s: "Ti", n: "Titanium", cn: "鈦", type: "金屬", state: "固體", mp: "1668°C", bp: "3287°C", p: 4, g: "4B", iupac: 4, c: "1s2 2s2 2p6 3s2 3p6 3d2 4s2", noble: "[Ar] 3d2 4s2" },
    { z: 23, s: "V", n: "Vanadium", cn: "釩", type: "金屬", state: "固體", mp: "1910°C", bp: "3407°C", p: 4, g: "5B", iupac: 5, c: "1s2 2s2 2p6 3s2 3p6 3d3 4s2", noble: "[Ar] 3d3 4s2" },
    { z: 24, s: "Cr", n: "Chromium", cn: "鉻", type: "金屬", state: "固體", mp: "1907°C", bp: "2671°C", p: 4, g: "6B", iupac: 6, c: "1s2 2s2 2p6 3s2 3p6 3d5 4s1", noble: "[Ar] 3d5 4s1", ex: true },    
    { z: 25, s: "Mn", n: "Manganese", cn: "錳", type: "金屬", state: "固體", mp: "1246°C", bp: "2061°C", p: 4, g: "7B", iupac: 7, c: "1s2 2s2 2p6 3s2 3p6 3d5 4s2", noble: "[Ar] 3d5 4s2" },
    { z: 26, s: "Fe", n: "Iron", cn: "鐵", type: "金屬", state: "固體", mp: "1538°C", bp: "2861°C", p: 4, g: "8B", iupac: 8, c: "1s2 2s2 2p6 3s2 3p6 3d6 4s2", noble: "[Ar] 3d6 4s2" },
    { z: 27, s: "Co", n: "Cobalt", cn: "鈷", type: "金屬", state: "固體", mp: "1495°C", bp: "2927°C", p: 4, g: "8B", iupac: 9, c: "1s2 2s2 2p6 3s2 3p6 3d7 4s2", noble: "[Ar] 3d7 4s2" },
    { z: 28, s: "Ni", n: "Nickel", cn: "鎳", type: "金屬", state: "固體", mp: "1455°C", bp: "2730°C", p: 4, g: "8B", iupac: 10, c: "1s2 2s2 2p6 3s2 3p6 3d8 4s2", noble: "[Ar] 3d8 4s2" },
    { z: 29, s: "Cu", n: "Copper", cn: "銅", type: "金屬", state: "固體", mp: "1085°C", bp: "2562°C", p: 4, g: "1B", iupac: 11, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s1", noble: "[Ar] 3d10 4s1", ex: true },
    { z: 30, s: "Zn", n: "Zinc", cn: "鋅", type: "金屬", state: "固體", mp: "420°C", bp: "907°C", p: 4, g: "2B", iupac: 12, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2", noble: "[Ar] 3d10 4s2" },
    { z: 31, s: "Ga", n: "Gallium", cn: "鎵", type: "金屬", state: "固體", mp: "30°C", bp: "2204°C", p: 4, g: "3A", iupac: 13, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p1", noble: "[Ar] 3d10 4s2 4p1" },
    { z: 32, s: "Ge", n: "Germanium", cn: "鍺", type: "類金屬", state: "固體", mp: "938°C", bp: "2833°C", p: 4, g: "4A", iupac: 14, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p2", noble: "[Ar] 3d10 4s2 4p2" },
    { z: 33, s: "As", n: "Arsenic", cn: "砷", type: "類金屬", state: "固體", mp: "817°C", bp: "614°C", p: 4, g: "5A", iupac: 15, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p3", noble: "[Ar] 3d10 4s2 4p3" },
    { z: 34, s: "Se", n: "Selenium", cn: "硒", type: "非金屬", state: "固體", mp: "221°C", bp: "685°C", p: 4, g: "6A", iupac: 16, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p4", noble: "[Ar] 3d10 4s2 4p4" },
    { z: 35, s: "Br", n: "Bromine", cn: "溴", type: "非金屬", state: "液體", mp: "-7°C", bp: "59°C", p: 4, g: "7A", iupac: 17, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p5", noble: "[Ar] 3d10 4s2 4p5" },
    { z: 36, s: "Kr", n: "Krypton", cn: "氪", type: "非金屬", state: "氣體", mp: "-157°C", bp: "-153°C", p: 4, g: "8A", iupac: 18, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6", noble: "[Ar] 3d10 4s2 4p6" },
    // Period 5
    { z: 37, s: "Rb", n: "Rubidium", cn: "銣", type: "金屬", state: "固體", mp: "39°C", bp: "688°C", p: 5, g: "1A", iupac: 1, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 5s1", noble: "[Kr] 5s1" },
    { z: 38, s: "Sr", n: "Strontium", cn: "鍶", type: "金屬", state: "固體", mp: "777°C", bp: "1382°C", p: 5, g: "2A", iupac: 2, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 5s2", noble: "[Kr] 5s2" },
    { z: 39, s: "Y", n: "Yttrium", cn: "釔", type: "金屬", state: "固體", mp: "1526°C", bp: "3338°C", p: 5, g: "3B", iupac: 3, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d1 5s2", noble: "[Kr] 4d1 5s2" },
    { z: 40, s: "Zr", n: "Zirconium", cn: "鋯", type: "金屬", state: "固體", mp: "1855°C", bp: "4409°C", p: 5, g: "4B", iupac: 4, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d2 5s2", noble: "[Kr] 4d2 5s2" },
    { z: 41, s: "Nb", n: "Niobium", cn: "鈮", type: "金屬", state: "固體", mp: "2477°C", bp: "4744°C", p: 5, g: "5B", iupac: 5, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d4 5s1", noble: "[Kr] 4d4 5s1", ex: true },    
    { z: 42, s: "Mo", n: "Molybdenum", cn: "鉬", type: "金屬", state: "固體", mp: "2623°C", bp: "4639°C", p: 5, g: "6B", iupac: 6, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d5 5s1", noble: "[Kr] 4d5 5s1", ex: true },    
    { z: 43, s: "Tc", n: "Technetium", cn: "鎝", type: "金屬", state: "固體", mp: "2157°C", bp: "4265°C", p: 5, g: "7B", iupac: 7, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d5 5s2", noble: "[Kr] 4d5 5s2" },
    { z: 44, s: "Ru", n: "Ruthenium", cn: "釕", type: "金屬", state: "固體", mp: "2334°C", bp: "4150°C", p: 5, g: "8B", iupac: 8, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d7 5s1", noble: "[Kr] 4d7 5s1" },
    { z: 45, s: "Rh", n: "Rhodium", cn: "銠", type: "金屬", state: "固體", mp: "1964°C", bp: "3695°C", p: 5, g: "8B", iupac: 9, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d8 5s1", noble: "[Kr] 4d8 5s1", ex: true },    
    { z: 46, s: "Pd", n: "Palladium", cn: "鈀", type: "金屬", state: "固體", mp: "1555°C", bp: "2963°C", p: 5, g: "8B", iupac: 10, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10", noble: "[Kr] 4d10", ex: true },    
    { z: 47, s: "Ag", n: "Silver", cn: "銀", type: "金屬", state: "固體", mp: "962°C", bp: "2162°C", p: 5, g: "1B", iupac: 11, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s1", noble: "[Kr] 4d10 5s1", ex: true },    
    { z: 48, s: "Cd", n: "Cadmium", cn: "鎘", type: "金屬", state: "固體", mp: "321°C", bp: "767°C", p: 5, g: "2B", iupac: 12, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2", noble: "[Kr] 4d10 5s2" },
    { z: 49, s: "In", n: "Indium", cn: "銦", type: "金屬", state: "固體", mp: "157°C", bp: "2072°C", p: 5, g: "3A", iupac: 13, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p1", noble: "[Kr] 4d10 5s2 5p1" },
    { z: 50, s: "Sn", n: "Tin", cn: "錫", type: "金屬", state: "固體", mp: "232°C", bp: "2602°C", p: 5, g: "4A", iupac: 14, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p2", noble: "[Kr] 4d10 5s2 5p2" },
    { z: 51, s: "Sb", n: "Antimony", cn: "銻", type: "類金屬", state: "固體", mp: "631°C", bp: "1587°C", p: 5, g: "5A", iupac: 15, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p3", noble: "[Kr] 4d10 5s2 5p3" },
    { z: 52, s: "Te", n: "Tellurium", cn: "碲", type: "類金屬", state: "固體", mp: "450°C", bp: "988°C", p: 5, g: "6A", iupac: 16, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p4", noble: "[Kr] 4d10 5s2 5p4" },
    { z: 53, s: "I", n: "Iodine", cn: "碘", type: "非金屬", state: "固體", mp: "114°C", bp: "184°C", p: 5, g: "7A", iupac: 17, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p5", noble: "[Kr] 4d10 5s2 5p5" },
    { z: 54, s: "Xe", n: "Xenon", cn: "氙", type: "非金屬", state: "氣體", mp: "-112°C", bp: "-108°C", p: 5, g: "8A", iupac: 18, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6", noble: "[Kr] 4d10 5s2 5p6" },
    // Period 6
    { z: 55, s: "Cs", n: "Cesium", cn: "銫", type: "金屬", state: "固體", mp: "28°C", bp: "671°C", p: 6, g: "1A", iupac: 1, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 6s1", noble: "[Xe] 6s1" },
    { z: 56, s: "Ba", n: "Barium", cn: "鋇", type: "金屬", state: "固體", mp: "727°C", bp: "1897°C", p: 6, g: "2A", iupac: 2, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 6s2", noble: "[Xe] 6s2" },
    { z: 57, s: "La", n: "Lanthanum", cn: "鑭", type: "金屬", state: "固體", mp: "920°C", bp: "3464°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 5d1 6s2", noble: "[Xe] 5d1 6s2", ex: true },    
    { z: 58, s: "Ce", n: "Cerium", cn: "鈰", type: "金屬", state: "固體", mp: "795°C", bp: "3443°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f1 5d1 6s2", noble: "[Xe] 4f1 5d1 6s2", ex: true },    
    { z: 59, s: "Pr", n: "Praseodymium", cn: "鐠", type: "金屬", state: "固體", mp: "931°C", bp: "3520°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f3 6s2", noble: "[Xe] 4f3 6s2" },
    { z: 60, s: "Nd", n: "Neodymium", cn: "釹", type: "金屬", state: "固體", mp: "1024°C", bp: "3074°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f4 6s2", noble: "[Xe] 4f4 6s2" },
    { z: 61, s: "Pm", n: "Promethium", cn: "鉕", type: "金屬", state: "固體", mp: "1042°C", bp: "3000°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f5 6s2", noble: "[Xe] 4f5 6s2" },
    { z: 62, s: "Sm", n: "Samarium", cn: "釤", type: "金屬", state: "固體", mp: "1072°C", bp: "1794°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f6 6s2", noble: "[Xe] 4f6 6s2" },
    { z: 63, s: "Eu", n: "Europium", cn: "銪", type: "金屬", state: "固體", mp: "826°C", bp: "1529°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f7 6s2", noble: "[Xe] 4f7 6s2" },
    { z: 64, s: "Gd", n: "Gadolinium", cn: "釓", type: "金屬", state: "固體", mp: "1312°C", bp: "3273°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f7 5d1 6s2", noble: "[Xe] 4f7 5d1 6s2", ex: true },    
    { z: 65, s: "Tb", n: "Terbium", cn: "鋱", type: "金屬", state: "固體", mp: "1356°C", bp: "3230°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f9 6s2", noble: "[Xe] 4f9 6s2" },
    { z: 66, s: "Dy", n: "Dysprosium", cn: "鏑", type: "金屬", state: "固體", mp: "1407°C", bp: "2567°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f10 6s2", noble: "[Xe] 4f10 6s2" },
    { z: 67, s: "Ho", n: "Holmium", cn: "鈥", type: "金屬", state: "固體", mp: "1461°C", bp: "2720°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f11 6s2", noble: "[Xe] 4f11 6s2" },
    { z: 68, s: "Er", n: "Erbium", cn: "鉺", type: "金屬", state: "固體", mp: "1529°C", bp: "2868°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f12 6s2", noble: "[Xe] 4f12 6s2" },
    { z: 69, s: "Tm", n: "Thulium", cn: "銩", type: "金屬", state: "固體", mp: "1545°C", bp: "1950°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f13 6s2", noble: "[Xe] 4f13 6s2" },
    { z: 70, s: "Yb", n: "Ytterbium", cn: "鐿", type: "金屬", state: "固體", mp: "824°C", bp: "1196°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 6s2", noble: "[Xe] 4f14 6s2" },
    { z: 71, s: "Lu", n: "Lutetium", cn: "鎦", type: "金屬", state: "固體", mp: "1663°C", bp: "3402°C", p: 6, g: "鑭系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d1 6s2", noble: "[Xe] 4f14 5d1 6s2" },
    { z: 72, s: "Hf", n: "Hafnium", cn: "鉿", type: "金屬", state: "固體", mp: "2233°C", bp: "4603°C", p: 6, g: "4B", iupac: 4, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d2 6s2", noble: "[Xe] 4f14 5d2 6s2" },
    { z: 73, s: "Ta", n: "Tantalum", cn: "鉭", type: "金屬", state: "固體", mp: "3017°C", bp: "5458°C", p: 6, g: "5B", iupac: 5, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d3 6s2", noble: "[Xe] 4f14 5d3 6s2" },
    { z: 74, s: "W", n: "Tungsten", cn: "鎢", type: "金屬", state: "固體", mp: "3422°C", bp: "5930°C", p: 6, g: "6B", iupac: 6, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d4 6s2", noble: "[Xe] 4f14 5d4 6s2" },
    { z: 75, s: "Re", n: "Rhenium", cn: "錸", type: "金屬", state: "固體", mp: "3186°C", bp: "5596°C", p: 6, g: "7B", iupac: 7, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d5 6s2", noble: "[Xe] 4f14 5d5 6s2" },
    { z: 76, s: "Os", n: "Osmium", cn: "鋨", type: "金屬", state: "固體", mp: "3033°C", bp: "5012°C", p: 6, g: "8B", iupac: 8, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d6 6s2", noble: "[Xe] 4f14 5d6 6s2" },
    { z: 77, s: "Ir", n: "Iridium", cn: "銥", type: "金屬", state: "固體", mp: "2446°C", bp: "4428°C", p: 6, g: "8B", iupac: 9, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d7 6s2", noble: "[Xe] 4f14 5d7 6s2" },
    { z: 78, s: "Pt", n: "Platinum", cn: "鉑", type: "金屬", state: "固體", mp: "1768°C", bp: "3825°C", p: 6, g: "8B", iupac: 10, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d9 6s1", noble: "[Xe] 4f14 5d9 6s1", ex: true },    
    { z: 79, s: "Au", n: "Gold", cn: "金", type: "金屬", state: "固體", mp: "1064°C", bp: "2970°C", p: 6, g: "1B", iupac: 11, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s1", noble: "[Xe] 4f14 5d10 6s1", ex: true },    
    { z: 80, s: "Hg", n: "Mercury", cn: "汞", type: "金屬", state: "液體", mp: "-39°C", bp: "357°C", p: 6, g: "2B", iupac: 12, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2", noble: "[Xe] 4f14 5d10 6s2" },
    { z: 81, s: "Tl", n: "Thallium", cn: "鉈", type: "金屬", state: "固體", mp: "304°C", bp: "1473°C", p: 6, g: "3A", iupac: 13, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p1", noble: "[Xe] 4f14 5d10 6s2 6p1" },
    { z: 82, s: "Pb", n: "Lead", cn: "鉛", type: "金屬", state: "固體", mp: "327°C", bp: "1749°C", p: 6, g: "4A", iupac: 14, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p2", noble: "[Xe] 4f14 5d10 6s2 6p2" },
    { z: 83, s: "Bi", n: "Bismuth", cn: "鉍", type: "金屬", state: "固體", mp: "271°C", bp: "1564°C", p: 6, g: "5A", iupac: 15, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p3", noble: "[Xe] 4f14 5d10 6s2 6p3" },
    { z: 84, s: "Po", n: "Polonium", cn: "釙", type: "金屬", state: "固體", mp: "254°C", bp: "962°C", p: 6, g: "6A", iupac: 16, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p4", noble: "[Xe] 4f14 5d10 6s2 6p4" },
    { z: 85, s: "At", n: "Astatine", cn: "砈", type: "類金屬", state: "固體", mp: "302°C", bp: "337°C", p: 6, g: "7A", iupac: 17, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p5", noble: "[Xe] 4f14 5d10 6s2 6p5" },
    { z: 86, s: "Rn", n: "Radon", cn: "氡", type: "非金屬", state: "氣體", mp: "-71°C", bp: "-62°C", p: 6, g: "8A", iupac: 18, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6", noble: "[Xe] 4f14 5d10 6s2 6p6" },
    // Period 7
    { z: 87, s: "Fr", n: "Francium", cn: "鍅", type: "金屬", state: "固體", mp: "27°C", bp: "677°C", p: 7, g: "1A", iupac: 1, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 7s1", noble: "[Rn] 7s1" },
    { z: 88, s: "Ra", n: "Radium", cn: "鐳", type: "金屬", state: "固體", mp: "700°C", bp: "1737°C", p: 7, g: "2A", iupac: 2, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 7s2", noble: "[Rn] 7s2" },
    { z: 89, s: "Ac", n: "Actinium", cn: "錒", type: "金屬", state: "固體", mp: "1050°C", bp: "3198°C", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 6d1 7s2", noble: "[Rn] 6d1 7s2", ex: true },
    { z: 90, s: "Th", n: "Thorium", cn: "釷", type: "金屬", state: "固體", mp: "1750°C", bp: "4788°C", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 6d2 7s2", noble: "[Rn] 6d2 7s2", ex: true },
    { z: 91, s: "Pa", n: "Protactinium", cn: "鏷", type: "金屬", state: "固體", mp: "1568°C", bp: "4027°C", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f2 6d1 7s2", noble: "[Rn] 5f2 6d1 7s2", ex: true },
    { z: 92, s: "U", n: "Uranium", cn: "鈾", type: "金屬", state: "固體", mp: "1132°C", bp: "4131°C", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f3 6d1 7s2", noble: "[Rn] 5f3 6d1 7s2", ex: true },
    { z: 93, s: "Np", n: "Neptunium", cn: "錼", type: "金屬", state: "固體", mp: "644°C", bp: "3902°C", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f4 6d1 7s2", noble: "[Rn] 5f4 6d1 7s2", ex: true },
    { z: 94, s: "Pu", n: "Plutonium", cn: "鈽", type: "金屬", state: "固體", mp: "640°C", bp: "3228°C", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f6 7s2", noble: "[Rn] 5f6 7s2" },
    { z: 95, s: "Am", n: "Americium", cn: "鋂", type: "金屬", state: "固體", mp: "1176°C", bp: "2607°C", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f7 7s2", noble: "[Rn] 5f7 7s2" },
    { z: 96, s: "Cm", n: "Curium", cn: "鋦", type: "金屬", state: "固體", mp: "1340°C", bp: "3110°C", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f7 6d1 7s2", noble: "[Rn] 5f7 6d1 7s2", ex: true },    
    { z: 97, s: "Bk", n: "Berkelium", cn: "鉳", type: "金屬", state: "固體", mp: "986°C", bp: "-", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f9 7s2", noble: "[Rn] 5f9 7s2" },
    { z: 98, s: "Cf", n: "Californium", cn: "鉲", type: "金屬", state: "固體", mp: "900°C", bp: "-", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f10 7s2", noble: "[Rn] 5f10 7s2" },
    { z: 99, s: "Es", n: "Einsteinium", cn: "鑀", type: "金屬", state: "固體", mp: "860°C", bp: "-", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f11 7s2", noble: "[Rn] 5f11 7s2" },
    { z: 100, s: "Fm", n: "Fermium", cn: "鐨", type: "金屬", state: "固體", mp: "1527°C", bp: "-", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f12 7s2", noble: "[Rn] 5f12 7s2" },
    { z: 101, s: "Md", n: "Mendelevium", cn: "鍆", type: "金屬", state: "固體", mp: "827°C", bp: "-", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f13 7s2", noble: "[Rn] 5f13 7s2" },
    { z: 102, s: "No", n: "Nobelium", cn: "鍩", type: "金屬", state: "固體", mp: "827°C", bp: "-", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 7s2", noble: "[Rn] 5f14 7s2" },
    { z: 103, s: "Lr", n: "Lawrencium", cn: "鐒", type: "金屬", state: "固體", mp: "1627°C", bp: "-", p: 7, g: "錒系", iupac: "-", c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 7s2 7p1", noble: "[Rn] 5f14 7s2 7p1" },
    { z: 104, s: "Rf", n: "Rutherfordium", cn: "鑪", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "4B", iupac: 4, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d2 7s2", noble: "[Rn] 5f14 6d2 7s2" },
    { z: 105, s: "Db", n: "Dubnium", cn: "𨧀", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "5B", iupac: 5, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d3 7s2", noble: "[Rn] 5f14 6d3 7s2" },
    { z: 106, s: "Sg", n: "Seaborgium", cn: "𨭎", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "6B", iupac: 6, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d4 7s2", noble: "[Rn] 5f14 6d4 7s2" },
    { z: 107, s: "Bh", n: "Bohrium", cn: "𨨏", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "7B", iupac: 7, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d5 7s2", noble: "[Rn] 5f14 6d5 7s2" },
    { z: 108, s: "Hs", n: "Hassium", cn: "𨭆", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "8B", iupac: 8, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d6 7s2", noble: "[Rn] 5f14 6d6 7s2" },
    { z: 109, s: "Mt", n: "Meitnerium", cn: "䥑", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "8B", iupac: 9, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d7 7s2", noble: "[Rn] 5f14 6d7 7s2" },
    { z: 110, s: "Ds", n: "Darmstadtium", cn: "鐽", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "8B", iupac: 10, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d8 7s2", noble: "[Rn] 5f14 6d8 7s2" },
    { z: 111, s: "Rg", n: "Roentgenium", cn: "錀", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "1B", iupac: 11, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d9 7s2", noble: "[Rn] 5f14 6d9 7s2" },
    { z: 112, s: "Cn", n: "Copernicium", cn: "鎶", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "2B", iupac: 12, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d10 7s2", noble: "[Rn] 5f14 6d10 7s2" },
    { z: 113, s: "Nh", n: "Nihonium", cn: "鉨", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "3A", iupac: 13, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d10 7s2 7p1", noble: "[Rn] 5f14 6d10 7s2 7p1" },
    { z: 114, s: "Fl", n: "Flerovium", cn: "鈇", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "4A", iupac: 14, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d10 7s2 7p2", noble: "[Rn] 5f14 6d10 7s2 7p2" },
    { z: 115, s: "Mc", n: "Moscovium", cn: "鏌", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "5A", iupac: 15, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d10 7s2 7p3", noble: "[Rn] 5f14 6d10 7s2 7p3" },
    { z: 116, s: "Lv", n: "Livermorium", cn: "鉝", type: "金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "6A", iupac: 16, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d10 7s2 7p4", noble: "[Rn] 5f14 6d10 7s2 7p4" },
    { z: 117, s: "Ts", n: "Tennessine", cn: "鿬", type: "類金屬", state: "固體", mp: "-", bp: "-", p: 7, g: "7A", iupac: 17, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d10 7s2 7p5", noble: "[Rn] 5f14 6d10 7s2 7p5" },
    { z: 118, s: "Og", n: "Oganesson", cn: "鿫", type: "非金屬", state: "氣體", mp: "-", bp: "-", p: 7, g: "8A", iupac: 18, c: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6 5f14 6d10 7s2 7p6", noble: "[Rn] 5f14 6d10 7s2 7p6" }
];

// ========== [每日運勢資料庫：最終修訂版] ==========

// ====== Cleanup: remove "模式: 複合" / composite-mode artifacts if present ======
(function cleanupCompositeMode() {
    const candidateNames = [
        "模式: 複合","模式_複合","複合模式",
        "compositeMode","modeComposite","composite"
    ];

    function tryDeleteGlobal(name){
        try{
            if (typeof window !== 'undefined' && window.hasOwnProperty(name)) {
                try { delete window[name]; } catch(e) { window[name] = undefined; }
            }
        }catch(e){}
    }

    function removeDomReferences(){
        const attrSelectors = ['[data-mode]','[data-mode-name]','[data-mode-id]','[data-mode-type]'];
        document.querySelectorAll(attrSelectors.join(',')).forEach(el=>{
            const v = (el.getAttribute('data-mode') || el.getAttribute('data-mode-name') || el.getAttribute('data-mode-id') || el.getAttribute('data-mode-type') || '');
            if (v.indexOf('複合') !== -1 || /composite/i.test(v)) el.remove();
        });
        // remove nodes whose text contains "模式: 複合"
        document.querySelectorAll('body *').forEach(el=>{
            if (el.childElementCount === 0 && /模式[:：]\s*複合/.test((el.textContent||''))) el.remove();
        });
    }

    function removeByNamePatterns(){
        // attempt to clear any globally reachable variables/functions containing keywords
        Object.getOwnPropertyNames(window).forEach(k=>{
            if (/複合|composite/i.test(k)) {
                try { delete window[k]; } catch(e) { window[k] = undefined; }
            }
        });
        // explicit list
        candidateNames.forEach(tryDeleteGlobal);
    }

    function run(){
        try { removeByNamePatterns(); } catch(e){}
        try { if (typeof document !== 'undefined') removeDomReferences(); } catch(e){}
        // As a last resort, try to null any likely variables we can find on window
        try {
            candidateNames.forEach(n=>{
                try {
                    if (window[n] !== undefined) window[n] = undefined;
                } catch(e){}
            });
        } catch(e){}
    }

    if (typeof document !== 'undefined' && document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run);
    } else {
        // run ASAP
        setTimeout(run, 0);
    }
})();
</script>
<script>
// ==========================================
// data_molecules.js - 分子結構定義與輔助函式
// ==========================================

let MOLECULE_DB = {};
let MOLECULE_INDEX = {};

// 幾何輔助函式
const di = (e, dist=60) => [{elem:e,x:-dist,y:0,z:0},{elem:e,x:dist,y:0,z:0}];
const getLinear = (c, o, r=70) => [ {elem:c,x:0,y:0,z:0, lpCount:0}, {elem:o,x:-r,y:0,z:0}, {elem:o,x:r,y:0,z:0} ];
const getTrigPlanar = (c, o, r=70) => [ {elem:c,x:0,y:0,z:0, lpCount:0}, {elem:o,x:0,y:r,z:0}, {elem:o,x:r*0.866,y:-r*0.5,z:0}, {elem:o,x:-r*0.866,y:-r*0.5,z:0} ];
const getTetra = (c, o, d=60) => { const r = d / 1.73205; return [ {elem:c,x:0,y:0,z:0, lpCount:0}, {elem:o,x:r,y:-r,z:r}, {elem:o,x:-r,y:r,z:r}, {elem:o,x:-r,y:-r,z:-r}, {elem:o,x:r,y:r,z:-r} ]; };
const getOcta = (c, o, r=65) => [{elem:c,x:0,y:0,z:0, lpCount:0}, {elem:o,x:r,y:0,z:0}, {elem:o,x:-r,y:0,z:0}, {elem:o,x:0,y:r,z:0}, {elem:o,x:0,y:-r,z:0}, {elem:o,x:0,y:0,z:r}, {elem:o,x:0,y:0,z:-r}];
const benzBase=[{x:0,y:70,z:0},{x:60,y:35,z:0},{x:60,y:-35,z:0},{x:0,y:-70,z:0},{x:-60,y:-35,z:0},{x:-60,y:35,z:0}];
function getBenzH(i,s=35){const v=benzBase[i],l=Math.sqrt(v.x**2+v.y**2);return{x:v.x+v.x/l*s,y:v.y+v.y/l*s,z:0};}

// Common English names fallback for molecules/elements when not provided explicitly
const COMMON_EN_NAMES = {
    'H2O': 'Water', 'CH4': 'Methane', 'NH3': 'Ammonia', 'PH3': 'Phosphine', 'H2S': 'Hydrogen sulphide',
    'H2': 'Hydrogen', 'N2': 'Nitrogen', 'O2': 'Oxygen', 'F2': 'Fluorine', 'Cl2': 'Chlorine', 'Br2': 'Bromine', 'I2': 'Iodine',
    'CO': 'Carbon monoxide', 'NO': 'Nitric oxide', 'CN-': 'Cyanide', 'O22-': 'Peroxide',
    'H2O2': 'Hydrogen peroxide',
    'HF': 'Hydrogen fluoride', 'HCl': 'Hydrogen chloride', 'HBr': 'Hydrogen bromide', 'HI': 'Hydrogen iodide',
    'NaCl': 'Sodium chloride', 'CsCl': 'Cesium chloride', 'ZnS': 'Zinc sulphide', 'CuCl': 'Copper(I) chloride',
    'TiO2': 'Titanium dioxide', 'Cu2O': 'Copper(I) oxide', 'CO2': 'Carbon dioxide', 'CH3OH': 'Methanol',
    // Common ions and polyatomic ions (British spelling: sulph-)
    'NH4+': 'Ammonium ion', 'SO42-': 'Sulphate ion', 'HSO4-': 'hydrogensulphate', 'NO3-': 'Nitrate',
    'HSO3-': 'hydrogensulphite', 'HSO3': 'hydrogensulphite',
    'H3O+': 'Hydronium ion',
    'BRO3-': 'Bromate ion', 'BrO3-': 'Bromate ion', 'IO3-': 'Iodate ion',
    'S2O32-': 'Thiosulphate ion',
    'HS2O3-': 'hydrogenthiosulphate',
    'H2PO2-': 'Hypophosphite ion', 'H2PO3-': 'hydrogenphosphite', 'H2PO4-': 'dihydrogenphosphate',
    'HPO32-': 'Phosphite ion', 'HPO42-': 'hydrogenphosphate', 'HS-': 'hydrosulphide',
    'CO32-': 'Carbonate ion', 'OH-': 'Hydroxide', 'PO43-': 'Phosphate ion',
    // Sulphite (provide several common token forms)
    'SO3^2-': 'Sulphite ion', 'SO32-': 'Sulphite ion', 'SO3 2-': 'Sulphite ion', 'SO3-': 'Sulphite ion',
    'S2-': 'Sulphide ion', 'SO2': 'Sulphur dioxide', 'HCO3-': 'hydrogencarbonate'
};

// 主註冊函式 (已修改：直接使用傳入的 hybrid 字串，不添加贅字)
const addMol = (keysStr, center, hybrid, shape, angle, mp, bp, atoms, bonds, variants = null, desc = null, pg = null) => {
    if (typeof MOLECULE_INDEX === 'undefined') MOLECULE_INDEX = {};
    if (typeof MOLECULE_DB === 'undefined') MOLECULE_DB = {};
    const keys = keysStr.split('|').map(s=>s.trim());
    const mainKey = keys[0];
    const mainKeyUpper = mainKey.toUpperCase();
    keys.forEach(k => { MOLECULE_INDEX[k.trim().toUpperCase()] = { key: mainKey, variant: null }; });

    // derive Chinese / English names from the remaining key parts
    let nameCN = '';
    let nameEN = '';
    for (let i = 1; i < keys.length; i++) {
        const p = keys[i];
        if (/[A-Za-z]/.test(p) && !nameEN) nameEN = p;
        else if (!/[A-Za-z]/.test(p) && !nameCN) nameCN = p;
    }
    // prefer explicitly-provided English; otherwise try common name map
    if (!nameCN && nameEN) nameCN = nameEN;
    if (!nameEN) {
        nameEN = COMMON_EN_NAMES[mainKey.toUpperCase()] || '';
        if (!nameEN && nameCN && /[A-Za-z]/.test(nameCN)) nameEN = nameCN;
    }

    const baseData = { 
        center,
        hybrid: hybrid,
        // keep legacy `shape` for backward compatibility, but also store separated CN/EN
        shape: Array.isArray(shape) ? `${shape[0]} (${shape[1]})` : shape,
        shapeCN: Array.isArray(shape) ? shape[0] : shape,
        shapeEN: Array.isArray(shape) ? shape[1] : shape,
        angle, mp, bp, atomsRaw: atoms, bondsRaw: bonds, desc, fullKey: keysStr,
        nameCN: nameCN,
        nameEN: nameEN,
        isMetal: false,
        pg: pg // 確保這裡有接收到傳入的 pg
    };
    
    if (variants) {
        baseData.variants = {};
        for (let vKeyRaw in variants) {
            const uniqueID = vKeyRaw; 
            const vObj = variants[vKeyRaw];
            const vKeyParts = vKeyRaw.split('|');
            vKeyParts.forEach(vk => { 
                const cleanKey = vk.trim().toUpperCase();
                if (cleanKey !== mainKeyUpper) { MOLECULE_INDEX[cleanKey] = { key: mainKey, variant: uniqueID }; }
            });
            // allow variant to override names/shapes if provided
            const variantShape = vObj.shape !== undefined ? vObj.shape : shape;
            let vShapeCN = Array.isArray(variantShape) ? variantShape[0] : variantShape;
            let vShapeEN = Array.isArray(variantShape) ? variantShape[1] : variantShape;
                // derive names from variant key string if present
                const vKeys = vKeyRaw.split('|').map(s=>s.trim());
                let vNameCN = '';
                let vNameEN = '';
                const isEnglishWord = s => (/[A-Za-z]/.test(String(s))) && !(/^[A-Z0-9+\-]+$/.test(String(s).replace(/\s/g,'')));
                // prefer human-readable English words (not formula-like tokens)
                for (let i=1;i<vKeys.length;i++){
                    const p=vKeys[i];
                    if (!vNameEN && isEnglishWord(p)) vNameEN = p;
                    else if (!vNameCN && !/[A-Za-z]/.test(p)) vNameCN = p;
                }
                if(!vNameCN) vNameCN = baseData.nameCN;
                if(!vNameEN) {
                    const rawVariant = vKeys[0] ? String(vKeys[0]) : '';
                    const variantFormula = rawVariant.replace(/\s/g,'').replace(/\^/g,'').toUpperCase();
                    const tryVKeys = [variantFormula, rawVariant.replace(/\s/g,'').toUpperCase(), rawVariant.replace(/\^/g,'').toUpperCase()];
                    for (let tk of tryVKeys) {
                        if (!tk) continue;
                        if (COMMON_EN_NAMES[tk]) { vNameEN = COMMON_EN_NAMES[tk]; break; }
                    }
                    if(!vNameEN) vNameEN = COMMON_EN_NAMES[uniqueID] || COMMON_EN_NAMES[mainKey.toUpperCase()] || baseData.nameEN || '';
                }

            baseData.variants[uniqueID] = { 
                ...baseData, 
                atomsRaw: vObj.atoms, 
                bondsRaw: vObj.bonds,
                // 核心修復：確保 pg 標籤能從資料中被讀取並傳遞
                pg: vObj.pg || baseData.pg || null,
                mp: vObj.mp !== undefined ? vObj.mp : baseData.mp,
                bp: vObj.bp !== undefined ? vObj.bp : baseData.bp,
                desc: vObj.desc !== undefined ? vObj.desc : baseData.desc,
                fullKey: vKeyRaw,
                shapeCN: vShapeCN,
                shapeEN: vShapeEN,
                nameCN: vNameCN,
                nameEN: vNameEN
            };
        }
    }
    MOLECULE_DB[mainKey] = baseData;
};

function markReps(atoms, bonds, cnA, elemA, cnB, elemB) {
    const counts = new Array(atoms.length).fill(0);
    bonds.forEach(b => { counts[b[0]]++; counts[b[1]]++; });
    atoms.forEach((a, i) => {
        if (a.elem === elemA && counts[i] === cnA) a.isRepresentative = true;
        else if (a.elem === elemB && counts[i] === cnB) a.isRepresentative = true;
        else a.isRepresentative = false;
    });
}

//NaCl晶體
(function(){
    const sa=[{elem:"Na",x:-40,y:0,z:0,r:20,lpCount:0},{elem:"Cl",x:40,y:0,z:0,r:35,lpCount:0}], sb=[[0,1,"ionic_thin"]];
    const ca=[], cb=[], s=120;
    for(let x=-1;x<=1;x++) for(let y=-1;y<=1;y++) for(let z=-1;z<=1;z++){
        const isNa=(Math.abs(x+y+z)%2!==0);
        ca.push({elem:isNa?"Na":"Cl",x:x*s,y:y*s,z:z*s,r:isNa?18:34,lpCount:0,gx:x,gy:y,gz:z,isRepresentative:(!x&&!y&&!z)});
    }
    for(let i=0;i<ca.length;i++) for(let j=i+1;j<ca.length;j++){
        const dist=Math.abs(ca[i].x-ca[j].x)+Math.abs(ca[i].y-ca[j].y)+Math.abs(ca[i].z-ca[j].z);
        if(Math.abs(dist-s)<1){
            const onFace=(Math.abs(ca[i].gx)===1&&ca[i].gx===ca[j].gx)||(Math.abs(ca[i].gy)===1&&ca[i].gy===ca[j].gy)||(Math.abs(ca[i].gz)===1&&ca[i].gz===ca[j].gz);
            cb.push([i,j,onFace?"ionic_thick":"ionic_thin"]);
        }
    }
    addMol("NaCl|氯化鈉|食鹽","Na","-","-","-","801","1465",sa,sb,{
        "Simple|基本單元 (離子對)":{atoms:sa,bonds:sb,hybrid:"-",shape:"-",desc:'<div class="info-section"><div class="info-title">🧂 物質簡介</div><div class="info-body"><strong>氯化鈉 (NaCl)</strong><br>俗稱食鹽。純淨時為無色透明晶體。它是生活中最重要的調味品與防腐劑。</div></div>'},
        "Crystal|晶體堆積 (FCC)":{atoms:ca,bonds:cb,isIonic:true,edgeRelation:"a = 2(r<sub>+</sub> + r<sub>-</sub>)",desc:'<div class="info-section"><div class="info-title">🧊 晶體特性</div><div class="info-body"><strong>面心立方堆積 (FCC)</strong><br>氯化鈉具有高熔點 (801°C)。每個鈉離子周圍都被6個氯離子包圍，配位數為 6。<br><span style="color:#facc15">★ 點擊中心原子可查看配位數。</span></div></div>'}
    },'<div class="info-section"><div class="info-title">🧂 氯化鈉</div><div class="info-body">請切換選項檢視。</div></div>');
    if(MOLECULE_DB["NaCl"]?.variants){MOLECULE_DB["NaCl"].variants["Crystal|晶體堆積 (FCC)"].isIonic=true;MOLECULE_DB["NaCl"].variants["Simple|基本單元 (離子對)"].isIonic=true;}
})();

//CsCl晶體
(function(){
    const sa=[{elem:"Cs",x:-45,y:0,z:0,r:26,lpCount:0},{elem:"Cl",x:45,y:0,z:0,r:34,lpCount:0}], sb=[[0,1,"ionic_thin"]];
    const ca=[], cb=[], s=200;
    ca.push({elem:"Cs",x:0,y:0,z:0,r:26,isRepresentative:true});
    [-1,1].forEach(x=>[-1,1].forEach(y=>[-1,1].forEach(z=>{ca.push({elem:"Cl",x:x*s*0.5,y:y*s*0.5,z:z*s*0.5,r:34,isCorner:true}); cb.push([0,ca.length-1,"ionic_thin"]);})));
    for(let i=1;i<ca.length;i++) for(let j=i+1;j<ca.length;j++) if(Math.abs((Math.abs(ca[i].x-ca[j].x)+Math.abs(ca[i].y-ca[j].y)+Math.abs(ca[i].z-ca[j].z))-s)<5) cb.push([i,j,"ionic_thick"]);
    addMol("CsCl|氯化銫|Cesium Chloride","Cs","-","-","-","645","1290",sa,sb,{
        "Simple|基本單元 (離子對)":{atoms:sa,bonds:sb,hybrid:"-",shape:"-",desc:'<div class="info-section"><div class="info-title">⚛️ 物質簡介</div><div class="info-body"><strong>氯化銫 (CsCl)</strong><br>由銫離子 (Cs⁺) 與氯離子 (Cl⁻) 組成。銫離子半徑較大，形成配位數 8 的結構。</div></div>'},
        "Crystal|晶體堆積 (SC)":{atoms:ca,bonds:cb,isIonic:true,edgeRelation:"√3 a = 2(r⁺+r⁻)",desc:'<div class="info-section"><div class="info-title">🧊 晶體結構</div><div class="info-body"><strong>簡單立方堆積 (SC)</strong><br>氯離子構成簡單立方，銫離子填入體心。配位數為 8。<br><span style="color:#facc15">★ 點擊中央 Cs 離子可查看配位數。</span></div></div>'}
    },'<div class="info-section"><div class="info-title">🧊 氯化銫</div><div class="info-body">請切換選項檢視。</div></div>');
    if(MOLECULE_DB["CsCl"]?.variants){MOLECULE_DB["CsCl"].variants["Crystal|晶體堆積 (SC)"].isIonic=true;MOLECULE_DB["CsCl"].variants["Simple|基本單元 (離子對)"].isIonic=true;}
})();

//ZnS晶體
(function(){
    const sa=[{elem:"Zn",x:-45,y:0,z:0,r:18,lpCount:0},{elem:"S",x:45,y:0,z:0,r:30,lpCount:0}], sb=[[0,1,"ionic_thin"]];
    const ca=[], cb=[], scale=220, bondDist=scale*0.433; 
    const baseS=[[0,0,0],[1,0,0],[0,1,0],[0,0,1],[1,1,0],[1,0,1],[0,1,1],[1,1,1],[0.5,0.5,0],[0.5,0,0.5],[0,0.5,0.5],[0.5,1,0.5],[1,0.5,0.5],[0.5,0.5,1]];
    const baseZn=[[0.25,0.25,0.25],[0.75,0.75,0.25],[0.75,0.25,0.75],[0.25,0.75,0.75]];
    let idx=0;
    baseS.forEach((p,i)=>ca.push({elem:"S",x:(p[0]-0.5)*scale,y:(p[1]-0.5)*scale,z:(p[2]-0.5)*scale,r:28,isCorner:(i<8),idx:idx++}));
    baseZn.forEach(p=>ca.push({elem:"Zn",x:(p[0]-0.5)*scale,y:(p[1]-0.5)*scale,z:(p[2]-0.5)*scale,r:12,isRepresentative:true}));
    for(let i=14;i<ca.length;i++) for(let j=0;j<14;j++) if(Math.abs(Math.sqrt((ca[i].x-ca[j].x)**2+(ca[i].y-ca[j].y)**2+(ca[i].z-ca[j].z)**2)-bondDist)<20) cb.push([i,j,"ionic_thin"]);
    for(let i=0;i<14;i++) for(let j=i+1;j<14;j++) if(ca[i].isCorner&&ca[j].isCorner&&Math.abs(Math.sqrt((ca[i].x-ca[j].x)**2+(ca[i].y-ca[j].y)**2+(ca[i].z-ca[j].z)**2)-scale)<5) cb.push([i,j,"ionic_thick"]);
    addMol("ZnS|閃鋅礦|硫化鋅|Zinc Blende","Zn","-","-","-","1185","昇華",sa,sb,{
        "Simple|基本單元 (離子對)":{atoms:sa,bonds:sb,hybrid:"-",shape:"-",desc:'<div class="info-section"><div class="info-title">💡 物質性質</div><div class="info-body"><strong>硫化鋅 (ZnS)</strong><br>白色或微黃色粉末。具有螢光特性，摻雜微量金屬後可用於製作夜光塗料、螢光屏以及陰極射線管。</div></div>'},
        "Crystal|晶體堆積 (FCC)":{atoms:ca,bonds:cb,isIonic:true,edgeRelation:"4(r<sub>+</sub> + r<sub>-</sub>) = √3 a",desc:'<div class="info-section"><div class="info-title">💎 閃鋅礦 (ZnS)</div><div class="info-body">硫離子(S²⁻)構成面心立方堆積，鋅離子(Zn²⁺)位於四面體空隙。<br><span style="color:#facc15">★ 點擊任一內部的 Zn 離子可查看配位數。</span></div></div>'}
    },'<div class="info-section"><div class="info-title">💡 硫化鋅</div><div class="info-body">請切換選項檢視。</div></div>');
    if(MOLECULE_DB["ZnS"]?.variants){MOLECULE_DB["ZnS"].variants["Crystal|晶體堆積 (FCC)"].isIonic=true;MOLECULE_DB["ZnS"].variants["Simple|基本單元 (離子對)"].isIonic=true;}
})();

//CuCl晶體
(function(){
    const sa=[{elem:"Cu",x:-45,y:0,z:0,r:13,lpCount:0},{elem:"Cl",x:45,y:0,z:0,r:27,lpCount:0}], sb=[[0,1,"ionic_thin"]];
    const ca=[], cb=[], scale=220, bondDist=scale*0.433;
    const baseCl=[[0,0,0],[1,0,0],[0,1,0],[0,0,1],[1,1,0],[1,0,1],[0,1,1],[1,1,1],[0.5,0.5,0],[0.5,0,0.5],[0,0.5,0.5],[0.5,1,0.5],[1,0.5,0.5],[0.5,0.5,1]];
    const baseCu=[[0.25,0.25,0.25],[0.75,0.75,0.25],[0.75,0.25,0.75],[0.25,0.75,0.75]];
    let clIdx=0;
    baseCl.forEach((p,i)=>ca.push({elem:"Cl",x:(p[0]-0.5)*scale,y:(p[1]-0.5)*scale,z:(p[2]-0.5)*scale,r:27,isCorner:(i<8),idx:clIdx++}));
    baseCu.forEach(p=>ca.push({elem:"Cu",x:(p[0]-0.5)*scale,y:(p[1]-0.5)*scale,z:(p[2]-0.5)*scale,r:13,isRepresentative:true}));
    for(let i=14;i<ca.length;i++) for(let j=0;j<14;j++) if(Math.abs(Math.sqrt((ca[i].x-ca[j].x)**2+(ca[i].y-ca[j].y)**2+(ca[i].z-ca[j].z)**2)-bondDist)<20) cb.push([i,j,"ionic_thin"]);
    for(let i=0;i<14;i++) for(let j=i+1;j<14;j++) if(ca[i].isCorner&&ca[j].isCorner&&Math.abs(Math.sqrt((ca[i].x-ca[j].x)**2+(ca[i].y-ca[j].y)**2+(ca[i].z-ca[j].z)**2)-scale)<5) cb.push([i,j,"ionic_thick"]);
    addMol("CuCl|氯化亞銅|Nantokite","Cu","-","-","-","430","1490",sa,sb,{
        "Simple|基本單元 (離子對)":{atoms:sa,bonds:sb,hybrid:"-",shape:"-",desc:'<div class="info-section"><div class="info-title">🔸 物質簡介</div><div class="info-body"><strong>氯化亞銅 (CuCl)</strong><br>白色固體，難溶於水。結構與閃鋅礦(ZnS)相同。</div></div>'},
        "Crystal|晶體堆積 (FCC)":{atoms:ca,bonds:cb,isIonic:true,edgeRelation:"4(r<sub>+</sub> + r<sub>-</sub>) = √3 a",desc:'<div class="info-section"><div class="info-title">🧊 晶體結構</div><div class="info-body"><strong>面心立方堆積 (FCC)</strong><br>結構同閃鋅礦。氯離子堆積，亞銅離子填入四面體空隙。<br><span style="color:#facc15">★ 點擊任一內部 Cu⁺ 可查看配位數。</span></div></div>'}
    },'<div class="info-section"><div class="info-title">🔸 氯化亞銅</div><div class="info-body">請切換選項檢視。</div></div>');
    if(MOLECULE_DB["CuCl"]?.variants){MOLECULE_DB["CuCl"].variants["Crystal|晶體堆積 (FCC)"].isIonic=true;MOLECULE_DB["CuCl"].variants["Simple|基本單元 (離子對)"].isIonic=true;}
})();

//TiO2晶體
(function(){
    const sa=[{elem:"Ti",x:0,y:0,z:0,r:11,lpCount:0},{elem:"O",x:50,y:0,z:0,r:21,lpCount:0},{elem:"O",x:-50,y:0,z:0,r:21,lpCount:0}], sb=[[0,1,"ionic_thin"],[0,2,"ionic_thin"]];
    const ca=[], cb=[], scale=180, c_ratio=0.65, u=0.3;
    const baseTi=[[0,0,0],[1,0,0],[0,1,0],[0,0,1],[1,1,0],[1,0,1],[0,1,1],[1,1,1],[0.5,0.5,0.5]];
    const baseO=[[u,u,0],[1-u,1-u,0],[u,u,1],[1-u,1-u,1],[0.5+u,0.5-u,0.5],[0.5-u,0.5+u,0.5]];
    let tiIdx=0;
    baseTi.forEach((p,i)=>ca.push({elem:"Ti",x:(p[0]-0.5)*scale,y:(p[1]-0.5)*scale,z:(p[2]-0.5)*scale*c_ratio,r:11,isCorner:(i<8),idx:tiIdx++,isRepresentative:(i===8)}));
    baseO.forEach(p=>ca.push({elem:"O",x:(p[0]-0.5)*scale,y:(p[1]-0.5)*scale,z:(p[2]-0.5)*scale*c_ratio,r:21,isCorner:false}));
    for(let i=0;i<ca.length;i++) for(let j=i+1;j<ca.length;j++){
        if(ca[i].elem===ca[j].elem) continue;
        if(Math.sqrt((ca[i].x-ca[j].x)**2+(ca[i].y-ca[j].y)**2+(ca[i].z-ca[j].z)**2)<scale*0.75) cb.push([i,j,"ionic_thin"]);
    }
    for(let i=0;i<8;i++) for(let j=i+1;j<8;j++){
        const dx=Math.abs(ca[i].x-ca[j].x), dy=Math.abs(ca[i].y-ca[j].y), dz=Math.abs(ca[i].z-ca[j].z);
        if((Math.abs(dx-scale)<5&&dy<5&&dz<5)||(Math.abs(dy-scale)<5&&dx<5&&dz<5)||(Math.abs(dz-scale*c_ratio)<5&&dx<5&&dy<5)) cb.push([i,j,"ionic_thick"]);
    }
    addMol("TiO2|金紅石|二氧化鈦|Rutile","Ti","-","-","-","1843","2972",sa,sb,{
        "Simple|基本單元":{atoms:sa,bonds:sb,hybrid:"-",shape:"-",desc:'<div class="info-section"><div class="info-title">⬜ 物質簡介</div><div class="info-body"><strong>二氧化鈦 (TiO₂)</strong><br>白色粉末，廣泛用於白色顏料、防曬乳及光觸媒。</div></div>'},
        "Crystal|晶體堆積 (Tetragonal)":{atoms:ca,bonds:cb,isIonic:true,edgeRelation:"複雜幾何",desc:'<div class="info-section"><div class="info-title">🧊 晶體結構</div><div class="info-body"><strong>四方晶系 (金紅石型)</strong><br>鈦離子位於體心與頂點，氧離子位於面上。Ti⁴⁺ 配位數為 6 (八面體)，O²⁻ 配位數為 3 (平面三角)。<br><span style="color:#facc15">★ 點擊體心 Ti⁴⁺ 可查看配位數。</span></div></div>'}
    },'<div class="info-section"><div class="info-title">⬜ 金紅石</div><div class="info-body">請切換選項檢視。</div></div>');
    if(MOLECULE_DB["TiO2"]?.variants){MOLECULE_DB["TiO2"].variants["Crystal|晶體堆積 (Tetragonal)"].isIonic=true;MOLECULE_DB["TiO2"].variants["Simple|基本單元"].isIonic=true;}
})();

//Cu2O晶體
(function(){
    const scale=180, baseO=[[0,0,0],[1,0,0],[0,1,0],[0,0,1],[1,1,0],[1,0,1],[0,1,1],[1,1,1],[0.5,0.5,0.5]], baseCu=[[0.25,0.25,0.25],[0.75,0.75,0.25],[0.75,0.25,0.75],[0.25,0.75,0.75]];
    const ca=[...baseO.map((p,i)=>({elem:"O",x:(p[0]-0.5)*scale,y:(p[1]-0.5)*scale,z:(p[2]-0.5)*scale,r:21,isCorner:i<8,isRepresentative:i===8})),...baseCu.map(p=>({elem:"Cu",x:(p[0]-0.5)*scale,y:(p[1]-0.5)*scale,z:(p[2]-0.5)*scale,r:13,isRepresentative:true}))];
    const cb=[];
    for(let i=0;i<ca.length;i++) for(let j=i+1;j<ca.length;j++){
        const d=Math.hypot(ca[i].x-ca[j].x,ca[i].y-ca[j].y,ca[i].z-ca[j].z);
        if(ca[i].elem!==ca[j].elem&&Math.abs(d-scale*0.433)<20) cb.push([i,j,"ionic_thin"]);
        if(ca[i].isCorner&&ca[j].isCorner&&Math.abs(d-scale)<5) cb.push([i,j,"ionic_thick"]);
    }
    const sa=[{elem:"O",x:0,y:0,z:0,r:21},{elem:"Cu",x:50,y:0,z:0,r:13},{elem:"Cu",x:-50,y:0,z:0,r:13}], sb=[[0,1,"ionic_thin"],[0,2,"ionic_thin"]];
    addMol("Cu2O|赤銅礦|氧化亞銅|Cuprite","Cu","-","-","-","1235","1800",sa,sb,{
        "Simple|基本單元":{atoms:sa,bonds:sb,hybrid:"-",shape:"-",desc:'<div class="info-section"><div class="info-title">🔴 物質簡介</div><div class="info-body"><strong>氧化亞銅 (Cu₂O)</strong><br>紅色固體。Cu⁺ 為直線型配位 (CN=2)，O²⁻ 為四面體型配位 (CN=4)。</div></div>'},
        "Crystal|晶體堆積 (Cubic)":{atoms:ca,bonds:cb,isIonic:true,edgeRelation:"複雜幾何",desc:'<div class="info-section"><div class="info-title">🧊 晶體結構</div><div class="info-body"><strong>赤銅礦結構</strong><br>氧離子(紅)構成體心立方，銅離子(橘)位於氧離子連線中點。<br>• 點擊<strong>紅色氧離子</strong> (體心) 可見配位數為 4。<br>• 點擊任一<strong>橘色銅離子</strong> 可見配位數為 2。</div></div>'}
    },'<div class="info-section"><div class="info-title">🔴 赤銅礦</div><div class="info-body">請切換選項檢視。</div></div>');
    if(MOLECULE_DB["Cu2O"]?.variants){MOLECULE_DB["Cu2O"].variants["Crystal|晶體堆積 (Cubic)"].isIonic=true;MOLECULE_DB["Cu2O"].variants["Simple|基本單元"].isIonic=true;}
})();











// ==========================================
// 金屬晶體生成模組 (CN=12 延伸增強版)
// ==========================================

function ensureElement(elem, defaultColor, defaultR) {
    if (typeof ELEMENT_PROPS !== 'undefined' && !ELEMENT_PROPS[elem]) {
        ELEMENT_PROPS[elem] = { ve: 1, c3d: defaultColor, r3d: defaultR, lp: 0, mass: 0, en: 0 };
    }
}

// 1. 簡單立方 (SC) 
function addMetal_SC(elem, name, mp, bp, scale=160) {
    ensureElement(elem, "#ab5c00", 28);
    const atoms = []; const bonds = [];
    for (let x = 0; x <= 1; x++) {
        for (let y = 0; y <= 1; y++) {
            for (let z = 0; z <= 1; z++) {
                atoms.push({ elem: elem, x: (x-0.5)*scale, y: (y-0.5)*scale, z: (z-0.5)*scale, r: 28, isRepresentative: true });
            }
        }
    }
    for (let i = 0; i < atoms.length; i++) {
        for (let j = i + 1; j < atoms.length; j++) {
            const d = Math.sqrt((atoms[i].x-atoms[j].x)**2 + (atoms[i].y-atoms[j].y)**2 + (atoms[i].z-atoms[j].z)**2);
            if (Math.abs(d - scale) < 10) bonds.push([i, j, "ionic_thick"]);
        }
    }
    addMol(`${elem}|${name}`, "Metal", "簡單立方堆積 (SC)", "52.4%", "6", mp, bp, atoms, bonds, null,
        `<div class="info-section"><div class="info-title">📦 簡單立方 (SC)</div><div class="info-body">金屬範例：<strong>${elem}</strong>。<br>空間利用率 52.4%。原子僅位於立方體頂點，沿著邊長互相接觸。</div></div>`);
    if(MOLECULE_DB[elem]) { MOLECULE_DB[elem].isIonic = true; MOLECULE_DB[elem].isMetal = true; MOLECULE_DB[elem].edgeRelation = "a = 2r"; }
}

// 2. 體心立方 (BCC)
function addMetal_BCC(elem, name, mp, bp, scale=200) {
    ensureElement(elem, "#9ca3af", 24); 
    const atoms = []; const bonds = [];
    const h = scale / 2;
    atoms.push({ elem: elem, x: 0, y: 0, z: 0, r: 24, isRepresentative: true });
    const pts = [[-h,-h,-h],[h,-h,-h],[h,h,-h],[-h,h,-h],[-h,-h,h],[h,-h,h],[h,h,h],[-h,h,h]];
    pts.forEach(p => atoms.push({ elem: elem, x: p[0], y: p[1], z: p[2], r: 24 }));
    for(let i=1; i<=8; i++) bonds.push([0, i, "ionic_thin"]);
    const cubeEdges = [[1,2],[2,3],[3,4],[4,1],[5,6],[6,7],[7,8],[8,5],[1,5],[2,6],[3,7],[4,8]];
    cubeEdges.forEach(e => bonds.push([e[0], e[1], "ionic_thick"]));
    addMol(`${elem}|${name}`, "Metal", "體心立方堆積 (BCC)", "68%", "8", mp, bp, atoms, bonds, null,
        `<div class="info-section"><div class="info-title">🧊 體心立方 (BCC)</div><div class="info-body">金屬範例：<strong>${elem}</strong>。<br>空間利用率 68%。原子位於角落與體中心，沿著體對角線互相接觸。</div></div>`);
    if(MOLECULE_DB[elem]) { MOLECULE_DB[elem].isIonic = true; MOLECULE_DB[elem].isMetal = true; MOLECULE_DB[elem].edgeRelation = "√3 a = 4r"; }
}

// 3. 面心立方 (FCC) - 升級為 5-4-5-4 堆積 (展示 CN=12)
function addMetal_FCC(elem, name, mp, bp, scale=200) {
    ensureElement(elem, "#d1d5db", 22);
    const atoms = []; const bonds = [];
    const h = scale / 2;
    
    // 定義四層：L1(5) -> L2(4) -> L3(5) -> L4(4)
    // 我們將座標中心設在 L3 的中心原子，方便旋轉觀察
    const addLayer5 = (z, isMain) => {
        const s = atoms.length;
        // 中心
        atoms.push({ elem: elem, x: 0, y: 0, z: z, r: 22, isRepresentative: isMain });
        // 四個角
        const corners = [[-h,-h,z],[h,-h,z],[h,h,z],[-h,h,z]];
        corners.forEach(p => atoms.push({ elem: elem, x: p[0], y: p[1], z: p[2], r: 22 }));
        // 只有主要晶胞層 (L1到L3) 有框
        if (isMain || z < scale) {
            bonds.push([s+1, s+2, "ionic_thick"], [s+2, s+3, "ionic_thick"], [s+3, s+4, "ionic_thick"], [s+4, s+1, "ionic_thick"]);
        }
    };

    const addLayer4 = (z, isExtended) => {
        const s = atoms.length;
        // 四個面心
        const faces = [[0,-h,z],[h,0,z],[0,h,z],[-h,0,z]];
        faces.forEach(p => atoms.push({ elem: elem, x: p[0], y: p[1], z: p[2], r: 22 }));
        // 垂直柱子 (只連接 L1-L3 核心)
        if (!isExtended) {
            // 此處邏輯由後續接觸線處理
        }
    };

    addLayer5(-scale, false); // L1 (底部)
    addLayer4(-h, false);     // L2
    addLayer5(0, true);       // L3 (核心層，設為座標 0)
    addLayer4(h, true);       // L4 (延伸層)

    // 建立所有原子間的接觸線 (距離為 0.707a)
    const contactDist = scale * 0.707;
    for (let i = 0; i < atoms.length; i++) {
        for (let j = i + 1; j < atoms.length; j++) {
            const d = Math.sqrt((atoms[i].x-atoms[j].x)**2 + (atoms[i].y-atoms[j].y)**2 + (atoms[i].z-atoms[j].z)**2);
            if (Math.abs(d - contactDist) < 10) {
                // 判斷是否屬於延伸層 (L4) 的連線
                const isExt = (atoms[i].z > 5 || atoms[j].z > 5);
                bonds.push([i, j, isExt ? "ionic_thin" : "ionic_thin"]); 
            }
        }
    }

    // 建立核心晶胞的垂直粗框線 (L1 到 L3)
    const coreCorners = [[1,10],[2,11],[3,12],[4,13]]; // L1 到 L3 的頂點對應
    coreCorners.forEach(e => bonds.push([e[0], e[1], "ionic_thick"]));

    addMol(`${elem}|${name}`, "Metal", "面心立方堆積 (FCC)", "74%", "12", mp, bp, atoms, bonds, null,
        `<div class="info-section"><div class="info-title">✨ 面心立方 (FCC)</div><div class="info-body">金屬範例：<strong>${elem}</strong>。<br>空間利用率 74%。模型展示了 5-4-5-4 的四層堆積。<br><span style="color:#facc15">★ 點擊第三層中心原子，可見其配位數為 12 (同層4, 下層4, 上層4)。</span></div></div>`);
    if(MOLECULE_DB[elem]) { MOLECULE_DB[elem].isIonic = true; MOLECULE_DB[elem].isMetal = true; MOLECULE_DB[elem].edgeRelation = "√2 a = 4r"; }
}

// 4. 六方最密堆積 (HCP) - 修正比例與配位數版
function addMetal_HCP(elem, name, mp, bp, scale=140) {
    ensureElement(elem, "#e5e7eb", 22);
    const atoms = []; const bonds = [];
    
    // a = scale (原子間距，即底面六角形的邊長)
    // h = 層與層之間的垂直距離 (理想比例為 sqrt(2/3) * a ≈ 0.8165a)
    const h = scale * 0.8165; 
    const r = 22;

    // A 層生成器 (中心 + 6 顆環繞)
    const getLayerA = (z) => [
        {x:0, y:0, z:z}, // 中心
        {x:scale, y:0, z:z}, {x:scale*0.5, y:scale*0.866, z:z}, {x:-scale*0.5, y:scale*0.866, z:z},
        {x:-scale, y:0, z:z}, {x:-scale*0.5, y:-scale*0.866, z:z}, {x:scale*0.5, y:-scale*0.866, z:z}
    ];

    // B 層生成器 (填入 A 層空隙的 3 顆)
    const getLayerB = (z) => [
        {x:scale*0.5, y:scale*0.288, z:z}, 
        {x:-scale*0.5, y:scale*0.288, z:z}, 
        {x:0, y:-scale*0.577, z:z}
    ];

    // --- 建立四層堆積 A1-B1-A2-B2 ---
    // 為了讓中心原子在座標原點，我們這樣對齊：
    const l1 = getLayerA(-2 * h);   // Index 0-6 (A1 最底層)
    const l2 = getLayerB(-h);       // Index 7-9 (B1)
    const l3 = getLayerA(0);        // Index 10-16 (A2 核心主角層)
    const l4 = getLayerB(h);        // Index 17-19 (B2 延伸層)

    [...l1, ...l2, ...l3, ...l4].forEach((p, i) => {
        atoms.push({
            elem: elem, ...p, r: r, lpCount: 0,
            // 將第三層的中心原子 (Index 10) 設為主角
            isRepresentative: (i === 10) 
        });
    });

    // --- 建立鍵結邏輯 ---
    for (let i = 0; i < atoms.length; i++) {
        for (let j = i + 1; j < atoms.length; j++) {
            const d = Math.sqrt((atoms[i].x-atoms[j].x)**2 + (atoms[i].y-atoms[j].y)**2 + (atoms[i].z-atoms[j].z)**2);
            
            // 距離約等於 scale (a) 的判定為鄰居
            if (d > 10 && d < scale * 1.1) {
                // 判斷是否為延伸層 (L4 / Index 17-19) 的連線
                const isExt = (atoms[i].z > h/2 || atoms[j].z > h/2);
                
                // 1. 同層內部的連線 (六角外框與內部輻射)
                if (Math.abs(atoms[i].z - atoms[j].z) < 1) {
                    const isCenter = (Math.abs(atoms[i].x) < 1 && Math.abs(atoms[i].y) < 1) || 
                                     (Math.abs(atoms[j].x) < 1 && Math.abs(atoms[j].y) < 1);
                    
                    if (isCenter) {
                        bonds.push([i, j, "ionic_thin"]); // 內部輻射用細線
                    } else {
                        // 外部六角框：L1到L3用粗框，延伸層L4用細線
                        bonds.push([i, j, isExt ? "ionic_thin" : "ionic_thick"]);
                    }
                } 
                // 2. 層與層之間的連線 (CN=12 的斜向接觸)
                else {
                    bonds.push([i, j, "ionic_thin"]);
                }
            }
        }
    }

    // --- 核心六角柱的「垂直」稜線 (L1 頂點對應到 L3 頂點) ---
    // 讓主要的晶胞框架看起來像一個完整的六角柱
    for (let i = 1; i <= 6; i++) {
        bonds.push([i, i + 10, "ionic_thick"]);
    }

    addMol(`${elem}|${name}`, "Metal", "六方最密堆積 (HCP)", "74%", "12", mp, bp, atoms, bonds, null,
        `<div class="info-section"><div class="info-title">🛑 六方最密堆積 (HCP)</div><div class="info-body">金屬範例：<strong>${elem} (如鎂、鋅)</strong>。<br>利用率 74%。模型展示 A-B-A-B 四層堆積，延伸出一層三角形 B 層。<br><span style="color:#facc15">★ 點擊第三層中心原子，可見配位數為 12 (同層6，下層3，上層3)。</span></div></div>`);
    
    if(MOLECULE_DB[elem]) { 
        MOLECULE_DB[elem].isIonic = true; 
        MOLECULE_DB[elem].isMetal = true; 
        MOLECULE_DB[elem].edgeRelation = "c ≈ 1.633 a";
    }
}

// 執行金屬生成
// 1A 族 (BCC)
addMetal_BCC("Li", "鋰", "180.5", "1342");
addMetal_BCC("Na", "鈉", "97.8", "883");
addMetal_BCC("K",  "鉀", "63.5", "759");
addMetal_BCC("Rb", "銣", "39.3", "688");
addMetal_BCC("Cs", "銫", "28.4", "671");

// 2A 族
addMetal_HCP("Be", "鈹", "1287", "2469"); // HCP
addMetal_HCP("Mg", "鎂", "650", "1090");  // HCP
addMetal_FCC("Ca", "鈣", "842", "1484");  // FCC
addMetal_FCC("Sr", "鍶", "777", "1382");  // FCC
addMetal_BCC("Ba", "鋇", "727", "1897");  // BCC

// 其他
addMetal_SC("Po", "釙", "254", "962");
addMetal_BCC("Fe", "鐵 (α)", "1538", "2861");
addMetal_FCC("Cu", "銅", "1085", "2562");
addMetal_FCC("Ag", "銀", "961.8", "2162");
addMetal_FCC("Au", "金", "1064", "2970");
addMetal_FCC("Al", "鋁", "660", "2519");
addMetal_HCP("Zn", "鋅", "419.5", "907");
addMetal_HCP("Ti", "鈦", "1668", "3287");






/*
 ==========================================================================
 ★ 視覺鍵長標準參考表 (Visual Bond Length Standards) v16.2
 ==========================================================================
 基準：以 1,2-二氯丙烷為錨點 (C-C ~ 70, C-H ~ 50, C-Cl ~ 75)
 
 [1] 原子視覺半徑貢獻 (Base Radius Contribution)
 --------------------------------------------------------------------------
  - H (氫) .................... 15  (最小，確保緊湊)
  - Row 2 (C, N, O, F) ........ 35  (基準)
  - Row 3 (Si, P, S, Cl) ...... 40  (略大)
  - Row 4 (Br) ................ 45
  - Row 5 (I, Xe) ............. 50  (最大)

 [2] 鍵級修正係數 (Bond Order Multiplier)
 --------------------------------------------------------------------------
  - 單鍵 (Single) ............. x 1.00
  - 雙鍵 (Double) ............. x 0.90
  - 參鍵 (Triple) ............. x 0.85

 [3] 常見鍵長計算範例 (Calculated Examples)
 --------------------------------------------------------------------------
  Type      Calc (R1 + R2) * Multiplier      Final Value
  -------   ---------------------------      -----------
  H-H       (15 + 15) * 1.0                  30
  C-H       (35 + 15) * 1.0                  50  (基準)
  N-H       (35 + 15) * 1.0                  50
  O-H       (35 + 15) * 1.0                  50
  P-H       (40 + 15) * 1.0                  55

  C-C       (35 + 35) * 1.0                  70  (基準)
  C=C       (35 + 35) * 0.9                  63
  C≡C       (35 + 35) * 0.85                 60
  
  C-O       (35 + 35) * 1.0                  70
  C=O       (35 + 35) * 0.9                  63

  S-O       (40 + 35) * 1.0                  75
  S=O       (40 + 35) * 0.9                  68  (SO4, SO3)
  
  P-Cl      (40 + 40) * 1.0                  80  (PCl3)
  Xe=O      (50 + 35) * 0.9                  76  (XeO3)
  
  F-F       (35 + 35) * 1.0                  70
  Cl-Cl     (40 + 40) * 1.0                  80
  I-I       (50 + 50) * 1.0                  100
 ==========================================================================
*/






// ==========================================
// [整理後] 資料注入區 (v14.0 含熔沸點數據)
// ==========================================

/// --- 1. 基礎元素與雙原子分子 (鍵長修正: H=15, 2nd=35, 3rd=40, 4th=45, 5th=50 | Double x0.9, Triple x0.85) ---
const diatomicNames = {'H': '氫|氫氣', 'N': '氮|氮氣', 'O': '氧|氧氣', 'F': '氟|氟氣', 'Cl': '氯|氯氣', 'Br': '溴', 'I': '碘'};
const diatomicProps = {'H': {mp: "-259.2", bp: "-252.9"}, 'N': {mp: "-210.0", bp: "-195.8"}, 'O': {mp: "-218.8", bp: "-183.0"}, 'F': {mp: "-219.7", bp: "-188.1"}, 'Cl': {mp: "-101.5", bp: "-34.0"}, 'Br': {mp: "-7.2", bp: "58.8"}, 'I': {mp: "113.7", bp: "184.3"}};
addMol("H2|氫氣|氫", "雙原子", "s-s", ["直線型", "Linear"], "-", "-259.2", "-252.9", [{elem:"H",x:-15,y:0,z:0},{elem:"H",x:15,y:0,z:0}], [[0,1,"single"]]);
addMol("N2|氮氣|氮", "雙原子", "sp", ["直線型", "Linear"], "-", "-210.0", "-195.8", [{elem:"N",x:-30,y:0,z:0},{elem:"N",x:30,y:0,z:0}], [[0,1,"triple"]]);
addMol("O2|氧氣|氧", "雙原子", "sp²", ["直線型", "Linear"], "-", "-218.8", "-183.0", [{elem:"O",x:-32,y:0,z:0},{elem:"O",x:32,y:0,z:0}], [[0,1,"double"]]);
addMol("F2|氟氣|氟", "雙原子", "sp³", ["直線型", "Linear"], "-", "-219.7", "-188.1", [{elem:"F",x:-35,y:0,z:0},{elem:"F",x:35,y:0,z:0}], [[0,1,"single"]]);
addMol("Cl2|氯氣|氯", "雙原子", "sp³", ["直線型", "Linear"], "-", "-101.5", "-34.0", [{elem:"Cl",x:-40,y:0,z:0},{elem:"Cl",x:40,y:0,z:0}], [[0,1,"single"]]);
addMol("Br2|溴", "雙原子", "sp³", ["直線型", "Linear"], "-", "-7.2", "58.8", [{elem:"Br",x:-45,y:0,z:0},{elem:"Br",x:45,y:0,z:0}], [[0,1,"single"]]);
addMol("I2|碘", "雙原子", "sp³", ["直線型", "Linear"], "-", "113.7", "184.3", [{elem:"I",x:-50,y:0,z:0},{elem:"I",x:50,y:0,z:0}], [[0,1,"single"]]);
["H2", "N2", "O2", "F2", "Cl2", "Br2", "I2"].forEach(key => {
    if (MOLECULE_DB[key]) MOLECULE_DB[key].pg = "Dinfh";
});

addMol("CO|一氧化碳", "雙原子", "sp", ["直線型","Linear"], "-", "-205.0", "-191.5", [{elem:"C",x:-30,y:0,z:0,lp3d:[{x:-1,y:0,z:0}]}, {elem:"O",x:33,y:0,z:0,lp3d:[{x:1,y:0,z:0}]}], [[1,0,"coordinate_triple"]]);
addMol("NO|一氧化氮", "雙原子", "sp²", ["直線型","Linear"], "-", "-164", "-152", [{elem:"N",x:-32,y:0,z:0,radical:true,lp3d:[{x:-1.2,y:1.0,z:0.35},{x:-1.2,y:1.0,z:-0.35},{x:-1.2,y:-1.0,z:0}]},{elem:"O",x:32,y:0,z:0}], [[0,1,"double"]]);
addMol("CN-|氰根|氰離子", "雙原子", "sp", ["直線型","Linear"], "-", "-", "-", [{elem:"C",x:-30,y:0,z:0,lp3d:[{x:-1,y:0,z:0}]},{elem:"N",x:30,y:0,z:0,lp3d:[{x:1,y:0,z:0}]}], [[0,1,"triple"]]);
addMol("O22-|過氧根離子", "O", "sp³", ["直線型","Linear"], "180°", "-", "-", [{elem:"O",x:-35,y:0,z:0,lp3d:[{x:-1,y:1.5,z:0},{x:-1,y:-0.75,z:1.3},{x:-1,y:-0.75,z:-1.3}]}, {elem:"O",x:35,y:0,z:0,lp3d:[{x:1,y:1.5,z:0},{x:1,y:-0.75,z:1.3},{x:1,y:-0.75,z:-1.3}]}], [[0,1]]);
addMol("C22-|碳化物離子", "C", "sp", ["直線型","Linear"], "180°", "-", "-", [{elem:"C",x:-30,y:0,z:0,lp3d:[{x:-1,y:0,z:0}]}, {elem:"C",x:30,y:0,z:0,lp3d:[{x:1,y:0,z:0}]}], [[0,1,"triple"]]);

// --- 2. 鹵化氫 (HX) ---
addMol("HF|氟化氫", "雙原子", "sp³", ["直線型","Linear"], "-", "-83.6", "19.5", [{elem:"F",x:-25,y:0,z:0}, {elem:"H",x:25,y:0,z:0}], [[0,1]]);
addMol("HCl|氯化氫", "雙原子", "sp³", ["直線型","Linear"], "-", "-114.2", "-85.1", [{elem:"Cl",x:-28,y:0,z:0}, {elem:"H",x:28,y:0,z:0}], [[0,1]]);
addMol("HBr|溴化氫", "雙原子", "sp³", ["直線型","Linear"], "-", "-86.8", "-66.4", [{elem:"Br",x:-30,y:0,z:0}, {elem:"H",x:30,y:0,z:0}], [[0,1]]);
addMol("HI|碘化氫", "雙原子", "sp³", ["直線型","Linear"], "-", "-50.8", "-35.4", [{elem:"I",x:-33,y:0,z:0}, {elem:"H",x:33,y:0,z:0}], [[0,1]]);

// 批次設定異核雙原子分子/離子為 Cinfv (直線非對稱)
["CO", "NO", "CN-", "HF", "HCl", "HBr", "HI"].forEach(key => {
    if (MOLECULE_DB[key]) MOLECULE_DB[key].pg = "Cinfv";
});

// 批次設定同核雙原子離子為 Dinfh (直線中心對稱)
["O22-", "C22-"].forEach(key => {
    if (MOLECULE_DB[key]) MOLECULE_DB[key].pg = "Dinfh";
});

// --- 3. 常見無機分子 (H2O, NH3, CH4 等) ---
addMol("CH4|甲烷", "C", "sp³", ["四面體","Tetrahedral"], "109.5°", "-182.5", "-161.5", getTetra("C","H", 50), [[0,1],[0,2],[0,3],[0,4]], null, 
    `<div class="info-section">
        <div class="info-title">⚗️ 物質性質</div>
        <div class="info-body">
            <span class="highlight-title">1. 立體結構：</span>中心碳原子採取 <strong>sp³ 混成軌域</strong>。由於周圍連接四個相同的氫原子且無孤對電子，四個 C-H 鍵之間的電子斥力完全均等，構成了完美的<strong>正四面體</strong>結構，鍵角為 <strong>109.5°</strong>。<br>
            <span class="highlight-title">2. 物理性質：</span>常溫常壓下為無色、無味、無毒的氣體（家用天然氣的臭味是為了安全而添加的硫醇）。屬於完全對稱的<strong>非極性分子</strong>，難溶於水。由於分子量小且分子間僅有微弱的<strong>凡得瓦力</strong>（倫敦分散力），因此熔沸點極低。<br>
            <span class="highlight-title">3. 化學性質：</span>化學性質相當穩定，在一般條件下不與強酸、強鹼或強氧化劑反應。具有可燃性，在空氣中完全燃燒生成二氧化碳與水；在紫外線光照下，可與鹵素（如氯氣）發生連鎖的<strong>自由基取代反應</strong>。
        </div>
    </div>
    <div class="info-section" style="margin-top: 12px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 10px;">
        <div class="info-title">🏭 生活應用</div>
        <div class="info-body">
            <span class="highlight-title">1. 潔淨能源 (天然氣)：</span>甲烷是<strong>天然氣</strong>的主要成分 (含量約 90% 以上)。其氫碳比 (H/C ratio) 是所有烴類中最高的，因此燃燒時產生的單位熱值極高，且碳排放量遠低於煤炭與石油，是現代發電與家庭烹飪的重要燃料。<br>
            <span class="highlight-title">2. 未來能源 (可燃冰)：</span>在深海高壓低溫的環境下，甲烷分子會被水分子包覆，形成籠狀結晶結構的<strong>「甲烷水合物」</strong>。外觀晶瑩剔透像冰塊，卻可以直接點火燃燒，其蘊藏量極大，被視為未來最具潛力的戰略能源。<br>
            <span class="highlight-title">3. 溫室氣體效應：</span>雖然大氣中含量遠低於二氧化碳，但甲烷的<strong>全球暖化潛勢 (GWP)</strong> 約是 CO₂ 的 25 倍。這是因為其分子結構中 C-H 鍵的特定震動模式，能非常有效地吸收地表反射的紅外線輻射熱，是造成氣候變遷的關鍵氣體之一。
        </div>
    </div>`, "Td");

addMol("SiH4|矽烷", "Si", "sp³", ["四面體","Tetrahedral"], "109.5°", "-185", "-112", getTetra("Si","H", 55), [[0,1],[0,2],[0,3],[0,4]], null, null, "Td");
addMol("NH3|氨系列", "N", "sp³", ["角錐形","Pyramidal"], "106.7°", "-77.7", "-33.3", [], [], { "NH3|氨|氨氣": {pg: "C3v", mp: "-77.7", bp: "-33.3", desc: "<strong>氨 (Ammonia)</strong><br>三角錐形，具有一對孤對電子，為弱鹼。", atoms: [{elem:"N",x:0,y:10,z:0,lpCount:1}, {elem:"H",x:0,y:-25,z:40}, {elem:"H",x:35,y:-25,z:-20}, {elem:"H",x:-35,y:-25,z:-20}], bonds: [[0,1],[0,2],[0,3]] }, "NH4+|銨根離子|銨離子|銨根": {pg: "Td", mp: "-", bp: "-", desc: "<strong>銨離子</strong><br>正四面體結構，是氨氣與氫離子結合的產物。", atoms: getTetra("N","H", 50), bonds: [[0,1],[0,2],[0,3],[0,4]] }, "NH2-|胺基陰離子|胺基負離子": {pg: "C2v", mp: "-", bp: "-", desc: "<strong>胺基負離子</strong><br>氨失去一個質子後的強鹼性陰離子，V型結構，有兩對孤對電子。", atoms: [{elem:"N",x:0,y:5,z:0,lpCount:2},{elem:"H",x:35,y:-30,z:0},{elem:"H",x:-35,y:-30,z:0}], bonds: [[0,1],[0,2]] }});
addMol("PH3|磷化氫系列", "P", "sp³", ["角錐形","Pyramidal"], "93.3°", "-133.8", "-87.7", [], [], { "PH3|磷化氫": {pg: "C3v", mp: "-133.8", bp: "-87.7", desc: "<strong>磷化氫</strong><br>劇毒氣體，鍵角接近90度(p軌域特性)，但VSEPR視為sp³。", atoms: [{elem:"P",x:0,y:15,z:0,lpCount:1}, {elem:"H",x:0,y:-30,z:45}, {elem:"H",x:39,y:-30,z:-22}, {elem:"H",x:-39,y:-30,z:-22}], bonds: [[0,1],[0,2],[0,3]] }, "PH4+|鏻離子": {pg: "Td", mp: "-", bp: "-", desc: "<strong>鏻離子</strong><br>結構類似銨根，由膦與氫離子形成。", atoms: getTetra("P","H", 55), bonds: [[0,1],[0,2],[0,3],[0,4]] }});
// AA
addMol("H2O|水系列", "O", "sp³", ["角形","Bent"], "104.5°", "0.0", "100.0", [], [], { "H2O|水|水分子": {pg: "C2v",mp: "0.0", bp: "100.0", desc: "<strong>水</strong><br>生命的基石，V型結構，中心氧原子有兩對孤對電子。", atoms: [{elem:"O",x:0,y:5,z:0,lpCount:2}, {elem:"H",x:38,y:-28,z:0}, {elem:"H",x:-38,y:-28,z:0}], bonds: [[0,1],[0,2]] }, "H3O+|水合氫離子|鋞離子": { pg: "C3v",mp: "-", bp: "-", desc: "<strong>水合氫離子</strong><br>水中氫離子的實際存在形式，三角錐形。", atoms: [{elem:"O",x:0,y:10,z:0,lpCount:1}, {elem:"H",x:0,y:-25,z:40}, {elem:"H",x:35,y:-25,z:-20}, {elem:"H",x:-35,y:-25,z:-20}], bonds: [[0,1],[0,2],[0,3]] }, "OH-|氫氧根|氫氧根離子": { pg: "Cinfv",mp: "-", bp: "-", desc: "<strong>氫氧根</strong><br>強鹼的特徵離子，氧原子周圍有三對孤對電子，帶負電。", atoms: [{elem:"O",x:-20,y:0,z:0,lpCount:3},{elem:"H",x:25,y:0,z:0}], bonds: [[0,1]] }});


addMol("H2S|硫化氫系列", "S", "sp³", ["角形","Bent"], "92.1°", "-85.5", "-60.3", [], [], { "H2S|硫化氫|氫硫酸": {pg: "C2v", mp: "-85.5", bp: "-60.3", desc: "<strong>硫化氫</strong><br>具有腐敗雞蛋味的氣體，V型結構。", atoms: [{elem:"S",x:0,y:5,z:0,lpCount:2}, {elem:"H",x:40,y:-35,z:0}, {elem:"H",x:-40,y:-35,z:0}], bonds: [[0,1],[0,2]] }, "HS-|硫氫根": {pg: "Cinfv", mp: "-", bp: "-", desc: "<strong>氫硫根</strong><br>硫化氫的一級解離產物，硫原子有三對孤對電子。", atoms: [{elem:"S",x:-20,y:0,z:0,lpCount:3},{elem:"H",x:30,y:0,z:0}], bonds: [[0,1]] }});

// --- 4. 鹵化物系列 (全資料補完與鍵長修正) ---
const halideProps = { "BF3": ["-126.8", "-100.3"], "BCl3": ["-107", "12.6"], "BBr3": ["-46", "91.3"], "BI3": ["49.9", "210"], "AlF3": ["1290 (昇華)", "-"], "AlCl3": ["192.4", "120 (昇華)"], "AlBr3": ["97.5", "255"], "AlI3": ["191", "360"], "CF4": ["-183.6", "-127.8"], "CCl4": ["-22.9", "76.7"], "CBr4": ["90.1", "189.5"], "CI4": ["171 (分解)", "-"], "SiF4": ["-90", "-86 (昇華)"], "SiCl4": ["-70", "57.7"], "SiBr4": ["5", "154"], "SiI4": ["120.5", "287.5"], "NF3": ["-206.8", "-129"], "NCl3": ["-40", "71"], "NBr3": ["-100", "爆炸"], "NI3": ["-", "爆炸"], "PF3": ["-151.5", "-101.8"], "PCl3": ["-93.6", "76.1"], "PBr3": ["-41.5", "173.2"], "PI3": ["61", "分解"], "OF2": ["-223.8", "-144.8"], "OCl2": ["-135", "2.0"], "OBr2": ["-", "-"], "OI2": ["-", "-"], "SF2": ["-", "-"], "SCl2": ["-121", "59 (分解)"], "SBr2": ["-", "-"], "SI2": ["-", "-"] };
const haloNames = {'F':'氟', 'Cl':'氯', 'Br':'溴', 'I':'碘'};

['F','Cl','Br','I'].forEach(X => {
    const hn = haloNames[X]; let rX = (X==='F'?35: (X==='Cl'?40: (X==='Br'?45:50)));
    
    // BX3 系列
    let p = halideProps[`B${X}3`] || ["-","-"]; 
    addMol(`B${X}3|三${hn}化硼`, "B", "sp²", ["平面三角形","Trigonal Planar"], "120°", p[0], p[1], getTrigPlanar("B", X, 35+rX), [[0,1],[0,2],[0,3]], null, null, "D3h");
    
    // AlX3 系列
    p = halideProps[`Al${X}3`] || ["-","-"]; 
    addMol(`Al${X}3|三${hn}化鋁`, "Al", "sp²", ["平面三角形","Trigonal Planar"], "120°", p[0], p[1], getTrigPlanar("Al", X, 40+rX), [[0,1],[0,2],[0,3]], null, null, "D3h");
    
    // CX4 系列
    p = halideProps[`C${X}4`] || ["-","-"]; 
    addMol(`C${X}4|四${hn}化碳|四${hn}甲烷`, "C", "sp³", ["四面體","Tetrahedral"], "109.5°", p[0], p[1], getTetra("C", X, 35+rX), [[0,1],[0,2],[0,3],[0,4]], null, null, "Td");
    
    // SiX4 系列
    if(X !== 'Cl') { 
        p = halideProps[`Si${X}4`] || ["-","-"]; 
        addMol(`Si${X}4|四${hn}化矽`, "Si", "sp³", ["四面體","Tetrahedral"], "109.5°", p[0], p[1], getTetra("Si", X, 40+rX), [[0,1],[0,2],[0,3],[0,4]], null, null, "Td"); 
    }
    
    // NX3 系列
    p = halideProps[`N${X}3`] || ["-","-"]; 
    let dN = 35+rX, hN=dN*0.85, vN=dN*0.5; 
    addMol(`N${X}3|三${hn}化氮`, "N", "sp³", ["角錐形","Pyramidal"], (X==='F'?"102.3°":(X==='Cl'?"107.1°":(X==='Br'?"108°":"110°"))), p[0], p[1], [{elem:"N",x:0,y:15,z:0,lp3d:[{x:0,y:1,z:0}]},{elem:X,x:0,y:-10,z:hN},{elem:X,x:hN*0.866,y:-10,z:-hN*0.5},{elem:X,x:-hN*0.866,y:-10,z:-hN*0.5}], [[0,1],[0,2],[0,3]], null, null, "C3v");
    
    // PX3 系列
    if(X !== 'Cl') { 
        p = halideProps[`P${X}3`] || ["-","-"]; 
        let dP = 40+rX, hP=dP*0.85, vP=dP*0.5; 
        addMol(`P${X}3|三${hn}化磷`, "P", "sp³", ["角錐形","Pyramidal"], (X==='F'?"97.8°":(X==='Cl'?"100.3°":(X==='Br'?"101.5°":"102°"))), p[0], p[1], [{elem:"P",x:0,y:20,z:0,lp3d:[{x:0,y:1,z:0}]},{elem:X,x:0,y:-15,z:hP},{elem:X,x:hP*0.866,y:-15,z:-hP*0.5},{elem:X,x:-hP*0.866,y:-15,z:-hP*0.5}], [[0,1],[0,2],[0,3]], null, null, "C3v"); 
    }
    
    // OX2 系列
    p = halideProps[`O${X}2`] || ["-","-"]; 
    let dO = 35+rX; 
    addMol(`O${X}2|二${hn}化氧`, "O", "sp³", ["角形","Bent"], (X==='F'?"103.3°":(X==='Cl'?"110.9°":"114°")), p[0], p[1], [{elem:"O",x:0,y:0,z:0,lpCount:2},{elem:X,x:dO*0.8,y:-dO*0.6,z:0},{elem:X,x:-dO*0.8,y:-dO*0.6,z:0}], [[0,1],[0,2]], null, null, "C2v");
    
    // SX2 系列
    p = halideProps[`S${X}2`] || ["-","-"]; 
    let dS = 40+rX; 
    addMol(`S${X}2|二${hn}化硫`, "S", "sp³", ["角形","Bent"], (X==='F'?"98.2°":(X==='Cl'?"102.7°":"104°")), p[0], p[1], [{elem:"S",x:0,y:0,z:0,lpCount:2},{elem:X,x:dS*0.85,y:-dS*0.55,z:0},{elem:X,x:-dS*0.85,y:-dS*0.55,z:0}], [[0,1],[0,2]], null, null, "C2v");
});


// [保留] SiCl4 詳細資料
addMol("SiCl4|四氯化矽|Silicon Tetrachloride", "Si", "sp³", ["四面體","Tetrahedral"], "109.5°", "-70", "57.7", getTetra("Si", "Cl", 80), [[0,1],[0,2],[0,3],[0,4]], null,
    `<div class="info-section">
        <div class="info-title">⚗️ 物質性質</div>
        <div class="info-body">
            <span class="highlight-title">1. 立體結構：</span>中心矽原子採取 <strong>sp³ 混成</strong>，與同族的四氯化碳 (CCl₄) 具有相同的<strong>正四面體</strong>幾何結構，鍵角為 <strong>109.5°</strong>。<br>
            <span class="highlight-title">2. 物理性質：</span>常溫下為無色、易揮發的液體，具有強烈的刺鼻氣味。雖然 Si-Cl 鍵是極性共價鍵，但由於分子對稱性高，偶極矩互相抵銷，整體為<strong>非極性分子</strong>。<br>
            <span class="highlight-title">3. 化學性質：</span>與化學性質安定的 CCl₄ 不同，SiCl₄ 極易發生<strong>水解反應</strong>。這是因為矽原子的原子半徑較大，且擁有<strong>空 d 軌域</strong>，能接受水分子的氧原子進行親核攻擊，反應後生成矽酸並產生大量的氯化氫 (HCl) 白煙。
        </div>
    </div>
    <div class="info-section" style="margin-top: 12px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 10px;">
        <div class="info-title">🏭 生活應用</div>
        <div class="info-body">
            <span class="highlight-title">1. 晶片製造 (多晶矽)：</span>它是半導體產業的基石。透過<strong>西門子法 (Siemens process)</strong>，將高純度的 SiCl₄ 與氫氣在 1100°C 高溫下反應還原，可製造出純度高達 99.9999999% (9N) 的<strong>電子級多晶矽</strong>，用於生產電腦晶片與太陽能電池。<br>
            <span class="highlight-title">2. 光纖通訊核心：</span>在光纖製程中，SiCl₄ 是最關鍵的原料。透過氣相沉積法將其高溫氧化，能生成折射率極高且無雜質的二氧化矽 (SiO₂)，構成光纖內層傳輸訊號的玻璃核心。<br>
            <span class="highlight-title">3. 軍事煙霧彈：</span>早期軍事上利用其「極易水解」的特性製作煙霧彈。當液態 SiCl₄ 炸開接觸空氣中的水氣時，會瞬間產生極濃密的白色酸霧 (HCl)，能有效遮蔽視線，但因具有毒性與腐蝕性，現代已較少使用。
        </div>
    </div>`
,"Td");

// [保留] PCl3 詳細資料
addMol("PCl3|三氯化磷|Phosphorus Trichloride", "P", "sp³", ["角錐形","Pyramidal"], "96-100°", "-93.6", "76.1", [{elem:"P",x:0,y:20,z:0,lp3d:[{x:0,y:1,z:0}]},{elem:"Cl",x:0,y:-15,z:68},{elem:"Cl",x:59,y:-15,z:-34},{elem:"Cl",x:-59,y:-15,z:-34}], [[0,1],[0,2],[0,3]], null,
    `<div class="info-section">
        <div class="info-title">⚗️ 物質性質</div>
        <div class="info-body">
            <span class="highlight-title">1. 立體結構：</span>中心磷原子採取 <strong>sp³ 混成</strong>。由於具有一對未共用電子對 (Lone Pair)，其對鍵結電子的斥力較大，導致 P-Cl 鍵角被壓縮至約 <strong>100°</strong>，形成<strong>三角錐形</strong>結構。<br>
            <span class="highlight-title">2. 物理性質：</span>常溫下為無色或微黃色的液體，會發煙。具有較低的沸點與強烈刺鼻味，可溶於苯、氯仿等有機溶劑。<br>
            <span class="highlight-title">3. 化學性質：</span>P-Cl 鍵極性大且反應性極高，遇水會劇烈<strong>水解</strong>並放熱，生成亞磷酸 (H₃PO₃) 與鹽酸霧。因磷原子上有一對孤對電子，可作為<strong>路易斯鹼</strong>參與配位反應。
        </div>
    </div>
    <div class="info-section" style="margin-top: 12px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 10px;">
        <div class="info-title">🏭 生活應用</div>
        <div class="info-body">
            <span class="highlight-title">1. 除草劑原料 (嘉磷塞)：</span>工業上最大宗的用途是作為中間體，用於合成廣效性除草劑<strong>嘉磷塞 (Glyphosate)</strong>，這是目前全球農業使用量最大的農藥之一。<br>
            <span class="highlight-title">2. 有機合成 (氯化劑)：</span>在製藥與有機化學實驗室中，它是不可或缺的試劑。專門用來將有機分子中的<strong>羥基 (-OH)</strong> 取代為氯原子，或是將羧酸轉化為活性極高的醯氯，是合成染料與藥物的重要步驟。<br>
            <span class="highlight-title">3. 塑膠添加劑：</span>可用於製造含磷的<strong>阻燃劑</strong>與塑化劑。這些添加劑能讓電子產品的塑膠外殼在受熱時不易燃燒，大幅提升產品安全性。
        </div>
    </div>`
,"C3v");




// --- 5. 碳與其他氧化物 (直線型/平面型) ---
addMol("CO2|二氧化碳|乾冰", "C", "sp", ["直線型","Linear"], "180°", "-78.5 (昇華)", "-56.6", getLinear("C","O", 70), [[0,1,"double"],[0,2,"double"]], null, null, "Dinfh");
addMol("CS2|二硫化碳", "C", "sp", ["直線型","Linear"], "180°", "-111.6", "46.2", getLinear("C","S", 75), [[0,1,"double"],[0,2,"double"]], null, null, "Dinfh");
addMol("BeCl2|二氯化鈹", "Be", "sp", ["直線型","Linear"], "180°", "399", "482", getLinear("Be","Cl", 75), [[0,1], [0,2]], null, null, "Dinfh");
addMol("BCl3|三氯化硼", "B", "sp²", ["平面三角形","Trigonal Planar"], "120°", "-107", "12.6", getTrigPlanar("B","Cl", 75), [[0,1], [0,2], [0,3]], null, null, "D3h");
addMol("SO2|二氧化硫", "S", "sp²", ["角形","Bent"], "119°", "-72", "-10", 
    [
        {elem:"S", x:0, y:15, z:0, lpCount:1, lp3d:[{x:0,y:1,z:0}]}, 
        {elem:"O", x:55, y:-30, z:0}, 
        {elem:"O", x:-55, y:-30, z:0}
    ], 
    // 預設給兩個雙鍵 (擴大八隅體狀態)，讓程式去切換
    [[0,1,"double"], [0,2,"double"]], null, null, "C2v");
addMol("SO3|三氧化硫", "S", "sp²", ["平面三角形","Trigonal Planar"], "120°", "16.9", "44.8", getTrigPlanar("S","O", 68), [[0,1,"double"],[0,2,"double"],[0,3,"double"]], null, null, "D3h");
addMol("O3|臭氧", "O", "sp²", ["角形","Bent"], "117°", "-192.2", "-112", [{elem:"O",x:0,y:10,z:0,lp3d:[{x:0,y:1,z:0}]},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0,lpCount:3}], [[0,1,"double"],[0,2,"coordinate"]], null, null, "C2v");
addMol("NO2|二氧化氮", "N", "sp²", ["角形","Bent"], "134°", "-11.2", "21.2", [{elem:"N",x:0,y:10,z:0,lp3d:[{x:0,y:1,z:0}],radical:true},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0,lpCount:3}], [[0,1,"double"],[0,2,"coordinate"]], null, null, "C2v");
addMol("N2O|一氧化二氮|笑氣", "N", "sp", ["直線型","Linear"], "180°", "-90.8", "-88.5", [{elem:"N",x:0,y:0,z:0,lpCount:0},{elem:"N",x:-65,y:0,z:0,lp3d:[{x:-1,y:0,z:0}]},{elem:"O",x:65,y:0,z:0}], [[0,1,"triple"],[0,2,"coordinate"]], null, null, "Cinfv");
addMol("NO|一氧化氮", "雙原子", "sp²", ["直線型","Linear"], "-", "-164", "-152", [{elem:"N",x:-32,y:0,z:0,radical:true,lp3d:[{x:-1,y:1,z:0},{x:-1,y:-1,z:0.4},{x:-1,y:-1,z:-0.4}]},{elem:"O",x:32,y:0,z:0}], [[0,1,"double"]], null, null, "Cinfv");

// --- 6. 離子與特殊無機分子 (含共振結構) ---
// --- SCN- 共振結構展示 (修改：以 N=C=S 為預設) ---
addMol("SCN-|硫氰酸根", "C", "sp", ["直線型","Linear"], "180°", "-", "-", [], [], {
    "SCN-|主要共振結構 (N=C=S)": {pg: "Cinfv", mp: "-", bp: "-", atoms: [{elem:"C", x:0, y:0, z:0}, {elem:"N", x:-65, y:0, z:0, lpCount:2},{elem:"S", x:85, y:0, z:0, lpCount:2}], bonds: [[0,1,"double"], [0,2,"double"]] },
    "SCN-|次要共振結構 (N≡C-S)": {pg: "Cinfv", mp: "-", bp: "-", atoms: [{elem:"C", x:0, y:0, z:0}, {elem:"N", x:-60, y:0, z:0, lpCount:1}, {elem:"S", x:90, y:0, z:0, lpCount:3}], bonds: [[0,1,"triple"], [0,2,"single"]] }
});
addMol("NO+|亞硝鎓離子", "N", "sp", ["直線型","Linear"], "180°", "-", "-", [{elem:"N",x:-30,y:0,z:0,lpCount:1}, {elem:"O",x:30,y:0,z:0,lpCount:1}], [[0,1,"triple"]], null, null, "Cinfv");
addMol("NO2+|硝鎓離子", "N", "sp", ["直線型","Linear"], "180°", "-", "-", [{elem:"N",x:0,y:0,z:0}, {elem:"O",x:-65,y:0,z:0}, {elem:"O",x:65,y:0,z:0}], [[0,1,"double"],[0,2,"double"]], null, null, "Dinfh");
addMol("N3-|疊氮酸根", "N", "sp", ["直線型","Linear"], "180°", "-", "-", [], [], {
    "N3-|主要共振結構 (N=N=N)": {pg: "Dinfh", atoms: [{elem:"N",x:0,y:0,z:0},{elem:"N",x:-65,y:0,z:0,lpCount:2},{elem:"N",x:65,y:0,z:0,lpCount:2}], bonds: [[0,1,"double"],[0,2,"double"]] },
    "N3-|主要共振結構 (N≡N-N)": {pg: "Dinfh", atoms: [{elem:"N",x:0,y:0,z:0},{elem:"N",x:-60,y:0,z:0,lpCount:1},{elem:"N",x:85,y:0,z:0,lpCount:3}], bonds: [[0,1,"triple"],[0,2,"single"]] }
});
addMol("OCN-|氰酸根", "C", "sp", ["直線型","Linear"], "180°", "-", "-", [], [], {
    "OCN-|主要共振結構 (N≡C-O)": {pg: "Cinfv", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"N",x:-60,y:0,z:0,lpCount:1},{elem:"O",x:85,y:0,z:0,lpCount:3}], bonds: [[0,1,"triple"],[0,2,"single"]] },
    "OCN-|次要共振結構 (N=C=O)": {pg: "Cinfv", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"N",x:-65,y:0,z:0,lpCount:2},{elem:"O",x:65,y:0,z:0,lpCount:2}], bonds: [[0,1,"double"],[0,2,"double"]] }
});
addMol("CNO-|雷酸根", "N", "sp", ["直線型","Linear"], "180°", "-", "-", [], [], {
    "CNO-|主要共振結構 (C≡N-O)": {pg: "Cinfv", atoms: [{elem:"N",x:0,y:0,z:0},{elem:"C",x:-60,y:0,z:0,lpCount:1},{elem:"O",x:85,y:0,z:0,lpCount:3}], bonds: [[0,1,"triple"],[0,2,"single"]] },
    "CNO-|次要共振結構 (C=N=O)": {pg: "Cinfv", atoms: [{elem:"N",x:0,y:0,z:0},{elem:"C",x:-65,y:0,z:0,lpCount:2},{elem:"O",x:65,y:0,z:0,lpCount:2}], bonds: [[0,1,"double"],[0,2,"double"]] }
});
addMol("HOCN|氰酸", "C", "sp", ["直線/角形","Linear/Bent"], "180°/105°", "-86", "23.5", [{elem:"C",x:0,y:0,z:0}, {elem:"N",x:65,y:0,z:0,lpCount:1}, {elem:"O",x:-65,y:0,z:0,lpCount:2}, {elem:"H",x:-95,y:30,z:0}], [[0,1,"triple"], [0,2], [2,3]], null, null, "Cs");

// --- 7. 擴大八隅體與複雜幾何構型 ---
// P-Cl=80, P-Br=85, S-F=75, S=O=68, Xe=O=76
addMol("PCl5|五氯化磷", "P", "sp³d", ["雙三角錐","Trigonal Bipyramidal"], "90°, 120°", "160.5", "166.8", [{elem:"P",x:0,y:0,z:0},{elem:"Cl",x:0,y:0,z:85},{elem:"Cl",x:0,y:0,z:-85},{elem:"Cl",x:-80,y:0,z:0},{elem:"Cl",x:40,y:69,z:0},{elem:"Cl",x:40,y:-69,z:0}], [[0,1],[0,2],[0,3],[0,4],[0,5]], null, null, "D3h");
addMol("PBr5|五溴化磷", "P", "sp³d", ["雙三角錐","Trigonal Bipyramidal"], "90°, 120°", "100 (分解)", "106 (分解)", [{elem:"P",x:0,y:0,z:0}, {elem:"Br",x:0,y:90,z:0}, {elem:"Br",x:0,y:-90,z:0}, {elem:"Br",x:85,y:0,z:0}, {elem:"Br",x:-42,y:0,z:74}, {elem:"Br",x:-42,y:0,z:-74}], [[0,1],[0,2],[0,3],[0,4],[0,5]], null, null, "D3h");
addMol("SF6|六氟化硫", "S", "sp³d²", ["八面體","Octahedral"], "90°", "-50.8", "-63.8 (昇華)", getOcta("S","F", 75), [[0,1],[0,2],[0,3],[0,4],[0,5],[0,6]], null, null, "Oh");
addMol("SF4|四氟化硫", "S", "sp³d", ["翹翹板型","Seesaw"], "<90°, <120°", "-121", "-38", [{elem:"S",x:0,y:0,z:0,lp3d:[{x:0,y:-1,z:0}]},{elem:"F",x:0,y:0,z:80},{elem:"F",x:0,y:0,z:-80},{elem:"F",x:45,y:65,z:0},{elem:"F",x:-45,y:65,z:0}], [[0,1],[0,2],[0,3],[0,4]], null, null, "C2v");
addMol("ClF3|三氟化氯", "Cl", "sp³d", ["T型","T-shaped"], "<90°", "-76.3", "11.8", [{elem:"Cl",x:0,y:0,z:0,lp3d:[{x:-1,y:0.5,z:0}, {x:-1,y:-0.5,z:0}]}, {elem:"F",x:0,y:80,z:0}, {elem:"F",x:0,y:-80,z:0}, {elem:"F",x:70,y:0,z:0}], [[0,1],[0,2],[0,3]], null, null, "C2v");
addMol("XeF2|二氟化氙", "Xe", "sp³d", ["直線型","Linear"], "180°", "128.6", "-", [{elem:"Xe",x:0,y:0,z:0,lp3d:[{x:0,y:1,z:0}, {x:0.866,y:-0.5,z:0}, {x:-0.866,y:-0.5,z:0}]}, {elem:"F",x:0,y:0,z:85}, {elem:"F",x:0,y:0,z:-85}], [[0,1],[0,2]], null, null, "Dinfh");

addMol("XeF4|四氟化氙", "Xe", "sp³d²", ["平面四邊形","Square Planar"], "90°", "117 (昇華)", "-", [
{elem:"Xe",x:0,y:0,z:0,lp3d:[{x:1,y:0,z:0}, {x:-1,y:0,z:0}]}, 
{elem:"F",x:0,y:85,z:0}, {elem:"F",x:0,y:-85,z:0}, 
{elem:"F",x:0,y:0,z:85}, {elem:"F",x:0,y:0,z:-85}
], [[0,1],[0,2],[0,3],[0,4]], null, null, "D4h");

addMol("BrF5|五氟化溴", "Br", "sp³d²", ["四角錐","Square Pyramidal"], "<90°", "-61.3", "40.3", [{elem:"Br",x:0,y:0,z:0,lp3d:[{x:0,y:-1,z:0}]}, {elem:"F",x:0,y:80,z:0}, {elem:"F",x:70,y:0,z:0}, {elem:"F",x:-70,y:0,z:0}, {elem:"F",x:0,y:0,z:70}, {elem:"F",x:0,y:0,z:-70}], [[0,1],[0,2],[0,3],[0,4],[0,5]], null, null, "C4v");
addMol("IF7|七氟化碘", "I", "sp³d³", ["五角雙錐","Pentagonal Bipyramidal"], "72°, 90°", "4.8", "4.8 (昇華)", [{elem:"I",x:0,y:0,z:0,lpCount:0}, {elem:"F",x:0,y:90,z:0}, {elem:"F",x:0,y:-90,z:0}, {elem:"F",x:80,y:0,z:0}, {elem:"F",x:25,y:0,z:76}, {elem:"F",x:25,y:0,z:-76}, {elem:"F",x:-65,y:0,z:47}, {elem:"F",x:-65,y:0,z:-47}], [[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7]], null, null, "D5h");
addMol("SeF6|六氟化硒", "Se", "sp³d²", ["八面體","Octahedral"], "90°", "-34.6", "-46.6 (昇華)", getOcta("Se","F", 75), [[0,1],[0,2],[0,3],[0,4],[0,5],[0,6]], null, null, "Oh");
addMol("TeF6|六氟化碲", "Te", "sp³d²", ["八面體","Octahedral"], "90°", "-37.6", "-38.9 (昇華)", getOcta("Te","F", 75), [[0,1],[0,2],[0,3],[0,4],[0,5],[0,6]], null, null, "Oh");
addMol("AsF5|五氟化砷", "As", "sp³d", ["雙三角錐","Trigonal Bipyramidal"], "90°, 120°", "-79.8", "-52.8", [{elem:"As",x:0,y:0,z:0}, {elem:"F",x:0,y:80,z:0}, {elem:"F",x:0,y:-80,z:0}, {elem:"F",x:70,y:0,z:0}, {elem:"F",x:-35,y:0,z:60}, {elem:"F",x:-35,y:0,z:-60}], [[0,1],[0,2],[0,3],[0,4],[0,5]], null, null, "D3h");
addMol("TeF4|四氟化碲", "Te", "sp³d", ["翹翹板型","Seesaw"], "<90°, <120°", "129.6", "193", [{elem:"Te",x:0,y:0,z:0,lp3d:[{x:-1,y:0,z:0}]}, {elem:"F",x:0,y:85,z:0}, {elem:"F",x:0,y:-85,z:0}, {elem:"F",x:70,y:0,z:50}, {elem:"F",x:70,y:0,z:-50}], [[0,1],[0,2],[0,3],[0,4]], null, null, "C2v");
addMol("XeO3|三氧化氙", "Xe", "sp³", ["角錐形","Trigonal Pyramidal"], "103°", "25 (爆炸)", "-", [{elem:"Xe",x:0,y:20,z:0,lp3d:[{x:0,y:1,z:0}]},{elem:"O",x:0,y:-30,z:57},{elem:"O",x:49,y:-30,z:-28.5},{elem:"O",x:-49,y:-30,z:-28.5}], [[0,1,"double"],[0,2,"double"],[0,3,"double"]], null, null, "C3v");
addMol("XeO4|四氧化氙", "Xe", "sp³", ["四面體","Tetrahedral"], "109.5°", "-35.9", "0 (分解)", getTetra("Xe","O", 76), [[0,1,"double"],[0,2,"double"],[0,3,"double"],[0,4,"double"]], null, null, "Td");
addMol("XeOF4|四氟氧化氙|XeOF4", "Xe", "sp³d²", ["四角錐","Square Pyramidal"], "<90°", "-46", "101", [{elem:"Xe",x:0,y:0,z:0,lp3d:[{x:0,y:-1,z:0}]}, {elem:"O",x:0,y:80,z:0}, {elem:"F",x:80,y:0,z:0}, {elem:"F",x:-80,y:0,z:0}, {elem:"F",x:0,y:0,z:80}, {elem:"F",x:0,y:0,z:-80}], [[0,1,"double"],[0,2],[0,3],[0,4],[0,5]], null, null, "C4v");
addMol("IOF5|五氟氧化碘", "I", "sp³d²", ["八面體","Octahedral"], "90°", "4.5", "110", [{elem:"I",x:0,y:0,z:0}, {elem:"O",x:0,y:85,z:0}, {elem:"F",x:0,y:-85,z:0}, {elem:"F",x:85,y:0,z:0}, {elem:"F",x:-85,y:0,z:0}, {elem:"F",x:0,y:0,z:85}, {elem:"F",x:0,y:0,z:-85}], [[0,1,"double"],[0,2],[0,3],[0,4],[0,5],[0,6]], null, null, "C4v");
addMol("AsF3|三氟化砷", "As", "sp³", ["角錐形","Pyramidal"], "96°", "-6", "57.8", [{elem:"As",x:0,y:15,z:0,lp3d:[{x:0,y:1,z:0}]}, {elem:"F",x:0,y:-45,z:55}, {elem:"F",x:48,y:-45,z:-28}, {elem:"F",x:-48,y:-45,z:-28}], [[0,1],[0,2],[0,3]], null, null, "C3v");
addMol("SbCl3|三氯化銻", "Sb", "sp³", ["角錐形","Pyramidal"], "97°", "73.4", "220.3", [{elem:"Sb",x:0,y:15,z:0,lp3d:[{x:0,y:1,z:0}]}, {elem:"Cl",x:0,y:-55,z:65}, {elem:"Cl",x:55,y:-55,z:-35}, {elem:"Cl",x:-55,y:-55,z:-35}], [[0,1],[0,2],[0,3]], null, null, "C3v");
addMol("ICl3|三氯化碘|Iodine Trichloride", "I", "sp³d", ["T型","T-shaped"], "<90°", "101 (分解)", "-", [{elem:"I",x:0,y:0,z:0,lpCount:2,lp3d:[{x:-1,y:0.5,z:0},{x:-1,y:-0.5,z:0}]},{elem:"Cl",x:90,y:0,z:0},{elem:"Cl",x:0,y:90,z:0},{elem:"Cl",x:0,y:-90,z:0}], [[0,1],[0,2],[0,3]], null, '<div class="info-section"><div class="info-title">🧪 物質簡介</div><div class="info-body"><strong>三氯化碘 (ICl₃)</strong><br>中心碘原子採取 sp³d 混成。為了減少電子雲斥力，兩對孤對電子佔據水平位置，使分子呈現 T 型結構。</div></div>', "C2v");
addMol("B2H6|乙硼烷|Diborane", "B", "sp³", ["特殊 (含氫橋鍵)","Banana Bonds"], "120°(端)/97°(橋)", "-164.8", "-92.5", [{elem:"B",x:-40,y:0,z:0,lpCount:0},{elem:"B",x:40,y:0,z:0,lpCount:0},{elem:"H",x:0,y:0,z:50},{elem:"H",x:0,y:0,z:-50},{elem:"H",x:-65,y:43,z:0},{elem:"H",x:-65,y:-43,z:0},{elem:"H",x:65,y:43,z:0},{elem:"H",x:65,y:-43,z:0}], [[0,2],[0,3],[1,2],[1,3],[0,4],[0,5],[1,6],[1,7]], null, '<div class="info-section"><div class="info-title">🍌 結構特性</div><div class="info-body"><strong>乙硼烷 (B₂H₆)</strong><br>具有三中心二電子鍵。每個硼原子與四個氫原子連線，形成類似 sp³ 的幾何排列。</div></div>', "D2h");
// --- 8. 陰離子群 (Complex Anions) ---
addMol("SiF62-|六氟矽酸根", "Si", "sp³d²", ["八面體","Octahedral"], "90°", "-", "-", getOcta("Si","F", 75), [[0,1],[0,2],[0,3],[0,4],[0,5],[0,6]], null, null, "Oh");
addMol("PF6-|六氟磷酸根", "P", "sp³d²", ["八面體","Octahedral"], "90°", "-", "-", getOcta("P","F", 75), [[0,1],[0,2],[0,3],[0,4],[0,5],[0,6]], null, null, "Oh");
addMol("SbF6-|六氟銻酸根", "Sb", "sp³d²", ["八面體","Octahedral"], "90°", "-", "-", getOcta("Sb","F", 80), [[0,1],[0,2],[0,3],[0,4],[0,5],[0,6]], null, null, "Oh");
addMol("I3-|三碘陰離子|三碘錯離子", "I", "sp³d", ["直線型","Linear"], "180°", "-", "-", [{elem:"I",x:0,y:0,z:0,lp3d:[{x:0,y:1,z:0},{x:0,y:-0.5,z:0.866},{x:0,y:-0.5,z:-0.866}]},{elem:"I",x:-100,y:0,z:0},{elem:"I",x:100,y:0,z:0}], [[0,1],[0,2]], null, null, "Dinfh");
addMol("ICl2-|二氯碘離子", "I", "sp³d", ["直線型","Linear"], "180°", "-", "-", [{elem:"I",x:0,y:0,z:0,lp3d:[{x:0,y:1,z:0},{x:0,y:-0.5,z:0.866},{x:0,y:-0.5,z:-0.866}]}, {elem:"Cl",x:-90,y:0,z:0}, {elem:"Cl",x:90,y:0,z:0}], [[0,1],[0,2]], null, null, "Dinfh");
addMol("ICl4-|四氯碘離子", "I", "sp³d²", ["平面四邊形","Square Planar"], "90°", "-", "-", [{elem:"I",x:0,y:0,z:0,lp3d:[{x:0,y:1,z:0}, {x:0,y:-1,z:0}]}, {elem:"Cl",x:90,y:0,z:0}, {elem:"Cl",x:-90,y:0,z:0}, {elem:"Cl",x:0,y:0,z:90}, {elem:"Cl",x:0,y:0,z:-90}], [[0,1],[0,2],[0,3],[0,4]], null, null, "D4h");
addMol("BF4-|四氟硼酸根", "B", "sp³", ["四面體","Tetrahedral"], "109.5°", "-", "-", getTetra("B","F", 70), [[0,1],[0,2],[0,3],[0,4]], null, null, "Td");
addMol("BBF4-|四氟硼酸根", "B", "sp³", ["四面體","Tetrahedral"], "109.5°", "-", "-", getTetra("B","F", 70), [[0,1],[0,2],[0,3],[4,0,"coordinate"]], null, null, "Td");
addMol("AlCl4-|四氯鋁酸根", "Al", "sp³", ["四面體","Tetrahedral"], "109.5°", "-", "-", getTetra("Al","Cl", 80), [[0,1],[0,2],[0,3],[0,4]], null, null, "Td");
addMol("BH4-|硼氫化離子", "B", "sp³", ["四面體","Tetrahedral"], "109.5°", "-", "-", getTetra("B","H", 50), [[0,1],[0,2],[0,3],[0,4]], null, null, "Td");

// --- 9. 酸根與含氧酸 ---
// --- 酸根與含氧酸 (修正離子鍵距離與鍵級顯示) ---
addMol("H2SO4|硫酸系列", "S", "sp³", ["四面體","Tetrahedral"], "109.5°", "10.3", "337", [], [], {
    "H2SO4|硫酸": { pg: "C2", mp: "10.3", bp: "337", desc: "<strong>硫酸</strong><br>工業之母，具強脫水性與氧化性，由兩個配位鍵 (S→O) 與兩個 S-OH 構成，分子電中性。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"O",x:0,y:68,z:0,lpCount:3},{elem:"O",x:0,y:-25,z:-63,lpCount:3},{elem:"O",x:60,y:-30,z:35,lpCount:2},{elem:"O",x:-60,y:-30,z:35,lpCount:2},{elem:"H",x:85,y:5,z:60},{elem:"H",x:-85,y:5,z:60}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"],[3,5],[4,6]] },
    "HSO4-|硫酸氫根": { pg: "Cs", mp: "-", bp: "-", desc: "<strong>硫酸氫根</strong><br>酸式鹽陰離子，水溶液呈強酸性，S-O⁻ 端帶有負電荷。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"O",x:0,y:68,z:0,lpCount:3},{elem:"O",x:0,y:-25,z:-63,lpCount:3},{elem:"O",x:60,y:-30,z:35,lpCount:3},{elem:"O",x:-60,y:-30,z:35,lpCount:2},{elem:"H",x:-85,y:5,z:60}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"],[4,5]] },
    "SO42-|硫酸根": { pg: "Td", mp: "-", bp: "-", desc: "<strong>硫酸根</strong><br>正四面體結構，化學性質穩定，兩個 S-O⁻ 端顯示粉紅電子。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"O",x:0,y:68,z:0,lpCount:3},{elem:"O",x:0,y:-25,z:-63,lpCount:3},{elem:"O",x:60,y:-30,z:35,lpCount:3},{elem:"O",x:-60,y:-30,z:35,lpCount:3}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"]] },
    "NaHSO4|硫酸氫鈉": { pg: "Cs", mp: "58 (分解)", bp: "-", desc: "<strong>硫酸氫鈉</strong><br>溶於水呈強酸性，常用於清潔劑或降低 pH 值。", atoms: [{elem:"S",x:-20,y:0,z:0},{elem:"O",x:-20,y:68,z:0,lpCount:3},{elem:"O",x:-20,y:-25,z:-63,lpCount:3},{elem:"O",x:40,y:-30,z:35,lpCount:3},{elem:"O",x:-80,y:-30,z:35,lpCount:2},{elem:"H",x:-105,y:-5,z:60},{elem:"Na",x:100,y:40,z:0,r:15}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"],[4,5]] },
    "KHSO4|硫酸氫鉀": { pg: "Cs", mp: "197", bp: "-", desc: "<strong>硫酸氫鉀</strong><br>易溶於水呈強酸性，加熱失水可製備焦硫酸鉀。", atoms: [{elem:"S",x:-20,y:0,z:0},{elem:"O",x:-20,y:68,z:0,lpCount:3},{elem:"O",x:-20,y:-25,z:-63,lpCount:3},{elem:"O",x:40,y:-30,z:35,lpCount:3},{elem:"O",x:-80,y:-30,z:35,lpCount:2},{elem:"H",x:-105,y:-5,z:60},{elem:"K",x:110,y:40,z:0,r:22}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"],[4,5]] },
    "CaSO4|硫酸鈣|石膏": { pg: "Td", mp: "1460", bp: "-", desc: "<strong>硫酸鈣 (石膏)</strong><br>微溶於水，廣泛用於建築材料、模型製作與作為豆腐凝固劑。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"O",x:0,y:68,z:0,lpCount:3},{elem:"O",x:0,y:-25,z:-63,lpCount:3},{elem:"O",x:60,y:-30,z:35,lpCount:3},{elem:"O",x:-60,y:-30,z:35,lpCount:3},{elem:"Ca",x:0,y:0,z:100,r:20,lpCount:0}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"]] },
    "BaSO4|硫酸鋇|重晶石": { pg: "Td", mp: "1580", bp: "-", desc: "<strong>硫酸鋇 (重晶石)</strong><br>極難溶於水與酸，無毒且密度大，醫學上用於消化道X光攝影(鋇餐)。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"O",x:0,y:68,z:0,lpCount:3},{elem:"O",x:0,y:-25,z:-63,lpCount:3},{elem:"O",x:60,y:-30,z:35,lpCount:3},{elem:"O",x:-60,y:-30,z:35,lpCount:3},{elem:"Ba",x:0,y:0,z:110,r:25,lpCount:0}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"]] },
    "CuSO4|硫酸銅": { pg: "Td", mp: "110 (失水)", bp: "-", desc: "<strong>硫酸銅</strong><br>無水物為白色，吸水後變藍色(五水合)，常用於游泳池殺菌、波爾多液原料與電鍍。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"O",x:0,y:68,z:0,lpCount:3},{elem:"O",x:0,y:-25,z:-63,lpCount:3},{elem:"O",x:60,y:-30,z:35,lpCount:3},{elem:"O",x:-60,y:-30,z:35,lpCount:3},{elem:"Cu",x:0,y:0,z:100,r:18,lpCount:0}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"]] },
    "FeSO4|硫酸亞鐵|綠礬": { pg: "Td", mp: "64 (失水)", bp: "-", desc: "<strong>硫酸亞鐵 (綠礬)</strong><br>淺綠色晶體，常用於醫療補血劑(鐵劑)、水處理絮凝劑與還原劑。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"O",x:0,y:68,z:0,lpCount:3},{elem:"O",x:0,y:-25,z:-63,lpCount:3},{elem:"O",x:60,y:-30,z:35,lpCount:3},{elem:"O",x:-60,y:-30,z:35,lpCount:3},{elem:"Fe",x:0,y:0,z:100,r:18,lpCount:0}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"]] },
    "ZnSO4|硫酸鋅|皓礬": { pg: "Td", mp: "100 (失水)", bp: "500 (分解)", desc: "<strong>硫酸鋅 (皓礬)</strong><br>無色針狀晶體，用於製造人造纖維、木材防腐與農業微量元素肥料。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"O",x:0,y:68,z:0,lpCount:3},{elem:"O",x:0,y:-25,z:-63,lpCount:3},{elem:"O",x:60,y:-30,z:35,lpCount:3},{elem:"O",x:-60,y:-30,z:35,lpCount:3},{elem:"Zn",x:0,y:0,z:100,r:18,lpCount:0}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"]] },
    "MgSO4|硫酸鎂|瀉鹽": { pg: "Td", mp: "1124", bp: "-", desc: "<strong>硫酸鎂 (瀉鹽)</strong><br>易溶於水，醫療上作為瀉劑或緩解子癇，生活中常用於泡澡浴鹽放鬆肌肉。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"O",x:0,y:68,z:0,lpCount:3},{elem:"O",x:0,y:-25,z:-63,lpCount:3},{elem:"O",x:60,y:-30,z:35,lpCount:3},{elem:"O",x:-60,y:-30,z:35,lpCount:3},{elem:"Mg",x:0,y:0,z:100,r:18,lpCount:0}], bonds: [[0,1,"coordinate"],[0,2,"coordinate"],[0,3,"single"],[0,4,"single"]] }
});

addMol("H2SO3|亞硫酸系列", "S", "sp³", ["角錐形","Pyramidal"], "106°", "-", "不穩定", [], [], {
"H2SO3|亞硫酸": { pg: "Cs", mp: "-", bp: "不穩定", desc: "<strong>亞硫酸</strong><br>僅存在於水溶液中的二元弱酸，極不穩定。具有強還原性與漂白能力，受熱或久置易分解出二氧化硫氣體。", atoms: [{elem:"S",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:80,z:0},{elem:"O",x:55,y:-30,z:30},{elem:"O",x:-55,y:-30,z:30},{elem:"H",x:85,y:-10,z:30},{elem:"H",x:-85,y:-10,z:30}], bonds: [[0,1,"double"],[0,2],[0,3],[2,4],[3,5]] },
"HSO3-|亞硫酸氫根": { pg: "Cs", mp: "-", bp: "-", desc: "<strong>亞硫酸氫根</strong><br>亞硫酸的第一級電離產物，為兩性離子。在酸性環境中不穩定，廣泛存在於亞硫酸氫鹽溶液中，具抗氧化性質。", atoms: [{elem:"S",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:80,z:0},{elem:"O",x:55,y:-30,z:30},{elem:"O",x:-55,y:-30,z:30},{elem:"H",x:85,y:-10,z:30}], bonds: [[0,1,"double"],[0,2],[0,3],[2,4]] },
"SO32-|亞硫酸根": { pg: "C3v", mp: "-", bp: "-", desc: "<strong>亞硫酸根</strong><br>亞硫酸的完全電離產物，中心硫原子有一對孤對電子。具有強還原性，易被空氣中的氧氧化成硫酸根。", atoms: [{elem:"S",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:80,z:0},{elem:"O",x:55,y:-30,z:30},{elem:"O",x:-55,y:-30,z:30}], bonds: [[0,1,"double"],[0,2,"single"],[0,3,"single"]] },
"Na2SO3|亞硫酸鈉": { pg: "C3v", mp: "33.4 (分解)", bp: "-", desc: "<strong>亞硫酸鈉</strong><br>常見的亞硫酸鹽，為白色粉末，易溶於水。常用作還原劑、防腐劑以及攝影顯影劑的保護劑。", atoms: [{elem:"S",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:80,z:0},{elem:"O",x:55,y:-30,z:30},{elem:"O",x:-55,y:-30,z:30},{elem:"Na",x:100,y:20,z:0,r:15},{elem:"Na",x:-100,y:20,z:0,r:15}], bonds: [[0,1,"double"],[0,2,"single"],[0,3,"single"],[4,2,"ionic_thin"],[5,3,"ionic_thin"]] },
"NaHSO3|亞硫酸氫鈉": { pg: "Cs", mp: "150 (分解)", bp: "-", desc: "<strong>亞硫酸氫鈉</strong><br>亞硫酸的酸式鹽，為白色結晶粉末，有二氧化硫的刺激氣氣味。常用於漂白織物、食品防腐及處理工業廢水。", atoms: [{elem:"S",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:80,z:0},{elem:"O",x:55,y:-30,z:30},{elem:"O",x:-55,y:-30,z:30},{elem:"H",x:85,y:-10,z:30},{elem:"Na",x:-100,y:0,z:0,r:15}], bonds: [[0,1,"double"],[0,2],[0,3],[2,4],[5,3,"ionic_thin"]] },
"CaSO3|亞硫酸鈣": { pg: "C3v", mp: "600 (分解)", bp: "-", desc: "<strong>亞硫酸鈣</strong><br>白色結晶粉末，微溶於水。主要用作食品防腐劑、消毒劑，也是煙氣脫硫工藝中的常見產物。", atoms: [{elem:"S",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:80,z:0},{elem:"O",x:55,y:-30,z:30},{elem:"O",x:-55,y:-30,z:30},{elem:"Ca",x:0,y:0,z:90,r:20}], bonds: [[0,1,"double"],[0,2,"single"],[0,3,"single"],[4,2,"ionic_thin"],[4,3,"ionic_thin"]] }
});

addMol("H2S2O3|硫代硫酸系列", "S", "sp³", ["四面體","Tetrahedral"], "109.5°", "-78 (分解)", "-", [], [], {
    "H2S2O3|硫代硫酸": { pg: "Cs", mp: "-78", bp: "-", desc: "<strong>硫代硫酸</strong><br>不穩定酸，中心S連接另一個外圍S原子。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"S",x:0,y:80,z:0},{elem:"O",x:0,y:-25,z:-63},{elem:"O",x:60,y:-30,z:35},{elem:"O",x:-60,y:-30,z:35},{elem:"H",x:85,y:5,z:60},{elem:"H",x:-85,y:5,z:60}], bonds: [[0,1,"double"],[0,2,"double"],[0,3],[0,4],[3,5],[4,6]] },
    "HS2O3-|硫代硫酸氫根": { pg: "Cs", mp: "-", bp: "-", desc: "<strong>硫代硫酸氫根</strong><br>結構類似硫酸氫根但一個O被S取代。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"S",x:0,y:80,z:0},{elem:"O",x:0,y:-25,z:-63},{elem:"O",x:60,y:-30,z:35},{elem:"O",x:-60,y:-30,z:35},{elem:"H",x:85,y:5,z:60}], bonds: [[0,1,"double"],[0,2,"double"],[0,3],[0,4],[3,5]] },
    "S2O32-|硫代硫酸根": { pg: "C3v", mp: "-", bp: "-", desc: "<strong>硫代硫酸根</strong><br>具還原性，中心硫原子與外圍硫形成雙鍵。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"S",x:0,y:80,z:0},{elem:"O",x:0,y:-25,z:-63},{elem:"O",x:60,y:-30,z:35},{elem:"O",x:-60,y:-30,z:35}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"],[0,4,"single"]] },
    "Na2S2O3|硫代硫酸鈉|大蘇打|海波": { pg: "C3v", mp: "48.3", bp: "100 (分解)", desc: "<strong>硫代硫酸鈉 (海波)</strong><br>Na⁺ 位於結構外側，無實體鍵連線。", atoms: [{elem:"S",x:0,y:0,z:0},{elem:"S",x:0,y:80,z:0},{elem:"O",x:0,y:-25,z:-63},{elem:"O",x:60,y:-30,z:35},{elem:"O",x:-60,y:-30,z:35},{elem:"Na",x:100,y:20,z:0,r:15},{elem:"Na",x:-100,y:20,z:0,r:15}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"],[0,4,"single"]] }
});

addMol("H2CO3|碳酸系列", "C", "sp²", ["平面三角形","Trigonal Planar"], "120°", "-", "不穩定", [], [], {
    "H2CO3|碳酸": { pg: "Cs", mp: "-", bp: "不穩定", desc: "<strong>碳酸</strong><br>二質子弱酸，存在於汽水中。", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"O",x:0,y:70,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0},{elem:"H",x:90,y:-10,z:0},{elem:"H",x:-90,y:-10,z:0}], bonds: [[0,1,"double"],[0,2],[0,3],[2,4],[3,5]] },
    "HCO3-|碳酸氫根": { pg: "Cs", mp: "-", bp: "-", desc: "<strong>碳酸氫根</strong><br>帶-1價電荷，小蘇打的主要成分。", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"O",x:0,y:70,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0},{elem:"H",x:-90,y:-10,z:0}], bonds: [[0,1,"double"],[0,2],[0,3],[3,4]] },
    "CO32-|碳酸根": { pg: "D3h", mp: "-", bp: "-", desc: "<strong>碳酸根</strong><br>帶-2價電荷，共振結構。", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"O",x:0,y:70,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0}], bonds: [[0,1,"double"],[0,2,"single"],[0,3,"single"]] },
    "CaCO3|碳酸鈣|灰石": { pg: "D3h", mp: "825 (分解)", bp: "-", desc: "<strong>碳酸鈣</strong><br>Ca²⁺ 位於碳酸根平面上方。", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"O",x:0,y:70,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0},{elem:"Ca",x:0,y:0,z:90,r:20,lpCount:0}], bonds: [[0,1,"double"],[0,2,"single"],[0,3,"single"]] },
    "MgCO3|碳酸鎂": { pg: "D3h", mp: "350 (分解)", bp: "-", desc: "<strong>碳酸鎂</strong><br>Mg²⁺ 位於碳酸根平面上方。", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"O",x:0,y:70,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0},{elem:"Mg",x:0,y:0,z:90,r:18,lpCount:0}], bonds: [[0,1,"double"],[0,2,"single"],[0,3,"single"]] },
    "Na2CO3|碳酸鈉|蘇打": { pg: "D3h", mp: "851", bp: "-", desc: "<strong>碳酸鈉 (蘇打)</strong><br>兩個 Na⁺ 位於外側。", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"O",x:0,y:70,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0},{elem:"Na",x:100,y:-20,z:0,r:15},{elem:"Na",x:-100,y:-20,z:0,r:15}], bonds: [[0,1,"double"],[0,2,"single"],[0,3,"single"]] },
    "K2CO3|碳酸鉀|草木灰": { pg: "D3h", mp: "891", bp: "-", desc: "<strong>碳酸鉀</strong><br>兩個 K⁺ 位於外側。", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"O",x:0,y:70,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0},{elem:"K",x:100,y:-20,z:0,r:22},{elem:"K",x:-100,y:-20,z:0,r:22}], bonds: [[0,1,"double"],[0,2,"single"],[0,3,"single"]] },
    "NaHCO3|碳酸氫鈉|小蘇打": { pg: "Cs", mp: "50 (分解)", bp: "-", desc: "<strong>碳酸氫鈉</strong><br>Na⁺ 位於外側。", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"O",x:0,y:70,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"O",x:-60,y:-35,z:0},{elem:"H",x:-90,y:-10,z:0},{elem:"Na",x:100,y:-20,z:0,r:15}], bonds: [[0,1,"double"],[0,2],[0,3],[3,4]] }
});

addMol("HNO3|硝酸系列", "N", "sp²", ["平面三角形","Trigonal Planar"], "120°", "-42", "83", [], [], {
    "HNO3|硝酸": { pg: "Cs", mp: "-42", bp: "83", desc: "<strong>硝酸</strong><br>強酸及強氧化劑。光照易分解產生紅棕色 NO₂。", atoms: [{elem:"N",x:0,y:0,z:0,lpCount:0}, {elem:"O",x:0,y:68,z:0}, {elem:"O",x:-59,y:-34,z:0}, {elem:"O",x:59,y:-34,z:0,lpCount:2}, {elem:"H",x:90,y:-15,z:0}], bonds: [[0,1,"double"], [0,2,"coordinate"], [0,3], [3,4]] },
    "NO3-|硝酸根": { pg: "D3h", mp: "-", bp: "-", desc: "<strong>硝酸根</strong><br>具有高度對稱的平面結構 (共振)。", atoms: [{elem:"N",x:0,y:0,z:0,lpCount:0}, {elem:"O",x:0,y:68,z:0}, {elem:"O",x:-59,y:-34,z:0}, {elem:"O",x:59,y:-34,z:0}], bonds: [[0,1,"double"], [0,2,"coordinate"], [0,3]] },
    "KNO3|硝酸鉀|硝石": { pg: "D3h", mp: "334", bp: "400 (分解)", desc: "<strong>硝酸鉀</strong><br>俗稱硝石。K⁺ 位於結構上方。", atoms: [{elem:"N",x:0,y:0,z:0,lpCount:0}, {elem:"O",x:0,y:68,z:0}, {elem:"O",x:-59,y:-34,z:0}, {elem:"O",x:59,y:-34,z:0}, {elem:"K",x:0,y:0,z:90,r:22,lpCount:0}], bonds: [[0,1,"double"], [0,2,"coordinate"], [0,3]] },
    "NaNO3|硝酸鈉|智利硝石": { pg: "D3h", mp: "308", bp: "380 (分解)", desc: "<strong>硝酸鈉</strong><br>俗稱智利硝石。Na⁺ 位於結構上方。", atoms: [{elem:"N",x:0,y:0,z:0,lpCount:0}, {elem:"O",x:0,y:68,z:0}, {elem:"O",x:-59,y:-34,z:0}, {elem:"O",x:59,y:-34,z:0}, {elem:"Na",x:0,y:0,z:85,r:15,lpCount:0}], bonds: [[0,1,"double"], [0,2,"coordinate"], [0,3]] },
    "AgNO3|硝酸銀": { pg: "D3h", mp: "212", bp: "444 (分解)", desc: "<strong>硝酸銀</strong><br>Ag⁺ 位於結構上方。", atoms: [{elem:"N",x:0,y:0,z:0,lpCount:0}, {elem:"O",x:0,y:68,z:0}, {elem:"O",x:-59,y:-34,z:0}, {elem:"O",x:59,y:-34,z:0}, {elem:"Ag",x:0,y:0,z:90,r:18,lpCount:0}], bonds: [[0,1,"double"], [0,2,"coordinate"], [0,3]] },
    "Cu(NO3)2|硝酸銅": { pg: "D3h", mp: "114", bp: "170 (分解)", desc: "<strong>硝酸銅</strong><br>藍色晶體。Cu²⁺ 。", atoms: [{elem:"Cu",x:0,y:0,z:0,r:18,lpCount:0}, {elem:"N",x:-90,y:0,z:0,lpCount:0}, {elem:"O",x:-145,y:0,z:0}, {elem:"O",x:-60,y:45,z:35}, {elem:"O",x:-60,y:-45,z:-35}, {elem:"N",x:90,y:0,z:0,lpCount:0}, {elem:"O",x:145,y:0,z:0}, {elem:"O",x:60,y:45,z:35}, {elem:"O",x:60,y:-45,z:-35}], bonds: [[1,2,"double"],[1,3,"coordinate"],[1,4,"single"], [5,6,"double"],[5,7,"coordinate"],[5,8,"single"]] }
});

addMol("HNO2|亞硝酸系列", "N", "sp²", ["角形","Bent"], "111°", "-", "不穩定", [], [], {
    "HNO2|亞硝酸": { pg: "Cs", mp: "-", bp: "不穩定", desc: "<strong>亞硝酸</strong><br>弱酸，N原子上有一對孤對電子。", atoms: [{elem:"N",x:0,y:0,z:0,lpCount:1},{elem:"O",x:0,y:65,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"H",x:90,y:-10,z:0}], bonds: [[0,1,"double"],[0,2],[2,3]] },
    "NO2-|亞硝酸根": { pg: "C2v", mp: "-", bp: "-", desc: "<strong>亞硝酸根</strong><br>常見的防腐劑成分(亞硝酸鹽)，結構呈V型。", atoms: [{elem:"N",x:0,y:0,z:0,lpCount:1},{elem:"O",x:0,y:65,z:0},{elem:"O",x:60,y:-35,z:0}], bonds: [[0,1,"double"],[0,2]] },
    "NaNO2|亞硝酸鈉": { pg: "C2v", mp: "271", bp: "320 (分解)", desc: "<strong>亞硝酸鈉</strong><br>Na⁺ 位於外側。", atoms: [{elem:"N",x:0,y:0,z:0,lpCount:1},{elem:"O",x:0,y:65,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"Na",x:-80,y:0,z:0,r:15}], bonds: [[0,1,"double"],[0,2]] },
    "KNO2|亞硝酸鉀": { pg: "C2v", mp: "440 (分解)", bp: "-", desc: "<strong>亞硝酸鉀</strong><br>K⁺ 位於外側。", atoms: [{elem:"N",x:0,y:0,z:0,lpCount:1},{elem:"O",x:0,y:65,z:0},{elem:"O",x:60,y:-35,z:0},{elem:"K",x:-85,y:0,z:0,r:22}], bonds: [[0,1,"double"],[0,2]] }
});

addMol("H3PO4|磷酸系列", "P", "sp³", ["四面體","Tetrahedral"], "109.5°", "42.4", "213 (分解)", [], [], {
    "H3PO4|磷酸": { pg: "Cs", mp: "42.4", bp: "213 (分解)", desc: "<strong>磷酸</strong><br>三質子酸，含一個 P=O 與三個 P-OH。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35,lpCount:2},{elem:"O",x:-55,y:-30,z:35,lpCount:2},{elem:"O",x:0,y:-30,z:-60,lpCount:2},{elem:"H",x:80,y:-10,z:55},{elem:"H",x:-80,y:-10,z:55},{elem:"H",x:0,y:-10,z:-90}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4],[2,5],[3,6],[4,7]] },
    "H2PO4-|磷酸二氫根": { pg: "C2v", mp: "-", bp: "-", desc: "<strong>磷酸二氫根</strong><br>帶 -1 價電荷。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35,lpCount:2},{elem:"O",x:-55,y:-30,z:35,lpCount:2},{elem:"O",x:0,y:-30,z:-60},{elem:"H",x:80,y:-10,z:55},{elem:"H",x:-80,y:-10,z:55}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4],[2,5],[3,6]] },
    "HPO42-|磷酸氫根": { pg: "C3v", mp: "-", bp: "-", desc: "<strong>磷酸氫根</strong><br>帶 -2 價電荷。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35,lpCount:2},{elem:"O",x:-55,y:-30,z:35},{elem:"O",x:0,y:-30,z:-60},{elem:"H",x:80,y:-10,z:55}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4],[2,5]] },
    "PO43-|磷酸根": { pg: "Td", mp: "-", bp: "-", desc: "<strong>磷酸根</strong><br>正四面體結構，四個 P-O 鍵長均等。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35},{elem:"O",x:-55,y:-30,z:35},{elem:"O",x:0,y:-30,z:-60}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4]] },
    "Ca3(PO4)2|磷酸鈣": { pg: "Td", mp: "1670", bp: "-", desc: "<strong>磷酸鈣</strong><br>難溶於水，變量原料。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35},{elem:"O",x:-55,y:-30,z:35},{elem:"O",x:0,y:-30,z:-60},{elem:"Ca",x:100,y:40,z:0,r:20},{elem:"Ca",x:-100,y:40,z:0,r:20},{elem:"Ca",x:0,y:-100,z:0,r:20}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4]] },
    "Na3PO4|磷酸鈉": { pg: "Td", mp: "1583", bp: "-", desc: "<strong>磷酸鈉</strong><br>強鹼性鹽類。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35},{elem:"O",x:-55,y:-30,z:35},{elem:"O",x:0,y:-30,z:-60},{elem:"Na",x:90,y:30,z:0,r:15},{elem:"Na",x:-90,y:30,z:0,r:15},{elem:"Na",x:0,y:-90,z:0,r:15}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4]] },
    "Ca(H2PO4)2|磷酸二氫鈣": { pg: "C2v", mp: "109 (分解)", bp: "-", desc: "<strong>磷酸二氫鈣</strong><br>肥料成分。", atoms: [{elem:"Ca",x:0,y:0,z:0,r:20}, {elem:"P",x:-100,y:0,z:0}, {elem:"O",x:-100,y:65,z:0}, {elem:"O",x:-100,y:-30,z:55}, {elem:"O",x:-145,y:-30,z:-30}, {elem:"O",x:-55,y:-30,z:-30}, {elem:"H",x:-145,y:-60,z:55}, {elem:"H",x:-175,y:-10,z:-30}, {elem:"P",x:100,y:0,z:0}, {elem:"O",x:100,y:65,z:0}, {elem:"O",x:100,y:-30,z:55}, {elem:"O",x:145,y:-30,z:-30}, {elem:"O",x:55,y:-30,z:-30}, {elem:"H",x:145,y:-60,z:55}, {elem:"H",x:175,y:-10,z:-30}], bonds: [[1,2,"double"],[1,3],[1,4],[1,5],[3,6],[4,7], [8,9,"double"],[8,10],[8,11],[8,12],[10,13],[11,14]] }
});

addMol("H3PO3|亞磷酸系列", "P", "sp³", ["四面體","Tetrahedral"], "109.5°", "73.6", "200 (分解)", [], [], {
    "H3PO3|亞磷酸": { pg: "Cs", mp: "73.6", bp: "200 (分解)", desc: "<strong>亞磷酸</strong><br>二質子酸，含一個 P-H 鍵 (不解離) 與兩個 P-OH。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35,lpCount:2},{elem:"O",x:-55,y:-30,z:35,lpCount:2},{elem:"H",x:0,y:-40,z:-60},{elem:"H",x:90,y:-10,z:60},{elem:"H",x:-90,y:-10,z:60}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4],[2,5],[3,6]] },
    "H2PO3-|亞磷酸氫根": { pg: "Cs", mp: "-", bp: "-", desc: "<strong>亞磷酸二氫根</strong><br>帶 -1 價電荷，P-H 鍵保留。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35,lpCount:2},{elem:"O",x:-55,y:-30,z:35,lpCount:2},{elem:"H",x:0,y:-40,z:-60},{elem:"H",x:90,y:-10,z:60}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4],[2,5]] },
    "HPO32-|亞磷酸根": { pg: "C3v", mp: "-", bp: "-", desc: "<strong>亞磷酸氫根 (亞磷酸根)</strong><br>帶 -2 價電荷，P-H 鍵通常不解離。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35},{elem:"O",x:-55,y:-30,z:35},{elem:"H",x:0,y:-40,z:-60}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4]] },
    "Na2HPO3|亞磷酸鈉": { pg: "C3v", mp: "-", bp: "-", desc: "<strong>亞磷酸鈉</strong><br>正鹽，P 直接連有一個 H。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:55,y:-30,z:35},{elem:"O",x:-55,y:-30,z:35},{elem:"H",x:0,y:-40,z:-60},{elem:"Na",x:90,y:20,z:0,r:15},{elem:"Na",x:-90,y:20,z:0,r:15}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4]] }
});

addMol("H3PO2|次磷酸系列", "P", "sp³", ["四面體","Tetrahedral"], "109.5°", "26.5", "130 (分解)", [], [], {
    "H3PO2|次磷酸": { pg: "Cs", mp: "26.5", bp: "130 (分解)", desc: "<strong>次磷酸</strong><br>單質子酸，含兩個 P-H 鍵與一個 P-OH。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:0,y:-30,z:-60,lpCount:2},{elem:"H",x:55,y:-35,z:35},{elem:"H",x:-55,y:-35,z:35},{elem:"H",x:0,y:-10,z:-100}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4],[2,5]] },
    "H2PO2-|次磷酸根": { pg: "C2v", mp: "-", bp: "-", desc: "<strong>次磷酸根</strong><br>帶 -1 價電荷。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:0,y:-30,z:-60},{elem:"H",x:55,y:-35,z:35},{elem:"H",x:-55,y:-35,z:35}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4]] },
    "NaH2PO2|次磷酸鈉": { pg: "C2v", mp: "90 (一水合)", bp: "-", desc: "<strong>次磷酸鈉</strong><br>強還原劑。", atoms: [{elem:"P",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:0,y:-30,z:-60},{elem:"H",x:55,y:-35,z:35},{elem:"H",x:-55,y:-35,z:35},{elem:"Na",x:-85,y:0,z:0,r:15}], bonds: [[0,1,"double"],[0,2],[0,3],[0,4]] }
});

addMol("HClO4|過氯酸系列", "Cl", "sp³", ["四面體","Tetrahedral"], "109.5°", "-112", "19 (分解)", [], [], {
    "HClO4|過氯酸": { pg: "Cs", mp: "-112", bp: "19 (分解)", desc: "<strong>過氯酸</strong><br>最強無機酸之一，正四面體結構。氯原子與三個氧形成雙鍵，與一個羥基形成單鍵。", atoms: [{elem:"Cl",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:58,y:-25,z:35,lpCount:2},{elem:"O",x:-58,y:-25,z:35,lpCount:2},{elem:"O",x:0,y:-25,z:-65,lpCount:2},{elem:"H",x:0,y:-5,z:-105}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"double"],[0,4,"single"],[4,5]] },
    "ClO4-|過氯酸根": { pg: "Td", mp: "-", bp: "-", desc: "<strong>過氯酸根</strong><br>化學性質穩定，四個 Cl-O 鍵長因共振而均等 (-1價)。", atoms: [{elem:"Cl",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:58,y:-25,z:35},{elem:"O",x:-58,y:-25,z:35},{elem:"O",x:0,y:-25,z:-65}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"double"],[0,4,"single"]] },
    "Mg(ClO4)2|過氯酸鎂": { pg: "Td", mp: "251", bp: "-", desc: "<strong>過氯酸鎂</strong><br>極強的脫水劑（乾燥劑）。", atoms: [{elem:"Mg",x:0,y:0,z:0,r:20,lpCount:0}, {elem:"Cl",x:-130,y:0,z:0,lpCount:0},{elem:"O",x:-130,y:68,z:0},{elem:"O",x:-72,y:-25,z:35},{elem:"O",x:-188,y:-25,z:35},{elem:"O",x:-130,y:-25,z:-65}, {elem:"Cl",x:130,y:0,z:0,lpCount:0},{elem:"O",x:130,y:68,z:0},{elem:"O",x:72,y:-25,z:35},{elem:"O",x:188,y:-25,z:35},{elem:"O",x:130,y:-25,z:-65}], bonds: [[1,2,"double"],[1,3,"double"],[1,4,"double"],[1,5,"single"], [6,7,"double"],[6,8,"double"],[6,9,"double"],[6,10,"single"]] },
    "KClO4|過氯酸鉀": { pg: "Td", mp: "610 (分解)", bp: "-", desc: "<strong>過氯酸鉀</strong><br>強氧化劑，用於煙火（紫色火焰）。", atoms: [{elem:"Cl",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:58,y:-25,z:35},{elem:"O",x:-58,y:-25,z:35},{elem:"O",x:0,y:-25,z:-65},{elem:"K",x:0,y:0,z:95,r:22}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"double"],[0,4,"single"]] },
    "NH4ClO4|過氯酸銨": { pg: "Td", mp: "240 (分解)", bp: "-", desc: "<strong>過氯酸銨 (AP)</strong><br>固體火箭燃料氧化劑。", atoms: [{elem:"Cl",x:0,y:0,z:0,lpCount:0},{elem:"O",x:0,y:68,z:0},{elem:"O",x:58,y:-25,z:35},{elem:"O",x:-58,y:-25,z:35},{elem:"O",x:0,y:-25,z:-65},{elem:"N",x:110,y:0,z:0,r:18},{elem:"H",x:110,y:40,z:0},{elem:"H",x:110,y:-20,z:35},{elem:"H",x:110,y:-20,z:-35},{elem:"H",x:145,y:0,z:0}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"double"],[0,4,"single"],[5,6],[5,7],[5,8],[5,9]] }
});

addMol("HClO3|氯酸系列", "Cl", "sp³", ["角錐形","Pyramidal"], "107°", "-20", "分解", [], [], {
    "HClO3|氯酸": { pg: "Cs", mp: "-20", bp: "分解", desc: "<strong>氯酸</strong><br>強酸，具有強氧化性，中心有一對孤對電子。", atoms: [{elem:"Cl",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28,lpCount:2},{elem:"H",x:-90,y:-20,z:-55}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"],[3,4]] },
    "ClO3-|氯酸根": { pg: "C3v", mp: "-", bp: "-", desc: "<strong>氯酸根</strong><br>三角錐形結構，常用於火藥與炸藥。", atoms: [{elem:"Cl",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"]] },
    "KClO3|氯酸鉀": { pg: "C3v", mp: "356", bp: "400 (分解)", desc: "<strong>氯酸鉀</strong><br>強氧化劑，受熱分解產生氧氣。", atoms: [{elem:"Cl",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28},{elem:"K",x:0,y:0,z:85,r:22}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"]] },
    "NaClO3|氯酸鈉": { pg: "C3v", mp: "248", bp: "300 (分解)", desc: "<strong>氯酸鈉</strong><br>工業漂白與除草劑原料。", atoms: [{elem:"Cl",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28},{elem:"Na",x:0,y:0,z:80,r:15}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"]] }
});

addMol("HClO2|亞氯酸系列", "Cl", "sp³", ["角形","Bent"], "111°", "-", "不穩定", [], [], {
    "HClO2|亞氯酸": { pg: "Cs", mp: "-", bp: "不穩定", desc: "<strong>亞氯酸</strong><br>弱酸，結構呈V型，中心有兩對孤對電子。", atoms: [{elem:"Cl",x:0,y:5,z:0,lpCount:2},{elem:"O",x:55,y:-35,z:0},{elem:"O",x:-55,y:-35,z:0,lpCount:2},{elem:"H",x:-90,y:-20,z:0}], bonds: [[0,1,"double"],[0,2,"single"],[2,3]] },
    "ClO2-|亞氯酸根": { pg: "C2v", mp: "-", bp: "-", desc: "<strong>亞氯酸根</strong><br>V型結構，常用於漂白劑。", atoms: [{elem:"Cl",x:0,y:5,z:0,lpCount:2},{elem:"O",x:55,y:-35,z:0},{elem:"O",x:-55,y:-35,z:0}], bonds: [[0,1,"double"],[0,2,"single"]] },
    "NaClO2|亞氯酸鈉": { pg: "C2v", mp: "170 (分解)", bp: "-", desc: "<strong>亞氯酸鈉</strong><br>高效漂白劑，反應可生成二氧化氯 (ClO₂)。", atoms: [{elem:"Cl",x:0,y:5,z:0,lpCount:2},{elem:"O",x:55,y:-35,z:0},{elem:"O",x:-55,y:-35,z:0},{elem:"Na",x:-90,y:0,z:0,r:15}], bonds: [[0,1,"double"],[0,2,"single"]] }
});

addMol("HClO|次氯酸系列", "O", "sp³", ["角形","Bent"], "104.5°", "-", "不穩定", [], [], {
    "HClO|次氯酸": { pg: "Cs", mp: "-", bp: "不穩定", desc: "<strong>次氯酸</strong><br>弱酸，殺菌力強，結構 H-O-Cl。", atoms: [{elem:"O",x:0,y:10,z:0,lpCount:2},{elem:"Cl",x:65,y:-25,z:0},{elem:"H",x:-35,y:-20,z:0}], bonds: [[0,1],[0,2]] },
    "ClO-|次氯酸根": { pg: "Cinfv", mp: "-", bp: "-", desc: "<strong>次氯酸根</strong><br>漂白水有效成分。", atoms: [{elem:"Cl",x:-35,y:0,z:0,lpCount:3},{elem:"O",x:35,y:0,z:0,lpCount:3}], bonds: [[0,1]] },
    "NaClO|次氯酸鈉|漂白水": { pg: "Cinfv", mp: "18 (五水合)", bp: "分解", desc: "<strong>次氯酸鈉 (漂白水)</strong><br>家用漂白劑。Na⁺ 與 ClO⁻ 之間為離子鍵。", atoms: [{elem:"Cl",x:-35,y:0,z:0,lpCount:3},{elem:"O",x:35,y:0,z:0,lpCount:3},{elem:"Na",x:85,y:0,z:0,r:15}], bonds: [[0,1]] },
    "Ca(ClO)2|次氯酸鈣|漂白粉": { pg: "Cinfv", mp: "100 (分解)", bp: "-", desc: "<strong>次氯酸鈣</strong><br>漂白粉主要成分。", atoms: [{elem:"Cl",x:-55,y:0,z:0,lpCount:3},{elem:"O",x:15,y:0,z:0,lpCount:3},{elem:"Ca",x:60,y:0,z:0,r:20},{elem:"O",x:105,y:0,z:0,lpCount:3},{elem:"Cl",x:175,y:0,z:0,lpCount:3}], bonds: [[0,1], [3,4]] }
});

addMol("HBrO3|溴酸系列", "Br", "sp³", ["角錐形","Pyramidal"], "107°", "-", "不穩定", [], [], {
    "HBrO3|溴酸": { pg: "Cs", mp: "-", bp: "不穩定", desc: "<strong>溴酸</strong><br>強酸，中心有一對孤對電子。", atoms: [{elem:"Br",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28,lpCount:2},{elem:"H",x:-90,y:-20,z:-55}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"],[3,4]] },
    "BrO3-|溴酸根": { pg: "C3v", mp: "-", bp: "-", desc: "<strong>溴酸根</strong><br>三角錐形結構。", atoms: [{elem:"Br",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"]] },
    "KBrO3|溴酸鉀": { pg: "C3v", mp: "350 (分解)", bp: "-", desc: "<strong>溴酸鉀</strong><br>強氧化劑，K⁺ 位於外側。", atoms: [{elem:"Br",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28},{elem:"K",x:0,y:60,z:0,r:22}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"]] },
    "AgBrO3|溴酸銀": { pg: "C3v", mp: "-", bp: "-", desc: "<strong>溴酸銀</strong><br>難溶於水的白色固體。", atoms: [{elem:"Br",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28},{elem:"Ag",x:0,y:60,z:0,r:18}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"]] }
});

addMol("HIO3|碘酸系列", "I", "sp³", ["角錐形","Pyramidal"], "107°", "110", "分解", [], [], {
    "HIO3|碘酸": { pg: "Cs", mp: "110", bp: "分解", desc: "<strong>碘酸</strong><br>穩定的白色固體，強酸。", atoms: [{elem:"I",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28,lpCount:2},{elem:"H",x:-90,y:-20,z:-55}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"],[3,4]] },
    "IO3-|碘酸根": { pg: "C3v", mp: "-", bp: "-", desc: "<strong>碘酸根</strong><br>三角錐形結構。", atoms: [{elem:"I",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"]] },
    "KIO3|碘酸鉀": { pg: "C3v", mp: "560 (分解)", bp: "-", desc: "<strong>碘酸鉀</strong><br>食鹽加碘成分，K⁺ 位於外側。", atoms: [{elem:"I",x:0,y:15,z:0,lpCount:1},{elem:"O",x:0,y:-40,z:50},{elem:"O",x:48,y:-40,z:-28},{elem:"O",x:-48,y:-40,z:-28},{elem:"K",x:0,y:60,z:0,r:22}], bonds: [[0,1,"double"],[0,2,"double"],[0,3,"single"]] }
});

// --- 11. 簡單有機分子與衍生物 (鍵長修正: C-H=50, C-C=70, C-N=70, C=O=68, C-Cl=75) ---
addMol("CH3NO2|硝基甲烷", "C", "sp3", ["正四面體","Tetrahedral"], "109.5°", "-29", "101.2", [{elem:"O",x:-65,y:50,z:0,lpCount:3},{elem:"O",x:-65,y:-50,z:0},{elem:"N",x:-35,y:0,z:0,lpCount:0},{elem:"C",x:35,y:0,z:0},{elem:"H",x:55,y:-35,z:-25},{elem:"H",x:55,y:35,z:-25},{elem:"H",x:55,y:0,z:45}], [[2,0,"coordinate"],[1,2,"double"],[2,3],[3,4],[3,5],[3,6]], null, null, "Cs");
addMol("C2H6|乙烷", "C", "sp³", ["四面體連結","Tetrahedral"], "109.5°", "-182.8", "-88.6", [{elem:"C",x:-35,y:0,z:0}, {elem:"C",x:35,y:0,z:0}, {elem:"H",x:-65,y:35,z:0}, {elem:"H",x:-65,y:-25,z:30}, {elem:"H",x:-65,y:-25,z:-30}, {elem:"H",x:65,y:-35,z:0}, {elem:"H",x:65,y:25,z:30}, {elem:"H",x:65,y:25,z:-30}], [[0,1], [0,2], [0,3], [0,4], [1,5], [1,6], [1,7]], null, null, "D3d");
addMol("CH3Cl|一氯甲烷|氯甲烷", "C", "sp3", ["正四面體","Tetrahedral"], "109.5°", "-97.4", "-24.2", [{elem:"Cl",x:75,y:0,z:0},{elem:"C",x:0,y:0,z:0},{elem:"H",x:-30,y:30,z:30},{elem:"H",x:-30,y:-40,z:10},{elem:"H",x:-30,y:10,z:-40}], [[0,1],[1,2],[1,3],[1,4]], null, null, "C3v");
addMol("C2H4|乙烯", "C", "sp²", ["平面","Planar"], "120°", "-169.2", "-103.7", [{elem:"C",x:-32,y:0,z:0}, {elem:"C",x:32,y:0,z:0}, {elem:"H",x:-67,y:45,z:0}, {elem:"H",x:-67,y:-45,z:0}, {elem:"H",x:67,y:45,z:0}, {elem:"H",x:67,y:-45,z:0}], [[0,1,"double"], [0,2], [0,3], [1,4], [1,5]], null, null, "D2h");
addMol("C2H2|乙炔", "C", "sp", ["直線型","Linear"], "180°", "-80.8", "-84 (昇華)", [{elem:"C",x:-30,y:0,z:0}, {elem:"C",x:30,y:0,z:0}, {elem:"H",x:-80,y:0,z:0}, {elem:"H",x:80,y:0,z:0}], [[0,1,"triple"], [0,2], [1,3]], null, null, "Dinfh");

addMol("C2H2", "C", "sp", ["直線型","Linear"], "180°", "-80.8", "-84", [], [], {
    "C2H2|乙炔": { pg: "Dinfh", mp: "-80.8", bp: "-84", atoms: [{elem:"C",x:-30,y:0,z:0},{elem:"C",x:30,y:0,z:0},{elem:"H",x:-80,y:0,z:0},{elem:"H",x:80,y:0,z:0}], bonds: [[0,1,"triple"], [0,2], [1,3]] }
});

addMol("N2H4|聯氨|肼", "N", "sp³", ["扭轉型","Gauche"], "107°", "2", "114", [{elem:"N",x:-35,y:0,z:0}, {elem:"N",x:35,y:0,z:0}, {elem:"H",x:-60,y:35,z:25}, {elem:"H",x:-60,y:-35,z:25}, {elem:"H",x:60,y:35,z:-25}, {elem:"H",x:60,y:-35,z:-25}], [[0,1], [0,2], [0,3], [1,4], [1,5]], null, null, "C2");

addMol("C3H6O|丙醛/丙酮 (同分異構)", "C", "sp²", ["平面/四面體","Mixed"], "120°", "-81", "48", [], [], 
    {
        "C2H5CHO|丙醛": { pg: "Cs", mp: "-81", bp: "48", atoms: [{elem:"O",x:-86,y:35,z:0},{elem:"C",x:5,y:-25,z:0},{elem:"C",x:45,y:35,z:0},{elem:"C",x:-60,y:-15,z:0},{elem:"H",x:15,y:-55,z:40},{elem:"H",x:15,y:-55,z:-40},{elem:"H",x:35,y:65,z:-40},{elem:"H",x:35,y:65,z:40},{elem:"H",x:95,y:25,z:0},{elem:"H",x:-85,y:-60,z:0}],  bonds: [[0,3,"double"],[1,2],[1,3],[1,4],[1,5],[2,6],[2,7],[2,8],[3,9]] },
        "CH3COCH3|丙酮": { pg: "C2v", mp: "-94.7", bp: "56.1", atoms: [{elem:"O",x:0,y:85,z:0},{elem:"C",x:0,y:20,z:0},{elem:"C",x:60,y:-15,z:0},{elem:"C",x:-60,y:-15,z:0},{elem:"H",x:60,y:-45,z:-40},{elem:"H",x:60,y:-45,z:40},{elem:"H",x:100,y:15,z:0},{elem:"H",x:-100,y:15,z:0},{elem:"H",x:-60,y:-45,z:-40},{elem:"H",x:-60,y:-45,z:40}], bonds: [[0,1,"double"],[1,2],[1,3],[2,4],[2,5],[2,6],[3,7],[3,8],[3,9]] }
    }
);

addMol("CH3NH2|甲胺|甲基胺", "N", "sp³", ["角錐形 (N端)","Pyramidal"], "107°", "-93", "-6.3", [{elem:"N",x:0,y:15,z:0,lp3d:[{x:0,y:1,z:0}]}, {elem:"H",x:30,y:-25,z:20}, {elem:"H",x:-30,y:-25,z:20}, {elem:"C",x:0,y:-25,z:-35}, {elem:"H",x:0,y:5,z:-65}, {elem:"H",x:25,y:-40,z:-55}, {elem:"H",x:-25,y:-40,z:-55}], [[0,1],[0,2],[0,3],[3,4],[3,5],[3,6]], null, null, "Cs");
addMol("CH3OCH3|甲醚|二甲醚", "O", "sp³", ["角形 (中心)","Bent"], "111°", "-141", "-24.8", [{elem:"O",x:0,y:15,z:0,lp3d:[{x:0,y:1,z:1},{x:0,y:1,z:-1}]}, {elem:"C",x:50,y:-20,z:0}, {elem:"C",x:-50,y:-20,z:0}, {elem:"H",x:80,y:0,z:0}, {elem:"H",x:50,y:-50,z:25}, {elem:"H",x:50,y:-50,z:-25}, {elem:"H",x:-80,y:0,z:0}, {elem:"H",x:-50,y:-50,z:25}, {elem:"H",x:-50,y:-50,z:-25}], [[0,1],[0,2],[1,3],[1,4],[1,5],[2,6],[2,7],[2,8]], null, null, "C2v");
addMol("HCOOH|甲酸|蟻酸", "C", "sp²", ["平面","Planar"], "120°", "8.4", "100.8", [{elem:"C",x:0,y:0,z:0}, {elem:"O",x:0,y:60,z:0}, {elem:"O",x:50,y:-35,z:0}, {elem:"H",x:-50,y:-35,z:0}, {elem:"H",x:80,y:-15,z:0}], [[0,1,"double"],[0,2],[0,3],[2,4]], null, null, "Cs");
addMol("CH2Cl2|二氯甲烷", "C", "sp³", ["四面體","Tetrahedral"], "109.5°", "-97", "39.6", getTetra("C","H", 50).map((a,i)=>i===1||i===2?{...a,elem:"Cl", x:a.x*1.5, y:a.y*1.5, z:a.z*1.5}:a), [[0,1],[0,2],[0,3],[0,4]], null, null, "C2v");
addMol("CHCl3|三氯甲烷|氯仿", "C", "sp³", ["四面體","Tetrahedral"], "109.5°", "-63.5", "61.2", getTetra("C","Cl", 75).map((a,i)=>i===4?{...a,elem:"H", x:a.x*0.66, y:a.y*0.66, z:a.z*0.66}:a), [[0,1],[0,2],[0,3],[0,4]], null, null, "C3v");
addMol("HCN|氰化氫|氫氰酸", "C", "sp", ["直線型","Linear"], "180°", "-13.3", "26", [{elem:"C",x:0,y:0,z:0}, {elem:"N",x:60,y:0,z:0,lpCount:1}, {elem:"H",x:-50,y:0,z:0}], [[0,1,"triple"],[0,2]], null, null, "Cinfv");
addMol("CH3CN|乙腈|氰甲烷", "C", "sp", ["直線型 (CN端)","Linear"], "180°", "-45", "82", [{elem:"C",x:0,y:0,z:0}, {elem:"N",x:60,y:0,z:0,lpCount:1}, {elem:"C",x:-70,y:0,z:0}, {elem:"H",x:-100,y:25,z:0}, {elem:"H",x:-100,y:-15,z:20}, {elem:"H",x:-100,y:-15,z:-20}], [[0,1,"triple"],[0,2],[2,3],[2,4],[2,5]], null, null, "C3v");
addMol("CO(NH2)2|尿素", "C", "sp²", ["平面","Planar"], "120°", "132.7", "分解", [{elem:"C",x:0,y:0,z:0}, {elem:"O",x:0,y:60,z:0}, {elem:"N",x:-50,y:-35,z:0}, {elem:"N",x:50,y:-35,z:0}, {elem:"H",x:-80,y:-15,z:0}, {elem:"H",x:-50,y:-70,z:0}, {elem:"H",x:80,y:-15,z:0}, {elem:"H",x:50,y:-70,z:0}], [[0,1,"double"],[0,2],[0,3],[2,4],[2,5],[3,6],[3,7]], null, null, "C2v");
addMol("SOCl2|亞硫醯氯|二氯亞碸", "S", "sp³", ["角錐形","Pyramidal"], "106°", "-104.5", "76", [{elem:"S",x:0,y:15,z:0,lp3d:[{x:0,y:1,z:0}]}, {elem:"O",x:0,y:-35,z:50}, {elem:"Cl",x:60,y:-35,z:-30}, {elem:"Cl",x:-60,y:-35,z:-30}], [[0,1,"double"],[0,2],[0,3]], null, null, "Cs");
addMol("POCl3|三氯氧化磷|磷醯氯", "P", "sp³", ["四面體","Tetrahedral"], "109.5°", "1.25", "105.8", [{elem:"P",x:0,y:0,z:0}, {elem:"O",x:0,y:65,z:0}, {elem:"Cl",x:55,y:-35,z:35}, {elem:"Cl",x:-55,y:-35,z:35}, {elem:"Cl",x:0,y:0,z:-70}], [[0,1,"double"],[0,2],[0,3],[0,4]], null, null, "C3v");
// C60 (使用 IIFE 生成資料並添加名稱)
(function(){
    const phi=(1+Math.sqrt(5))/2,scale=28;let rawVerts=[];
    const groups=[[0,1,3*phi],[1,2+phi,2*phi],[phi,2,2*phi+1]];
    function addPermutations(u,v,w){
        const cycles=[[u,v,w],[v,w,u],[w,u,v]];
        cycles.forEach(p=>{
            for(let i=0;i<8;i++){
                let x=p[0]*((i&1)?1:-1),y=p[1]*((i&2)?1:-1),z=p[2]*((i&4)?1:-1);
                rawVerts.push({x,y,z});
            }
        });
    }
    groups.forEach(g=>addPermutations(g[0],g[1],g[2]));
    const atoms=[],threshold=0.1;
    rawVerts.forEach(v=>{
        if(!atoms.some(a=>Math.abs(a.x-v.x*scale)<threshold&&Math.abs(a.y-v.y*scale)<threshold&&Math.abs(a.z-v.z*scale)<threshold)){
            atoms.push({elem:"C",x:v.x*scale,y:v.y*scale,z:v.z*scale,lpCount:0,r:5});
        }
    });
    const bonds=[],bondSet=new Set();
    for(let i=0;i<atoms.length;i++){
        let distances=[];
        for(let j=0;j<atoms.length;j++){
            if(i===j)continue;
            let d=(atoms[i].x-atoms[j].x)**2+(atoms[i].y-atoms[j].y)**2+(atoms[i].z-atoms[j].z)**2;
            distances.push({id:j,dist:d});
        }
        distances.sort((a,b)=>a.dist-b.dist);
        for(let k=0;k<3;k++){
            let neighbor=distances[k].id,id1=Math.min(i,neighbor),id2=Math.max(i,neighbor),key=`${id1}-${id2}`;
            if(!bondSet.has(key)){
                let type=(k===0)?"double":"single";
                bonds.push([id1,id2,type]);
                bondSet.add(key);
            }
        }
    }
    // [修正] 加入中文名稱搜尋
    addMol("C60|碳60|碳六十|富勒烯|足球烯","C","sp²",["球狀 (12個五邊形, 20個六邊形)","Truncated Icosahedron"],"120°", "> 280 (昇華)", "-", atoms,bonds);
})();

// --- 12. 有同分異構物的有機分子與其他有機化合物 (全面修正：Key 統一為 分子式|中文名稱) ---
// N2F2 (二氟二氮)
addMol("N2F2", "N", "sp²", ["平面","Planar"], "120°", "-165", "-105", [], [], {
    "N2F2|順式-二氟二氮": { pg: "C2v", mp: "-165", bp: "-105", atoms: [{elem:"N",x:-32,y:0,z:0},{elem:"N",x:32,y:0,z:0},{elem:"F",x:-67,y:60,z:0},{elem:"F",x:67,y:60,z:0}], bonds: [[0,1,"double"],[0,2],[1,3]] },
    "N2F2|反式-二氟二氮": { pg: "C2h", mp: "-172", bp: "-111", atoms: [{elem:"N",x:-32,y:0,z:0},{elem:"N",x:32,y:0,z:0},{elem:"F",x:-67,y:60,z:0},{elem:"F",x:67,y:-60,z:0}], bonds: [[0,1,"double"],[0,2],[1,3]] }
});

// C2H2Cl2 (二氯乙烯)
addMol("C2H2Cl2|二氯乙烯", "C", "sp²", ["平面","Planar"], "120°", "-81.5", "60.3", [], [], {
    "C2H2Cl2|順-1,2-二氯乙烯": { pg: "C2v", mp: "-81.5", bp: "60.3", atoms: [{elem:"C",x:-32,y:0,z:0},{elem:"C",x:32,y:0,z:0},{elem:"Cl",x:-69,y:65,z:0},{elem:"Cl",x:69,y:65,z:0},{elem:"H",x:-57,y:-43,z:0},{elem:"H",x:57,y:-43,z:0}], bonds: [[0,1,"double"],[0,2],[0,4],[1,3],[1,5]] },
    "C2H2Cl2|反-1,2-二氯乙烯": { pg: "C2h", mp: "-49.4", bp: "47.5", atoms: [{elem:"C",x:-32,y:0,z:0},{elem:"C",x:32,y:0,z:0},{elem:"Cl",x:-69,y:65,z:0},{elem:"Cl",x:69,y:-65,z:0},{elem:"H",x:-57,y:-43,z:0},{elem:"H",x:57,y:43,z:0}], bonds: [[0,1,"double"],[0,2],[0,4],[1,3],[1,5]] },
    "C2H2Cl2|1,1-二氯乙烯": { pg: "C2v", mp: "-122.6", bp: "31.6", atoms: [{elem:"C",x:-32,y:0,z:0},{elem:"C",x:32,y:0,z:0},{elem:"Cl",x:-69,y:65,z:0},{elem:"Cl",x:-69,y:-65,z:0},{elem:"H",x:57,y:43,z:0},{elem:"H",x:57,y:-43,z:0}], bonds: [[0,1,"double"],[0,2],[0,3],[1,4],[1,5]] }
});

// C5H12 (戊烷)
addMol("C5H12", "C", "sp³", ["鏈狀/四面體","Chain/Tetra"], "109.5°", "-129.8", "36.1", [], [], {
    "C5H12|正戊烷": { pg: "C2h", mp: "-129.8", bp: "36.1", atoms: [{elem:"C",x:-140,y:-20,z:0},{elem:"C",x:-70,y:20,z:0},{elem:"C",x:0,y:-20,z:0},{elem:"C",x:70,y:20,z:0},{elem:"C",x:140,y:-20,z:0},{elem:"H",x:-140,y:-70,z:0},{elem:"H",x:-175,y:-5,z:25},{elem:"H",x:-175,y:-5,z:-25},{elem:"H",x:-70,y:70,z:0},{elem:"H",x:-70,y:20,z:50},{elem:"H",x:0,y:-70,z:0},{elem:"H",x:0,y:-20,z:-50},{elem:"H",x:70,y:70,z:0},{elem:"H",x:70,y:20,z:50},{elem:"H",x:140,y:-70,z:0},{elem:"H",x:175,y:-5,z:25},{elem:"H",x:175,y:-5,z:-25}], bonds: [[0,1],[1,2],[2,3],[3,4],[0,5],[0,6],[0,7],[1,8],[1,9],[2,10],[2,11],[3,12],[3,13],[4,14],[4,15],[4,16]] },
    "C5H12|異戊烷": { pg: "Cs", mp: "-159.9", bp: "27.8", atoms: [{elem:"C",x:-80,y:-20,z:0},{elem:"C",x:-10,y:20,z:0},{elem:"C",x:60,y:-20,z:0},{elem:"C",x:130,y:20,z:0},{elem:"C",x:-10,y:90,z:0},{elem:"H",x:-80,y:-70,z:0},{elem:"H",x:-115,y:-5,z:25},{elem:"H",x:-115,y:-5,z:-25},{elem:"H",x:-10,y:20,z:50},{elem:"H",x:60,y:-70,z:0},{elem:"H",x:60,y:-20,z:-50},{elem:"H",x:130,y:70,z:0},{elem:"H",x:165,y:-5,z:25},{elem:"H",x:165,y:-5,z:-25},{elem:"H",x:-10,y:140,z:0},{elem:"H",x:-45,y:105,z:25},{elem:"H",x:25,y:105,z:25}], bonds: [[0,1],[1,2],[2,3],[1,4],[0,5],[0,6],[0,7],[1,8],[2,9],[2,10],[3,11],[3,12],[3,13],[4,14],[4,15],[4,16]] },
    "C5H12|新戊烷": { pg: "Td", mp: "-16.5", bp: "9.5", atoms: [{elem:"C",x:0,y:0,z:0},{elem:"C",x:0,y:70,z:0},{elem:"C",x:66,y:-23,z:0},{elem:"C",x:-33,y:-23,z:57},{elem:"C",x:-33,y:-23,z:-57},{elem:"H",x:0,y:120,z:0},{elem:"H",x:-35,y:85,z:35},{elem:"H",x:35,y:85,z:35},{elem:"H",x:116,y:-23,z:0},{elem:"H",x:80,y:-60,z:35},{elem:"H",x:80,y:-60,z:-35},{elem:"H",x:-83,y:-23,z:57},{elem:"H",x:-20,y:27,z:80},{elem:"H",x:-20,y:-73,z:80},{elem:"H",x:-83,y:-23,z:-57},{elem:"H",x:-20,y:27,z:-80},{elem:"H",x:-20,y:-73,z:-80}], bonds: [[0,1],[0,2],[0,3],[0,4],[1,5],[1,6],[1,7],[2,8],[2,9],[2,10],[3,11],[3,12],[3,13],[4,14],[4,15],[4,16]] }
});

// C4H8 (丁烯/環丁烷)
addMol("C4H8", "C", "sp3", ["形狀","Shape"], "N/A", "-185.3", "-6.3", [], [], {
    "C4H8|1-丁烯": { pg: "Cs", mp: "-185.3", bp: "-6.3", atoms: [{elem:"C",x:30,y:-35,z:-15},{elem:"C",x:80,y:20,z:5},{elem:"C",x:-40,y:-20,z:20},{elem:"C",x:-90,y:20,z:-10},{elem:"H",x:25,y:-40,z:-65},{elem:"H",x:50,y:-80,z:5},{elem:"H",x:120,y:10,z:-20},{elem:"H",x:70,y:70,z:-15},{elem:"H",x:90,y:30,z:55},{elem:"H",x:-50,y:-40,z:65},{elem:"H",x:-130,y:25,z:15},{elem:"H",x:-80,y:40,z:-60}], bonds: [[0,1],[0,2],[0,4],[0,5],[1,6],[1,7],[1,8],[2,3,"double"],[2,9],[3,10],[3,11]] },
    "C4H8|順-2-丁烯": { pg: "C2v", mp: "-138.9", bp: "3.7", atoms: [{elem:"C",x:-32,y:-40,z:0},{elem:"C",x:32,y:-40,z:0},{elem:"C",x:-75,y:25,z:0},{elem:"C",x:75,y:25,z:0},{elem:"H",x:-57,y:-85,z:0},{elem:"H",x:57,y:-85,z:0},{elem:"H",x:-115,y:15,z:-30},{elem:"H",x:-55,y:65,z:-20},{elem:"H",x:-90,y:35,z:50},{elem:"H",x:115,y:15,z:30},{elem:"H",x:55,y:65,z:20},{elem:"H",x:90,y:35,z:-50}], bonds: [[0,1,"double"],[0,2],[0,4],[1,3],[1,5],[2,6],[2,7],[2,8],[3,9],[3,10],[3,11]] },
    "C4H8|反-2-丁烯": { pg: "C2h", mp: "-105.5", bp: "0.9", atoms: [{elem:"C",x:-30,y:20,z:0},{elem:"C",x:30,y:-20,z:0},{elem:"C",x:-90,y:-10,z:0},{elem:"C",x:90,y:10,z:0},{elem:"H",x:-20,y:70,z:0},{elem:"H",x:20,y:-70,z:0},{elem:"H",x:-115,y:10,z:40},{elem:"H",x:-95,y:-60,z:0},{elem:"H",x:-115,y:10,z:-40},{elem:"H",x:115,y:-10,z:40},{elem:"H",x:95,y:60,z:0},{elem:"H",x:115,y:-10,z:-40}], bonds: [[0,1,"double"],[0,2],[0,4],[1,3],[1,5],[2,6],[2,7],[2,8],[3,9],[3,10],[3,11]] },
    "C4H8|2-甲基丙烯": { pg: "C2v", mp: "-140.3", bp: "-6.9", atoms: [{elem:"C",x:0,y:10,z:0},{elem:"C",x:-60,y:-25,z:0},{elem:"C",x:60,y:-25,z:0},{elem:"C",x:0,y:73,z:0},{elem:"H",x:-65,y:-60,z:40},{elem:"H",x:-65,y:-60,z:-40},{elem:"H",x:-105,y:5,z:0},{elem:"H",x:65,y:-60,z:-40},{elem:"H",x:65,y:-60,z:40},{elem:"H",x:105,y:5,z:0},{elem:"H",x:43,y:98,z:0},{elem:"H",x:-43,y:98,z:0}], bonds: [[0,1],[0,2],[0,3,"double"],[1,4],[1,5],[1,6],[2,7],[2,8],[2,9],[3,10],[3,11]] },
    "C4H8|環丁烷": { pg: "D2d", mp: "-91", bp: "12.5", atoms: [{elem:"C",x:35,y:35,z:10},{elem:"C",x:-35,y:35,z:-10},{elem:"C",x:-35,y:-35,z:10},{elem:"C",x:35,y:-35,z:-10},{elem:"H",x:45,y:45,z:60},{elem:"H",x:60,y:60,z:-30},{elem:"H",x:-45,y:45,z:-60},{elem:"H",x:-60,y:60,z:30},{elem:"H",x:-60,y:-60,z:30},{elem:"H",x:-45,y:-45,z:60},{elem:"H",x:60,y:-60,z:-30},{elem:"H",x:45,y:-45,z:-60}], bonds: [[0,1],[1,2],[2,3],[3,0],[0,4],[0,5],[1,6],[1,7],[2,8],[2,9],[3,10],[3,11]] },
    "C4H8|甲基環丙烷": { pg: "Cs", mp: "-117.2", bp: "0.7", atoms: [{elem:"C",x:-10,y:0,z:35},{elem:"C",x:50,y:-35,z:0},{elem:"C",x:50,y:35,z:0},{elem:"C",x:-70,y:0,z:-10},{elem:"H",x:-20,y:0,z:85},{elem:"H",x:80,y:-60,z:30},{elem:"H",x:40,y:-60,z:-50},{elem:"H",x:40,y:60,z:-50},{elem:"H",x:80,y:60,z:30},{elem:"H",x:-100,y:-45,z:5},{elem:"H",x:-60,y:0,z:-60},{elem:"H",x:-100,y:45,z:5}], bonds: [[0,1],[0,2],[0,3],[0,4],[1,2],[1,5],[1,6],[2,7],[2,8],[3,9],[3,10],[3,11]] }
});


// C8H10 (二甲苯類) - 已中心化調整
addMol("C8H10", "C", "sp²", ["平面/四面體","Planar/Tetra"], "120°", "-47.8", "139", [], [], {
"C8H10|乙苯|Ethylbenzene": { pg: "Cs", symVectors: { "s": [0,0,1] }, atoms: [{elem:"C",x:0,y:63,z:0},{elem:"C",x:54,y:31,z:0},{elem:"C",x:54,y:-31,z:0},{elem:"C",x:0,y:-63,z:0},{elem:"C",x:-54,y:-31,z:0},{elem:"C",x:-54,y:31,z:0},{elem:"C",x:0,y:129,z:0},{elem:"C",x:66,y:141,z:0},{elem:"H",x:96,y:56,z:0},{elem:"H",x:96,y:-56,z:0},{elem:"H",x:0,y:-112,z:0},{elem:"H",x:-96,y:-56,z:0},{elem:"H",x:-96,y:56,z:0},{elem:"H",x:-39,y:139,z:0},{elem:"H",x:66,y:209,z:0},{elem:"H",x:114,y:101,z:0}], bonds: [[0,1,"double"],[1,2],[2,3,"double"],[3,4],[4,5,"double"],[5,0],[0,6],[1,8],[2,9],[3,10],[4,11],[5,12],[6,7],[6,13],[7,14],[7,15]] },
"C8H10|鄰二甲苯|o-Xylene": { pg: "C2v", symVectors: { "C2": [0,1,0], "sv": [0,0,1], "sv2": [1,0,0] }, atoms: [{elem:"C",x:31,y:54,z:0},{elem:"C",x:-31,y:54,z:0},{elem:"C",x:63,y:0,z:0},{elem:"C",x:-63,y:0,z:0},{elem:"C",x:31,y:-54,z:0},{elem:"C",x:-31,y:-54,z:0},{elem:"C",x:66,y:112,z:0},{elem:"C",x:-66,y:112,z:0},{elem:"H",x:112,y:0,z:0},{elem:"H",x:56,y:-97,z:0},{elem:"H",x:-56,y:-97,z:0},{elem:"H",x:-112,y:0,z:0},{elem:"H",x:115,y:104,z:0},{elem:"H",x:56,y:139,z:40},{elem:"H",x:56,y:139,z:-40},{elem:"H",x:-115,y:104,z:0},{elem:"H",x:-56,y:139,z:40},{elem:"H",x:-56,y:139,z:-40}], bonds: [[0,1],[0,2,"double"],[0,6],[1,3,"double"],[1,7],[2,4],[2,8],[3,5],[3,11],[4,5,"double"],[4,9],[5,10],[6,12],[6,13],[6,14],[7,15],[7,16],[7,17]] },
"C8H10|間二甲苯|m-Xylene": { pg: "C2v", symVectors: { "C2": [0,1,0], "sv": [0,0,1], "sv2": [1,0,0] }, atoms: [{elem:"C",x:-54,y:31.5,z:0},{elem:"C",x:54,y:31.5,z:0},{elem:"C",x:0,y:62.5,z:0},{elem:"C",x:-54,y:-31.5,z:0},{elem:"C",x:54,y:-31.5,z:0},{elem:"C",x:0,y:-62.5,z:0},{elem:"C",x:-112,y:64.5,z:0},{elem:"C",x:112,y:64.5,z:0},{elem:"H",x:0,y:111.5,z:0},{elem:"H",x:-96,y:-56.5,z:0},{elem:"H",x:96,y:-56.5,z:0},{elem:"H",x:0,y:-111.5,z:0},{elem:"H",x:-148,y:38.5,z:0},{elem:"H",x:-126,y:74.5,z:46},{elem:"H",x:-108,y:107.5,z:-46},{elem:"H",x:148,y:38.5,z:0},{elem:"H",x:126,y:74.5,z:46},{elem:"H",x:108,y:107.5,z:-46}], bonds: [[0,2,"double"],[0,3],[0,6],[1,2],[1,4,"double"],[1,7],[2,8],[3,5,"double"],[3,9],[4,5],[4,10],[5,11],[6,12],[6,13],[6,14],[7,15],[7,16],[7,17]] },
"C8H10|對二甲苯|p-Xylene": { pg: "D2h", symVectors: { "C2x": [1,0,0], "C2y": [0,1,0], "C2z": [0,0,1], "sh": [0,0,1], "i": [0,0,0] }, atoms: [{elem:"C",x:63,y:0,z:0},{elem:"C",x:-63,y:0,z:0},{elem:"C",x:31,y:-54,z:0},{elem:"C",x:-31,y:-54,z:0},{elem:"C",x:31,y:54,z:0},{elem:"C",x:-31,y:54,z:0},{elem:"C",x:130,y:0,z:0},{elem:"C",x:-130,y:0,z:0},{elem:"H",x:55,y:-97,z:0},{elem:"H",x:-55,y:-97,z:0},{elem:"H",x:55,y:97,z:0},{elem:"H",x:-55,y:97,z:0},{elem:"H",x:148,y:40,z:0},{elem:"H",x:148,y:-40,z:46},{elem:"H",x:147,y:0,z:-46},{elem:"H",x:-148,y:40,z:0},{elem:"H",x:-148,y:-40,z:46},{elem:"H",x:-147,y:0,z:-46}], bonds: [[0,2,"double"],[0,4],[0,6],[1,3,"double"],[1,5],[1,7],[2,3],[2,8],[3,9],[4,5,"double"],[4,10],[5,11],[6,12],[6,13],[6,14],[7,15],[7,16],[7,17]] }
}, null, null, "D2h");


// C6H12O6 (己糖)
addMol("C6H12O6", "C", "sp³", ["鏈狀/環狀","Chain/Ring"], "109.5°", "146", "dec.", [], [], {
    "C6H12O6|半乳糖": { pg: "C1", mp: "167", bp: "dec.", atoms: [{elem:"O",x:35,y:-42,z:-14},{elem:"O",x:14,y:76,z:-59},{elem:"O",x:-95,y:91,z:1},{elem:"O",x:-127,y:-35,z:16},{elem:"O",x:-39,y:-115,z:-30},{elem:"O",x:154,y:-27,z:13},{elem:"C",x:11,y:63,z:4},{elem:"C",x:-54,y:45,z:20},{elem:"C",x:53,y:10,z:18},{elem:"C",x:-71,y:-15,z:-9},{elem:"C",x:-24,y:-63,z:4},{elem:"C",x:118,y:24,z:-1},{elem:"H",x:24,y:104,z:27},{elem:"H",x:-58,y:42,z:69},{elem:"H",x:53,y:0,z:66},{elem:"H",x:-79,y:-9,z:-57},{elem:"H",x:-24,y:-75,z:51},{elem:"H",x:122,y:31,z:-50},{elem:"H",x:136,y:63,z:22},{elem:"H",x:9,y:39,z:-82},{elem:"H",x:-135,y:77,z:12},{elem:"H",x:-137,y:-73,z:-3},{elem:"H",x:-21,y:-149,z:-10},{elem:"H",x:138,y:-61,z:-8}], bonds: [[0,8],[0,10],[1,6],[1,19],[2,7],[2,20],[3,9],[3,21],[4,10],[4,22],[5,11],[5,23],[6,7],[6,8],[6,12],[7,9],[7,13],[8,11],[8,14],[9,10],[9,15],[10,16],[11,17],[11,18]] },
    "C6H12O6|葡萄糖": { pg: "C1", mp: "146", bp: "dec.", atoms: [{elem:"O",x:-26,y:-57,z:14},{elem:"O",x:-36,y:106,z:-13},{elem:"O",x:88,y:88,z:24},{elem:"O",x:132,y:-29,z:-18},{elem:"O",x:54,y:-124,z:14},{elem:"O",x:-148,y:-48,z:-6},{elem:"C",x:-13,y:51,z:13},{elem:"C",x:53,y:44,z:-6},{elem:"C",x:-51,y:-2,z:-8},{elem:"C",x:76,y:-19,z:11},{elem:"C",x:32,y:-68,z:-9},{elem:"C",x:-116,y:2,z:15},{elem:"H",x:-15,y:56,z:62},{elem:"H",x:58,y:52,z:-55},{elem:"H",x:-53,y:-4,z:-58},{elem:"H",x:85,y:-21,z:59},{elem:"H",x:31,y:-73,z:-58},{elem:"H",x:-117,y:2,z:64},{elem:"H",x:-138,y:43,z:-2},{elem:"H",x:-35,y:102,z:-56},{elem:"H",x:71,y:127,z:12},{elem:"H",x:126,y:-27,z:-62},{elem:"H",x:71,y:-117,z:54},{elem:"H",x:-128,y:-84,z:9}], bonds: [[0,8],[0,10],[1,6],[1,19],[2,7],[2,20],[3,9],[3,21],[4,10],[4,22],[5,11],[5,23],[6,7],[6,8],[6,12],[7,9],[7,13],[8,11],[8,14],[9,10],[9,15],[10,16],[11,17],[11,18]] },
    "C6H12O6|果糖": { pg: "C1", mp: "103", bp: "dec.", atoms: [{elem:"O",x:30,y:-58,z:-2},{elem:"O",x:4,y:106,z:-2},{elem:"O",x:60,y:18,z:67},{elem:"O",x:-117,y:57,z:-1},{elem:"O",x:-92,y:-55,z:-46},{elem:"O",x:148,y:-20,z:-14},{elem:"C",x:-9,y:44,z:-13},{elem:"C",x:45,y:5,z:6},{elem:"C",x:-66,y:26,z:21},{elem:"C",x:-77,y:-42,z:15},{elem:"C",x:-21,y:-77,z:32},{elem:"C",x:100,y:18,z:-33},{elem:"H",x:-18,y:39,z:-62},{elem:"H",x:-61,y:38,z:69},{elem:"H",x:-115,y:-56,z:43},{elem:"H",x:-27,y:-125,z:22},{elem:"H",x:-11,y:-73,z:80},{elem:"H",x:91,y:9,z:-81},{elem:"H",x:115,y:64,z:-28},{elem:"H",x:34,y:119,z:-32},{elem:"H",x:102,y:8,z:73},{elem:"H",x:-118,y:53,z:-45},{elem:"H",x:-131,y:-38,z:-54},{elem:"H",x:134,y:-61,z:-18}], bonds: [[0,7],[0,10],[1,6],[1,19],[2,7],[2,20],[3,8],[3,21],[4,9],[4,22],[5,11],[5,23],[6,7],[6,8],[6,12],[7,11],[8,9],[8,13],[9,10],[9,14],[10,15],[10,16],[11,17],[11,18]] }
});

addMol("C4H4O4", "C", "sp²", ["平面","Planar"], "120°", "", "", [], [], {
    "C4H4O4|順丁烯二酸": { pg: "C2v", mp: "131", bp: "135 (dec)", atoms: [{elem:"C",x:-57,y:-5,z:-2},{elem:"C",x:-29,y:49,z:3},{elem:"C",x:-29,y:-65,z:-6},{elem:"C",x:36,y:62,z:6},{elem:"O",x:19,y:-73,z:31},{elem:"O",x:-49,y:-105,z:-38},{elem:"O",x:70,y:28,z:-31},{elem:"O",x:57,y:101,z:38},{elem:"H",x:-106,y:-6,z:-5},{elem:"H",x:-57,y:89,z:7},{elem:"H",x:33,y:-114,z:23},{elem:"H",x:111,y:40,z:-25}], bonds: [[0,1,"double"],[0,2],[0,8],[1,3],[1,9],[2,4],[2,5,"double"],[3,6],[3,7,"double"],[4,10],[6,11]] },
    "C4H4O4|反丁烯二酸": { pg: "C2h", mp: "287", bp: "290 (subl)", atoms: [{elem:"C",x:-15,y:25,z:-8},{elem:"C",x:15,y:-25,z:8},{elem:"C",x:-80,y:31,z:5},{elem:"C",x:80,y:-31,z:-5},{elem:"O",x:-101,y:84,z:-16},{elem:"O",x:-111,y:-5,z:30},{elem:"O",x:101,y:-84,z:16},{elem:"O",x:111,y:6,z:-30},{elem:"H",x:8,y:61,z:-32},{elem:"H",x:-8,y:-61,z:32},{elem:"H",x:-144,y:85,z:-6},{elem:"H",x:144,y:-85,z:6}], bonds: [[0,1,"double"],[0,2],[0,8],[1,3],[1,9],[2,4],[2,5,"double"],[3,6],[3,7,"double"],[4,10],[6,11]] }
});

addMol("C3H6", "C", "sp3", ["四面體","Tetrahedral"], "109.5", "-185.2", "-47.6", [], [], {
    "C3H6|丙烯": { pg: "Cs", mp: "-185.2", bp: "-47.6", atoms: [{elem:"C",x:54,y:7,z:0},{elem:"C",x:-9,y:-28,z:0},{elem:"C",x:-65,y:9,z:0},{elem:"H",x:79,y:-15,z:-40},{elem:"H",x:54,y:60,z:0},{elem:"H",x:79,y:-15,z:40},{elem:"H",x:-9,y:-78,z:0},{elem:"H",x:-105,y:-20,z:0},{elem:"H",x:-65,y:60,z:0}], bonds: [[0,1],[0,3],[0,4],[0,5],[1,2,"double"],[1,6],[2,7],[2,8]] },
    "C3H6|環丙烷": { pg: "D3h", mp: "-127.6", bp: "-32.9", atoms: [{elem:"C",x:0,y:-40,z:0},{elem:"C",x:-35,y:20,z:0},{elem:"C",x:35,y:20,z:0},{elem:"H",x:0,y:-75,z:-40},{elem:"H",x:0,y:-75,z:40},{elem:"H",x:-65,y:35,z:40},{elem:"H",x:-65,y:35,z:-40},{elem:"H",x:65,y:35,z:-40},{elem:"H",x:65,y:35,z:40}], bonds: [[0,1],[0,2],[0,3],[0,4],[1,2],[1,5],[1,6],[2,7],[2,8]] }
});

addMol("C3H8O", "C", "sp3", ["正四面體","Tetrahedral"], "109.5°", "-126", "97.2", [], [], {
    "C3H8O|1-丙醇": { pg: "Cs", mp: "-126", bp: "97.2", atoms: [{elem:"O",x:115,y:10,z:-5},{elem:"C",x:-5,y:25,z:-5},{elem:"C",x:55,y:-25,z:-5},{elem:"C",x:-70,y:-10,z:-5},{elem:"H",x:0,y:55,z:-45},{elem:"H",x:0,y:55,z:40},{elem:"H",x:50,y:-55,z:-45},{elem:"H",x:50,y:-55,z:40},{elem:"H",x:-75,y:-40,z:-45},{elem:"H",x:-110,y:25,z:-5},{elem:"H",x:-75,y:-40,z:40},{elem:"H",x:120,y:40,z:35}], bonds: [[0,2],[0,11],[1,2],[1,3],[1,4],[1,5],[2,6],[2,7],[3,8],[3,9],[3,10]] },
    "C3H8O|2-丙醇": { pg: "Cs", mp: "-89", bp: "82.3", atoms: [{elem:"O",x:0,y:-80,z:-5},{elem:"C",x:0,y:-15,z:25},{elem:"C",x:-60,y:20,z:0},{elem:"C",x:60,y:20,z:0},{elem:"H",x:0,y:-15,z:75},{elem:"H",x:-60,y:70,z:20},{elem:"H",x:-100,y:-10,z:20},{elem:"H",x:-60,y:20,z:-50},{elem:"H",x:60,y:70,z:20},{elem:"H",x:100,y:-10,z:20},{elem:"H",x:60,y:20,z:-50},{elem:"H",x:0,y:-80,z:-55}], bonds: [[0,1],[0,11],[1,2],[1,3],[1,4],[2,5],[2,6],[2,7],[3,8],[3,9],[3,10]] },
    "C3H8O|甲乙醚": { pg: "Cs", mp: "-113", bp: "7.4", atoms: [{elem:"O",x:0,y:20,z:0},{elem:"C",x:-50,y:-15,z:0},{elem:"C",x:50,y:-15,z:0},{elem:"C",x:95,y:20,z:0},{elem:"H",x:-50,y:-45,z:25},{elem:"H",x:-50,y:-45,z:-25},{elem:"H",x:-85,y:5,z:0},{elem:"H",x:50,y:-45,z:25},{elem:"H",x:50,y:-45,z:-25},{elem:"H",x:95,y:50,z:0},{elem:"H",x:130,y:0,z:25},{elem:"H",x:130,y:0,z:-25}], bonds: [[0,1],[0,2],[1,4],[1,5],[1,6],[2,3],[2,7],[2,8],[3,9],[3,10],[3,11]] }
});

addMol("C3H6Cl2", "C", "sp3", ["正四面體","Tetrahedral"], "109.5°", "-78", "87", [], [], {
    "C3H6Cl2|1,1-二氯丙烷": { pg: "Cs", mp: "-78", bp: "87", atoms: [{elem:"Cl",x:85,y:60,z:-15},{elem:"Cl",x:85,y:-60,z:-15},{elem:"C",x:-15,y:0,z:30},{elem:"C",x:55,y:0,z:20},{elem:"C",x:-55,y:0,z:-35},{elem:"H",x:-30,y:-45,z:55},{elem:"H",x:-30,y:45,z:55},{elem:"H",x:75,y:0,z:70},{elem:"H",x:-45,y:45,z:-65},{elem:"H",x:-105,y:0,z:-25},{elem:"H",x:-45,y:-45,z:-65}], bonds: [[0,3],[1,3],[2,3],[2,4],[2,5],[2,6],[3,7],[4,8],[4,9],[4,10]] },
    "C3H6Cl2|1,2-二氯丙烷": { pg: "C1", mp: "-100.4", bp: "96", atoms: [{elem:"Cl",x:-45,y:-80,z:20},{elem:"Cl",x:95,y:-30,z:30},{elem:"C",x:-25,y:-15,z:-15},{elem:"C",x:45,y:-20,z:-30},{elem:"C",x:-35,y:45,z:30},{elem:"H",x:-50,y:-10,z:-60},{elem:"H",x:65,y:25,z:-55},{elem:"H",x:55,y:-60,z:-60},{elem:"H",x:-15,y:40,z:75},{elem:"H",x:-85,y:50,z:35},{elem:"H",x:-20,y:90,z:10}], bonds: [[0,2],[1,3],[2,3],[2,4],[2,5],[3,6],[3,7],[4,8],[4,9],[4,10]] },
    "C3H6Cl2|1,3-二氯丙烷": { pg: "C2v", mp: "-99.5", bp: "120.4", atoms: [{elem:"Cl",x:90,y:50,z:-15},{elem:"Cl",x:-90,y:50,z:15},{elem:"C",x:0,y:-30,z:0},{elem:"C",x:50,y:10,z:35},{elem:"C",x:-50,y:10,z:-35},{elem:"H",x:-25,y:-65,z:35},{elem:"H",x:25,y:-65,z:-35},{elem:"H",x:85,y:-25,z:55},{elem:"H",x:30,y:40,z:70},{elem:"H",x:-30,y:40,z:-70},{elem:"H",x:-85,y:-25,z:-55}], bonds: [[0,3],[1,4],[2,3],[2,4],[2,5],[2,6],[3,7],[3,8],[4,9],[4,10]] },
    "C3H6Cl2|2,2-二氯丙烷": { pg: "C2v", mp: "-33.8", bp: "69.3", atoms: [{elem:"Cl",x:-60,y:-70,z:0},{elem:"Cl",x:60,y:-70,z:0},{elem:"C",x:0,y:-25,z:0},{elem:"C",x:0,y:20,z:60},{elem:"C",x:0,y:20,z:-60},{elem:"H",x:0,y:-10,z:105},{elem:"H",x:-45,y:50,z:60},{elem:"H",x:45,y:50,z:60},{elem:"H",x:45,y:50,z:-60},{elem:"H",x:0,y:-10,z:-105},{elem:"H",x:-45,y:50,z:-60}], bonds: [[0,2],[1,2],[2,3],[2,4],[3,5],[3,6],[3,7],[4,8],[4,9],[4,10]] }
});

addMol("C3H7Cl", "C", "sp3", ["正四面體","Tetrahedral"], "109.5°", "-122.8", "46.6", [], [], {
    "C3H7Cl|1-氯丙烷": { pg: "Cs", mp: "-122.8", bp: "46.6", atoms: [{elem:"Cl",x:105,y:28,z:-5},{elem:"C",x:-15,y:-22,z:-18},{elem:"C",x:55,y:-30,z:12},{elem:"C",x:-50,y:40,z:5},{elem:"H",x:-12,y:-20,z:-68},{elem:"H",x:-45,y:-65,z:-5},{elem:"H",x:52,y:-32,z:62},{elem:"H",x:78,y:-75,z:-5},{elem:"H",x:-52,y:42,z:55},{elem:"H",x:-100,y:40,z:-15},{elem:"H",x:-25,y:85,z:-12}], bonds: [[0,2],[1,2],[1,3],[1,4],[1,5],[2,6],[2,7],[3,8],[3,9],[3,10]] },
    "C3H7Cl|2-氯丙烷": { pg: "Cs", mp: "-117.2", bp: "35.7", atoms: [{elem:"Cl",x:90,y:0,z:-5},{elem:"C",x:15,y:0,z:20},{elem:"C",x:-20,y:60,z:-5},{elem:"C",x:-20,y:-60,z:-5},{elem:"H",x:14,y:0,z:70},{elem:"H",x:5,y:105,z:15},{elem:"H",x:-65,y:60,z:10},{elem:"H",x:-20,y:60,z:-55},{elem:"H",x:5,y:-105,z:15},{elem:"H",x:-65,y:-60,z:10},{elem:"H",x:-20,y:-60,z:-55}], bonds: [[0,1],[1,2],[1,3],[1,4],[2,5],[2,6],[2,7],[3,8],[3,9],[3,10]] }
});


addMol("C2H4Cl2|二氯乙烷", "C", "sp3", ["正四面體","Tetrahedral"], "109.5°", "-96.9", "57.3", [], [], 
    {
        "C2H4Cl2|1,1-二氯乙烷": { pg: "Cs", mp: "-96.9", bp: "57.3", atoms: [{elem:"Cl",x:66,y:68,z:-9},{elem:"Cl",x:-66,y:68,z:-9},{elem:"C",x:0,y:28,z:15},{elem:"C",x:0,y:-35,z:-10},{elem:"H",x:0,y:27,z:64},{elem:"H",x:0,y:-35,z:-60},{elem:"H",x:-40,y:60,z:5},{elem:"H",x:40,y:60,z:5}], bonds: [[0,2],[1,2],[2,3],[2,4],[3,5],[3,6],[3,7]] },
        "C2H4Cl2|1,2-二氯乙烷": { pg: "C2h", mp: "-35.7", bp: "83.5", atoms: [{elem:"Cl",x:74,y:58,z:6},{elem:"Cl",x:-74,y:58,z:-6},{elem:"C",x:31,y:-6,z:-15},{elem:"C",x:-31,y:-6,z:15},{elem:"H",x:27,y:-6,z:-64},{elem:"H",x:56,y:-46,z:-2},{elem:"H",x:-56,y:-46,z:2},{elem:"H",x:-27,y:-6,z:64}], bonds: [[0,2],[1,3],[2,3],[2,4],[2,5],[3,6],[3,7]] }
    }
);

addMol("C6H4Cl2|二氯苯", "C", "sp²", ["平面 (苯環)","Planar"], "120°", "-17", "180.5", [], [], {
"C6H4Cl2|鄰二氯苯|1,2-Dichlorobenzene": { pg: "C2v", mp: "-17", bp: "180.5", atoms: [{elem:"C",x:-39,y:68,z:0},{elem:"C",x:39,y:68,z:0},{elem:"C",x:78,y:0,z:0},{elem:"C",x:39,y:-68,z:0},{elem:"C",x:-39,y:-68,z:0},{elem:"C",x:-78,y:0,z:0},{elem:"Cl",x:-68,y:117,z:0},{elem:"Cl",x:68,y:117,z:0},{elem:"H",x:135,y:0,z:0},{elem:"H",x:68,y:-117,z:0},{elem:"H",x:-68,y:-117,z:0},{elem:"H",x:-135,y:0,z:0}], bonds: [[0,1,"double"],[1,2],[2,3,"double"],[3,4],[4,5,"double"],[5,0],[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]] },
"C6H4Cl2|間二氯苯|1,3-Dichlorobenzene": { pg: "C2v", mp: "-24.7", bp: "173", atoms: [{elem:"C",x:-68,y:39,z:0},{elem:"C",x:0,y:78,z:0},{elem:"C",x:68,y:39,z:0},{elem:"C",x:68,y:-39,z:0},{elem:"C",x:0,y:-78,z:0},{elem:"C",x:-68,y:-39,z:0},{elem:"Cl",x:-117,y:68,z:0},{elem:"Cl",x:117,y:68,z:0},{elem:"H",x:0,y:135,z:0},{elem:"H",x:117,y:-68,z:0},{elem:"H",x:0,y:-135,z:0},{elem:"H",x:-117,y:-68,z:0}], bonds: [[0,1,"double"],[1,2],[2,3,"double"],[3,4],[4,5,"double"],[5,0],[0,6],[2,7],[1,8],[3,9],[4,10],[5,11]] },
"C6H4Cl2|對二氯苯|1,4-Dichlorobenzene": { pg: "D2h", mp: "53.5", bp: "174", symVectors: { "C2_1": [1,0,0], "C2_2": [0,1,0], "C2_3": [0,0,1], "sh": [0,0,1], "sv1": [1,0,0], "sv2": [0,1,0] }, atoms: [{elem:"C",x:78,y:0,z:0},{elem:"C",x:39,y:-68,z:0},{elem:"C",x:-39,y:-68,z:0},{elem:"C",x:-78,y:0,z:0},{elem:"C",x:-39,y:68,z:0},{elem:"C",x:39,y:68,z:0},{elem:"Cl",x:135,y:0,z:0},{elem:"Cl",x:-135,y:0,z:0},{elem:"H",x:68,y:-117,z:0},{elem:"H",x:-68,y:-117,z:0},{elem:"H",x:-68,y:117,z:0},{elem:"H",x:68,y:117,z:0}], bonds: [[0,1,"double"],[1,2],[2,3,"double"],[3,4],[4,5,"double"],[5,0],[0,6],[3,7],[1,8],[2,9],[4,10],[5,11]] }
});

addMol("C2H2Cl4", "C", "sp3", ["四面體","Tetrahedral"], "109.5°", "", "", [], [], 
{
        "C2H2Cl4|1,1,2,2-四氯乙烷": { pg: "C2h", mp: "-42.3", bp: "146", atoms: [{elem:"Cl",x:-38,y:66,z:59},{elem:"Cl",x:-93,y:-33,z:-9},{elem:"Cl",x:38,y:-66,z:59},{elem:"Cl",x:93,y:33,z:-9},{elem:"C",x:-30,y:17,z:-5},{elem:"C",x:30,y:-17,z:-5},{elem:"H",x:-33,y:46,z:-45},{elem:"H",x:33,y:-46,z:-45}], bonds: [[0,4],[1,4],[2,5],[3,5],[4,5],[4,6],[5,7]] },
        "C2H2Cl4|1,1,1,2-四氯乙烷": { pg: "Cs", mp: "-70.2", bp: "130.2", atoms: [{elem:"Cl",x:27,y:-65,z:-65},{elem:"Cl",x:95,y:-1,z:26},{elem:"Cl",x:29,y:66,z:-63},{elem:"Cl",x:-98,y:0,z:-13},{elem:"C",x:27,y:0,z:-18},{elem:"C",x:-27,y:0,z:25},{elem:"H",x:-27,y:-40,z:54},{elem:"H",x:-26,y:40,z:54}], bonds: [[0,4],[1,4],[2,4],[3,5],[4,5],[5,6],[5,7]] }
    }
);

addMol("C4H6", "C", "sp/sp²/sp³", ["多種異構物", "Isomers"], "Varies", "-108", "10", [], [], 
{
    "C4H6|1,3-丁二烯": { pg: "C2h", mp: "-108.9", bp: "-4.4", atoms: [{elem:"C",x:-27,y:-18,z:0},{elem:"C",x:27,y:18,z:0},{elem:"C",x:-82,y:6,z:0},{elem:"C",x:82,y:-6,z:0},{elem:"H",x:-22,y:-67,z:0},{elem:"H",x:22,y:67,z:0},{elem:"H",x:-122,y:-23,z:0},{elem:"H",x:-90,y:54,z:0},{elem:"H",x:122,y:23,z:0},{elem:"H",x:90,y:-54,z:0}], bonds: [[0,1],[0,2,"double"],[0,4],[1,3,"double"],[1,5],[2,6],[2,7],[3,8],[3,9]] },
    "C4H6|1,2-丁二烯": { pg: "Cs", mp: "-136.2", bp: "10.9", atoms: [{elem:"C",x:-71,y:-13,z:0},{elem:"C",x:-18,y:28,z:0},{elem:"C",x:38,y:11,z:0},{elem:"C",x:94,y:-6,z:0},{elem:"H",x:-98,y:-5,z:-40},{elem:"H",x:-57,y:-60,z:0},{elem:"H",x:-98,y:-5,z:40},{elem:"H",x:-27,y:76,z:0},{elem:"H",x:105,y:-54,z:0},{elem:"H",x:130,y:26,z:0}], bonds: [[0,1],[0,4],[0,5],[0,6],[1,2,"double"],[1,7],[2,3,"double"],[3,8],[3,9]] },
    "C4H6|2-丁炔": { pg: "D3h", mp: "-32.3", bp: "27", atoms: [{elem:"C",x:-93,y:0,z:0},{elem:"C",x:93,y:0,z:0},{elem:"C",x:-27,y:0,z:0},{elem:"C",x:27,y:0,z:0},{elem:"H",x:-110,y:15,z:43},{elem:"H",x:-110,y:-45,z:-9},{elem:"H",x:-110,y:30,z:-35},{elem:"H",x:110,y:46,z:1},{elem:"H",x:110,y:-24,z:39},{elem:"H",x:110,y:-22,z:-40}], bonds: [[0,2],[0,4],[0,5],[0,6],[1,3],[1,7],[1,8],[1,9],[2,3,"triple"]] },
    "C4H6|1-甲基環丙烯": { pg: "Cs", mp: "-", bp: "12", atoms: [{elem:"C",x:53,y:-28,z:0},{elem:"C",x:0,y:8,z:0},{elem:"C",x:51,y:36,z:0},{elem:"C",x:-65,y:3,z:0},{elem:"H",x:65,y:-50,z:42},{elem:"H",x:65,y:-50,z:-42},{elem:"H",x:75,y:77,z:0},{elem:"H",x:-80,y:-22,z:40},{elem:"H",x:-86,y:47,z:0},{elem:"H",x:-80,y:-22,z:-40}], bonds: [[0,1],[0,2],[0,4],[0,5],[1,2,"double"],[1,3],[2,6],[3,7],[3,8],[3,9]] },
    "C4H6|1-丁炔": { pg: "Cs", mp: "-125.7", bp: "8.1", atoms: [{elem:"C",x:10,y:31,z:0},{elem:"C",x:55,y:-20,z:0},{elem:"C",x:-52,y:8,z:0},{elem:"C",x:-103,y:-10,z:0},{elem:"H",x:18,y:59,z:40},{elem:"H",x:18,y:59,z:-40},{elem:"H",x:50,y:-49,z:40},{elem:"H",x:50,y:-49,z:40},{elem:"H",x:101,y:-3,z:0},{elem:"H",x:-148,y:-27,z:0}], bonds: [[0,1],[0,2],[0,4],[0,5],[1,6],[1,7],[1,8],[2,3,"triple"],[3,9]] },
    "C4H6|3-甲基環丙烯": { pg: "Cs", mp: "-", bp: "0", atoms: [{elem:"C",x:5,y:0,z:-24},{elem:"C",x:54,y:-29,z:4},{elem:"C",x:54,y:29,z:4},{elem:"C",x:-55,y:0,z:8},{elem:"H",x:3,y:0,z:-72},{elem:"H",x:76,y:-70,z:16},{elem:"H",x:76,y:70,z:16},{elem:"H",x:-81,y:-40,z:-5},{elem:"H",x:-81,y:40,z:-5},{elem:"H",x:-51,y:0,z:57}], bonds: [[0,1],[0,2],[0,3],[0,4],[1,2,"double"],[1,5],[2,6],[3,7],[3,8],[3,9]] },
    "C4H6|雙環丁烷": { pg: "C2v", mp: "-", bp: "8", atoms: [{elem:"C",x:0,y:-34,z:-12},{elem:"C",x:0,y:34,z:-12},{elem:"C",x:51,y:0,z:15},{elem:"C",x:-51,y:0,z:15},{elem:"H",x:0,y:-53,z:-57},{elem:"H",x:0,y:53,z:-57},{elem:"H",x:93,y:0,z:-9},{elem:"H",x:55,y:0,z:63},{elem:"H",x:-55,y:0,z:63},{elem:"H",x:-93,y:0,z:-9}], bonds: [[0,1],[0,2],[0,3],[0,4],[1,2],[1,3],[1,5],[2,6],[2,7],[3,8],[3,9]] },
    "C4H6|環丁烯": { pg: "C2v", mp: "-135.7", bp: "2.5", atoms: [{elem:"C",x:-26,y:-35,z:0},{elem:"C",x:-26,y:35,z:0},{elem:"C",x:42,y:-30,z:0},{elem:"C",x:42,y:30,z:0},{elem:"H",x:-46,y:-55,z:40},{elem:"H",x:-46,y:-55,z:-40},{elem:"H",x:-46,y:55,z:-40},{elem:"H",x:-46,y:55,z:40},{elem:"H",x:77,y:-64,z:0},{elem:"H",x:77,y:64,z:0}], bonds: [[0,1],[0,2],[0,4],[0,5],[1,3],[1,6],[1,7],[2,3,"double"],[2,8],[3,9]] }
});

addMol("C8H88|Conformer3D_COMPOUND_CID_69667", "C", "sp³", ["幾何形狀","Shape"], "角度", "", "", [{elem:"C",x:39,y:133,z:0},{elem:"C",x:-39,y:133,z:0},{elem:"C",x:34,y:58,z:0},{elem:"C",x:-34,y:58,z:0},{elem:"C",x:71,y:0,z:0},{elem:"C",x:-71,y:0,z:0},{elem:"C",x:35,y:-60,z:0},{elem:"C",x:-35,y:-60,z:0},{elem:"H",x:62,y:156,z:-44},{elem:"H",x:61,y:156,z:44},{elem:"H",x:-62,y:156,z:44},{elem:"H",x:-62,y:156,z:-44},{elem:"H",x:125,y:1,z:0},{elem:"H",x:-125,y:1,z:0},{elem:"H",x:62,y:-107,z:0},{elem:"H",x:-62,y:-107,z:0}], [[0,1],[0,2],[0,8],[0,9],[1,3],[1,10],[1,11],[2,3],[2,4,"double"],[3,5,"double"],[4,6],[4,12],[5,7],[5,13],[6,7,"double"],[6,14],[7,15]], null, null, "C2v");



addMol("C8H8|苯乙烯|Styrene", "C", "sp²", ["平面","Planar"], "120°", "-30.6", "145.2", [{elem:"C",x:18,y:11,z:6},{elem:"C",x:-22,y:59,z:1},{elem:"C",x:-4,y:-48,z:6},{elem:"C",x:-84,y:49,z:-3},{elem:"C",x:-66,y:-58,z:2},{elem:"C",x:-106,y:-10,z:-3},{elem:"C",x:82,y:22,z:10},{elem:"C",x:126,y:-14,z:-11},{elem:"H",x:-6,y:105,z:1},{elem:"H",x:26,y:-86,z:10},{elem:"H",x:-115,y:86,z:-7},{elem:"H",x:-83,y:-104,z:2},{elem:"H",x:-154,y:-18,z:-6},{elem:"H",x:95,y:64,z:31},{elem:"H",x:173,y:-1,z:-5},{elem:"H",x:117,y:-56,z:-34}], [[0,1,"double"],[0,2],[0,6],[1,3],[1,8],[2,4,"double"],[2,9],[3,5,"double"],[3,10],[4,5],[4,11],[5,12],[6,7,"double"],[6,13],[7,14],[7,15]], null, null, "Cs");
addMol("C3H3N|丙烯腈|Acrylonitrile", "C", "sp²/sp", ["平面/直線","Planar/Linear"], "120°/180°", "-83.5", "77.3", [{elem:"N",x:-113,y:10,z:0},{elem:"C",x:-1,y:-22,z:0},{elem:"C",x:43,y:18,z:0},{elem:"C",x:-63,y:-4,z:0},{elem:"H",x:9,y:-70,z:0},{elem:"H",x:90,y:3,z:0},{elem:"H",x:35,y:66,z:0}], [[0,3,"triple"],[1,2,"double"],[1,3],[1,4],[2,5],[2,6]], null, null, "Cs");
addMol("C2H3Cl|氯乙烯", "C", "sp3", ["四面體","Tetrahedral"], "109.5°", "-153.8", "-13.8", [{elem:"Cl",x:-91,y:-12,z:0},{elem:"C",x:-20,y:18,z:0},{elem:"C",x:30,y:-15,z:0},{elem:"H",x:-20,y:67,z:0},{elem:"H",x:74,y:6,z:0},{elem:"H",x:28,y:-64,z:0}], [[0,1],[1,2,"double"],[1,3],[2,4],[2,5]], null, null, "Cs");
addMol("C3H8|丙烷", "C", "sp3", ["正四面體","Tetrahedral"], "109.5°", "-187.7", "-42.1", [{elem:"C",x:0,y:35,z:0},{elem:"C",x:-61,y:-17,z:0},{elem:"C",x:61,y:-17,z:0},{elem:"H",x:0,y:65,z:40},{elem:"H",x:0,y:65,z:-40},{elem:"H",x:-65,y:-55,z:40},{elem:"H",x:-65,y:-55,z:-40},{elem:"H",x:-105,y:15,z:0},{elem:"H",x:105,y:15,z:0},{elem:"H",x:65,y:-55,z:40},{elem:"H",x:65,y:-55,z:-40}], [[0,1],[0,2],[0,3],[0,4],[1,5],[1,6],[1,7],[2,8],[2,9],[2,10]], null, null, "C2v");
addMol("C6H5COOH|苯甲酸|安息香酸", "C", "sp²", ["平面","Planar"], "120°", "122", "249", [{elem:"O",x:118,y:50,z:0},{elem:"O",x:125,y:-52,z:0},{elem:"C",x:28,y:-5,z:0},{elem:"C",x:-5,y:-59,z:0},{elem:"C",x:-2,y:50,z:0},{elem:"C",x:-67,y:-58,z:0},{elem:"C",x:-65,y:51,z:0},{elem:"C",x:-98,y:-3,z:0},{elem:"C",x:93,y:-6,z:0},{elem:"H",x:18,y:-102,z:0},{elem:"H",x:21,y:93,z:0},{elem:"H",x:-93,y:-99,z:0},{elem:"H",x:-89,y:94,z:0},{elem:"H",x:-146,y:-2,z:0},{elem:"H",x:162,y:48,z:0}], [[0,8],[0,14],[1,8,"double"],[2,3,"double"],[2,4],[2,8],[3,5],[3,9],[4,6,"double"],[4,10],[5,7,"double"],[5,11],[6,7],[6,12],[7,13]], null, null, "Cs");
addMol("C7H6O3|鄰羥基苯甲酸|Salicylic Acid|水楊酸|柳酸", "C", "sp²", ["平面","Planar"], "120°", "158.6", "211", [{elem:"O",x:27,y:102,z:-7},{elem:"O",x:116,y:-59,z:-20},{elem:"O",x:126,y:34,z:23},{elem:"C",x:28,y:-5,z:3},{elem:"C",x:-3,y:49,z:-2},{elem:"C",x:-4,y:-59,z:8},{elem:"C",x:-66,y:49,z:-3},{elem:"C",x:-67,y:-59,z:7},{elem:"C",x:-98,y:-5,z:2},{elem:"C",x:93,y:-7,z:3},{elem:"H",x:19,y:-102,z:12},{elem:"H",x:-91,y:91,z:-7},{elem:"H",x:-92,y:-101,z:11},{elem:"H",x:-147,y:-4,z:2},{elem:"H",x:-2,y:135,z:-10},{elem:"H",x:160,y:-59,z:-20}], [[0,4],[0,14],[1,9],[1,15],[2,9,"double"],[3,4],[3,5,"double"],[3,9],[4,6,"double"],[5,7],[5,10],[6,8],[6,11],[7,8,"double"],[7,12],[8,13]], null, null, "Cs");
addMol("C9H8O4|阿斯匹靈|乙醯柳酸|乙醯水楊酸", "C", "sp²", ["平面/苯環","Planar"], "109-120°", "136", "140", [{elem:"O",x:51,y:-18,z:35},{elem:"O",x:-36,y:129,z:-33},{elem:"O",x:31,y:105,z:39},{elem:"O",x:76,y:-29,z:-66},{elem:"C",x:-8,y:-20,z:20},{elem:"C",x:-40,y:32,z:6},{elem:"C",x:-37,y:-76,z:19},{elem:"C",x:-101,y:28,z:-9},{elem:"C",x:-98,y:-80,z:4},{elem:"C",x:-130,y:-27,z:-11},{elem:"C",x:-11,y:90,z:7},{elem:"C",x:91,y:-23,z:-14},{elem:"C",x:154,y:-20,z:8},{elem:"H",x:-13,y:-117,z:30},{elem:"H",x:-127,y:68,z:-20},{elem:"H",x:-121,y:-123,z:3},{elem:"H",x:-177,y:-30,z:-23},{elem:"H",x:163,y:-57,z:39},{elem:"H",x:185,y:-24,z:-31},{elem:"H",x:163,y:23,z:29},{elem:"H",x:-16,y:169,z:-33}], [[0,4],[0,11],[1,10],[1,20],[2,10,"double"],[3,11,"double"],[4,5],[4,6,"double"],[5,7,"double"],[5,10],[6,8],[6,13],[7,9],[7,14],[8,9,"double"],[8,15],[9,16],[11,12],[12,17],[12,18],[12,19]], null, null, "C1");
addMol("C3H4|丙二烯|Allene", "C", "sp (中) / sp² (端)", ["直線軸 (兩端垂直)","Linear Axis (Perpendicular Ends)"], "180° (軸) / 90° (面)", "-136", "-34", [{elem:"C",x:53,y:25,z:-3},{elem:"C",x:0,y:0,z:0},{elem:"C",x:-53,y:-25,z:3},{elem:"H",x:63,y:62,z:-33},{elem:"H",x:90,y:9,z:26},{elem:"H",x:-88,y:-8,z:33},{elem:"H",x:-65,y:-63,z:-26}], [[0,1,"double"],[0,3],[0,4],[1,2,"double"],[2,5],[2,6]], null, null, "D2d");
addMol("H2C2O4|乙二酸|草酸", "C", "sp²", ["平面","Planar"], "120°", "189.5", "365", [{elem:"O",x:57,y:54,z:0},{elem:"O",x:-57,y:-54,z:0},{elem:"O",x:61,y:-49,z:0},{elem:"O",x:-61,y:49,z:0},{elem:"C",x:34,y:-2,z:0},{elem:"C",x:-34,y:2,z:0},{elem:"H",x:101,y:53,z:0},{elem:"H",x:-101,y:-53,z:0}], [[0,4],[0,6],[1,5],[1,7],[2,4,"double"],[3,5,"double"],[4,5]], null, null, "C2h");
addMol("C2H4(OH)2|乙二醇|1,2-乙二醇", "C", "sp³", ["扭轉型/四面體","Gauche/Tetrahedral"], "109.5°", "-12.9", "197.3", [{elem:"O",x:-60,y:36,z:-1},{elem:"O",x:65,y:36,z:12},{elem:"C",x:-29,y:-16,z:19},{elem:"C",x:34,y:-16,z:-8},{elem:"H",x:-54,y:-56,z:5},{elem:"H",x:-27,y:-15,z:68},{elem:"H",x:59,y:-56,z:7},{elem:"H",x:33,y:-15,z:-57},{elem:"H",x:-63,y:34,z:-45},{elem:"H",x:42,y:71,z:-1}], [[0,2],[0,8],[1,3],[1,9],[2,3],[2,4],[2,5],[3,6],[3,7]], null, null, "C2");
addMol("C3H5(OH)3|丙三醇|甘油", "C", "sp³", ["鏈狀/四面體","Chain/Tetrahedral"], "109.5°", "17.8", "290", [{elem:"O",x:4,y:70,z:3},{elem:"O",x:111,y:10,z:-19},{elem:"O",x:-106,y:10,z:-19},{elem:"C",x:3,y:10,z:-20},{elem:"C",x:59,y:-22,z:3},{elem:"C",x:-54,y:-21,z:3},{elem:"H",x:3,y:14,z:-69},{elem:"H",x:62,y:-23,z:52},{elem:"H",x:61,y:-68,z:-14},{elem:"H",x:-56,y:-68,z:-13},{elem:"H",x:-56,y:-20,z:52},{elem:"H",x:4,y:68,z:47},{elem:"H",x:108,y:51,z:-4},{elem:"H",x:-141,y:-11,z:-3}], [[0,3],[0,11],[1,4],[1,12],[2,5],[2,13],[3,4],[3,5],[3,6],[4,7],[4,8],[5,9],[5,10]], null, null, "C1");
addMol("C8H9NO2|乙醯胺基苯酚|普拿疼", "C", "sp²", ["平面/四面體","Planar/Tetra"], "120°", "169", ">250", [{elem:"O",x:187,y:-27,z:0},{elem:"O",x:-103,y:-70,z:0},{elem:"N",x:-57,y:26,z:0},{elem:"C",x:4,y:12,z:0},{elem:"C",x:24,y:-47,z:0},{elem:"C",x:46,y:59,z:0},{elem:"C",x:85,y:-60,z:0},{elem:"C",x:108,y:46,z:0},{elem:"C",x:127,y:-14,z:0},{elem:"C",x:-106,y:-15,z:0},{elem:"C",x:-165,y:18,z:0},{elem:"H",x:-6,y:-86,z:0},{elem:"H",x:32,y:106,z:0},{elem:"H",x:-67,y:70,z:0},{elem:"H",x:99,y:-107,z:0},{elem:"H",x:140,y:82,z:0},{elem:"H",x:-169,y:45,z:-41},{elem:"H",x:-202,y:-15,z:1},{elem:"H",x:-168,y:47,z:40},{elem:"H",x:192,y:-70,z:0}], [[0,8],[0,19],[1,9,"double"],[2,3],[2,9],[2,13],[3,4,"double"],[3,5],[4,6],[4,11],[5,7,"double"],[5,12],[6,8,"double"],[6,14],[7,8],[7,15],[9,10],[10,16],[10,17],[10,18]], null, null, "Cs");
addMol("C7H8|甲苯|Toluene", "C", "sp²", ["平面/四面體","Mixed"], "120°", "-95", "110.6", [{elem:"C",x:-62.5,y:0,z:0},{elem:"C",x:-31.5,y:-54,z:0},{elem:"C",x:-31.5,y:54,z:0},{elem:"C",x:-129.5,y:0,z:0},{elem:"C",x:31.5,y:-54,z:0},{elem:"C",x:31.5,y:54,z:0},{elem:"C",x:62.5,y:0,z:0},{elem:"H",x:-55.5,y:-97,z:0},{elem:"H",x:-55.5,y:97,z:0},{elem:"H",x:-147.5,y:40,z:23},{elem:"H",x:-147.5,y:-40,z:23},{elem:"H",x:-146.5,y:0,z:-46},{elem:"H",x:55.5,y:-97,z:0},{elem:"H",x:55.5,y:97,z:0},{elem:"H",x:111.5,y:0,z:0}], [[0,1,"double"],[0,2],[0,3],[1,4],[1,7],[2,5,"double"],[2,8],[3,9],[3,10],[3,11],[4,6,"double"],[4,12],[5,6],[5,13],[6,14]], null, null, "Cs");addMol("C10H8|萘|Naphthalene", "C", "sp²", ["平面","Planar"], "120°", "80.2", "218", [{elem:"C",x:0,y:-32,z:0},{elem:"C",x:0,y:32,z:0},{elem:"C",x:55,y:-63,z:0},{elem:"C",x:55,y:63,z:0},{elem:"C",x:-55,y:-63,z:0},{elem:"C",x:-55,y:63,z:0},{elem:"C",x:109,y:-31,z:0},{elem:"C",x:109,y:31,z:0},{elem:"C",x:-109,y:-31,z:0},{elem:"C",x:-109,y:31,z:0},{elem:"H",x:56,y:-112,z:0},{elem:"H",x:56,y:112,z:0},{elem:"H",x:-56,y:-112,z:0},{elem:"H",x:-56,y:112,z:0},{elem:"H",x:152,y:-56,z:0},{elem:"H",x:152,y:56,z:0},{elem:"H",x:-152,y:-56,z:0},{elem:"H",x:-152,y:56,z:0}], [[0,1],[0,2,"double"],[0,4],[1,3,"double"],[1,5],[2,6],[2,10],[3,7],[3,11],[4,8,"double"],[4,12],[5,9,"double"],[5,13],[6,7,"double"],[6,14],[7,15],[8,9],[8,16],[9,17]], null, null, "D2h");
addMol("C6H6|苯|Benzene", "C", "sp²", ["平面","Planar"], "120°", "5.5", "80.1", [{elem:"C",x:63,y:0,z:0},{elem:"C",x:31.5,y:54.6,z:0},{elem:"C",x:-31.5,y:54.6,z:0},{elem:"C",x:-63,y:0,z:0},{elem:"C",x:-31.5,y:-54.6,z:0},{elem:"C",x:31.5,y:-54.6,z:0},{elem:"H",x:112,y:0,z:0},{elem:"H",x:56,y:97,z:0},{elem:"H",x:-56,y:97,z:0},{elem:"H",x:-112,y:0,z:0},{elem:"H",x:-56,y:-97,z:0},{elem:"H",x:56,y:-97,z:0}], [[0,1,"double"],[1,2],[2,3,"double"],[3,4],[4,5,"double"],[5,0],[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]], null, null, "D6h");
addMol("CH3COOCH3|乙酸甲酯|Methyl Acetate", "C", "sp²", ["平面/四面體","Mixed"], "120°", "-98", "56.9", [{elem:"C",x:-35,y:0,z:0},{elem:"C",x:10,y:0,z:0},{elem:"O",x:10,y:50,z:0},{elem:"O",x:50,y:-30,z:0},{elem:"C",x:90,y:-30,z:0},{elem:"H",x:-35,y:-45,z:0},{elem:"H",x:-65,y:25,z:25},{elem:"H",x:-65,y:25,z:-25},{elem:"H",x:90,y:-70,z:0},{elem:"H",x:120,y:-5,z:25},{elem:"H",x:120,y:-5,z:-25}], [[0,1],[1,2,"double"],[1,3],[3,4],[0,5],[0,6],[0,7],[4,8],[4,9],[4,10]], null, null, "Cs");
addMol("CH3COOC2H5|乙酸乙酯|Ethyl Acetate", "C", "sp²", ["平面/四面體","Mixed"], "120°", "-83.6", "77.1", [{elem:"C",x:-35,y:0,z:0},{elem:"C",x:10,y:0,z:0},{elem:"O",x:10,y:50,z:0},{elem:"O",x:50,y:-30,z:0},{elem:"C",x:90,y:-30,z:0},{elem:"C",x:125,y:15,z:0},{elem:"H",x:-35,y:-45,z:0},{elem:"H",x:-65,y:25,z:25},{elem:"H",x:-65,y:25,z:-25},{elem:"H",x:90,y:-70,z:0},{elem:"H",x:115,y:-50,z:30},{elem:"H",x:125,y:55,z:0},{elem:"H",x:155,y:-5,z:25},{elem:"H",x:155,y:-5,z:-25}], [[0,1],[1,2,"double"],[1,3],[3,4],[4,5],[0,6],[0,7],[0,8],[4,9],[4,10],[5,11],[5,12],[5,13]], null, null, "Cs");
addMol("CH3NHCH3|二甲胺|Dimethylamine", "N", "sp³", ["角錐","Pyramidal"], "107°", "-92.2", "6.9", [{elem:"N",x:0,y:0,z:0},{elem:"H",x:0,y:30,z:0},{elem:"C",x:40,y:-25,z:25},{elem:"C",x:-40,y:-25,z:25},{elem:"H",x:40,y:-25,z:65},{elem:"H",x:70,y:-50,z:5},{elem:"H",x:60,y:10,z:15},{elem:"H",x:-40,y:-25,z:65},{elem:"H",x:-70,y:-50,z:5},{elem:"H",x:-60,y:10,z:15}], [[0,1],[0,2],[0,3],[2,4],[2,5],[2,6],[3,7],[3,8],[3,9]], null, null, "Cs");
addMol("N(CH3)3|三甲胺|Trimethylamine", "N", "sp³", ["角錐","Pyramidal"], "108°", "-117.2", "2.9", [{elem:"N",x:0,y:15,z:0},{elem:"C",x:0,y:-25,z:35},{elem:"C",x:35,y:-25,z:-25},{elem:"C",x:-35,y:-25,z:-25},{elem:"H",x:0,y:-25,z:75},{elem:"H",x:30,y:-55,z:35},{elem:"H",x:-30,y:-55,z:35},{elem:"H",x:35,y:-25,z:-65},{elem:"H",x:65,y:-55,z:-25},{elem:"H",x:65,y:5,z:-25},{elem:"H",x:-35,y:-25,z:-65},{elem:"H",x:-65,y:-55,z:-25},{elem:"H",x:-65,y:5,z:-25}], [[0,1],[0,2],[0,3],[1,4],[1,5],[1,6],[2,7],[2,8],[2,9],[3,10],[3,11],[3,12]], null, null, "C3v");
addMol("HCONH2|甲醯胺|Formamide", "C", "sp²", ["平面","Planar"], "120°", "2.6", "210", [{elem:"C",x:0,y:0,z:0},{elem:"O",x:0,y:50,z:0},{elem:"N",x:45,y:-30,z:0},{elem:"H",x:-40,y:-25,z:0},{elem:"H",x:45,y:-65,z:0},{elem:"H",x:80,y:-10,z:0}], [[0,1,"double"],[0,2],[0,3],[2,4],[2,5]], null, null, "Cs");
addMol("CH3CONH2|乙醯胺|Acetamide", "C", "sp²", ["平面","Planar"], "120°", "82.3", "221.2", [{elem:"C",x:-40,y:0,z:0},{elem:"C",x:5,y:0,z:0},{elem:"O",x:5,y:50,z:0},{elem:"N",x:50,y:-30,z:0},{elem:"H",x:-40,y:-45,z:0},{elem:"H",x:-70,y:25,z:25},{elem:"H",x:-70,y:25,z:-25},{elem:"H",x:50,y:-65,z:0},{elem:"H",x:85,y:-10,z:0}], [[0,1],[1,2,"double"],[1,3],[0,4],[0,5],[0,6],[3,7],[3,8]], null, null, "Cs");
addMol("P4|白磷|黃磷|White Phosphorus", "P", "sp³", ["正四面體 (籠狀)","Tetrahedral Cage"], "60°", "44.1", "280.5", [{elem:"P",x:50,y:50,z:50}, {elem:"P",x:50,y:-50,z:-50}, {elem:"P",x:-50,y:50,z:-50}, {elem:"P",x:-50,y:-50,z:50}], [[0,1],[0,2],[0,3],[1,2],[1,3],[2,3]], null, null, "Td");
addMol("P4O6|六氧化四磷|Phosphorus Hexoxide", "P", "sp³", ["籠狀 (類金剛烷)","Cage"], "100°", "23.8", "173.1", [{elem:"P",x:55,y:55,z:55}, {elem:"P",x:55,y:-55,z:-55}, {elem:"P",x:-55,y:55,z:-55}, {elem:"P",x:-55,y:-55,z:55}, {elem:"O",x:85,y:0,z:0}, {elem:"O",x:-85,y:0,z:0}, {elem:"O",x:0,y:85,z:0}, {elem:"O",x:0,y:-85,z:0}, {elem:"O",x:0,y:0,z:85}, {elem:"O",x:0,y:0,z:-85}], [[0,4],[0,6],[0,8], [1,4],[1,7],[1,9], [2,5],[2,6],[2,9], [3,5],[3,7],[3,8]], null, null, "Td");
addMol("P4O10|十氧化四磷|Phosphorus Pentoxide", "P", "sp³", ["籠狀","Cage"], "102°/123°", "340 (昇華)", "-", [{elem:"P",x:55,y:55,z:55}, {elem:"P",x:55,y:-55,z:-55}, {elem:"P",x:-55,y:55,z:-55}, {elem:"P",x:-55,y:-55,z:55}, {elem:"O",x:85,y:0,z:0}, {elem:"O",x:-85,y:0,z:0}, {elem:"O",x:0,y:85,z:0}, {elem:"O",x:0,y:-85,z:0}, {elem:"O",x:0,y:0,z:85}, {elem:"O",x:0,y:0,z:-85}, {elem:"O",x:95,y:95,z:95}, {elem:"O",x:95,y:-95,z:-95}, {elem:"O",x:-95,y:95,z:-95}, {elem:"O",x:-95,y:-95,z:95}], [[0,4],[0,6],[0,8], [1,4],[1,7],[1,9], [2,5],[2,6],[2,9], [3,5],[3,7],[3,8], [0,10,"double"], [1,11,"double"], [2,12,"double"], [3,13,"double"]], null, null, "Td");
addMol("S8|斜方硫|單斜硫|硫磺", "S", "sp3", ["皇冠型 (環狀)","Crown Ring"], "108°", "115.2", "444.6", [{elem:"S",x:0,y:-105,z:-25},{elem:"S",x:-75,y:-75,z:25},{elem:"S",x:75,y:-75,z:25},{elem:"S",x:-105,y:0,z:-25},{elem:"S",x:105,y:0,z:-25},{elem:"S",x:-75,y:75,z:25},{elem:"S",x:75,y:75,z:25},{elem:"S",x:0,y:105,z:-25}], [[0,1],[0,2],[1,3],[2,4],[3,5],[4,6],[5,7],[6,7]], null, null, "D4d");
addMol("H2O2|過氧化氫|雙氧水", "O", "sp³", ["書本型","Open Book"], "111°", "-0.4", "150.2", [{elem:"O",x:-17,y:5,z:-17},{elem:"O",x:17,y:-5,z:17},{elem:"H",x:-55,y:35,z:-22},{elem:"H",x:55,y:-35,z:22}], [[0,1],[0,2],[1,3]], null, null, "C2");
addMol("H2S2|二硫化氫", "S", "sp³", ["書本型","Open Book"], "92°", "-89.6", "70.7", [{elem:"S",x:-20,y:5,z:-20},{elem:"S",x:20,y:-5,z:20},{elem:"H",x:-55,y:35,z:-25},{elem:"H",x:55,y:-35,z:25}], [[0,1],[0,2],[1,3]], null, null, "C2");
addMol("S2Cl2|二氯化二硫|二氯化硫", "S", "sp³", ["書本型","Open Book"], "103°", "-77", "138", [{elem:"S",x:0,y:25,z:0},{elem:"S",x:0,y:-25,z:0},{elem:"Cl",x:65,y:60,z:50},{elem:"Cl",x:-65,y:-60,z:50}], [[0,1],[0,2],[1,3]], null, null, "C2");
addMol("N2O3|三氧化二氮", "N", "sp²+sp²", ["平面","Planar"], "120°", "-100.7", "3.5", [{elem:"N",x:-32,y:0,z:0},{elem:"N",x:32,y:0,z:0},{elem:"O",x:-67,y:50,z:0},{elem:"O",x:67,y:50,z:0},{elem:"O",x:67,y:-50,z:0}], [[0,1],[0,2,"double"],[1,3,"double"],[1,4]], null, null, "Cs");
addMol("N2O4|四氧化二氮", "N", "sp²", ["平面","Planar"], "120°", "-11.2", "21.2", [{elem:"N",x:-35,y:0,z:0,lpCount:0},{elem:"N",x:35,y:0,z:0,lpCount:0},{elem:"O",x:-75,y:55,z:0},{elem:"O",x:-75,y:-55,z:0},{elem:"O",x:75,y:55,z:0},{elem:"O",x:75,y:-55,z:0}], [[0,1],[0,2,"double"],[0,3],[1,4,"double"],[1,5]], null, null, "D2h");
addMol("N2O5|五氧化二氮", "N", "sp²", ["非平面","V-shape"], "120°", "30 (昇華)", "47 (分解)", [{elem:"O",x:0,y:30,z:0},{elem:"N",x:-50,y:-15,z:0},{elem:"N",x:50,y:-15,z:0},{elem:"O",x:-85,y:30,z:0},{elem:"O",x:-85,y:-60,z:0},{elem:"O",x:85,y:30,z:0},{elem:"O",x:85,y:-60,z:0}], [[0,1],[0,2],[1,3,"double"],[1,4],[2,5,"double"],[2,6]], null, null, "C2");
addMol("C2H5Cl|氯乙烷", "C", "sp3", ["四面體","Tetrahedral"], "109.5", "-138.7", "12.3", [{elem:"Cl",x:100,y:-16,z:0},{elem:"C",x:25,y:28,z:0},{elem:"C",x:-35,y:-20,z:0},{elem:"H",x:25,y:56,z:-40},{elem:"H",x:25,y:56,z:40},{elem:"H",x:-78,y:5,z:0},{elem:"H",x:-35,y:-55,z:40},{elem:"H",x:-35,y:-55,z:-40}], [[0,1],[1,2],[1,3],[1,4],[2,5],[2,6],[2,7]], null, null, "Cs");
addMol("CHOCHO|乙二醛|Glyoxal", "C", "sp²", ["平面","Planar"], "120°", "15", "50.4", [{elem:"C",x:-28,y:0,z:0},{elem:"C",x:28,y:0,z:0},{elem:"O",x:-55,y:45,z:0},{elem:"O",x:55,y:-45,z:0},{elem:"H",x:-45,y:-40,z:0},{elem:"H",x:45,y:40,z:0}], [[0,1],[0,2,"double"],[1,3,"double"],[0,4],[1,5]], null, null, "C2h");
addMol("CH3OH|甲醇|木精", "C", "sp³", ["四面體","Tetrahedral"], "109.5°", "-97.6", "64.7", [{elem:"C",x:0,y:0,z:0}, {elem:"O",x:0,y:70,z:0,lpCount:2}, {elem:"H",x:0,y:-50,z:0}, {elem:"H",x:45,y:15,z:30}, {elem:"H",x:-45,y:15,z:30}, {elem:"H",x:50,y:85,z:0}], [[0,1],[0,2],[0,3],[0,4],[1,5]], null, null, "Cs");
addMol("C2H5OH|乙醇|Ethanol|酒精", "C", "sp3", ["四面體","Tetrahedral"], "109.5°", "-114.1", "78.2", [{elem:"O",x:-69,y:-14,z:-4},{elem:"C",x:-19,y:25,z:-4},{elem:"C",x:38,y:-13,z:-4},{elem:"H",x:-21,y:54,z:36},{elem:"H",x:-21,y:53,z:-44},{elem:"H",x:78,y:16,z:-5},{elem:"H",x:39,y:-42,z:-43},{elem:"H",x:40,y:-41,z:36},{elem:"H",x:-67,y:-38,z:32}], [[0,1],[0,8],[1,2],[1,3],[1,4],[2,5],[2,6],[2,7]], null, null, "Cs");
addMol("C10H15N|甲基苯丙胺|Methamphetamine", "C,N", "sp²/sp³", ["苯環平面","側鏈四面體"], "120°/109.5°", "3", "212", [{elem:"N",x:-126,y:-6,z:0,lpCount:1},{elem:"C",x:-63,y:-12,z:-18},{elem:"C",x:-22,y:11,z:33},{elem:"C",x:44,y:8,z:18},{elem:"C",x:-51,y:-79,z:-32},{elem:"C",x:71,y:57,z:-10},{elem:"C",x:76,y:-43,z:33},{elem:"C",x:-140,y:56,z:15},{elem:"C",x:132,y:54,z:-23},{elem:"C",x:137,y:-45,z:19},{elem:"C",x:165,y:3,z:-9},{elem:"H",x:-55,y:14,z:-59},{elem:"H",x:-32,y:58,z:44},{elem:"H",x:-31,y:-14,z:75},{elem:"H",x:-7,y:-85,z:-53},{elem:"H",x:-55,y:-107,z:8},{elem:"H",x:-84,y:-95,z:-65},{elem:"H",x:-153,y:-19,z:-35},{elem:"H",x:46,y:97,z:-21},{elem:"H",x:55,y:-81,z:55},{elem:"H",x:-189,y:62,z:16},{elem:"H",x:-125,y:68,z:60},{elem:"H",x:-123,y:88,z:-18},{elem:"H",x:154,y:92,z:-45},{elem:"H",x:163,y:-85,z:30},{elem:"H",x:213,y:1,z:-20}], [[0,1],[0,7],[0,17],[1,2],[1,4],[1,11],[2,3],[2,12],[2,13],[3,5,"double"],[3,6],[4,14],[4,15],[4,16],[5,8],[5,18],[6,9,"double"],[6,19],[7,20],[7,21],[7,22],[8,10,"double"],[8,23],[9,10],[9,24],[10,25]], null, null, "C1");


addMol("aaa", "C", "sp3", ["形狀","Shape"], "角度", "", "", [{elem:"C",x:20,y:12,z:6},{elem:"C",x:-24,y:66,z:1},{elem:"C",x:-4,y:-53,z:7},{elem:"C",x:-93,y:54,z:-3},{elem:"C",x:-73,y:-65,z:2},{elem:"C",x:-117,y:-11,z:-3},{elem:"C",x:91,y:24,z:11},{elem:"C",x:140,y:-16,z:-12},{elem:"H",x:-6,y:117,z:1},{elem:"H",x:29,y:-96,z:11},{elem:"H",x:-127,y:96,z:-7},{elem:"H",x:-92,y:-116,z:2},{elem:"H",x:-171,y:-20,z:-7},{elem:"H",x:106,y:71,z:35},{elem:"H",x:192,y:-1,z:-6},{elem:"H",x:130,y:-62,z:-38}], [[0,1,'double'],[0,2],[0,6],[1,3],[1,8],[2,4,'double'],[2,9],[3,5,'double'],[3,10],[4,5],[4,11],[5,12],[6,7,'double'],[6,13],[7,14],[7,15]]);
addMol("bbb", "C", "sp3", ["形狀","Shape"], "角度", "", "", [{elem:"C",x:91,y:39,z:0},{elem:"C",x:91,y:-39,z:0},{elem:"C",x:16,y:34,z:0},{elem:"C",x:16,y:-34,z:0},{elem:"C",x:-42,y:71,z:0},{elem:"C",x:-42,y:-71,z:0},{elem:"C",x:-102,y:35,z:0},{elem:"C",x:-102,y:-35,z:0},{elem:"H",x:114,y:62,z:44},{elem:"H",x:114,y:61,z:-44},{elem:"H",x:114,y:-62,z:-44},{elem:"H",x:114,y:-62,z:44},{elem:"H",x:-42,y:125,z:0},{elem:"H",x:-42,y:-125,z:0},{elem:"H",x:-149,y:62,z:0},{elem:"H",x:-149,y:-62,z:0}], [[0,1],[0,2],[0,8],[0,9],[1,3],[1,10],[1,11],[2,3],[2,4,'double'],[3,5,'double'],[4,6],[4,12],[5,7],[5,13],[6,7,'double'],[6,14],[7,15]]);







// --- 13.簡單離子化合物
addMol("KCl|氯化鉀", "K", "-", "-", "-", "770", "1420", [{elem:"K",x:-50,y:0,z:0,r:22,lpCount:0}, {elem:"Cl",x:50,y:0,z:0,r:35,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>氯化鉀 (KCl)</strong><br>白色結晶固體，外觀與食鹽相似。它是鉀肥的主要成分，對植物生長至關重要。</div></div>');
addMol("KI|碘化鉀", "K", "-", "-", "-", "681", "1330", [{elem:"K",x:-55,y:0,z:0,r:22,lpCount:0}, {elem:"I",x:55,y:0,z:0,r:40,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>碘化鉀 (KI)</strong><br>白色晶體，易溶於水。常添加於食鹽中作為碘的來源。</div></div>');
addMol("KBr|溴化鉀", "K", "-", "-", "-", "734", "1435", [{elem:"K",x:-50,y:0,z:0,r:22,lpCount:0}, {elem:"Br",x:50,y:0,z:0,r:38,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>溴化鉀 (KBr)</strong><br>白色結晶，對紅外光透明，常用來製作光譜分析的樣品鹽片。</div></div>');
addMol("NaF|氟化鈉", "Na", "-", "-", "-", "993", "1704", [{elem:"Na",x:-40,y:0,z:0,r:20,lpCount:0}, {elem:"F",x:40,y:0,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>氟化鈉 (NaF)</strong><br>牙膏中常見的添加劑，能提供氟離子以強化牙齒琺瑯質。</div></div>');
addMol("LiF|氟化鋰", "Li", "-", "-", "-", "845", "1676", [{elem:"Li",x:-40,y:0,z:0,r:15,lpCount:0}, {elem:"F",x:40,y:0,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>氟化鋰 (LiF)</strong><br>在紫外線區域具有極佳的穿透性，常用於光學透鏡材料。</div></div>');
addMol("MgO|氧化鎂|苦土", "Mg", "-", "-", "-", "2852", "3600", [{elem:"Mg",x:-40,y:0,z:0,r:18,lpCount:0}, {elem:"O",x:40,y:0,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧱 物質性質</div><div class="info-body"><strong>氧化鎂 (MgO)</strong><br>熔點極高，是優良的耐火材料。</div></div>');
addMol("CaO|氧化鈣|生石灰", "Ca", "-", "-", "-", "2572", "2850", [{elem:"Ca",x:-45,y:0,z:0,r:22,lpCount:0}, {elem:"O",x:45,y:0,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧱 物質性質</div><div class="info-body"><strong>氧化鈣 (CaO)</strong><br>俗稱生石灰，遇水放熱生成熟石灰，是常用的乾燥劑。</div></div>');
addMol("BaO|氧化鋇", "Ba", "-", "-", "-", "1923", "2000", [{elem:"Ba",x:-50,y:0,z:0,r:28,lpCount:0}, {elem:"O",x:50,y:0,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧱 物質性質</div><div class="info-body"><strong>氧化鋇 (BaO)</strong><br>用於玻璃工業增加折射率。</div></div>');
addMol("ZnO|氧化鋅|鋅白", "Zn", "-", "-", "-", "1975", "-", [{elem:"Zn",x:-40,y:0,z:0,r:18,lpCount:0}, {elem:"O",x:40,y:0,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🎨 物質性質</div><div class="info-body"><strong>氧化鋅 (ZnO)</strong><br>俗稱鋅白，具有紫外線遮蔽能力，用於防曬乳與橡膠工業。</div></div>');
addMol("CuO|氧化銅", "Cu", "-", "-", "-", "1326", "-", [{elem:"Cu",x:-40,y:0,z:0,r:18,lpCount:0}, {elem:"O",x:40,y:0,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">⚫ 物質性質</div><div class="info-body"><strong>氧化銅 (CuO)</strong><br>黑色固體，用於製造顏料與有機分析。</div></div>');
addMol("AgCl|氯化銀", "Ag", "-", "-", "-", "455", "1550", [{elem:"Ag",x:-45,y:0,z:0,r:22,lpCount:0}, {elem:"Cl",x:45,y:0,z:0,r:35,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">📷 物質性質</div><div class="info-body"><strong>氯化銀 (AgCl)</strong><br>白色沈澱，見光分解產生黑色的銀，曾用於攝影底片。</div></div>');
addMol("AgBr|溴化銀", "Ag", "-", "-", "-", "432", "1502", [{elem:"Ag",x:-48,y:0,z:0,r:22,lpCount:0}, {elem:"Br",x:48,y:0,z:0,r:38,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">📷 物質性質</div><div class="info-body"><strong>溴化銀 (AgBr)</strong><br>淺黃色固體，感光性強，傳統攝影底片的主要成分。</div></div>');
addMol("AgI|碘化銀", "Ag", "-", "-", "-", "558", "1506", [{elem:"Ag",x:-50,y:0,z:0,r:22,lpCount:0}, {elem:"I",x:50,y:0,z:0,r:40,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🌧️ 物質性質</div><div class="info-body"><strong>碘化銀 (AgI)</strong><br>黃色固體，晶體結構似冰，用於人造降雨的晶種。</div></div>');
addMol("NaH|氫化鈉", "Na", "-", "-", "-", "800", "分解", [{elem:"Na",x:-40,y:0,z:0,r:20,lpCount:0}, {elem:"H",x:40,y:0,z:0,r:15,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧪 物質性質</div><div class="info-body"><strong>氫化鈉 (NaH)</strong><br>含氫負離子 (H⁻) 的強還原劑。</div></div>');
addMol("HgS|硫化汞|硃砂", "Hg", "-", "-", "-", "583", "昇華", [{elem:"Hg",x:-45,y:0,z:0,r:25,lpCount:0}, {elem:"S",x:45,y:0,z:0,r:30,lpCount:0}], [[0, 1, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🎨 物質性質</div><div class="info-body"><strong>硫化汞 (HgS)</strong><br>天然硃砂，鮮紅色，古代顏料與煉丹原料。</div></div>');
addMol("MgCl2|氯化鎂", "Mg", "-", "-", "-", "714", "1412", [{elem:"Mg",x:0,y:0,z:0,r:18,lpCount:0}, {elem:"Cl",x:-85,y:0,z:0,r:35,lpCount:0}, {elem:"Cl",x:85,y:0,z:0,r:35,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>氯化鎂 (MgCl₂)</strong><br>苦滷的主要成分，豆腐凝固劑。</div></div>');
addMol("CaCl2|氯化鈣", "Ca", "-", "-", "-", "772", "1935", [{elem:"Ca",x:0,y:0,z:0,r:22,lpCount:0}, {elem:"Cl",x:-90,y:0,z:0,r:35,lpCount:0}, {elem:"Cl",x:90,y:0,z:0,r:35,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>氯化鈣 (CaCl₂)</strong><br>強吸濕性，常用乾燥劑與融雪劑。</div></div>');
addMol("CaF2|氟化鈣|螢石", "Ca", "-", "-", "-", "1418", "2533", [{elem:"Ca",x:0,y:0,z:0,r:22,lpCount:0}, {elem:"F",x:-80,y:0,z:0,r:25,lpCount:0}, {elem:"F",x:80,y:0,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">💎 物質性質</div><div class="info-body"><strong>氟化鈣 (CaF₂)</strong><br>螢石，製備 HF 的原料，也用於光學鏡頭。</div></div>');
addMol("BaCl2|氯化鋇", "Ba", "-", "-", "-", "962", "1560", [{elem:"Ba",x:0,y:0,z:0,r:28,lpCount:0}, {elem:"Cl",x:-95,y:0,z:0,r:35,lpCount:0}, {elem:"Cl",x:95,y:0,z:0,r:35,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>氯化鋇 (BaCl₂)</strong><br>檢驗硫酸根的試劑，劇毒，燃燒呈黃綠色火焰。</div></div>');
addMol("CuCl2|氯化銅", "Cu", "-", "-", "-", "620", "993", [{elem:"Cu",x:0,y:0,z:0,r:18,lpCount:0}, {elem:"Cl",x:-80,y:0,z:0,r:35,lpCount:0}, {elem:"Cl",x:80,y:0,z:0,r:35,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>氯化銅 (CuCl₂)</strong><br>燃燒呈藍綠色火焰。</div></div>');
addMol("PbI2|碘化鉛", "Pb", "-", "-", "-", "402", "953", [{elem:"Pb",x:0,y:0,z:0,r:25,lpCount:0}, {elem:"I",x:-90,y:0,z:0,r:40,lpCount:0}, {elem:"I",x:90,y:0,z:0,r:40,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">✨ 物質性質</div><div class="info-body"><strong>碘化鉛 (PbI₂)</strong><br>亮黃色晶體，用於「黃金雨」實驗。</div></div>');
addMol("CaH2|氫化鈣", "Ca", "-", "-", "-", "816", "分解", [{elem:"Ca",x:0,y:0,z:0,r:22,lpCount:0}, {elem:"H",x:-70,y:0,z:0,r:15,lpCount:0}, {elem:"H",x:70,y:0,z:0,r:15,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">⛺ 物質性質</div><div class="info-body"><strong>氫化鈣 (CaH₂)</strong><br>攜帶方便的氫氣發生劑。</div></div>');
addMol("Na2O|氧化鈉", "Na", "-", "-", "-", "1132", "1950", [{elem:"O",x:0,y:0,z:0,r:25,lpCount:0}, {elem:"Na",x:-90,y:0,z:0,r:20,lpCount:0}, {elem:"Na",x:90,y:0,z:0,r:20,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>氧化鈉 (Na₂O)</strong><br>鹼性氧化物。</div></div>');
addMol("K2O|氧化鉀", "K", "-", "-", "-", "740", "分解", [{elem:"O",x:0,y:0,z:0,r:25,lpCount:0}, {elem:"K",x:-100,y:0,z:0,r:22,lpCount:0}, {elem:"K",x:100,y:0,z:0,r:22,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧂 物質性質</div><div class="info-body"><strong>氧化鉀 (K₂O)</strong><br>極易吸濕，用於肥料計算基準。</div></div>');
addMol("Na2S|硫化鈉", "Na", "-", "-", "-", "1176", "-", [{elem:"S",x:0,y:0,z:0,r:30,lpCount:0}, {elem:"Na",x:-90,y:0,z:0,r:20,lpCount:0}, {elem:"Na",x:90,y:0,z:0,r:20,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧪 物質性質</div><div class="info-body"><strong>硫化鈉 (Na₂S)</strong><br>俗稱臭鹼，用於造紙與皮革工業。</div></div>');
addMol("FeCl2|氯化亞鐵", "Fe", "-", "-", "-", "677", "1023", [{elem:"Fe",x:0,y:0,z:0,r:18,lpCount:0}, {elem:"Cl",x:-85,y:0,z:0,r:35,lpCount:0}, {elem:"Cl",x:85,y:0,z:0,r:35,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧪 物質性質</div><div class="info-body"><strong>氯化亞鐵 (FeCl₂)</strong><br>淺綠色晶體，具還原性。</div></div>');
addMol("FeCl3|氯化鐵", "Fe", "-", "-", "-", "306", "315", [{elem:"Fe",x:0,y:0,z:0,r:18,lpCount:0}, {elem:"Cl",x:0,y:90,z:0,r:35,lpCount:0}, {elem:"Cl",x:-78,y:-45,z:0,r:35,lpCount:0}, {elem:"Cl",x:78,y:-45,z:0,r:35,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"], [0, 3, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧪 物質性質</div><div class="info-body"><strong>氯化鐵 (FeCl₃)</strong><br>黑棕色晶體，用於電路板蝕刻。</div></div>');
addMol("AlCl3|氯化鋁", "Al", "-", "-", "-", "192", "180 (昇華)", [{elem:"Al",x:0,y:0,z:0,r:18,lpCount:0}, {elem:"Cl",x:0,y:90,z:0,r:35,lpCount:0}, {elem:"Cl",x:-78,y:-45,z:0,r:35,lpCount:0}, {elem:"Cl",x:78,y:-45,z:0,r:35,lpCount:0}], [[0, 1, "ionic_thin"], [0, 2, "ionic_thin"], [0, 3, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧪 物質性質</div><div class="info-body"><strong>氯化鋁 (AlCl₃)</strong><br>路易斯酸，有機合成催化劑。</div></div>');
addMol("Al2O3|氧化鋁|剛玉", "Al", "-", "-", "-", "2072", "2977", [{elem:"O",x:-90,y:-20,z:0,r:25,lpCount:0}, {elem:"Al",x:-45,y:40,z:0,r:18,lpCount:0}, {elem:"O",x:0,y:-20,z:0,r:25,lpCount:0}, {elem:"Al",x:45,y:40,z:0,r:18,lpCount:0}, {elem:"O",x:90,y:-20,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"], [1, 2, "ionic_thin"], [2, 3, "ionic_thin"], [3, 4, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">💎 物質性質</div><div class="info-body"><strong>氧化鋁 (Al₂O₃)</strong><br>剛玉，紅寶石與藍寶石的主要成分，硬度高。</div></div>');
addMol("Fe2O3|氧化鐵|赤鐵礦", "Fe", "-", "-", "-", "1565", "-", [{elem:"O",x:-90,y:-20,z:0,r:25,lpCount:0}, {elem:"Fe",x:-45,y:40,z:0,r:18,lpCount:0}, {elem:"O",x:0,y:-20,z:0,r:25,lpCount:0}, {elem:"Fe",x:45,y:40,z:0,r:18,lpCount:0}, {elem:"O",x:90,y:-20,z:0,r:25,lpCount:0}], [[0, 1, "ionic_thin"], [1, 2, "ionic_thin"], [2, 3, "ionic_thin"], [3, 4, "ionic_thin"]], null, '<div class="info-section"><div class="info-title">🧱 物質性質</div><div class="info-body"><strong>氧化鐵 (Fe₂O₃)</strong><br>紅棕色粉末，俗稱鐵鏽或紅土，為赤鐵礦成分。</div></div>');


// ==========================================
// 碳簇生成器 (放在檔案最後面)
// ==========================================
function addFullerene(name, n, radius, stretch = 1) {
    const atoms = [];
    if (n === 60) {
        const phi = (1 + Math.sqrt(5)) / 2; 
        const scale = 28;
        let rawVerts = [];
        const groups = [[0, 1, 3*phi], [1, 2+phi, 2*phi], [phi, 2, 2*phi+1]];
        groups.forEach(g => {
            const cycles = [[g[0],g[1],g[2]], [g[1],g[2],g[0]], [g[2],g[0],g[1]]];
            cycles.forEach(p => {
                for(let i=0; i<8; i++) {
                    let x = p[0] * ((i & 1) ? 1 : -1);
                    let y = p[1] * ((i & 2) ? 1 : -1);
                    let z = p[2] * ((i & 4) ? 1 : -1);
                    rawVerts.push({x, y, z});
                }
            });
        });
        const threshold = 0.1;
        rawVerts.forEach(v => {
            if(!atoms.some(a => Math.abs(a.x - v.x*scale) < threshold && Math.abs(a.y - v.y*scale) < threshold && Math.abs(a.z - v.z*scale) < threshold)) {
                atoms.push({elem: "C", x: v.x*scale, y: v.y*scale, z: v.z*scale, r: 5, lpCount: 0});
            }
        });
    } else {
        const phi = Math.PI * (3 - Math.sqrt(5)); 
        for(let i = 0; i < n; i++) {
            const y = 1 - (i / (n - 1)) * 2; 
            const r = Math.sqrt(1 - y * y);
            const theta = phi * i;
            const x = Math.cos(theta) * r;
            const z = Math.sin(theta) * r;
            atoms.push({elem: "C", x: x * radius, y: y * radius * stretch, z: z * radius, r: 5, lpCount: 0});
        }
    }
    const bonds = []; const bondSet = new Set();
    for(let i = 0; i < atoms.length; i++) {
        let dists = [];
        for(let j = 0; j < atoms.length; j++) {
            if(i === j) continue;
            let d = (atoms[i].x - atoms[j].x)**2 + (atoms[i].y - atoms[j].y)**2 + (atoms[i].z - atoms[j].z)**2;
            dists.push({id: j, d: d});
        }
        dists.sort((a, b) => a.d - b.d);
        for(let k = 0; k < 3; k++){
            let neighbor = dists[k].id;
            let id1 = Math.min(i, neighbor); let id2 = Math.max(i, neighbor);
            let key = `${id1}-${id2}`;
            if(!bondSet.has(key)){
                let type = (k === 0) ? "double" : "single"; 
                bonds.push([id1, id2, type]); bondSet.add(key);
            }
        }
    }
    // [修正] 補上 mp 和 bp 參數 ("-", "-")，避免參數錯位
    addMol(name, "C", "sp²", ["球狀", n===60?"Truncated Icosahedron":"Fullerene"], "120°", "-", "-", atoms, bonds);
}

// [修正] 加上中文名稱，讓「猜你想看」顯示更完整
addFullerene("C36|碳36", 36, 130);
addFullerene("C40|碳40", 40, 140);
addFullerene("C50|碳50", 50, 160);
addFullerene("C70|碳70", 70, 160, 1.4);
addFullerene("C80|碳80", 80, 170);
addFullerene("C100|碳100", 100, 190);

// Defensive cleanup for any "複合"/composite mode artifacts possibly defined here
(function(){
    const keys = ["模式: 複合","模式_複合","複合模式","compositeMode","modeComposite","composite"];
    if (typeof window !== 'undefined') {
        keys.forEach(k=>{
            try { if (window.hasOwnProperty(k)) delete window[k]; } catch(e){ try { window[k]=undefined; } catch(_){} }
        });
    }
})();
</script>
<script>
// ==========================================
// data_reactions.js - 化學反應邏輯與動畫控制
// ==========================================

// 儲存反應歷史紀錄，用於「重置/返回」功能
moleculeHistory = [];

// 取得當前分子的中文名稱 (輔助函式)
function getCurrentMoleculeName() {
    // 確保讀取全域的 window.currentMolecule
    if (!window.currentMolecule || !window.currentMolecule.fullKey) return "";
    const parts = currentMolecule.fullKey.split('|');
    return parts.length > 1 ? parts[1].trim() : parts[0].trim();
}

// 核心邏輯：檢查按鈕狀態 & 決定哪些反應按鈕該出現
function checkReactionAvailable(key) {
    const btnContainer = document.getElementById("reaction-container");
    const resetBtn = document.querySelector(".reset-btn");
    const btns = document.querySelectorAll(".reaction-btn"); 
    
    // 1. 初始化：隱藏所有按鈕（guard for removed UI）
    if (btns && btns.length) btns.forEach(b => b.style.display = "none");
    if (btnContainer) btnContainer.style.display = "none";
    if (resetBtn) resetBtn.style.display = "none";

    const currentName = getCurrentMoleculeName();

    // --- A. 乙烯專屬反應 ---
    if (currentName === "乙烯") {
        if (btnContainer) btnContainer.style.display = "block";
        ["reaction-btn", "reaction-h2-btn", "reaction-hcl-btn", "reaction-cl2-btn", "reaction-kmno4-btn"].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = "flex";
        });
    } 
    // --- B. 丙烯專屬反應 ---
    else if (currentName === "丙烯") { 
        if (btnContainer) btnContainer.style.display = "block";
        ["reaction-propene-h2-btn", "reaction-propene-cl2-btn", "reaction-propene-hcl-btn", "reaction-propene-h2o-btn"].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = "flex";
        });
    } 
    // --- C. 乙炔專屬反應 ---
    else if (currentName === "乙炔") {
        if (btnContainer) btnContainer.style.display = "block";
        ["btn-c2h2-h2-full", "btn-c2h2-h2-part", "btn-c2h2-cl2-full", "btn-c2h2-cl2-part", "btn-c2h2-hcl-full", "btn-c2h2-hcl-part", "btn-c2h2-h2o"].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = "flex";
        });
    }
    // --- D. 甲烷專屬反應 ---
    else if (currentName === "甲烷") {
        if (btnContainer) btnContainer.style.display = "block";
        const subBtn = document.getElementById("reaction-sub-btn");
        const nitroBtn = document.getElementById("reaction-nitro-btn");
        if(subBtn) subBtn.style.display = "flex"; 
        if(nitroBtn) nitroBtn.style.display = "flex"; 
    } 
    // --- E. 乙醇/乙醛/乙酸 ---
    else if (currentName === "乙醇" || currentName === "酒精") {
        if (btnContainer) btnContainer.style.display = "block";
        const oxBtn = document.getElementById("reaction-ox-btn");
        const kmBtn = document.getElementById("reaction-kmno4-btn");
        if(oxBtn) oxBtn.style.display = "flex";
        if(kmBtn) kmBtn.style.display = "flex";
    }
    else if (currentName === "乙醛") {
        if (btnContainer) btnContainer.style.display = "block";
        const oxBtn = document.getElementById("reaction-ox-btn");
        const redBtn = document.getElementById("reaction-red-btn");
        if(oxBtn) oxBtn.style.display = "flex";
        if(redBtn) redBtn.style.display = "flex";
    }

    // 只要歷史紀錄不是空的，就顯示重置按鈕 (回到上一步)
    if (moleculeHistory.length > 0) {
        if (btnContainer) btnContainer.style.display = "block";
        if (resetBtn) resetBtn.style.display = "block";
    }
}

// 重置反應 (返回上一步)
function resetReaction() {
    if (moleculeHistory.length === 0) return;

    isReactionRunning = false;
    isReactionFinished = false; 
    
    const subEl = document.getElementById("viewport-subtitle");
    if(subEl) subEl.style.display = 'none';

    // 取出上一筆紀錄並載入
    const previousState = moleculeHistory.pop();
    loadMolecule(previousState.key, previousState.variant);
}

// 執行反應動畫與切換分子
function finishReaction(nextKey, nextTitle, variantName = null, description = null) {
    moleculeHistory.push({
        key: currentKey,
        variant: currentVariantKey
    });

    const svg = document.getElementById("scene-root");
    svg.classList.add("scene-blur-out");
    
    setTimeout(() => {
        loadMolecule(nextKey, variantName); 
        
        if (description) {
            // 1. 隱藏左上角副標題文字
            const subtitle = document.getElementById("viewport-subtitle");
            if (subtitle) subtitle.style.display = "none";

            // 2. 將描述文字放回控制面板的「小知識」卡片
            const kCard = document.getElementById("knowledge-card");
            const kText = document.getElementById("knowledge-text");
            if (kCard && kText) {
                kText.innerHTML = description;
                kCard.style.display = "block";
                kCard.classList.add("expanded"); // 自動展開卡片
            }
        }
        
        svg.classList.remove("scene-blur-out");
        svg.classList.add("scene-blur-in");
        
        setTimeout(() => {
            svg.classList.remove("scene-blur-in");
            isReactionRunning = false; 
            isReactionFinished = true; 
            checkReactionAvailable(nextKey); 
        }, 1500);
    }, 1500);
}

// --- 以下為各別反應的 Runner 函式 ---
// 1. 乙烯系列 (原料: 乙烯)
function runEthyleneHydration() {
    finishReaction("C2H5OH", "乙醇", null, "乙烯的碳碳𝝿鍵打斷，一個C原子接H，另一個C原子接OH，轉變成乙醇");
}
function runEthyleneChlorination() {
    finishReaction("C2H4Cl2", "1,2-二氯乙烷", "C2H4Cl2|1,2-二氯乙烷", "乙烯的碳碳𝝿鍵打斷，兩個C原子各接1個Cl，轉變成1,2-二氯乙烷，亦為氧化反應(C氧化數上升)");
}
function runEthyleneHydrogenation() {
    finishReaction("C2H6", "乙烷", null, "乙烯的碳碳𝝿鍵打斷，兩個C原子各接1個H，轉變成乙烷，亦為還原反應(C氧化數下降)");
}
function runEthyleneHydrohalogenation() {
    finishReaction("C2H5Cl", "氯乙烷", null, "乙烯的碳碳𝝿鍵打斷，一個C原子接H，另一個C原子接Cl，轉變成氯乙烷");
}
function runEthyleneOxidation() {
    finishReaction("C2H4(OH)2", "乙二醇", "C2H4(OH)2|乙二醇|1,2-乙二醇", "乙烯通入冷稀、中性或微鹼性的過錳酸鉀溶液中，碳碳雙鍵斷裂，發生氧化反應，雙鍵的兩個C接上OH，生成乙二醇。");
}

// 2. 甲烷系列 (原料: 甲烷)
function runMethaneSubstitution() {
    finishReaction("CH3Cl", "一氯甲烷", null, "甲烷其中一個C-H鍵斷裂，接上Cl原子，脫去的H與另一個Cl原子結合成HCl");
}
function runMethaneNitration() {
    finishReaction("CH3NO2", "硝基甲烷", null, "甲烷其中一個C-H鍵斷裂，接上NO₂，脫去的H與硝酸脫去的OH結合成H₂O");
}

// 3. 丙烯系列 (原料: 丙烯)
function runPropeneHydrogenation() {
    finishReaction("C3H8", "丙烷", null, "丙烯的碳碳𝝿鍵打斷，兩個斷𝝿鍵的C原子各接1個H，轉變成丙烷，亦為還原反應(C氧化數下降)");
}
function runPropeneChlorination() {
    finishReaction("C3H6Cl2", "1,2-二氯丙烷", "C3H6Cl2|1,2-二氯丙烷", "丙烯的碳碳𝝿鍵打斷，兩個斷𝝿鍵的C原子各接1個Cl，轉變成1,2-二氯丙烷，亦為氧化反應(C氧化數上升)");
}
function runPropeneHydrohalogenation() {
    finishReaction("C3H7Cl", "2-氯丙烷", "C3H7Cl|2-氯丙烷", "丙烯的碳碳𝝿鍵打斷，兩個斷𝝿鍵的C原子，含H較多的C連接H，另一個C(中間)連接Cl，轉變成2-氯丙烷(需考慮馬氏規則)");
}
function runPropeneHydration() {
    finishReaction("C3H8O", "2-丙醇", "C3H8O|2-丙醇", "丙烯的碳碳𝝿鍵打斷，兩個斷𝝿鍵的C原子，含H較多的C連接H，另一個C(中間)連接OH，轉變成異丙醇(需考慮馬氏規則)");
}

// 4. 乙醇/乙醛系列
function runEthanolMildOxidation() {
    finishReaction("CH3CHO", "乙醛", null, "乙醇為1級醇，接O的C上具有H，一般氧化劑會先將乙醇氧化成乙醛");
}
function runEthanolStrongOxidation() {
    finishReaction("CH3COOH", "乙酸", null, "乙醇為1級醇，接O的C上具有H，由於過錳酸鉀氧化力較強，故乙醇直接氧化成乙酸");
}
function runAcetaldehydeOxidation() {
    finishReaction("CH3COOH", "乙酸", null, "乙醛接O的C上具有H，經過氧化可以形成乙酸");
}
function runAcetaldehydeReduction() {
    finishReaction("C2H5OH", "乙醇", null, "醛類可以還原，變回1級醇，乙醛還原後形成乙醇");
}

// 5. 乙炔系列
function runAcetyleneFullHydrogenation() {
    finishReaction("C2H6", "乙烷", null, "乙炔的兩個碳碳𝝿鍵全數打斷，參鍵兩端的C原子各接上2個H，轉變成飽和的乙烷，亦為還原反應(C氧化數下降)。");
}
function runAcetylenePartialHydrogenation() {
    finishReaction("C2H4", "乙烯", null, "乙炔的其中一個碳碳𝝿鍵打斷，參鍵兩端的C原子各接上1個H，轉變成乙烯，此為控制條件下的部分還原反應(C氧化數下降)。");
}
function runAcetyleneFullHalogenation() {
    finishReaction("C2H2Cl4", "1,1,2,2-四氯乙烷", "C2H2Cl4|1,1,2,2-四氯乙烷", "乙炔的兩個碳碳𝝿鍵全數打斷，參鍵兩端的C原子各接上2個Cl，轉變成1,1,2,2-四氯乙烷，亦為氧化反應(C氧化數上升)。");
}
function runAcetylenePartialHalogenation() {
    finishReaction("C2H2Cl2", "反-1,2-二氯乙烯", "C2H2Cl2|反-1,2-二氯乙烯", "乙炔的其中一個碳碳𝝿鍵打斷，參鍵兩端的C原子各接上1個Cl，轉變成1,2-二氯乙烯(從反應機構可知主產物為反式)。");
}
function runAcetyleneFullHydrohalogenation() {
    finishReaction("C2H4Cl2", "1,1-二氯乙烷", "C2H4Cl2|1,1-二氯乙烷", "乙炔與足量鹵化氫反應，兩個碳碳𝝿鍵全數打斷。依馬氏規則，兩個Cl原子會接在同一個C原子上，轉變成1,1-二氯乙烷。");
}
function runAcetylenePartialHydrohalogenation() {
    finishReaction("C2H3Cl", "氯乙烯", "C2H3Cl|氯乙烯", "乙炔的其中一個碳碳𝝿鍵打斷，一個C接H，另一個C接Cl，轉變成氯乙烯，此為聚氯乙烯(PVC)的重要單體原料。");
}
function runAcetyleneHydration() {
    finishReaction("CH3CHO", "乙醛", null, "乙炔在硫酸與硫酸汞(HgSO₄)催化下與水加成，𝝿鍵斷裂後先形成不穩定的乙烯醇，隨即發生『醛酮-烯醇互變異構』，氫原子轉移，最終轉變成乙醛。");
}

// Defensive cleanup for any "複合"/composite mode artifacts possibly defined here
(function(){
	const keys = ["模式: 複合","模式_複合","複合模式","compositeMode","modeComposite","composite"];
	if (typeof window !== 'undefined') {
		keys.forEach(k=>{
			try { if (window.hasOwnProperty(k)) delete window[k]; } catch(e){ try { window[k]=undefined; } catch(_){} }
		});
	}
})();
</script>
<script>
// ==========================================
// 1. 系統初始化
// ==========================================
window.currentMolecule = null;
window.currentKey = null;
window.togglePgFlowchart = function() {
    const overlay = document.getElementById('pg-flowchart-overlay');
    if (!overlay) return;
    if (overlay.style.display === 'none' || overlay.style.display === '') {
        overlay.style.display = 'block';
        document.body.style.overflow = 'hidden'; 
    } else {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
    }
};
window.currentVariantKey = null;
window.moleculeHistory = [];
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
let isReactionRunning = false; 
let isReactionFinished = false; 
let isPlasmaMode = false; // [修復] 確保變數存在
window.isGlowOn = false; // Glow disabled by default (option removed)



// --- [新增] 用來儲存反應歷史紀錄 ---
let moleculeHistory = [];

function autoAssignLonePairs(atom, bonds, allAtoms) {
    if (atom.lp3d !== undefined && atom.lp3d.length > 0) return atom.lpCount || atom.lp3d.length;
    if (atom.lpCount !== undefined) return atom.lpCount;
    const props = ELEMENT_PROPS[atom.elem]; if (!props) return 0;
    const valence = props.ve; const en = props.en || 0;
    let bondElectronCount = 0; let neighborCount = 0;
    const myIndex = atom.originalIndex;
    bonds.forEach(b => {
        if (b[0] !== myIndex && b[1] !== myIndex) return;
        neighborCount++; 
        let type = b[2] || "single";
        if (type.includes("triple")) bondElectronCount += 3;
        else if (type.includes("double")) bondElectronCount += 2;
        else if (type === "coordinate") { if (b[0] === myIndex) bondElectronCount += 2; }
        else if (type === "coordinate_triple") bondElectronCount += 3;
        else bondElectronCount += 1;
    });
    let remainingElectrons = valence - bondElectronCount;
    if (remainingElectrons % 2 !== 0 && !atom.radical) {
        if (neighborCount === 1 && en > 2.5) remainingElectrons += 1;
    }
    let lp = Math.floor(remainingElectrons / 2);
    return Math.max(0, lp);
}
function generateElectronDots(atom, atomIndex, allAtoms, allBonds) {
    const dots = []; 
    let lpCount = atom.calculatedLP;
    // 如果沒有孤對電子且不是自由基，直接返回空陣列
    if (lpCount <= 0 && !atom.radical) return dots;

    // --- 1. 幾何位置計算 (維持原有的 3D 向量運算) ---
    if (atom.lp3d && atom.lp3d.length > 0) {
        // 如果有手動指定的座標 (hardcoded)
        const pushDist = atom.r * 2.2; 
        atom.lp3d.forEach(v => {
            const len = Math.sqrt(v.x*v.x + v.y*v.y + v.z*v.z) || 1;
            addPairToDots(dots, atom, { x: (v.x/len)*pushDist, y: (v.y/len)*pushDist, z: (v.z/len)*pushDist });
        });
    } else {
        // 自動計算：根據鍵結向量推算孤對電子位置
        const myBonds = allBonds.filter(b => b[0] === atomIndex || b[1] === atomIndex);
        let bondVectors = [];
        myBonds.forEach(b => {
            const otherIdx = (b[0] === atomIndex) ? b[1] : b[0];
            const other = allAtoms[otherIdx];
            let vx = other.x - atom.x, vy = other.y - atom.y, vz = other.z - atom.z;
            const len = Math.sqrt(vx*vx + vy*vy + vz*vz) || 1;
            bondVectors.push({ x: vx/len, y: vy/len, z: vz/len, style: b[2] });
        });
        
        let sumX = 0, sumY = 0, sumZ = 0;
        if (bondVectors.length > 0) { bondVectors.forEach(v => { sumX += v.x; sumY += v.y; sumZ += v.z; }); } 
        else { sumX = 0; sumY = -1; sumZ = 0; }
        
        let backX = -sumX, backY = -sumY, backZ = -sumZ;
        let backLen = Math.sqrt(backX*backX + backY*backY + backZ*backZ);
        if (backLen < 0.001) { backX=0; backY=1; backZ=0; backLen=1; }
        backX /= backLen; backY /= backLen; backZ /= backLen;
        
        let ux = backX, uy = backY, uz = backZ;
        let tempX = 0, tempY = 1, tempZ = 0;
        if (Math.abs(ux) < 0.1 && Math.abs(uz) < 0.1) { tempX=1; tempY=0; tempZ=0; }
        let wx = uy*tempZ - uz*tempY, wy = uz*tempX - ux*tempZ, wz = ux*tempY - uy*tempX;
        let wLen = Math.sqrt(wx*wx + wy*wy + wz*wz);
        wx/=wLen; wy/=wLen; wz/=wLen;
        let vx = wy*uz - wz*uy, vy = wz*ux - wx*uz, vz = wx*uy - wy*ux;
        
        const lpDist = atom.r * 2.2;
        const pushLP = (dx, dy, dz) => { addPairToDots(dots, atom, { x: dx*lpDist, y: dy*lpDist, z: dz*lpDist }); };

        if (bondVectors.length === 1) {
            if (lpCount === 3) {
                const angle = 70 * (Math.PI/180); const sinA = Math.sin(angle); const cosA = Math.cos(angle);
                for(let i=0; i<3; i++) {
                    const theta = i * (120 * Math.PI/180);
                    const px = cosA * ux + sinA * (Math.cos(theta)*vx + Math.sin(theta)*wx);
                    const py = cosA * uy + sinA * (Math.cos(theta)*vy + Math.sin(theta)*wy);
                    const pz = cosA * uz + sinA * (Math.cos(theta)*vz + Math.sin(theta)*wz);
                    pushLP(px, py, pz);
                }
            } else if (lpCount === 2) {
                const angle = 60 * (Math.PI/180);
                pushLP(Math.cos(angle)*ux + Math.sin(angle)*vx, Math.cos(angle)*uy + Math.sin(angle)*vy, Math.cos(angle)*uz + Math.sin(angle)*vz);
                pushLP(Math.cos(angle)*ux - Math.sin(angle)*vx, Math.cos(angle)*uy - Math.sin(angle)*vy, Math.cos(angle)*uz - Math.sin(angle)*vz);
            } else if (lpCount === 1) { pushLP(ux, uy, uz); }
        } else if (bondVectors.length === 2) {
            if (lpCount === 2) {
                let b1 = bondVectors[0], b2 = bondVectors[1];
                let nx = b1.y*b2.z - b1.z*b2.y, ny = b1.z*b2.x - b1.x*b2.z, nz = b1.x*b2.y - b1.y*b2.x;
                let nLen = Math.sqrt(nx*nx + ny*ny + nz*nz);
                if (nLen > 0.001) { nx/=nLen; ny/=nLen; nz/=nLen; } else { nx=vx; ny=vy; nz=vz; }
                const tilt = 50 * (Math.PI/180);
                pushLP(Math.cos(tilt)*ux + Math.sin(tilt)*nx, Math.cos(tilt)*uy + Math.sin(tilt)*ny, Math.cos(tilt)*uz + Math.sin(tilt)*nz);
                pushLP(Math.cos(tilt)*ux - Math.sin(tilt)*nx, Math.cos(tilt)*uy - Math.sin(tilt)*ny, Math.cos(tilt)*uz - Math.sin(tilt)*nz);
            } else if (lpCount === 1) { pushLP(ux, uy, uz); }
        } else { pushLP(ux, uy, uz); }
    }

    // --- 2. [修正] 顏色判定邏輯 (排除 NO/NO2) ---
    
    // 判斷是否為氮氧化物特例
    let isNitrogenOxide = false;
    if (typeof currentKey !== 'undefined' && currentKey) {
        // 只要分子名稱包含 NO 或 NO2 且不含電荷符號(如 NO3-)，就視為特例
        if (currentKey === "NO" || currentKey === "NO2" || 
            currentKey.startsWith("NO|") || currentKey.startsWith("NO2|")) {
            isNitrogenOxide = true;
        }
    }

    // 只有當：
    // 1. 形式電荷 <= -0.5 (帶負電)
    // 2. 且 不是配位鍵接收者
    // 3. 且 不是 NO/NO2 這種特例
    // 才將電子塗成粉紅色
    if (atom.formalCharge <= -0.5 && !atom.isCoordinateReceiver && !isNitrogenOxide) {
        let countToColor = Math.round(Math.abs(atom.formalCharge));
        
        // 倒著找，把最後幾顆電子標記為粉紅
        for (let i = dots.length - 1; i >= 0; i--) {
            if (countToColor > 0) {
                dots[i].isNegativeCharge = true;
                countToColor--;
            } else {
                break;
            }
        }
    }

    return dots;
}

function addPairToDots(dotsArray, atom, vector) {
    let lx = vector.x, ly = vector.y, lz = vector.z;
    let ox = -ly, oy = lx, oz = 0;
    if (Math.abs(lx) < 0.1 && Math.abs(ly) < 0.1) { ox = 1; oy = 0; oz = 0; }
    let oLen = Math.sqrt(ox*ox + oy*oy + oz*oz);
    const separation = 14.0; 
    ox = (ox/oLen) * (separation/2); oy = (oy/oLen) * (separation/2); oz = (oz/oLen) * (separation/2);
    const eRadius = 4.5;
    
    // 預設 isNegativeCharge 為 false
    dotsArray.push({ x: atom.x + lx + ox, y: atom.y + ly + oy, z: atom.z + lz + oz, isElectron: true, r: eRadius, type: 'electron', parentAtom: atom, isNegativeCharge: false });
    
    if (!atom.radical) {
        dotsArray.push({ x: atom.x + lx - ox, y: atom.y + ly - oy, z: atom.z + lz - oz, isElectron: true, r: eRadius, type: 'electron', parentAtom: atom, isNegativeCharge: false });
    }
}





// ==========================================
// 3. 核心邏輯與顯示更新
// ==========================================

currentMolecule = null;
let currentMatrix = [1, 0, 0, 0, 1, 0, 0, 0, 1];
let isFaceBuildMode = false;
let faceSelection = [];
let customFaces = [];   
let currentFaceColor = 'yellow'; // 預設顏色
let rotVelocity = { x: 0.004, y: 0.004, z: 0 };
let panOffset = { x: 0, y: 0 }; 
let isLongPressActive = false;
let scale = 1.6; 
let isDragging = false; 
let lastMouse = { x: 0, y: 0 };
let currentMode = 2; 
let altKeyIsDown = false;
currentKey = null; 
currentVariantKey = null;
let lastInteractTime = 0; 
let lastTouchDist = 0;
let lastTouchCenter = { x:0, y:0 };
let lastTouchAngle = 0; 

function toggleMode() {
    currentMode = (currentMode + 1) % 3; 
    const modes = ['平移', '旋轉', '複合'];
    const classes = ['mode-pan', 'mode-rotate', 'mode-composite'];
    modeToggleBtn.className = `control-button ${classes[currentMode]} active`;
    modeToggleBtn.innerHTML = `模式: ${modes[currentMode]}`;
}

function formatFormula(str) {
    if (!str) return "";
    let s = str.trim();
    let mainPart = s;
    let chargePart = "";
    // Normalize stray caret superscripts and spaces
    s = s.replace(/\^/g, '').replace(/\s+/g, '');
    // Match either a trailing digits+sign (e.g. "2-") or a lone sign ("+")
    const m = s.match(/^(.*?)(\d+([+-])|[+-])$/);
    if (m) {
        let rawCharge = m[2] || m[0].slice(m[1].length);
        const startIdx = s.length - rawCharge.length;
        mainPart = s.slice(0, startIdx);

        // If rawCharge contains digits before the sign, decide whether those digits
        // are part of the formula (subscripts) or part of the charge.
        const digitMatch = rawCharge.match(/^(\d+)/);
        if (digitMatch) {
            const digits = digitMatch[1];
            const charBeforeDigits = s[startIdx - 1];
            // If there are multiple digits captured before the sign (e.g. "22-")
            // and the character immediately before those digits is a letter,
            // then it's likely that all but the last digit belong to the formula
            // (e.g. "O22-" -> mainPart should gain the first '2' and charge be '2-').
            if (digits.length > 1 && charBeforeDigits && /[A-Za-z]/.test(charBeforeDigits)) {
                const leading = digits.slice(0, -1);
                const lastDigit = digits.slice(-1);
                mainPart += leading;
                rawCharge = lastDigit + rawCharge.slice(digits.length);
            } else {
                // Fallback heuristic using element parsing: if mainPart contains
                // multiple element types, captured digits are more likely subscript.
                try {
                    const elCounts = parseAtoms(mainPart);
                    const distinctEls = Object.keys(elCounts).length;
                    if (charBeforeDigits && /[A-Za-z]/.test(charBeforeDigits) && distinctEls > 1) {
                        const signOnly = rawCharge.slice(digits.length);
                        mainPart += digits;
                        rawCharge = signOnly || '';
                    }
                } catch (_) {}
            }
            }

        if (rawCharge) {
            // Build display for charge: digits as-is, signs wrapped for styling
            const chargeDisplay = rawCharge.replace(/(\d+)/g, '$1').replace(/([+-]+)/g, '<span class="charge-sign">$1</span>');
            chargePart = `<sup>${chargeDisplay}</sup>`;
        }
    }

    mainPart = mainPart.replace(/(\d+)(?![^<]*>)/g, '<sub>$1</sub>');
    return mainPart + chargePart;
}

function toFraction(val) {
    if (Math.abs(val - Math.round(val)) < 1e-4) return Math.round(val).toString();
    let best_n = 1, best_d = 1, min_err = Math.abs(val - 1);
    for (let d = 2; d <= 64; d++) {
        let n = Math.round(val * d);
        let err = Math.abs(val - n / d);
        if (err < min_err) { min_err = err; best_n = n; best_d = d; }
        if (err < 1e-4) break;
    }
    return `${best_n}/${best_d}`;
}

function parseCharge(c) {
    if (!c) return 0;
    if (c === '+') return 1; if (c === '-') return -1;
    const m = c.match(/^(\d*)([+-])$/);
    if (!m) return 0;
    return parseInt(m[1] || "1") * (m[2] === '+' ? 1 : -1);
}

function parseAtoms(f) {
    let formula = f.replace(/\[/g, '(').replace(/\]/g, ')').replace(/\{/g, '(').replace(/\}/g, ')');
    const stack = [{}];
    let i = 0;
    while (i < formula.length) {
        let char = formula[i];
        if (char === '(') { stack.push({}); i++; }
        else if (char === ')') {
            i++; let mStr = "";
            while (i < formula.length && /\d/.test(formula[i])) { mStr += formula[i]; i++; }
            let m = parseInt(mStr || "1"), popped = stack.pop(), top = stack[stack.length - 1];
            for (let el in popped) { top[el] = (top[el] || 0) + popped[el] * m; }
        } else {
            let match = formula.slice(i).match(/^([A-Z][a-z]*)(\d*)/);
            if (match) {
                let el = match[1], count = parseInt(match[2] || "1"), top = stack[stack.length - 1];
                top[el] = (top[el] || 0) + count; i += match[0].length;
            } else { i++; }
        }
    }
    return stack[0];
}

// Balance feature removed: setupEquationBalancer() deleted per user request.

function solveChemicalEquationWithSteps(eqn) {
    const sides = eqn.split('=');
    if (sides.length !== 2) throw new Error("缺少 '=' 號");
    const parseSide = (s) => s.split(/\s+\+\s+/).map(x => x.trim()).filter(x => x);
    const leftRaw = parseSide(sides[0]), rightRaw = parseSide(sides[1]), allRaw = [...leftRaw, ...rightRaw];

    // 1. 解析物質與元素清單
    const species = allRaw.map((s, idx) => {
        const p = s.split(/\s+/);
        let f = p[0], cS = p[1] || "";
        if (!cS && (f.endsWith('+') || f.endsWith('-'))) { const m = f.match(/^(.*?)(\d*[+-]+)$/); if (m) { f = m[1]; cS = m[2]; } }
        return { index: idx, formula: f, charge: parseCharge(cS), atoms: parseAtoms(f), raw: s };
    });
    const elements = Array.from(new Set(species.flatMap(s => Object.keys(s.atoms))));
    // 將變數定義在外部作用域，讓後面的詳解步驟也能讀取
    let redoxInfo = { partnerEl: null, partnerDelta: 0, h2o2Delta: 0, h2o2Idx: -1 };

    const finalCoeffs = (function() {
        // 初始化矩陣：原子守恆(elements.length) + 電子守恆(1) + 電荷守恆(1)
        let m = Array.from({ length: elements.length + 2 }, () => new Array(species.length).fill(0));
        const redoxRowIdx = elements.length;
        const chargeRowIdx = elements.length + 1;

        // --- 氧化還原邏輯判定 ---
        const h2o2 = species.find(s => s.formula === "H2O2" && s.index < leftRaw.length);
        if (h2o2) {
            redoxInfo.h2o2Idx = h2o2.index;
            elements.filter(e => e !== 'H' && e !== 'O').forEach(el => {
                const r = species.find(s => s.index < leftRaw.length && s.atoms[el]);
                const p = species.find(s => s.index >= leftRaw.length && s.atoms[el]);
                if (r && p) {
                    const oxR = (r.charge - (r.atoms['O'] || 0) * -2 - (r.atoms['H'] || 0) * 1) / (r.atoms[el] || 1);
                    const oxP = (p.charge - (p.atoms['O'] || 0) * -2 - (p.atoms['H'] || 0) * 1) / (p.atoms[el] || 1);
                    if (Math.abs(oxR - oxP) > 0.01) {
                        redoxInfo.partnerEl = el;
                        redoxInfo.partnerDelta = oxP - oxR;
                        redoxInfo.h2o2Delta = (redoxInfo.partnerDelta < 0) ? 1 : -1;
                    }
                }
            });
        }

        species.forEach((s, j) => {
            const sign = (j < leftRaw.length) ? 1 : -1;
            // 1. 原子守恆
            elements.forEach((el, i) => m[i][j] = (s.atoms[el] || 0) * sign);
            
            // 2. 電子守恆 (只有反應物參與電子交換計算)
            if (redoxInfo.h2o2Delta !== 0 && j < leftRaw.length) {
                if (s.formula === "H2O2") {
                    m[redoxRowIdx][j] = 2 * redoxInfo.h2o2Delta; // 每莫耳 H2O2 轉移 2 莫耳電子
                } else if (redoxInfo.partnerEl && s.atoms[redoxInfo.partnerEl]) {
                    m[redoxRowIdx][j] = s.atoms[redoxInfo.partnerEl] * redoxInfo.partnerDelta;
                }
            }

            // 3. 電荷守恆
            m[chargeRowIdx][j] = s.charge * sign;
        });
        return gaussElimination(m);
    })();

    const buildModularEq = (coeffs) => {
        let itemsHtml = "";
        species.forEach((s, i) => {
            let unit = `<div style="display: inline-flex; align-items: baseline; background: #1e293b; padding: 4px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); box-shadow: inset 0 1px 1px rgba(255,255,255,0.05), 0 4px 8px rgba(0,0,0,0.3); margin: 4px 2px; gap: 4px; vertical-align: middle;"><span style="font-size: 1.1rem; color: #facc15; font-weight: 900; font-style: italic;">${coeffs[i]}</span><span style="font-size: 1.1rem; color: #fff; font-weight: 500;">${formatFormula(s.raw)}</span></div>`;
            itemsHtml += unit;
            if (i === leftRaw.length - 1) itemsHtml += `<span style="display: inline-flex; align-items: center; margin: 0 8px; color: var(--accent-yellow); font-size: 1.2rem; font-weight: bold;">→</span>`;
            else if (i < species.length - 1) itemsHtml += `<span style="display: inline-flex; align-items: center; margin: 0 2px; color: rgba(255,255,255,0.8); font-size: 1rem;">+</span>`;
        });
        return `<div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; width: 100%;">${itemsHtml}</div>`;
    };

    let stp = `<div style="font-weight:bold; font-size:1.2rem; color:#fff; margin-bottom:20px; text-align:center; border-bottom:2px solid #facc15; padding-bottom:10px; letter-spacing:2px;">🧪 觀察法 + 代數法解題</div>`;
    let startIdx = 0, maxScore = 0;
    species.forEach((s, i) => { 
        let score = Object.keys(s.atoms).length * 10 + Object.values(s.atoms).reduce((a,b)=>a+b,0);
        if (score > maxScore) { maxScore = score; startIdx = i; } 
    });
    stp += `<div class="step-box"><div class="step-title">步驟 1：選定基準</div>設定結構最複雜的 <span style="color:#fbbf24; font-weight:bold;">${formatFormula(species[startIdx].raw)}</span> 係數為 <span class="coeff">1</span>。</div>`;

    let locked = new Set([startIdx]), expressions = new Array(species.length).fill(""), usedConservation = new Set(), obsDetails = [];
    expressions[startIdx] = "1";
    const toMathTerm = (expr, count) => {
        if (!count || !expr) return null;
        if (expr === "1") return `${count}`;
        let mMatch = expr.match(/^(\d*\.?\d*)/)[1], numPart = mMatch === "" ? 1 : parseFloat(mMatch);
        let varPart = expr.replace(/[0-9.]/g, ''), totalNum = numPart * count;
        return (totalNum === 1 ? "" : (totalNum === -1 ? "-" : totalNum)) + varPart;
    };

    let progressed = true;
    while(progressed) {
        progressed = false;
        for(let el of elements) {
            if (usedConservation.has(el)) continue;
            let rel = species.filter(s => s.atoms[el] > 0), unk = rel.filter(s => !locked.has(s.index));
            if(unk.length === 1 && rel.length > 1) {
                let target = unk[0]; locked.add(target.index);
                expressions[target.index] = toFraction(finalCoeffs[target.index] / finalCoeffs[startIdx]);
                usedConservation.add(el);
                obsDetails.push(`• 觀察 <span class="highlight-atom">${el}</span> 原子：鎖定 <span style="color:var(--accent-yellow);">${formatFormula(target.raw)}</span> 為 <span class="coeff">${expressions[target.index]}</span>。`);
                progressed = true; break;
            }
        }
        if(progressed) continue;
        if (!usedConservation.has("charge")) {
            let unkC = species.filter(s => s.charge !== 0 && !locked.has(s.index));
            if(unkC.length === 1) {
                let target = unkC[0]; locked.add(target.index);
                expressions[target.index] = toFraction(finalCoeffs[target.index] / finalCoeffs[startIdx]);
                usedConservation.add("charge");
                obsDetails.push(`• 觀察 <span class="highlight-atom">電荷</span>：鎖定 <span style="color:var(--accent-yellow);">${formatFormula(target.raw)}</span> 為 <span class="coeff">${expressions[target.index]}</span>。`);
                progressed = true;
            }
        }
    }
    stp += `<div class="step-box"><div class="step-title">步驟 2：觀察法</div><div style="font-size:1.05rem; line-height:1.8;">${obsDetails.length > 0 ? obsDetails.join('<br>') : "可由基準直接推導。"}</div></div>`;
    // --- 步驟 3：氧化還原守恆說法 ---
    if (redoxInfo && redoxInfo.h2o2Delta !== 0) {
        const h2o2Role = redoxInfo.h2o2Delta > 0 ? "還原劑 (氧化成 O<sub>2</sub>)" : "氧化劑 (還原成 H<sub>2</sub>O)";
        const eFlowPerPartner = Math.abs(redoxInfo.partnerDelta * species[startIdx].atoms[redoxInfo.partnerEl]);
        const h2o2Coeff = finalCoeffs[redoxInfo.h2o2Idx] / finalCoeffs[startIdx];
        
        stp += `<div class="step-box" style="border-left-color: #f472b6; background: rgba(244, 114, 182, 0.05);">
            <div class="step-title" style="color: #f472b6;">步驟 3：氧化還原守恆 (關鍵限制)</div>
            偵測到 <span style="color:#f472b6; font-weight:bold;">H<sub>2</sub>O<sub>2</sub></span> 參與反應：<br>
            • 變價夥伴：<span style="color:var(--accent-yellow); font-weight:bold;">${redoxInfo.partnerEl}</span> 氧化數從基點變化了 <span style="color:#facc15;">${redoxInfo.partnerDelta}</span>。<br>
            • H<sub>2</sub>O<sub>2</sub> 角色：擔任 <span style="color:#f472b6; font-weight:bold;">${h2o2Role}</span>。<br>
            • 根據電子得失守恆：<br>
            <div class="step-formula-box" style="border-color: #f472b6; color: #f472b6; font-weight:bold;">
                1 × ${eFlowPerPartner}(e⁻) = a(H<sub>2</sub>O<sub>2</sub>) × 2(e⁻) 
                &nbsp; → &nbsp; <span style="font-size:1.3rem;">a = ${toFraction(h2o2Coeff)}</span>
            </div>
            得到 H<sub>2</sub>O<sub>2</sub> 係數後，代數系統即可解出唯一解。
        </div>`;
        locked.add(redoxInfo.h2o2Idx);
        expressions[redoxInfo.h2o2Idx] = toFraction(h2o2Coeff);
    }

    if (locked.size < species.length) {
        let vars = ['a', 'b', 'c', 'd'], vIdx = 0, algebraicSteps = [];
        let remaining = species.filter(s => !locked.has(s.index));
        while(remaining.length > 0) {
            let next = remaining[0], v = vars[vIdx++] || 'k';
            let linkEl = Object.keys(next.atoms).find(el => {
                let allRel = species.filter(s => s.atoms[el] > 0);
                return allRel.filter(x => !locked.has(x.index)).length === 2 && allRel.filter(x => locked.has(x.index)).length === 0;
            });
            if (linkEl) {
                let pair = species.filter(s => s.atoms[linkEl] > 0);
                let s1 = pair[0], s2 = pair[1], n1 = s1.atoms[linkEl], n2 = s2.atoms[linkEl];
                expressions[s1.index] = (n2 === 1 ? "" : n2) + v; expressions[s2.index] = (n1 === 1 ? "" : n1) + v;
                usedConservation.add(linkEl);
                algebraicSteps.push(`• 關聯 <span class="highlight-atom">${linkEl}</span> 原子：設 <span style="color:#f472b6; font-weight:bold;">${formatFormula(s1.raw)}</span> 為 <span style="color:#f472b6;">${expressions[s1.index]}</span>，則 <span style="color:#f472b6; font-weight:bold;">${formatFormula(s2.raw)}</span> 為 <span style="color:#f472b6;">${expressions[s2.index]}</span>。`);
                locked.add(s1.index); locked.add(s2.index);
            } else {
                expressions[next.index] = v; algebraicSteps.push(`• 獨立設元：設 <span style="color:#f472b6; font-weight:bold;">${formatFormula(next.raw)}</span> 為 <span style="color:#f472b6;">${v}</span>。`);
                locked.add(next.index);
            }
            remaining = species.filter(s => !locked.has(s.index));
        }
        const buildEq = (type, elName) => {
            let L = [], R = [];
            species.forEach((s, idx) => {
                let term = toMathTerm(expressions[idx], (type === 'atom' ? s.atoms[elName] : s.charge));
                if (term) (idx < leftRaw.length ? L : R).push(term);
            });
            return `${L.join(' + ') || "0"} = ${R.join(' + ') || "0"}`;
        };
        algebraicSteps.push(`<div style="margin-top:15px; color:#94a3b8; font-size:0.95rem;">列出守恆等式：</div>`);
        elements.forEach(el => { if (!usedConservation.has(el)) algebraicSteps.push(`• 根據 <span class="highlight-atom">${el}</span>：<span style="font-family:'Noto Serif TC', serif; color:#facc15; font-size:1.1rem; font-weight:bold;">${buildEq('atom', el)}</span>`); });
        if (!usedConservation.has("charge") && species.some(s => s.charge !== 0)) algebraicSteps.push(`• 根據 <span class="highlight-atom">電荷</span>：<span style="font-family:'Noto Serif TC', serif; color:#facc15; font-size:1.1rem; font-weight:bold;">${buildEq('charge')}</span>`);

        let solvedVars = []; let seenV = new Set();
        species.forEach((s, idx) => {
            let ex = expressions[idx]; if(!ex || ex === "1") return;
            let vChar = ex.match(/[a-z]/);
            if(vChar && !seenV.has(vChar[0])) {
                seenV.add(vChar[0]); let numMatch = ex.match(/[0-9.]+/), mult = numMatch ? parseFloat(numMatch[0]) : 1;
                let val = toFraction((finalCoeffs[idx] / finalCoeffs[startIdx]) / mult);
                solvedVars.push(`<div style="display:flex; align-items:center; gap:8px;"><span style="font-style:italic; color:#f472b6; font-weight:bold; font-size:1.3rem;">${vChar[0]}</span> <span style="color:#94a3b8;">=</span> <span style="color:#facc15; font-weight:900; font-size:1.6rem; text-shadow: 0 0 10px rgba(250,204,21,0.4);">${val}</span></div>`);
            }
        });
        algebraicSteps.push(`<div style="margin-top:20px; color:#94a3b8;">解聯立方程得：</div><div style="display:flex; flex-wrap:wrap; justify-content:center; gap:25px; margin:15px 0; padding:15px; background:rgba(255,255,255,0.03); border-radius:12px;">${solvedVars.join('')}</div>`);
        stp += `<div class="step-box"><div class="step-title">步驟 3：代數法</div><div style="font-size:1.05rem; line-height:1.8;">${algebraicSteps.join('<br>')}</div></div>`;
    }

    let multiplier = 1, baseV = finalCoeffs[startIdx];
    finalCoeffs.forEach(c => {
        let f = c / baseV;
        for(let d=1; d<=60; d++){ if(Math.abs(f*d - Math.round(f*d)) < 0.01){ multiplier = Math.max(multiplier, d); break; } }
    });

    const finalBox = buildModularEq(finalCoeffs);
    stp += `<div class="step-box" style="border:none;"><div class="step-title">步驟 4：整數化 (最簡整數比)</div>目前比例：<span style="color:#94a3b8;">(${finalCoeffs.map(c => toFraction(c/baseV)).join(' : ')})</span>。<br>全體乘以 <span style="color:#facc15; font-weight:bold;">${multiplier}</span> 消除分母，得到最終平衡反應式：<br><div style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.03); border-radius:15px; border:1px solid rgba(255,255,255,0.08);">${finalBox}</div></div>`;

    const btnDom = document.getElementById('steps-toggle-btn');
    if(btnDom) { btnDom.style.margin = "35px auto 25px auto"; btnDom.style.display = "block"; }
    const resDom = document.getElementById('balance-result');
    if(resDom) { resDom.style.marginBottom = "20px"; }

    let html = buildModularEq(finalCoeffs);

    return { html, stepsHtml: stp };
}

function gaussElimination(matrix) {
    const rows = matrix.length, cols = matrix[0].length;
    let pivot = 0;
    for (let j = 0; j < cols && pivot < rows; j++) {
        let max = pivot;
        for (let i = pivot + 1; i < rows; i++) { if (Math.abs(matrix[i][j]) > Math.abs(matrix[max][j])) max = i; }
        [matrix[pivot], matrix[max]] = [matrix[max], matrix[pivot]];
        if (Math.abs(matrix[pivot][j]) < 1e-10) continue;
        const val = matrix[pivot][j];
        for (let k = 0; k < cols; k++) matrix[pivot][k] /= val;
        for (let i = 0; i < rows; i++) { if (i !== pivot) { const factor = matrix[i][j]; for (let k = 0; k < cols; k++) matrix[i][k] -= factor * matrix[pivot][k]; } }
        pivot++;
    }
    let sol = new Array(cols).fill(0); sol[cols - 1] = 1;
    for (let i = 0; i < cols - 1; i++) { sol[i] = -matrix[i][cols - 1]; }
    let bestMult = 1;
    for (let m = 1; m <= 1000; m++) {
        let allInt = true;
        for (let v of sol) { if (Math.abs(v * m - Math.round(v * m)) > 1e-3) { allInt = false; break; } }
        if (allInt) { bestMult = m; break; }
    }
    return sol.map(v => Math.round(Math.abs(v * bestMult)));
}

function handleLoadBtn() {
    let rawVal = document.getElementById("formula-input").value;
    if (!rawVal) return;

    // ========== 隱藏功能：查詢瀏覽人次 ==========
    if (rawVal === "人次") {
        const subEl = document.getElementById("viewport-subtitle");
        if (subEl) {
            subEl.style.display = "block";
            subEl.style.width = "fit-content";
            subEl.style.border = "1px solid #10b981"; 
            subEl.style.backgroundColor = "rgba(0, 0, 0, 0.9)";
            subEl.style.color = "#10b981"; 
            subEl.style.boxShadow = "0 0 15px rgba(16, 185, 129, 0.3)";
            subEl.style.padding = "10px 20px";
            subEl.style.textAlign = "center";
            
            subEl.innerHTML = `<div style="margin-bottom:8px; font-size:0.9rem; color:#ccc; font-weight:bold;">👁️ 本站累積瀏覽人次</div>`;
            
            const newImg = new Image();
            newImg.src = `https://hits.sh/weiwei-molecular-lab.app.svg?label=Views&color=10b981&labelColor=2d3748&t=${new Date().getTime()}`;
            newImg.alt = "載入中...";
            newImg.style.height = "28px";
            newImg.style.display = "block";
            newImg.style.margin = "0 auto";

            newImg.onerror = function() {
                subEl.innerHTML += `<div style="color:#f87171; font-size:0.8rem;">(連線失敗)</div>`;
            };
            subEl.appendChild(newImg);
            document.getElementById("formula-input").value = "";
        }
        return; 
    }
    // ===============================================

    // [新增] 手動搜尋時，清空歷史紀錄
    moleculeHistory = [];

    let searchKey = rawVal.replace(/\s/g, '').toUpperCase();
    let target = MOLECULE_INDEX[searchKey];
    if (target) {
        loadMolecule(target.key, target.variant);
    } else if (MOLECULE_DB[rawVal]) {
        loadMolecule(rawVal);
    } else if (MOLECULE_DB[searchKey]) {
        loadMolecule(searchKey);
    } else {
        alert("資料庫中未找到該分子: " + rawVal);
    }
}

// `toggleKnowledge` removed — knowledge card feature disabled

function multiplyMatrix(a, b) {
    const out = [];
    for (let i = 0; i < 3; i++) { 
        for (let j = 0; j < 3; j++) { 
            let sum = 0;
            for (let k = 0; k < 3; k++) sum += a[i * 3 + k] * b[k * 3 + j];
            out.push(sum);
        }
    }
    return out;
}

function normalizeMatrix(m) {
    let x = [m[0], m[3], m[6]], y = [m[1], m[4], m[7]];
    const lenX = Math.sqrt(x[0]*x[0] + x[1]*x[1] + x[2]*x[2]);
    x = x.map(v => v / lenX);
    const dot = x[0]*y[0] + x[1]*y[1] + x[2]*y[2];
    y = [y[0]-x[0]*dot, y[1]-x[1]*dot, y[2]-x[2]*dot];
    const lenY = Math.sqrt(y[0]*y[0] + y[1]*y[1] + y[2]*y[2]);
    y = y.map(v => v / lenY);
    const z = [x[1]*y[2]-x[2]*y[1], x[2]*y[0]-x[0]*y[2], x[0]*y[1]-x[1]*y[0]];
    return [x[0], y[0], z[0], x[1], y[1], z[1], x[2], y[2], z[2]];
}

function applyRotation(dx, dy, dz) {
    const cx = Math.cos(dy), sx = Math.sin(dy);
    const rotX = [1,0,0, 0,cx,-sx, 0,sx,cx];
    const cy = Math.cos(dx), sy = Math.sin(dx);
    const rotY = [cy,0,sy, 0,1,0, -sy,0,cy];
    const cz = Math.cos(dz), sz = Math.sin(dz);
    const rotZ = [cz,-sz,0, sz,cz,0, 0,0,1];
    let rot = multiplyMatrix(rotY, multiplyMatrix(rotX, rotZ));
    currentMatrix = multiplyMatrix(rot, currentMatrix);
    currentMatrix = normalizeMatrix(currentMatrix);
}

const sceneRoot = document.getElementById("scene-root");
const viewport = document.getElementById("viewport");
const modeToggleBtn = document.getElementById("mode-toggle");
const themeToggleBtn = document.getElementById("theme-toggle");
const variantSelector = document.getElementById("variant-selector");

window.onload = () => {
    // Ensure every molecule has an English name available for English mode
    try {
        if (typeof MOLECULE_DB === 'object') {
            Object.keys(MOLECULE_DB).forEach(k => {
                const d = MOLECULE_DB[k];
                if (!d) return;
                // prefer existing nameEN
                if (d.nameEN && String(d.nameEN).trim() !== '') return;
                const fullKey = d.fullKey || k || '';
                const parts = String(fullKey).split('|').map(p => p && p.trim()).filter(Boolean);
                const isLikelyEnglish = (s) => /[A-Za-z]/.test(String(s));
                let en = '';
                // Prefer any part that looks like English (contains Latin letters)
                for (let i = 0; i < parts.length; i++) {
                    if (isLikelyEnglish(parts[i])) { en = parts[i]; break; }
                }
                // If not found, try common-names lookup (by formula or Chinese name)
                if (!en && typeof COMMON_EN_NAMES === 'object') {
                    const raw0 = parts[0] ? String(parts[0]) : '';
                    const p0 = raw0.toUpperCase();
                    const p1 = parts[1] || parts[0] || '';
                    const norm = (k) => String(k || '').replace(/\^/g, '').replace(/\s+/g, '').toUpperCase();
                    const tryKeys = [p1, p0, norm(p0), norm(p1), raw0.replace(/\s+/g,''), raw0.replace(/\^/g,'')];
                    for (let tk of tryKeys) {
                        if (!tk) continue;
                        if (COMMON_EN_NAMES[tk]) { en = COMMON_EN_NAMES[tk]; break; }
                        if (COMMON_EN_NAMES[tk.toUpperCase()]) { en = COMMON_EN_NAMES[tk.toUpperCase()]; break; }
                    }
                }
                // Last resort: use formula (parts[0]) so something displays in English mode
                if (!en) en = parts[0] || k;
                d.nameEN = en;
            });
        }
    } catch (e) { console.error('populate nameEN failed', e); }

    if(Object.keys(MOLECULE_DB).length > 0) {
        loadMolecule("H2O"); 
    }
    animate();
    setupInteractions();
    // Initialize theme from localStorage
    try {
        const light = localStorage.getItem('lightMode') === 'true';
        if (light) {
            document.body.classList.add('light-mode');
            if (themeToggleBtn) themeToggleBtn.textContent = '深色模式';
        } else {
            if (themeToggleBtn) themeToggleBtn.textContent = '淺色模式';
        }
    } catch (e) { /* ignore localStorage errors */ }
};

// Debug helper: open the app with ?dbg=1 to log formatted formulas for candidates
if (typeof window !== 'undefined' && window.location && window.location.search && window.location.search.indexOf('dbg=1') !== -1) {
    try {
        const seen = new Set();
        const addToken = (t) => { if (!t) return; const s = String(t).trim(); if (s && /[+-]/.test(s)) seen.add(s); };
        if (typeof MOLECULE_DB === 'object') {
            Object.keys(MOLECULE_DB).forEach(k => {
                addToken((k||'').split('|')[0]);
                const d = MOLECULE_DB[k];
                if (d && d.variants) Object.keys(d.variants).forEach(vk => addToken((vk||'').split('|')[0]));
            });
        }
        if (typeof COMMON_EN_NAMES === 'object') Object.keys(COMMON_EN_NAMES).forEach(k => addToken(k));
        console.log('Format debug: found', seen.size, 'candidates');
        seen.forEach(t => console.log(t, '->', formatFormula(t)));
    } catch (e) { console.error('Format debug failed', e); }
}

function loadMolecule(key, variantKey = null) {
    const subEl = document.getElementById("viewport-subtitle");
    if(subEl) { subEl.style.display = 'none'; subEl.textContent = ""; }
    
    let targetData = MOLECULE_DB[key];
    if (!targetData && MOLECULE_INDEX[key.toUpperCase()]) {
        const idx = MOLECULE_INDEX[key.toUpperCase()];
        targetData = MOLECULE_DB[idx.key];
        key = idx.key; 
        if (!variantKey) variantKey = idx.variant;
    }
    if (!targetData) { console.error("Data missing for:", key); return; }
    
    // Do not automatically reuse previous variant when loading the same base key —
    // if a user requests the base key explicitly, we should show its default variant.

    rotVelocity = { x: 0.004, y: 0.004, z: 0 }; 
    currentKey = key;
    
    let data = targetData;
    if (variantKey && data.variants && data.variants[variantKey]) {
        data = data.variants[variantKey];
    } else if (data.variants && !variantKey) {
        const firstKey = Object.keys(data.variants)[0];
        data = data.variants[firstKey];
        variantKey = firstKey;
    }
    currentVariantKey = variantKey;

    if (!data.bondsRaw) data.bondsRaw = []; 
    let processedBonds = JSON.parse(JSON.stringify(data.bondsRaw)); 
    let processedAtoms = JSON.parse(JSON.stringify(data.atomsRaw)); 

    // 優先遵循八隅體：固定為 true（已移除外部開關）
    const isOctetMode = true;

    const expandableCenters = ['P', 'S', 'Cl', 'As', 'Se', 'Br', 'I', 'Xe', 'Sb', 'Te'];
    let keptDoubleBonds = 0;

    processedBonds.forEach(bond => {
        const idx1 = bond[0], idx2 = bond[1], type = bond[2];
        const a1 = processedAtoms[idx1], a2 = processedAtoms[idx2];
        let cIdx = -1, tIdx = -1;

        if (expandableCenters.includes(a1.elem) && a2.elem === 'O') { cIdx = idx1; tIdx = idx2; }
        else if (expandableCenters.includes(a2.elem) && a1.elem === 'O') { cIdx = idx2; tIdx = idx1; }

        if (cIdx !== -1) {
            if (isOctetMode) {
                if (type === 'double') {
                    const resonanceMols = ["SO2", "二氧化硫", "亞硫酸", "H2SO3", "SO3", "亞硫酸根", "HSO3"];
                    const isResonance = resonanceMols.some(n => currentKey.includes(n));

                    if (isResonance && keptDoubleBonds === 0) {
                        keptDoubleBonds++;
                    } else {
                        bond[2] = 'coordinate';
                        bond[0] = cIdx;
                        bond[1] = tIdx;
                    }
                }
            } else {
                if (type === 'coordinate') bond[2] = 'double';
            }
        }
    });

    let renderObjects = processAtomsData(processedAtoms, processedBonds, data.center);
    
    // UI 標籤切換
    const isIonic = data.isIonic === true || data.center === "Ionic";
    
    // [修正] 如果是離子晶體，強制移除所有電子點 (LP)
    if (isIonic) {
        renderObjects = renderObjects.filter(obj => obj.type !== 'electron');
    }

    currentMolecule = { ...data, renderObjects: renderObjects, bonds3D: processedBonds };

    const lblHybrid = document.getElementById("lbl-hybrid");
    const lblShape = document.getElementById("lbl-shape");
    const lblAngle = document.getElementById("lbl-angle");
    const lblBonds = document.getElementById("lbl-bonds");
    const lblMass = document.getElementById("lbl-mass");

    // [修改] 標籤顯示邏輯（會依語言切換）
    const currentLang = (window.__APP_LANG) || localStorage.getItem('app_lang') || ((navigator.language && navigator.language.startsWith('en')) ? 'en' : 'zh');
    let labels = { hybrid: '', shape: '', angle: '', bonds: '', mass: '' };
    if (data.isMetal) {
        labels.hybrid = (currentLang === 'en') ? 'Crystal packing' : '晶體堆積';
        labels.shape = (currentLang === 'en') ? 'Packing efficiency' : '空間利用率';
        labels.angle = (currentLang === 'en') ? 'Coordination number' : '配位數';
        labels.bonds = (currentLang === 'en') ? 'Edge relation' : '邊長關係';
        labels.mass = (currentLang === 'en') ? 'Atomic mass' : '原子量';
    } else if (isIonic) {
        labels.hybrid = (currentLang === 'en') ? 'Crystal packing' : '晶體堆積';
        labels.shape = (currentLang === 'en') ? 'Radius ratio (r⁺/r⁻)' : '半徑比 (r⁺/r⁻)';
        labels.angle = (currentLang === 'en') ? 'Coordination number' : '配位數';
        labels.bonds = (currentLang === 'en') ? 'Edge relation' : '邊長關係';
        labels.mass = (currentLang === 'en') ? 'Formula mass' : '式量';
    } else {
        labels.hybrid = (currentLang === 'en') ? 'Hybridization' : '混成軌域';
        labels.shape = (currentLang === 'en') ? 'Shape' : '形狀';
        labels.angle = (currentLang === 'en') ? 'Bond angle' : '鍵角';
        labels.bonds = (currentLang === 'en') ? 'Bond stats' : '鍵結統計';
        labels.mass = (currentLang === 'en') ? 'Molar mass' : '分子量';
    }
    if (lblHybrid) lblHybrid.textContent = labels.hybrid;
    if (lblShape) lblShape.textContent = labels.shape;
    if (lblAngle) lblAngle.textContent = labels.angle;
    if (lblBonds) lblBonds.textContent = labels.bonds;
    if (lblMass) lblMass.textContent = labels.mass;

    const formulaEl = document.getElementById('info-formula');
    const nameEl = document.getElementById('info-name');
    const keyParts = (data.fullKey || key).split('|');
    let formulaText = keyParts[0];
    // determine current language (use runtime global or fallback to localStorage / navigator)
    // reuse `currentLang` declared earlier for label translations
    // choose display name: prefer data.nameEN/nameCN if available
    let nameText = '';
    if (currentLang === 'en') {
        nameText = data.nameEN || data.nameCN || (keyParts.length>1? keyParts[1] : '') || '';
    } else {
        nameText = data.nameCN || data.nameEN || (keyParts.length>1? keyParts[1] : '') || '';
    }
    if(formulaEl) formulaEl.innerHTML = formatFormula(formulaText);
    if(nameEl) nameEl.textContent = nameText;

    // Knowledge card removed: no descriptive sidebar is shown

    const dispFormulaEl = document.getElementById("disp-formula");
    if (dispFormulaEl) dispFormulaEl.innerHTML = formatFormula(formulaText);
    const dispCenterEl = document.getElementById("disp-center");
    if (dispCenterEl) dispCenterEl.textContent = nameText;
    const dispHybridEl = document.getElementById("disp-hybrid");
    if (dispHybridEl) dispHybridEl.textContent = data.hybrid;
    const dispShapeEl = document.getElementById("disp-shape");
    if (dispShapeEl) {
        const shapeText = (currentLang === 'en') ? (data.shapeEN || data.shapeCN || data.shape) : (data.shapeCN || data.shapeEN || data.shape);
        dispShapeEl.textContent = shapeText;
    }
    const dispAngleEl = document.getElementById("disp-angle");
    if (dispAngleEl) dispAngleEl.textContent = data.angle;
    const dispMpEl = document.getElementById("disp-mp");
    const missingText = currentLang === 'en' ? 'No data' : '無資料';
    if (dispMpEl) dispMpEl.textContent = (data.mp && data.mp !== "-") ? `${data.mp} °C` : missingText;
    const dispBpEl = document.getElementById("disp-bp");
    if (dispBpEl) dispBpEl.textContent = (data.bp && data.bp !== "-") ? `${data.bp} °C` : missingText;
    
    const bondDisp = document.getElementById("disp-bonds");
    if(bondDisp) {
        if (isIonic) {
            bondDisp.innerHTML = data.edgeRelation || "a = 2(r<sub>+</sub> + r<sub>-</sub>)";
        } else {
            let sigma = 0, pi = 0, totalLP = 0;
            if (currentMolecule.bonds3D) currentMolecule.bonds3D.forEach(b => { 
                sigma++; if(b[2]==='double') pi++; if(b[2]==='triple') pi+=2; 
            });
            currentMolecule.renderObjects.forEach(obj => { if (obj.type === 'atom') totalLP += (obj.calculatedLP||0); });
            bondDisp.innerHTML = `&sigma;: ${sigma} &nbsp; &pi;: ${pi} &nbsp; LP: ${totalLP}`;
        }
    }
    
    let totalMass = 0;
    if (data.atomsRaw) {
        if (isIonic && key.includes("NaCl")) totalMass = 22.99 + 35.45; 
        else data.atomsRaw.forEach(a => { totalMass += (ELEMENT_PROPS[a.elem]?.mass || 0); });
    }
    document.getElementById("disp-mass").textContent = totalMass > 0 ? `${totalMass.toFixed(2)} g/mol` : "N/A";
    
    const subtitle = document.getElementById("viewport-subtitle");
    
    // --- 點群自動生成器邏輯 ---
    const pgDisplay = document.getElementById("pg-group-display");
    const symList = document.getElementById("symmetry-elements-list");
    
    if (pgDisplay && symList) {
        const currentPg = data.pg;
        
        if (currentPg) {
            // 內建下標轉換，防止報錯
            const toSub = (n) => n.toString().split('').map(c => ({'0':'₀','1':'₁','2':'₂','3':'₃','4':'₄','5':'₅','6':'₆','7':'₇','8':'₈','9':'₉'}[c]||c)).join('');

            // 1. 【核心修正】精確計算幾何重心，確保對稱軸不會移位
            let tX = 0, tY = 0, tZ = 0, atomCount = 0;
            const realAtoms = data.atomsRaw ? data.atomsRaw.filter(a => !a.isElectron) : [];
            realAtoms.forEach(a => { tX += a.x; tY += a.y; tZ += a.z; atomCount++; });
            data.centroid = atomCount > 0 ? { x: tX/atomCount, y: tY/atomCount, z: tZ/atomCount } : { x:0, y:0, z:0 };

            // 2. 顯示美化與初始化
            pgDisplay.textContent = `點群: ${currentPg.replace("inf", "∞")}`;
            data.symmetry = { group: currentPg, elements: [] };
            
            // 【核心修正：支援虛線參數 isDashed】
            const addSym = (type, label, defaultVec, colorType = 'cyan', customKey = null, isDashed = false) => {
                let vec = defaultVec;
                if (data.symVectors && customKey && data.symVectors[customKey]) vec = data.symVectors[customKey];
                data.symmetry.elements.push({ 
                    type: type, 
                    label: label, 
                    v: vec, 
                    active: false, 
                    colorType: colorType,
                    isDashed: isDashed // 新增虛線標記
                });
            };

            const nMatch = currentPg.match(/\d+/);
            const n = nMatch ? parseInt(nMatch[0]) : 1;
            const isTShaped = data.shape && data.shape.includes("T型");

            // --- 3. 全球點群對稱元素模板 (完全覆蓋教科書) ---
            
            // Cnv 系列 (例如 C2v, C3v)
            if (/^C\d+v$/.test(currentPg)) {
                let mainVec = isTShaped ? [1, 0, 0] : [0, 1, 0];
                addSym('axis', `1 × C${toSub(n)} (主軸)`, mainVec, 'cyan', 'Cn');
                addSym('plane', `σᵥ (分子面)`, [0, 0, 1], 'cyan', 'sv1');
                addSym('plane', `${n-1} × σᵥ (鉛直面)`, (isTShaped ? [0, 1, 0] : [1, 0, 0]), 'pink', 'sv2');
            } 
            // Cnh 系列 (例如 C2h)
            else if (/^C\d+h$/.test(currentPg)) {
                addSym('axis', `1 × C${toSub(n)} (主軸)`, [0, 1, 0], 'cyan', 'Cn');
                addSym('plane', `1 × σₕ (水平面)`, [0, 1, 0], 'yellow', 'sh');
                if (n % 2 === 0) addSym('center', '反轉中心 (i)', [0, 0, 0], 'cyan', 'i');
            }
            // Dnh 系列 (例如 D2h, D3h, D6h)
            else if (/^D\d+h$/.test(currentPg)) {
                addSym('axis', `1 × C${toSub(n)} (主軸)`, [0, 0, 1], 'cyan', 'Cn');
                addSym('plane', `1 × σₕ (水平面)`, [0, 0, 1], 'yellow', 'sh');
                addSym('axis', `${n} × C₂ (副軸)`, [1, 0, 0], 'cyan', 'C2');
                addSym('plane', `${n} × σᵥ (鉛直面)`, [0, 1, 0], 'pink', 'sv');
                if (n % 2 === 0) addSym('center', '反轉中心 (i)', [0, 0, 0], 'cyan', 'i');
            }
            // Dnd 系列 (例如 D2d, D3d, D4d)
            else if (/^D\d+d$/.test(currentPg)) {
                addSym('axis', `1 × C${toSub(n)} (主軸)`, [0, 0, 1], 'cyan', 'Cn');
                addSym('axis', `${n} × C₂ (副軸)`, [1, 0, 0], 'cyan', 'C2');
                addSym('plane', `${n} × σd (二面鏡面)`, [1, 1, 0], 'pink', 'sd');
                // 【教科書規格：不當軸 Sn 為虛線】
                addSym('axis', `1 × S${toSub(2*n)} (不當軸)`, [0, 0, 1], 'yellow', 'Sn', true);
                if (n % 2 !== 0) addSym('center', '反轉中心 (i)', [0, 0, 0], 'cyan', 'i');
            }
            // Sn 系列 (例如 S4, S6)
            else if (/^S\d+$/.test(currentPg)) {
                addSym('axis', `1 × S${toSub(n)} (不當旋轉軸)`, [0, 0, 1], 'yellow', 'Sn', true);
                if ((n / 2) % 2 !== 0) addSym('center', '反轉中心 (i)', [0, 0, 0], 'cyan', 'i');
            }
            // Dn 系列
            else if (/^D\d+$/.test(currentPg)) {
                addSym('axis', `1 × C${toSub(n)} (主軸)`, [0, 0, 1], 'cyan', 'Cn');
                addSym('axis', `${n} × C₂ (副軸)`, [1, 0, 0], 'cyan', 'C2');
            }
            // Td (四面體)
            else if (currentPg === "Td") {
                addSym('axis', '4 × C₃ (頂點軸)', [1, 1, 1], 'cyan', 'C3');
                addSym('axis', '3 × C₂ (對邊軸)', [1, 0, 0], 'cyan', 'C2');
                addSym('plane', '6 × σd (對角面)', [1, -1, 0], 'pink', 'sd');
            } 
            // Oh (八面體)
            else if (currentPg === "Oh") {
                addSym('axis', '3 × C₄ (主軸)', [1, 0, 0], 'cyan', 'C4');
                addSym('axis', '4 × C₃ (對角軸)', [1, 1, 1], 'cyan', 'C3');
                addSym('plane', '3 × σₕ (主要面)', [0, 0, 1], 'yellow', 'sh');
                addSym('center', '反轉中心 (i)', [0, 0, 0], 'cyan', 'i');
            } 
            // 線性分子
            else if (currentPg === "Cinfv") {
                addSym('axis', 'C∞ (分子軸)', [1, 0, 0], 'cyan', 'Cinf');
                addSym('plane', '∞ × σᵥ (鉛直面)', [0, 1, 0], 'pink', 'sv');
            } else if (currentPg === "Dinfh") {
                addSym('axis', 'C∞ (分子軸)', [1, 0, 0], 'cyan', 'Cinf');
                addSym('plane', '1 × σₕ (中心面)', [1, 0, 0], 'yellow', 'sh');
                addSym('center', '反轉中心 (i)', [0, 0, 0], 'cyan', 'i');
            } else if (currentPg === "Cs") {
                addSym('plane', '1 × σ (對稱面)', [0, 0, 1], 'cyan', 's');
            } else if (currentPg === "Ci") {
                addSym('center', '反轉中心 (i)', [0, 0, 0], 'cyan', 'i');
            }

            // 4. 【更新選單 UI】
            symList.innerHTML = "";
            data.symmetry.elements.forEach(el => {
                const div = document.createElement("div");
                div.className = "variant-option";
                div.style.fontSize = "0.85rem";
                div.style.cursor = "pointer";
                const chk = document.createElement("input");
                chk.type = "checkbox";
                chk.checked = el.active; 
                chk.onchange = (e) => { el.active = e.target.checked; renderScene(); };
                const span = document.createElement("span");
                if (el.type === 'plane') {
                    const colorMap = { 'cyan': 'var(--accent-yellow)', 'pink': '#f472b6', 'yellow': '#facc15' };
                    span.style.color = colorMap[el.colorType];
                } else if (el.type === 'center') { 
                    span.style.color = "#facc15"; span.style.fontWeight = "bold"; 
                }
                const icon = el.type === 'axis' ? '軸' : (el.type === 'center' ? '點' : '面');
                span.textContent = ` [${icon}] ${el.label}`;
                div.appendChild(chk); div.appendChild(span);
                symList.appendChild(div);
            });
            
            // 同步重心與對稱性到當前分子
            currentMolecule.centroid = data.centroid;
            currentMolecule.symmetry = data.symmetry;
        } else {
            pgDisplay.textContent = "點群: -";
            symList.innerHTML = '<div style="color: #888; font-size: 0.85rem; text-align: center;">此物質暫無對稱資料</div>';
            currentMolecule.symmetry = null;
            currentMolecule.centroid = { x: 0, y: 0, z: 0 };
        }
    }
    if(subtitle) subtitle.textContent = `${nameText} (${formulaText})`; 
    
    updateVariantUI(key, variantKey);
    checkReactionAvailable(key);
}

function processAtomsData(atomList, bondList, centerElem) {
    let processed = [];
    
    // 1. 建立原子基本物件
    const atomObjects = atomList.map((a, index) => { 
        const props = ELEMENT_PROPS[a.elem] || { c3d: "#ccc", r3d: 20 };
        const finalRadius = (a.r !== undefined) ? a.r : props.r3d;
        return { ...a, color: props.c3d, r: finalRadius, type: 'atom', originalIndex: index };
    });

    // 2. 計算屬性
    atomObjects.forEach((atomObj, idx) => {
        const calcLP = autoAssignLonePairs(atomObj, bondList, atomObjects);
        atomObj.calculatedLP = calcLP;
        
        let bondLines = 0;
        let isCoordinateReceiver = false; // [標記] 是否為配位鍵的接收端

        bondList.forEach(b => {
            if (b[0] === idx || b[1] === idx) {
                let type = b[2] || "single";
                
                // [關鍵] 判斷是否為配位鍵接收端 (b[0] -> b[1])
                // 若我是接收端 (idx === b[1])，標記起來，但鍵數照算 1
                if (type === "coordinate" && b[1] === idx) {
                    isCoordinateReceiver = true;
                    bondLines += 1;
                } else if (type === "coordinate" && b[0] === idx) {
                    bondLines += 1; // 施予端也算 1 根鍵
                } else {
                    // 一般共價鍵計算
                    if (type.includes("triple")) bondLines += 3;
                    else if (type.includes("double")) bondLines += 2;
                    else bondLines += 1;
                }
            }
        });

        // 將標記存入物件，給 generateElectronDots 使用
        atomObj.isCoordinateReceiver = isCoordinateReceiver;

        const props = ELEMENT_PROPS[atomObj.elem];
        if (props) {
            const dots = (calcLP * 2) + (atomObj.radical ? 1 : 0);
            // 正常計算形式電荷 (S->O 的 O 算出來會是 -1，這是對的化學定義)
            atomObj.formalCharge = props.ve - dots - bondLines;
        } else {
            atomObj.formalCharge = 0;
        }
        
        processed.push(atomObj);
        
        if (ELEMENT_PROPS[atomObj.elem]) { 
            const electronDots = generateElectronDots(atomObj, idx, atomObjects, bondList);
            electronDots.forEach(dot => {
                processed.push(dot); 
            });
        }
    });
    return processed;
}

function updateVariantUI(key, activeVariant) {
    const rootData = MOLECULE_DB[key];
    variantSelector.innerHTML = ''; 
    
    // 清除所有舊的主題 class
    variantSelector.classList.remove('acid-theme', 'resonance-theme', 'structure-theme');
    
    if (rootData.variants) {
        // Only show variants that share the same molecular formula as the base
        const allVariantKeys = Object.keys(rootData.variants);
        const baseFormula = ((rootData.fullKey || key).split('|')[0] || key).trim();
        const visibleVariantKeys = allVariantKeys.filter(vKey => {
            const vData = rootData.variants[vKey] || {};
            const vFormula = ((vData.fullKey || vKey).split('|')[0] || vKey).trim();
            return vFormula === baseFormula;
        });

        // If there's 0 or only 1 same-formula variant, do not show the selector
        if (visibleVariantKeys.length <= 1) {
            variantSelector.style.display = 'none';
            return;
        }

        variantSelector.style.display = 'block';

        // --- determine theme based on visible variants only ---
        const isResonance = visibleVariantKeys.some(vKey => vKey.includes("共振") || vKey.includes("Resonance"));
        const isStructure = visibleVariantKeys.some(vKey => vKey.includes("晶體") || vKey.includes("堆積") || vKey.includes("Crystal"));

        const hdr = document.createElement('div');
        hdr.className = 'variant-header';
        if (isResonance) {
            variantSelector.classList.add('resonance-theme');
            hdr.textContent = '選擇共振結構 (Resonance):';
        } else if (isStructure) {
            variantSelector.classList.add('structure-theme');
            hdr.textContent = '選擇結構層次 (Structure):';
        } else {
            hdr.textContent = '選擇同分異構物:';
        }
        variantSelector.appendChild(hdr);

        // Populate only visible variants (same formula)
        for (let vKey of visibleVariantKeys) {
            const div = document.createElement('div');
            div.className = 'variant-option';
            const radio = document.createElement('input');
            radio.type = 'radio'; radio.name = 'v';
            if (vKey === activeVariant) radio.checked = true;
            const span = document.createElement('span');
            const variantData = rootData.variants[vKey];
            const fullKeyString = variantData.fullKey || vKey;
            const parts = fullKeyString.split('|');
            let labelText = "";
            if (parts.length > 1) {
                labelText = parts[1].trim();
                span.textContent = ` ${labelText}`;
            } else {
                labelText = parts[0].trim();
                span.innerHTML = ` ${formatFormula(labelText)}`;
            }
            div.appendChild(radio); div.appendChild(span);
            div.addEventListener('click', () => loadMolecule(key, vKey));
            variantSelector.appendChild(div);
        }
    } else {
        variantSelector.style.display = 'none';
    }
}



// ==========================================
// 4. 渲染引擎
// ==========================================

function project(p) {
    const m = currentMatrix;
    let x3 = p.x * m[0] + p.y * m[1] + p.z * m[2];
    let y3 = p.x * m[3] + p.y * m[4] + p.z * m[5];
    let z3 = p.x * m[6] + p.y * m[7] + p.z * m[8];
    
    let s = (600 / (600 - Math.min(z3, 590))) * scale;
    return { x: x3 * s + panOffset.x, y: y3 * s + panOffset.y, z: z3, scale: s };
}

function renderScene(time = 0) {
    sceneRoot.innerHTML = "";
    if(!currentMolecule) return;
    
    // --- 1. 定義濾鏡與漸層 ---
    const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
    // Light-mode flag: used to darken very-light visuals for contrast on white background
    const isLight = document.body && document.body.classList && document.body.classList.contains('light-mode');
    // 發光濾鏡
    const boxGlowFilter = document.createElementNS("http://www.w3.org/2000/svg", "filter");
    boxGlowFilter.setAttribute("id", "box-glow");
    boxGlowFilter.innerHTML = `<feGaussianBlur stdDeviation="1.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>`;
    defs.appendChild(boxGlowFilter);

    // 原子立體漸層
    const usedColors = new Set();
    currentMolecule.renderObjects.forEach(obj => { if (obj.type === 'atom') usedColors.add(obj.color); });
    usedColors.forEach(color => {
        const cleanColor = (color || '#000000').replace('#','');
        const atomGrad = document.createElementNS("http://www.w3.org/2000/svg", "radialGradient");
        atomGrad.setAttribute("id", `atom-grad-${cleanColor}`);
        atomGrad.setAttribute("cx", "35%"); atomGrad.setAttribute("cy", "35%"); atomGrad.setAttribute("r", "60%");
        // In light mode, slightly darken very-light element colors so they remain visible on white
        const baseColor = isLight ? adjustColor(color, -30) : color;
        const highlight = isLight ? "#ffffff" : "#FFFFFF"; // keep highlight bright for vibrant atoms
        const shadowColor = adjustColor(baseColor, -30);
        atomGrad.innerHTML = `<stop offset="0%" stop-color="${highlight}" stop-opacity="0.95"/><stop offset="40%" stop-color="${baseColor}" stop-opacity="1"/><stop offset="100%" stop-color="${shadowColor}" stop-opacity="1"/>`;
        defs.appendChild(atomGrad);
    });

    // 【重要修正】確保金色漸層定義在每一幀都存在
    const goldGrad = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
    goldGrad.setAttribute("id", "grad-hyper-gold");
    goldGrad.setAttribute("x1", "0%"); goldGrad.setAttribute("y1", "0%"); goldGrad.setAttribute("x2", "100%"); goldGrad.setAttribute("y2", "0%");
    goldGrad.innerHTML = `<stop offset="0%" stop-color="#bf953f"/><stop offset="25%" stop-color="#fcf6ba"/><stop offset="50%" stop-color="#b38728"/><stop offset="75%" stop-color="#fbf5b7"/><stop offset="100%" stop-color="#aa771c"/>`;
    defs.appendChild(goldGrad);
    
    // 其餘光暈定義 (保持原樣)
    const highlightGlowCenter = document.createElementNS("http://www.w3.org/2000/svg", "radialGradient");
    highlightGlowCenter.setAttribute("id", "highlight-glow-center");
    highlightGlowCenter.setAttribute("cx", "50%"); highlightGlowCenter.setAttribute("cy", "50%"); highlightGlowCenter.setAttribute("r", "50%");
    highlightGlowCenter.innerHTML = `<stop offset="0%" stop-color="#facc15" stop-opacity="0.6"/><stop offset="100%" stop-color="#facc15" stop-opacity="0"/>`;
    defs.appendChild(highlightGlowCenter);
    const highlightGlowNeighbor = document.createElementNS("http://www.w3.org/2000/svg", "radialGradient");
    highlightGlowNeighbor.setAttribute("id", "highlight-glow-neighbor");
    highlightGlowNeighbor.setAttribute("cx", "50%"); highlightGlowNeighbor.setAttribute("cy", "50%"); highlightGlowNeighbor.setAttribute("r", "50%");
    highlightGlowNeighbor.innerHTML = `<stop offset="0%" stop-color="#ffffff" stop-opacity="0.4"/><stop offset="100%" stop-color="#ffffff" stop-opacity="0"/>`;
    defs.appendChild(highlightGlowNeighbor);
    const chargeGlow = document.createElementNS("http://www.w3.org/2000/svg", "radialGradient");
    chargeGlow.setAttribute("id", "charge-glow-pink");
    chargeGlow.setAttribute("cx", "50%"); chargeGlow.setAttribute("cy", "50%"); chargeGlow.setAttribute("r", "50%");
    chargeGlow.innerHTML = `<stop offset="0%" stop-color="#ffffff" stop-opacity="1"/><stop offset="40%" stop-color="#f472b6" stop-opacity="0.9"/><stop offset="100%" stop-color="#ec4899" stop-opacity="0"/>`;
    defs.appendChild(chargeGlow);
    const orbGradP = document.createElementNS("http://www.w3.org/2000/svg", "radialGradient");
    orbGradP.setAttribute("id", "grad-orb-p");
    orbGradP.setAttribute("cx", "30%"); orbGradP.setAttribute("cy", "30%"); orbGradP.setAttribute("r", "80%");
    orbGradP.innerHTML = `<stop offset="0%" stop-color="#34D399" stop-opacity="0.95"/><stop offset="60%" stop-color="#059669" stop-opacity="0.9"/><stop offset="100%" stop-color="#064E3B" stop-opacity="0.9"/>`;
    defs.appendChild(orbGradP);
    const orbGradD = document.createElementNS("http://www.w3.org/2000/svg", "radialGradient");
    orbGradD.setAttribute("id", "grad-orb-d");
    orbGradD.setAttribute("cx", "30%"); orbGradD.setAttribute("cy", "30%"); orbGradD.setAttribute("r", "80%");
    orbGradD.innerHTML = `<stop offset="0%" stop-color="#FBBF24" stop-opacity="0.95"/><stop offset="60%" stop-color="#D97706" stop-opacity="0.9"/><stop offset="100%" stop-color="#78350F" stop-opacity="0.9"/>`;
    defs.appendChild(orbGradD);

    sceneRoot.appendChild(defs);

    // --- 2. 投影與物件收集 ---
    const showLPs = document.getElementById('toggle-lp') ? document.getElementById('toggle-lp').checked : true;
    const isAnyHighlighted = currentMolecule.renderObjects.some(o => o.isHighlighted);
    const renderList = [];
    const atomMap = new Map();
    const atomPosList = [];

    currentMolecule.renderObjects.forEach((obj, i) => {
        if (obj.isLobe) {
            const pStart = project(obj); const pEnd = project(obj.end);
            renderList.push({ type: 'lobe', z: (pStart.z + pEnd.z)/2, pStart, pEnd, colorType: obj.colorType, scale: pStart.scale });
            return;
        }
        if (obj.isAxis) {
            const pStart = project(obj); const pEnd = project(obj.end);
            renderList.push({ type: 'axisVector', z: (pStart.z + pEnd.z)/2, pStart, pEnd, label: obj.label, scale: pStart.scale });
            return;
        }
        if (obj.type === 'electron' && !showLPs) return;

        const p = project(obj);
        let alpha = 1.0;
        if (isAnyHighlighted) {
            if (obj.type === 'atom') alpha = obj.isHighlighted ? 1.0 : 0.1;
            else if (obj.type === 'electron') alpha = obj.parentAtom && obj.parentAtom.isHighlighted ? 1.0 : 0.1;
        }
        const renderObj = { ...obj, px: p.x, py: p.y, pz: p.z, scale: p.scale, idx: i, alpha: alpha, z: p.z };
        renderList.push(renderObj);
        if (obj.type === 'atom') {
            atomMap.set(obj.originalIndex, renderObj);
            atomPosList.push({ x: obj.x, y: obj.y, z: obj.z, r: obj.r });
        }
    });

    if (customFaces.length > 0) {
        customFaces.forEach(faceIndices => {
            const nodes = faceIndices.map(idx => atomMap.get(idx)).filter(n => n);
            if (nodes.length === 3) {
                const avgZ = (nodes[0].z + nodes[1].z + nodes[2].z) / 3;
                renderList.push({ type: 'polyFace', z: avgZ, nodes: nodes, colorType: faceIndices[3] || 'yellow', alpha: isAnyHighlighted ? 0.1 : 1.0 });
            }
        });
    }

    if (currentMolecule.extraLines) {
        currentMolecule.extraLines.forEach(line => {
            const pStart = project(line.start); const pEnd = project(line.end);
            const avgZ = (pStart.z + pEnd.z) / 2;
            let alpha = isAnyHighlighted ? 0.1 : 1.0;
            const findAtomR = (pt) => {
                const match = atomPosList.find(a => Math.abs(a.x - pt.x) < 2 && Math.abs(a.y - pt.y) < 2 && Math.abs(a.z - pt.z) < 2);
                return match ? match.r : 0;
            };
            renderList.push({ type: "boxLine", z: avgZ, x1: pStart.x, y1: pStart.y, x2: pEnd.x, y2: pEnd.y, scale: (pStart.scale + pEnd.scale) / 2, r1: findAtomR(line.start), r2: findAtomR(line.end), alpha: alpha });
        });
    }

    if (currentMolecule.bonds3D) {
        currentMolecule.bonds3D.forEach((bond, index) => { 
            const idx1 = bond[0]; const idx2 = bond[1];
            const a1 = atomMap.get(idx1); const a2 = atomMap.get(idx2);
            if (!a1 || !a2) return; 
            let drawStyle = bond[2] || "single";
            let bondAlpha = 1.0;
            if (isAnyHighlighted) {
                const connectedToCenter = (a1.isHighlighted==='center' && a2.isHighlighted==='neighbor') || (a2.isHighlighted==='center' && a1.isHighlighted==='neighbor');
                if (!connectedToCenter) bondAlpha = 0.05;
            }
            renderList.push({ type: "bond", z: (a1.pz + a2.pz) / 2, x1: a1.px, y1: a1.py, x2: a2.px, y2: a2.py, r1: a1.r * a1.scale, r2: a2.r * a2.scale, style: drawStyle, scale: (a1.scale + a2.scale) / 2, c1: a1.color, c2: a2.color, bondIdx: index, opacity: 1, alpha: bondAlpha });
        });
    }

    // CC (點群對稱元素渲染區塊：重心對齊版)
    if (currentMolecule.symmetry && currentMolecule.symmetry.elements) {
        // 取得當前分子的重心，若無則預設為原點
        const mCentroid = currentMolecule.centroid || { x: 0, y: 0, z: 0 };
        
        currentMolecule.symmetry.elements.forEach(el => {
            if (!el.active || !el.v) return;
            try {
                if (el.type === 'axis') {
                    const len = 110; // 軸的視覺長度
                    // 向量正規化，確保不同角度長度一致
                    const rawLen = Math.sqrt(el.v[0]**2 + el.v[1]**2 + el.v[2]**2);
                    const vLen = rawLen < 0.001 ? 1 : rawLen;
                    const nx = el.v[0] / vLen, ny = el.v[1] / vLen, nz = el.v[2] / vLen;

                    // 從分子重心出發延伸
                    const p1 = project({ x: mCentroid.x + nx * len, y: mCentroid.y + ny * len, z: mCentroid.z + nz * len });
                    const p2 = project({ x: mCentroid.x - nx * len, y: mCentroid.y - ny * len, z: mCentroid.z - nz * len });
                    
                    renderList.push({ 
                        type: 'axisVector', z: (p1.z + p2.z)/2, pStart: p1, pEnd: p2, 
                        label: el.label, scale: p1.scale, 
                        customColor: "url(#grad-hyper-gold)", labelColor: "#facc15" 
                    });
                } else if (el.type === 'center') {
                    // 反轉中心 (i) 直接定位在重心
                    const p = project({ x: mCentroid.x, y: mCentroid.y, z: mCentroid.z });
                    renderList.push({
                        type: 'atom', z: p.z, px: p.x, py: p.y, scale: p.scale,
                        r: 6, color: "#facc15", elem: "i", isHighlighted: "center"
                    });
                } else if (el.type === 'plane') {
                    const s = 80; // 平面尺寸
                    let v1 = [0, 1, 0], v2 = [0, 0, 1];
                    // 計算垂直於 el.v 的平面基底向量
                    if (Math.abs(el.v[0]) < 0.9) { 
                        v1 = [1, 0, 0]; 
                        v2 = [0, el.v[2], -el.v[1]]; 
                    }
                    
                    // 根據基底向量生成平面的四個頂點，並加上重心位移
                    const pts = [
                        {x: mCentroid.x + (v1[0]+v2[0])*s, y: mCentroid.y + (v1[1]+v2[1])*s, z: mCentroid.z + (v1[2]+v2[2])*s},
                        {x: mCentroid.x + (v1[0]-v2[0])*s, y: mCentroid.y + (v1[1]-v2[1])*s, z: mCentroid.z + (v1[2]-v2[2])*s},
                        {x: mCentroid.x + (-v1[0]-v2[0])*s, y: mCentroid.y + (-v1[1]-v2[1])*s, z: mCentroid.z + (-v1[2]-v2[2])*s},
                        {x: mCentroid.x + (-v1[0]+v2[0])*s, y: mCentroid.y + (-v1[1]+v2[1])*s, z: mCentroid.z + (-v1[2]+v2[2])*s}
                    ];
                    const proj = pts.map(p => project(p));
                    renderList.push({ 
                        type: 'polyFace', 
                        z: proj.reduce((sum, p) => sum + p.z, 0) / 4, 
                        nodes: proj.map(p => ({ px: p.x, py: p.y })), 
                        colorType: el.colorType || 'cyan' 
                    });
                }
            } catch (err) { console.error("對稱元素投影失敗:", err); }
        });
    }

    // --- 4. 排序並繪製 ---
    renderList.sort((a,b) => (a.z - b.z)).forEach(obj => {
        if (obj.type === "bond") drawBond(obj);
        else if (obj.type === "atom") drawAtom(obj);
        else if (obj.type === "lobe") drawLobe(obj);
        else if (obj.type === "axisVector") drawAxisVector(obj);
        else if (obj.type === "electron") drawElectron(obj);
        else if (obj.type === "boxLine") drawBoxLine(obj);
        else if (obj.type === "polyFace") {
            const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            poly.setAttribute("points", obj.nodes.map(n => `${n.px},${n.py}`).join(" "));
            // 【重要修正】顏色對照表必須定義在渲染當下
            const symmetryColors = {
                'yellow': { f: "rgba(253, 224, 71, 0.2)", s: "rgba(253, 224, 71, 0.9)" },
                'cyan':   { f: "rgba(34, 211, 238, 0.2)", s: "rgba(34, 211, 238, 0.9)" },
                'pink':   { f: "rgba(244, 114, 182, 0.2)", s: "rgba(244, 114, 182, 0.9)" }
            };
            const config = symmetryColors[obj.colorType] || symmetryColors.cyan;
            poly.setAttribute("fill", config.f); poly.setAttribute("stroke", config.s);
            poly.setAttribute("stroke-width", "3"); poly.setAttribute("opacity", "1.0");
            sceneRoot.appendChild(poly);
        }
    });
}

function drawBoxLine(l) {
    let x1 = l.x1, y1 = l.y1, x2 = l.x2, y2 = l.y2;
    
    const dx = x2 - x1;
    const dy = y2 - y1;
    const len = Math.sqrt(dx*dx + dy*dy);
    
    if (len > 0) {
        const nx = dx / len;
        const ny = dy / len;

        // 截斷邏輯
        const cut1 = (l.r1 || 0) * l.scale * 0.95;
        const cut2 = (l.r2 || 0) * l.scale * 0.95;

        if (len > (cut1 + cut2)) {
            x1 = x1 + nx * cut1;
            y1 = y1 + ny * cut1;
            x2 = x2 - nx * cut2;
            y2 = y2 - ny * cut2;
        } else {
            return;
        }
    }

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x1); line.setAttribute("y1", y1);
    line.setAttribute("x2", x2); line.setAttribute("y2", y2);
    
    // [設定：白色粗框]
    line.setAttribute("stroke", "#ffffff"); 
    line.setAttribute("stroke-width", "5"); 
    line.setAttribute("stroke-linecap", "round");
    
    if (!isMobile) {
        line.setAttribute("filter", "url(#box-glow)"); 
    }
    
    line.setAttribute("opacity", l.alpha === 0.1 ? "0.1" : "0.9"); 
    
    sceneRoot.appendChild(line);
}

// 2. 繪製原子連線 (細白線 + 截斷)
function drawBond(b) {
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    const isLight = document.body && document.body.classList && document.body.classList.contains('light-mode');

    // ============================================================
    // [區塊 1] NaCl / 離子晶體專用繪圖邏輯 (外金屬框 + 內發光細線)
    // ============================================================
    if (b.style === "ionic_thick" || b.style === "ionic_thin") {
        const dx = b.x2 - b.x1, dy = b.y2 - b.y1, len = Math.sqrt(dx*dx + dy*dy);
        if(len === 0) return;
        
        // 計算截斷點，讓線條貼齊原子表面
        const nx = dx / len, ny = dy / len;
        const off1 = b.r1 * 0.9, off2 = b.r2 * 0.9; 
        
        if (len > (off1 + off2)) {
            const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
            l.setAttribute("x1", b.x1 + nx * off1);
            l.setAttribute("y1", b.y1 + ny * off1);
            l.setAttribute("x2", b.x2 - nx * off2);
            l.setAttribute("y2", b.y2 - ny * off2);
            
            // 1. 自動注入「高質感金屬漸層」 (如果還沒建立過)
            const gradID = "grad-hyper-metal";
            if (!document.getElementById(gradID)) {
                const defs = document.querySelector("defs") || sceneRoot;
                const grad = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
                grad.setAttribute("id", gradID);
                grad.setAttribute("x1", "0%"); grad.setAttribute("y1", "0%");
                grad.setAttribute("x2", "100%"); grad.setAttribute("y2", "0%"); 
                grad.innerHTML = `
                    <stop offset="0%" stop-color="#475569"/>
                    <stop offset="30%" stop-color="#cbd5e1"/>
                    <stop offset="50%" stop-color="#ffffff"/>
                    <stop offset="70%" stop-color="#cbd5e1"/>
                    <stop offset="100%" stop-color="#475569"/>
                `;
                defs.appendChild(grad);
            }

            // 2. 樣式與濾鏡設定
            let baseOpacity = 1.0;

            if (b.style === "ionic_thick") {
                // --- 外框 (粗金屬) ---
                l.setAttribute("stroke", `url(#${gradID})`); 
                l.setAttribute("stroke-width", 12 * b.scale); 
                baseOpacity = 1.0; 
            } else {
                // --- 內部 (朦朧發光線) ---
                l.setAttribute("stroke", "#ffffff");      
                l.setAttribute("stroke-width", 4.0 * b.scale); 
                
                // [關鍵修改] 移除 !isMobile 判斷，強制所有裝置都套用發光濾鏡
                // 這樣手機版也能看到漂亮的發光效果
                l.setAttribute("filter", "url(#soft-glow)");

                baseOpacity = 0.6; // 半透明
            }
            l.setAttribute("stroke-linecap", "round");

            // 3. 互動邏輯 (點擊中心時的淡出效果)
            let finalOpacity = baseOpacity; 
            if (b.alpha < 0.9) {
                finalOpacity = 0.05; 
            }
            l.setAttribute("opacity", finalOpacity);

            g.appendChild(l);
        }
        sceneRoot.appendChild(g);
        return; // 晶體繪製完畢，直接返回
    }

    // ============================================================
    // [區塊 2] 一般共價鍵與舊版金屬 (保持原樣不動)
    // ============================================================
    
    // 應用透明度 (共用)
    if (b.alpha < 1.0) g.setAttribute("opacity", b.alpha);

    // A. 舊版金屬/簡單離子晶體邏輯
    if (currentMolecule && (currentMolecule.isMetal || (currentMolecule.isIonic && !b.style))) {
        const dx = b.x2 - b.x1;
        const dy = b.y2 - b.y1;
        const len = Math.sqrt(dx*dx + dy*dy);
        if(len > 0) { // 原本邏輯有做 len > 0 判斷，這裡整合
            const nx = dx / len;
            const ny = dy / len;
            // 這裡使用 0.95 的截斷係數，與上面晶體不同，保持原樣
            const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
            l.setAttribute("x1", b.x1 + nx * b.r1 * 0.95); 
            l.setAttribute("y1", b.y1 + ny * b.r1 * 0.95);
            l.setAttribute("x2", b.x2 - nx * b.r2 * 0.95); 
            l.setAttribute("y2", b.y2 - ny * b.r2 * 0.95);
            l.setAttribute("stroke", "#9ca3af"); 
            l.setAttribute("stroke-width", "4"); 
            l.setAttribute("stroke-linecap", "round");
            l.setAttribute("opacity", b.alpha < 1.0 ? 0.05 : 0.6); 
            g.appendChild(l);
        }
        sceneRoot.appendChild(g);
        return; 
    }

    // B. 一般共價鍵 (漸層、多重鍵)
    const dxMol = b.x2-b.x1, dyMol = b.y2-b.y1, lenMol = Math.sqrt(dxMol*dxMol+dyMol*dyMol);
    if(lenMol === 0) return;
    const nxMol = dxMol/lenMol, nyMol = dyMol/lenMol;
    const px = -nyMol, py = nxMol;
    const w = 16 * b.scale; const strokeW = w * 0.45; const shorten = 0.75;      
    const x1 = b.x1 + nxMol * b.r1 * shorten; const y1 = b.y1 + nyMol * b.r1 * shorten;
    const x2 = b.x2 - nxMol * b.r2 * shorten; const y2 = b.y2 - nyMol * b.r2 * shorten;
    
    let strokeColor;
        if (b.style === "coordinate") strokeColor = b.c1; 
    else {
        const gradId = `bond-grad-${b.bondIdx}`;
        const defs = sceneRoot.querySelector("defs");
        const grad = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
        grad.setAttribute("id", gradId); grad.setAttribute("gradientUnits", "userSpaceOnUse");
        grad.setAttribute("x1", x1); grad.setAttribute("y1", y1); grad.setAttribute("x2", x2); grad.setAttribute("y2", y2);
        // Darken bond end colors in light mode to keep contrast against white viewport
        const c1 = isLight ? adjustColor(b.c1 || '#999999', -30) : (b.c1 || '#999999');
        const c2 = isLight ? adjustColor(b.c2 || '#666666', -30) : (b.c2 || '#666666');
        grad.innerHTML = `<stop offset="0%" stop-color="${c1}"/><stop offset="40%" stop-color="${c1}"/><stop offset="60%" stop-color="${c2}"/><stop offset="100%" stop-color="${c2}"/>`;
        defs.appendChild(grad);
        strokeColor = `url(#${gradId})`;
    }
    
    const drawLine = (ox, oy, width, color, opacity=1) => {
        const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
        l.setAttribute("x1", x1+ox); l.setAttribute("y1", y1+oy); l.setAttribute("x2", x2+ox); l.setAttribute("y2", y2+oy);
        l.setAttribute("stroke", color); l.setAttribute("stroke-width", width); l.setAttribute("stroke-linecap", "round");
        const finalOp = opacity * (b.opacity || 1); 
        if(finalOp < 1) l.setAttribute("opacity", finalOp);
        return l;
    };
    const drawCylinder = (ox, oy) => {
        g.appendChild(drawLine(ox, oy, strokeW, strokeColor));
        g.appendChild(drawLine(ox, oy, strokeW * 0.25, "#ffffff", 0.5));
    };
    
    if (b.style === "double") { const off = w * 0.38; drawCylinder(px*off, py*off); drawCylinder(-px*off, -py*off); } 
    else if (b.style === "triple") { const off = w * 0.75; drawCylinder(0, 0); drawCylinder(px*off, py*off); drawCylinder(-px*off, -py*off); } 
    else if (b.style === "coordinate_triple") { const off = w * 0.75; drawCylinder(0, 0); drawCylinder(px*off, py*off); g.appendChild(drawLine(-px*off, -py*off, strokeW, strokeColor)); } 
    else { drawCylinder(0, 0); }
    
    sceneRoot.appendChild(g);
}

function drawAtom(a) {
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g.setAttribute("data-atom-idx", a.idx); 
    
    if (a.alpha < 1.0) g.setAttribute("opacity", a.alpha);

    // 點擊高亮
    if (a.isHighlighted) {
        const glowId = a.isHighlighted === "center" ? "highlight-glow-center" : "highlight-glow-neighbor";
        const halo = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        halo.setAttribute("cx", a.px); halo.setAttribute("cy", a.py);
        halo.setAttribute("r", a.r * a.scale * 2.5); 
        halo.setAttribute("fill", `url(#${glowId})`);
        g.appendChild(halo);
    }

    if (isPlasmaMode) {
        // [修正] 手機版電漿修復：強制使用標準濾鏡
        g.setAttribute("style", "mix-blend-mode: screen;"); 
        const baseR = a.r * a.scale;
        
        // 核心
        const gasCloud = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        gasCloud.setAttribute("cx", a.px); gasCloud.setAttribute("cy", a.py);
        gasCloud.setAttribute("r", baseR * 1.6); 
        // 這裡需要確保 plasma-grad- 存在，如果沒有定義，回退到單色
        // 建議直接用 atom-grad 以確保有顏色
        gasCloud.setAttribute("fill", `url(#atom-grad-${a.color.replace('#','')})`);
        gasCloud.setAttribute("filter", "url(#soft-glow)"); // 加上光暈
        g.appendChild(gasCloud);

        const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
        txt.setAttribute("x", a.px); txt.setAttribute("y", a.py);
        txt.setAttribute("font-size", baseR * 0.85); 
        txt.setAttribute("class", "atom-label-text");
        txt.style.textShadow = "0 0 3px #000, 0 0 5px #000"; 
        txt.style.fill = "#fff";
        txt.textContent = a.elem;
        g.appendChild(txt);

    } else {
        const useGlow = window.isGlowOn;
        
        if (useGlow) {
            const glow = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            glow.setAttribute("cx", a.px); glow.setAttribute("cy", a.py); 
            
            // [關鍵修正] 移除手機版 mobile-glow 分支，統一使用電腦版邏輯
            glow.setAttribute("r", a.r * a.scale * 1.3); 
            glow.setAttribute("fill", a.color); 
            glow.setAttribute("opacity", "0.36");
            glow.setAttribute("filter", "url(#soft-glow)"); // 手機現在也跑這個
            
            g.appendChild(glow);
        }

        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", a.px); circle.setAttribute("cy", a.py); 
        circle.setAttribute("r", a.r * a.scale); 
        circle.setAttribute("fill", `url(#atom-grad-${a.color.replace('#','')})`); 
        
        const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
        txt.setAttribute("x", a.px); txt.setAttribute("y", a.py); 
        txt.setAttribute("font-size", a.r * 0.75 * a.scale); 
        txt.setAttribute("class", "atom-label-text"); 
        txt.textContent = a.elem;
        
        g.appendChild(circle); g.appendChild(txt);
    }
    
    sceneRoot.appendChild(g);
}

// ========== [請替換 drawElectron] ==========
function drawElectron(e) {
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    const r = e.r * e.scale;
    
    let coreColor = "#ffffff";
    let glowFill = "#ffffff";
    let glowOpacity = "0.28";
    const isLight = document.body && document.body.classList && document.body.classList.contains('light-mode');
    if (isLight) {
        // Force electrons to be dark/black in light mode for visibility on white background
        coreColor = "#000000";
        glowFill = "#000000";
        glowOpacity = "0.42";
    }
    
    if (e.isNegativeCharge) {
        // keep negative-charge highlight when not in light mode; in light mode prefer black for contrast
        if (!isLight) {
            coreColor = "#ff9efa"; 
            glowFill = "#ff9efa"; 
            glowOpacity = "0.5"; 
        }
    }

    if (isPlasmaMode) {
        g.setAttribute("style", "mix-blend-mode: screen;"); 
        const halo = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        halo.setAttribute("cx", e.px); halo.setAttribute("cy", e.py);
        halo.setAttribute("r", r * (e.isNegativeCharge ? 3.0 : 2.0)); 
        halo.setAttribute("fill", glowFill);
        halo.setAttribute("opacity", "0.6");
        halo.setAttribute("filter", "url(#soft-glow)"); // [修正] 強制加濾鏡
        g.appendChild(halo);

        const core = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        core.setAttribute("cx", e.px); core.setAttribute("cy", e.py);
        core.setAttribute("r", r * 1.0);
        core.setAttribute("fill", coreColor);
        core.setAttribute("class", "electron-spark"); 
        g.appendChild(core);

    } else {
        const useGlow = window.isGlowOn;
        if (useGlow) {
            const glow = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            glow.setAttribute("cx", e.px); glow.setAttribute("cy", e.py); 
            
            // [關鍵修正] 移除手機特判，強制統一
            glow.setAttribute("r", r * 2.0); 
            glow.setAttribute("fill", glowFill);
            glow.setAttribute("opacity", glowOpacity);
            glow.setAttribute("filter", "url(#soft-glow)"); 
            
            g.appendChild(glow);
        }

        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", e.px); c.setAttribute("cy", e.py); c.setAttribute("r", r);
        c.setAttribute("fill", coreColor); 
        c.setAttribute("opacity", "0.95");
        g.appendChild(c);
    }
    
    sceneRoot.appendChild(g);
}

function adjustColor(col, amt) {
    let usePound = false;
    if (col[0] == "#") { col = col.slice(1); usePound = true; }
    let num = parseInt(col,16);
    let r = (num >> 16) + amt; if (r > 255) r = 255; else if  (r < 0) r = 0;
    let b = ((num >> 8) & 0x00FF) + amt; if (b > 255) b = 255; else if  (b < 0) b = 0;
    let g = (num & 0x0000FF) + amt; if (g > 255) g = 255; else if (g < 0) g = 0;
    return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16).padStart(6,'0');
}

function animate() {
    const time = performance.now(); 
    if (!isDragging && !isReactionRunning && !isLongPressActive) {
        rotVelocity.x *= 0.96; rotVelocity.y *= 0.96; rotVelocity.z *= 0.96;
        let speed = Math.sqrt(rotVelocity.x*rotVelocity.x + rotVelocity.y*rotVelocity.y + rotVelocity.z*rotVelocity.z);
        const MIN_SPEED = 0.004; 
        const autoRotateEl = document.getElementById('toggle-auto-rotate');
        const isAutoRotateOn = autoRotateEl ? autoRotateEl.checked : true;

        if (speed > 0.00001) { 
            if (speed < MIN_SPEED) {
                if (isAutoRotateOn) {
                    let scaleFactor = MIN_SPEED / speed;
                    rotVelocity.x *= scaleFactor; rotVelocity.y *= scaleFactor; rotVelocity.z *= scaleFactor;
                }
            }
            applyRotation(rotVelocity.y, rotVelocity.x, rotVelocity.z);
        } else {
            if (isAutoRotateOn) applyRotation(0.004, 0, 0); 
        }
    }
    renderScene(time);
    requestAnimationFrame(animate);
}

function setupInteractions() {
    // Balance UI removed — no binding for balance button.

    // 更新點群流程圖 Overlay 邏輯
    window.togglePgFlowchart = function() {
        const overlay = document.getElementById('pg-flowchart-overlay');
        if (!overlay) return;
        overlay.style.display = (overlay.style.display === 'none' || overlay.style.display === '') ? 'block' : 'none';
        document.body.style.overflow = (overlay.style.display === 'block') ? 'hidden' : '';
    };
    // Balance feature removed; previously invoked setupEquationBalancer().

    // 1. 基礎按鈕綁定
    const modeBtn = document.getElementById('mode-toggle');
    if (modeBtn) modeBtn.addEventListener('click', toggleMode);

    const loadBtn = document.getElementById('load-btn');
    if (loadBtn) loadBtn.addEventListener('click', handleLoadBtn);

    const inputField = document.getElementById('formula-input');
    if (inputField) {
        inputField.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleLoadBtn();
        });
    }

    // 2. 顯示設定開關
    const toggleLp = document.getElementById('toggle-lp');
    if (toggleLp) toggleLp.addEventListener('change', () => { renderScene(); });

    // Glow option removed; glow is fixed disabled so no event binding required

    // 優先遵循八隅體：控制項已移除，無需事件綁定

    const togglePoly = document.getElementById('toggle-polyhedron');
    if (togglePoly) togglePoly.addEventListener('change', () => { renderScene(); });

    // 電漿態模式控制項已移除; plasma 保持 disabled (isPlasmaMode defaults to false)

    // Reaction button bindings removed (buttons removed from DOM)

    const btnConfig = document.getElementById('btn-open-config');
    if(btnConfig) btnConfig.addEventListener('click', openConfigModal);

    // Theme toggle handler
    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
            const isLight = document.body.classList.toggle('light-mode');
            try { localStorage.setItem('lightMode', isLight ? 'true' : 'false'); } catch (e) {}
            // Show the mode that will be switched to
            themeToggleBtn.textContent = isLight ? '深色模式' : '淺色模式';
        });
    }


    // 5. 手機面板與鍵盤
    const mobileHandle = document.getElementById('mobile-panel-handle');
    if (mobileHandle) {
        mobileHandle.addEventListener('click', () => {
            const body = document.body;
            body.classList.toggle('simulate-mobile-open');
            const panel = document.querySelector('.controls-area');
            if (panel) {
                if (body.classList.contains('simulate-mobile-open')) panel.style.transform = 'translateY(0)';
                else panel.style.transform = 'translateY(70vh)';
            }
        });
    }
    window.addEventListener('keydown', (e) => { if (e.key === 'Alt') altKeyIsDown = true; });
    window.addEventListener('keyup', (e) => { if (e.key === 'Alt') altKeyIsDown = false; });

    // 6. 3D 拖曳控制
    const MOUSE_SENSITIVITY = 0.005; const TOUCH_SENSITIVITY = 0.004;
    let longPressTimer = null; let startX = 0, startY = 0;
    const LONG_PRESS_MS = 500; const MOVE_TOLERANCE = 10;

    const handleStart = (x, y) => { 
        isDragging = true; isLongPressActive = false; 
        startX = x; startY = y; lastMouse = { x, y }; 
        rotVelocity = { x: 0, y: 0, z: 0 }; hideHybridTooltip(); 
        clearTimeout(longPressTimer);

        if (isFaceBuildMode) {
            // 手機版優化：成面模式需停留 0.2 秒才觸發，防止旋轉誤觸導致選取失敗
            longPressTimer = setTimeout(() => {
                checkAtomClick(startX, startY);
                isLongPressActive = true; // 標記已觸發，防止放開時重複選取
                if (navigator.vibrate) navigator.vibrate(30); 
            }, 200);
        } else {
            // 正常模式：長按 0.5 秒顯示混成軌域
            longPressTimer = setTimeout(() => {
                isDragging = false; isLongPressActive = true; 
                checkAtomClick(startX, startY); 
                if (navigator.vibrate) navigator.vibrate(40);
            }, LONG_PRESS_MS);
        }
    };

    const handleMove = (x, y, sensitivity) => {
        if (Math.abs(x - startX) > MOVE_TOLERANCE || Math.abs(y - startY) > MOVE_TOLERANCE) clearTimeout(longPressTimer);
        if (!isDragging) return;
        const dx = x - lastMouse.x; const dy = y - lastMouse.y;
        if (currentMode === 1 || (currentMode === 2 && !altKeyIsDown)) {
            rotVelocity.y = dx * sensitivity; rotVelocity.x = -dy * sensitivity; 
            applyRotation(rotVelocity.y, rotVelocity.x, 0);
        } else {
            panOffset.x += dx * 0.5; panOffset.y += dy * 0.5;
        }
        lastMouse = { x, y };
    };
    const handleEnd = (x, y) => { 
        clearTimeout(longPressTimer); 
        
        // 若在成面模式，選取已在 0.2 秒計時器完成，此處僅重置旗標
        if (isFaceBuildMode) {
            isDragging = false;
            isLongPressActive = false;
            return;
        }

        const moveDist = Math.hypot(x - startX, y - startY);
        if (!isLongPressActive && moveDist < MOVE_TOLERANCE) {
            checkAtomClick(x, y);
        }
        isDragging = false; 
        isLongPressActive = false; 
    };

    viewport.addEventListener("mousedown", e => handleStart(e.clientX, e.clientY));
    viewport.addEventListener("mousemove", e => handleMove(e.clientX, e.clientY, MOUSE_SENSITIVITY));
    viewport.addEventListener("mouseup", handleEnd);
    
    viewport.addEventListener("touchstart", e => {
        if(e.target.closest('.control-button')) return;
        if (e.touches.length === 1) {
            // 手機版也強制立即執行 handleStart 邏輯
            handleStart(e.touches[0].clientX, e.touches[0].clientY);
        } else if (e.touches.length === 2) {
            clearTimeout(longPressTimer); 
            const t1 = e.touches[0], t2 = e.touches[1];
            lastTouchDist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
            lastTouchCenter = { x: (t1.clientX + t2.clientX)/2, y: (t1.clientY + t2.clientY)/2 };
            lastTouchAngle = Math.atan2(t2.clientY - t1.clientY, t2.clientX - t1.clientX);
        }
    }, { passive: false });

    viewport.addEventListener("touchmove", e => {
        e.preventDefault(); 
        if(e.touches.length === 1) {
            handleMove(e.touches[0].clientX, e.touches[0].clientY, TOUCH_SENSITIVITY);
        } else if (e.touches.length === 2) {
            const t1 = e.touches[0], t2 = e.touches[1];
            const center = { x: (t1.clientX + t2.clientX)/2, y: (t1.clientY + t2.clientY)/2 };
            panOffset.x += (center.x - lastTouchCenter.x) * 0.4;
            panOffset.y += (center.y - lastTouchCenter.y) * 0.4;
            lastTouchCenter = center;
            const dist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
            if (lastTouchDist > 0) {
                const zoomDelta = (dist - lastTouchDist) * 0.003;
                scale = Math.max(0.3, Math.min(8, scale + zoomDelta));
            }
            lastTouchDist = dist;
            const angle = Math.atan2(t2.clientY - t1.clientY, t2.clientX - t1.clientX);
            let angleDelta = angle - lastTouchAngle;
            if (angleDelta > Math.PI) angleDelta -= Math.PI * 2;
            if (angleDelta < -Math.PI) angleDelta += Math.PI * 2;
            rotVelocity.z = angleDelta;
            applyRotation(0, 0, rotVelocity.z);
            lastTouchAngle = angle;
        }
    }, { passive: false });

    viewport.addEventListener("touchend", e => {
        if (e.changedTouches.length > 0) {
            handleEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        } else {
            handleEnd(0, 0);
        }
    });
    viewport.addEventListener("wheel", e => {
        scale = Math.max(0.5, Math.min(6, scale - e.deltaY * 0.001));
        hideHybridTooltip();
    });

    setupMobilePanel();
}

// 繪製水滴狀花瓣 (Bezier Curve)
function drawLobe(lobe) {
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    const x1 = lobe.pStart.x; const y1 = lobe.pStart.y;
    const x2 = lobe.pEnd.x;   const y2 = lobe.pEnd.y;
    
    const dx = x2 - x1; const dy = y2 - y1;
    const len = Math.sqrt(dx*dx + dy*dy);
    if (len < 1) return;

    const width = 45 * lobe.scale; 
    const nx = -dy / len; const ny = dx / len; 

    const midX = x1 + dx * 0.6; const midY = y1 + dy * 0.6;
    const cp1x = midX + nx * width; const cp1y = midY + ny * width;
    const cp2x = midX - nx * width; const cp2y = midY - ny * width;

    const d = `M ${x1} ${y1} Q ${cp1x} ${cp1y} ${x2} ${y2} Q ${cp2x} ${cp2y} ${x1} ${y1} Z`;
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", d);
    
    const fillUrl = (lobe.colorType === 'd') ? "url(#grad-orb-d)" : "url(#grad-orb-p)";
    path.setAttribute("fill", fillUrl);
    path.setAttribute("stroke", (lobe.colorType === 'd') ? "#B45309" : "#047857");
    path.setAttribute("stroke-width", "1");
    path.setAttribute("opacity", "0.9"); 

    g.appendChild(path);
    sceneRoot.appendChild(g);
}

// ★ 新版：高質感金屬軸 (銀灰軸身 + 白色文字 + 無凸點箭頭) ★
function drawAxisVector(axis) {
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    const x1 = axis.pStart.x; const y1 = axis.pStart.y;
    const x2 = axis.pEnd.x;   const y2 = axis.pEnd.y;

    const dx = x2 - x1; const dy = y2 - y1;
    const len = Math.sqrt(dx*dx + dy*dy);
    
    // 安全檢查：防止長度為 0 導致 NaN 錯誤
    if (len < 0.1) return;

    const ux = dx/len; const uy = dy/len;
    const arrowSize = 10 * axis.scale;
    const lineEndX = x2 - ux * (arrowSize - 2); 
    const lineEndY = y2 - uy * (arrowSize - 2);

    // 1. 畫線 (支援金色漸層)
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x1); line.setAttribute("y1", y1);
    line.setAttribute("x2", lineEndX); line.setAttribute("y2", lineEndY);
    line.setAttribute("stroke", axis.customColor || "#B0B0B0"); 
    line.setAttribute("stroke-width", 3 * axis.scale); 
    line.setAttribute("stroke-linecap", "butt");
    g.appendChild(line);
    line.setAttribute("stroke", axis.customColor || "#B0B0B0"); 
    line.setAttribute("stroke-width", 3 * axis.scale); 
    line.setAttribute("stroke-linecap", "butt");
    // 如果是 Sn 軸，設定為虛線
    if (axis.isDashed) {
        line.setAttribute("stroke-dasharray", "8, 5"); 
    }
    g.appendChild(line);

    // 2. 畫箭頭
    const bx = x2 - ux * arrowSize;
    const by = y2 - uy * arrowSize;
    const vx = -uy * arrowSize * 0.5;
    const vy = ux * arrowSize * 0.5;
    const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
    polygon.setAttribute("points", `${x2},${y2} ${bx + vx},${by + vy} ${bx - vx},${by - vy}`);
    polygon.setAttribute("fill", axis.customColor || "#B0B0B0"); 
    g.appendChild(polygon);

    // 3. 畫文字 (支援黃色文字)
    if (axis.label) {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", x2 + ux * 18 * axis.scale);
        text.setAttribute("y", y2 + uy * 18 * axis.scale);
        text.setAttribute("fill", axis.labelColor || "#FFFFFF"); 
        text.setAttribute("font-size", 16 * axis.scale);
        text.setAttribute("font-weight", "bold");
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("dominant-baseline", "middle");
        text.style.textShadow = "0 0 5px #000000"; 
        text.textContent = axis.label;
        g.appendChild(text);
    }
    sceneRoot.appendChild(g);
}



function toChineseNum(num) { const map={1:'一',2:'二',3:'三',4:'四',5:'五',6:'六',7:'七'}; return map[num]||num; }
function toSub(num) { 
    const subs = {'0':'₀','1':'₁','2':'₂','3':'₃','4':'₄','5':'₅','6':'₆','7':'₇','8':'₈','9':'₉'};
    return num.toString().split('').map(c => subs[c] || c).join('');
}

// ========== [請插入這段 JS] 離子計算邏輯 ==========
// ========== [請插入這段 JS] 1. 標準軌域順序 & 2. 縮寫轉換器 ==========
const ORBITAL_ORDER = ['1s','2s','2p','3s','3p','4s','3d','4p','5s','4d','5p','6s','4f','5d','6p','7s','5f','6d','7p'];

// 將完整組態轉為惰性氣體縮寫 (例如: 1s2 2s2 2p6 -> [Ne])
function toNobleNotation(fullConfig) {
    // 定義惰性氣體核心
    const nobles = [
        { sym: '[Rn]', conf: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6 4f14 5d10 6s2 6p6" },
        { sym: '[Xe]', conf: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6 4d10 5s2 5p6" },
        { sym: '[Kr]', conf: "1s2 2s2 2p6 3s2 3p6 3d10 4s2 4p6" },
        { sym: '[Ar]', conf: "1s2 2s2 2p6 3s2 3p6" },
        { sym: '[Ne]', conf: "1s2 2s2 2p6" },
        { sym: '[He]', conf: "1s2" }
    ];

    for (let gas of nobles) {
        if (fullConfig.startsWith(gas.conf) && fullConfig !== gas.conf) {
            // 移除核心部分，保留剩下的
            let rest = fullConfig.replace(gas.conf, "").trim();
            return `<span class="noble">${gas.sym}</span> ${rest}`;
        }
    }
    // 如果比 He 還小 (例如 H)，直接回傳
    return fullConfig;
}
function calculateIonConfig(baseConfigStr, charge) {
    if (charge === 0) return baseConfigStr;

    const parts = baseConfigStr.split(' ');
    let orbitals = [];
    const typeVal = { 's':0, 'p':1, 'd':2, 'f':3 };
    // 定義各軌域容量
    const capacity = { 's':2, 'p':6, 'd':10, 'f':14 };

    parts.forEach(p => {
        const match = p.match(/(\d)([spdf])(\d+)/);
        if (match) {
            orbitals.push({
                n: parseInt(match[1]),
                type: match[2],
                l: typeVal[match[2]],
                count: parseInt(match[3]),
                name: match[1] + match[2] // e.g., "1s"
            });
        }
    });

    // --- CASE A: 陽離子 (失去電子) ---
    if (charge > 0) {
        let removeCount = charge;
        while (removeCount > 0) {
            let candidates = orbitals.filter(o => o.count > 0);
            if (candidates.length === 0) break;

            // 排序：先拔 n 最大，n 相同拔 l 最大
            candidates.sort((a, b) => {
                if (b.n !== a.n) return b.n - a.n;
                return b.l - a.l;
            });

            let target = candidates[0];
            if (target.count >= removeCount) {
                target.count -= removeCount;
                removeCount = 0;
            } else {
                removeCount -= target.count;
                target.count = 0;
            }
        }
    } 
    // --- CASE B: 陰離子 (得到電子) ---
    else {
        let addCount = Math.abs(charge);
        
        // 1. 先嘗試填滿現有的最後一個軌域
        // 依照能量排序 (原本的字串順序通常就是能量順序，除了例外，但這邊我們簡單處理)
        // 為了保險，我們直接看最後一個軌域
        while (addCount > 0) {
            let lastOrbital = orbitals[orbitals.length - 1];
            let maxCap = capacity[lastOrbital.type];

            if (lastOrbital.count < maxCap) {
                let space = maxCap - lastOrbital.count;
                let fill = Math.min(space, addCount);
                lastOrbital.count += fill;
                addCount -= fill;
            } else {
                // 當前軌域已滿，尋找下一個軌域
                let currentName = lastOrbital.name; // e.g. "2p"
                let idx = ORBITAL_ORDER.indexOf(currentName);
                
                if (idx !== -1 && idx < ORBITAL_ORDER.length - 1) {
                    let nextName = ORBITAL_ORDER[idx + 1]; // e.g. "3s"
                    let nextMatch = nextName.match(/(\d)([spdf])/);
                    
                    // 新增一個空軌域到陣列中
                    let newOrb = {
                        n: parseInt(nextMatch[1]),
                        type: nextMatch[2],
                        l: typeVal[nextMatch[2]],
                        count: 0, // 初始為0，下一輪迴圈會填入
                        name: nextName
                    };
                    orbitals.push(newOrb);
                } else {
                    break; // 超出範圍或找不到，停止 (避免無窮迴圈)
                }
            }
        }
    }

    // 重組字串
    return orbitals
        .filter(o => o.count > 0)
        .map(o => `${o.n}${o.type}${o.count}`)
        .join(' ');
}

function generateEcViz(configStr) {
    const parts = configStr.split(' ');
    let html = '';
    parts.forEach(part => {
        const match = part.match(/(\d)([spdf])(\d+)/);
        if(match) {
            const level = match[1]; const type = match[2]; const count = parseInt(match[3]);
            const boxCount = {s:1, p:3, d:5, f:7}[type];
            let arrows = []; let e = count;
            for(let i=0; i<boxCount; i++) arrows[i] = "";
            for(let i=0; i<boxCount && e>0; i++, e--) arrows[i] = "↑";
            for(let i=0; i<boxCount && e>0; i++, e--) arrows[i] = "⇅";
            let boxes = '';
            arrows.forEach(a => { boxes += `<div class="ec-box">${a || ''}</div>`; });
            html += `<div class="ec-sub"><div class="ec-boxes">${boxes}</div><div class="ec-label">${level}${type}<sup>${count}</sup></div></div>`;
        }
    });
    return html;
}

function renderConfigList() {
    const input = document.getElementById('configSearchInput');
    const filter = input ? input.value.toLowerCase() : "";
    const container = document.getElementById('configListContainer');
    container.innerHTML = "";
    let shownCount = 0;
    const MAX_SHOW = (window.innerWidth < 768) ? 15 : 118;

    ELECTRON_DATA.forEach(el => {
        if (filter) {
            const isNumeric = !isNaN(filter) && filter !== "";
            const isSymbolMatch = el.s.toLowerCase().startsWith(filter); 
            const isChineseMatch = el.cn === filter; // 中文完全匹配
            const isZMatch = el.z.toString() === filter;

            if (isNumeric) {
                if (!isZMatch) return;
            } else {
                if (!isSymbolMatch && !isChineseMatch) return;
            }
        }

        // 2. 效能限制邏輯 (搜尋時通常不會達到限制，主要是保護空搜尋狀態)
        if (shownCount >= MAX_SHOW) return;
        shownCount++;

        const card = document.createElement('div');
        card.className = 'element-card';
        
        // 預設顯示：縮寫版
        // 我們將 "完整組態" 存在 data-full-config 屬性中
        // 將 "當前電荷" 存在 data-charge 屬性中 (預設0)
        // 將 "顯示模式" 存在 data-mode 屬性中 (預設 'noble')
        
        let nobleHtml = el.noble.replace(/(\[.*?\])/g, '<span class="noble">$1</span>')
                                .replace(/([spdf])(\d+)/g, '$1<sup>$2</sup>');
        const vizHtml = generateEcViz(el.c);
        
        let periodGroupStr = "";
        if (el.g === "鑭系" || el.g === "錒系") {
            periodGroupStr = `第${toChineseNum(el.p)}週期 <span style="color:#f472b6;">${el.g}</span>`;
        } else {
            periodGroupStr = `第${toChineseNum(el.p)}週期 ${el.g}族 (第${el.iupac}族)`;
        }

        const cardId = `card-${el.s}`;

        card.innerHTML = `
            <div class="ec-header">
                <div class="ec-top-row">
                    <div class="ec-sym-box">
                        <div class="ec-sym">${el.s}</div>
                        <div class="ec-info">
                            <span class="ec-name">${el.cn ? el.cn + " " : ""}${el.n} <span style="color:var(--accent-yellow); font-family:'Noto Serif TC', serif;">Z=${el.z}</span></span>
                            <span class="ec-tag">${periodGroupStr}</span>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px;">
                                <div style="border:1px solid rgba(255,255,255,0.2); border-radius:6px; padding:3px 8px; font-size:0.75rem; color:#cbd5e1; background:rgba(20,20,20,0.3); white-space:nowrap;">分類: ${el.type || "-"}</div>
                                <div style="border:1px solid rgba(255,255,255,0.2); border-radius:6px; padding:3px 8px; font-size:0.75rem; color:#cbd5e1; background:rgba(20,20,20,0.3); white-space:nowrap;">狀態: ${el.state || "-"}</div>
                                <div style="border:1px solid rgba(255,255,255,0.2); border-radius:6px; padding:3px 8px; font-size:0.75rem; color:#cbd5e1; background:rgba(20,20,20,0.3); white-space:nowrap;">熔點: ${el.mp || "-"}</div>
                                <div style="border:1px solid rgba(255,255,255,0.2); border-radius:6px; padding:3px 8px; font-size:0.75rem; color:#cbd5e1; background:rgba(20,20,20,0.3); white-space:nowrap;">沸點: ${el.bp || "-"}</div>
                            </div>
                        </div>
                    </div>
                
                <!-- 顯示模式切換按鈕 -->
                <button onclick="toggleConfigMode('${el.s}', '${el.c}')" style="font-size:0.75rem; background:rgba(255,255,255,0.1); border:1px solid #555; color:#aaa; border-radius:4px; padding:2px 6px; cursor:pointer;" id="${cardId}-mode-btn">
                    模式: 縮寫
                </button>
            </div>
            
            <!-- 離子控制 -->
            <div id="ion-group-${el.s}" style="display:flex; gap:6px; margin:10px 0; flex-wrap:wrap; align-items:center;">
                <button class="ion-btn active" data-charge="0" data-type="neutral" onclick="updateIonViz('${el.s}', '${el.c}', 0)" 
                    style="font-size:0.75rem; padding:4px 8px; border:1px solid #64748b; border-radius:4px; color:#cbd5e1; background:#1e293b; cursor:pointer;">中性</button>
                
                <button class="ion-btn" data-charge="1" data-type="pos" onclick="updateIonViz('${el.s}', '${el.c}', 1)" 
                    style="font-size:0.75rem; padding:4px 8px; border:1px solid #f87171; border-radius:4px; color:#f87171; background:rgba(248,113,113,0.1); cursor:pointer;">+1</button>
                <button class="ion-btn" data-charge="2" data-type="pos" onclick="updateIonViz('${el.s}', '${el.c}', 2)" 
                    style="font-size:0.75rem; padding:4px 8px; border:1px solid #f87171; border-radius:4px; color:#f87171; background:rgba(248,113,113,0.1); cursor:pointer;">+2</button>
                <button class="ion-btn" data-charge="3" data-type="pos" onclick="updateIonViz('${el.s}', '${el.c}', 3)" 
                    style="font-size:0.75rem; padding:4px 8px; border:1px solid #f87171; border-radius:4px; color:#f87171; background:rgba(248,113,113,0.1); cursor:pointer;">+3</button>
                
                <button class="ion-btn" data-charge="-1" data-type="neg" onclick="updateIonViz('${el.s}', '${el.c}', -1)" 
                    style="font-size:0.75rem; padding:4px 8px; border:1px solid #60a5fa; border-radius:4px; color:#60a5fa; background:rgba(96,165,250,0.1); cursor:pointer;">-1</button>
                <button class="ion-btn" data-charge="-2" data-type="neg" onclick="updateIonViz('${el.s}', '${el.c}', -2)" 
                    style="font-size:0.75rem; padding:4px 8px; border:1px solid #60a5fa; border-radius:4px; color:#60a5fa; background:rgba(96,165,250,0.1); cursor:pointer;">-2</button>
                <button class="ion-btn" data-charge="-3" data-type="neg" onclick="updateIonViz('${el.s}', '${el.c}', -3)" 
                    style="font-size:0.75rem; padding:4px 8px; border:1px solid #60a5fa; border-radius:4px; color:#60a5fa; background:rgba(96,165,250,0.1); cursor:pointer;">-3</button>
            </div>

                <!-- 隱藏欄位：儲存當前電荷與模式 -->
                <input type="hidden" id="${cardId}-charge" value="0">
                <input type="hidden" id="${cardId}-mode" value="noble">

                <div class="ec-config-row ec-scroll" id="${cardId}-text" style="justify-content: flex-start;">
                    <div class="ec-config" style="white-space: nowrap;">${nobleHtml}</div>
                </div>
            </div>
            <div class="ec-scroll">
                <div class="ec-row" id="${cardId}-viz">
                    ${vizHtml}
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}
// ========== [請替換 updateIonViz 並新增 toggleConfigMode] ==========
// [修改] 更新離子視覺化 (加入按鈕發亮邏輯)
function updateIonViz(symbol, baseConfig, charge) {
    // 1. 計算離子組態
    const newConfig = calculateIonConfig(baseConfig, charge);
    
    // 2. 取得模式與儲存電荷
    const modeInput = document.getElementById(`card-${symbol}-mode`);
    const currentMode = modeInput ? modeInput.value : 'noble';
    const chargeInput = document.getElementById(`card-${symbol}-charge`);
    if(chargeInput) chargeInput.value = charge;

    // 3. 【關鍵】切換按鈕狀態 (這裡只改 Class，不涉及複雜運算)
    const btnGroup = document.getElementById(`ion-group-${symbol}`);
    if (btnGroup) {
        // 使用最傳統的 for 迴圈，效能最好
        const btns = btnGroup.getElementsByClassName('ion-btn');
        for (let i = 0; i < btns.length; i++) {
            let btn = btns[i];
            let btnCharge = parseInt(btn.getAttribute('data-charge'));
            if (btnCharge === charge) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }
    }

    // 4. 更新文字顯示
    let displayHtml = (currentMode === 'noble') ? formatConfigHtml(toNobleNotation(newConfig)) : formatConfigHtml(newConfig);
    const textEl = document.getElementById(`card-${symbol}-text`);
    const color = charge > 0 ? '#f87171' : (charge < 0 ? '#60a5fa' : '#a5f3fc');
    if(textEl) textEl.innerHTML = `<div class="ec-config" style="color:${color}">${displayHtml}</div>`;
    
    // 5. 更新軌域圖
    const vizEl = document.getElementById(`card-${symbol}-viz`);
    if(vizEl) vizEl.innerHTML = generateEcViz(newConfig);
}

// 切換顯示模式 (縮寫 <-> 完整)
function toggleConfigMode(symbol, baseConfig) {
    const modeInput = document.getElementById(`card-${symbol}-mode`);
    const btn = document.getElementById(`card-${symbol}-mode-btn`);
    const chargeInput = document.getElementById(`card-${symbol}-charge`);
    
    if (modeInput && btn && chargeInput) {
        // 切換狀態
        if (modeInput.value === 'noble') {
            modeInput.value = 'full';
            btn.textContent = "模式: 完整";
            btn.style.color = "#fff";
        } else {
            modeInput.value = 'noble';
            btn.textContent = "模式: 縮寫";
            btn.style.color = "#aaa";
        }
        
        // 讀取當前電荷，重新刷新顯示
        const currentCharge = parseInt(chargeInput.value);
        updateIonViz(symbol, baseConfig, currentCharge);
    }
}

// 輔助：HTML 格式化 (將 [Ar] 變色，將數字變上標)
function formatConfigHtml(str) {
    return str.replace(/(\[.*?\])/g, '<span class="noble">$1</span>')
              .replace(/([spdf])(\d+)/g, '$1<sup>$2</sup>');
}

function openConfigModal() { const modal = document.getElementById('config-modal'); if(modal) { modal.style.display = 'flex'; renderConfigList(); } }
function closeConfigModal() { const modal = document.getElementById('config-modal'); if(modal) modal.style.display = 'none'; }


function checkAtomClick(screenX, screenY) {
    if (!currentMolecule || !currentMolecule.renderObjects) return;
    const bestMatch = findAtomByScreenPos(screenX, screenY);
    
    if (bestMatch) {
        if (isFaceBuildMode) {
            const idx = bestMatch.originalIndex;
            const selectPos = faceSelection.indexOf(idx);
            
            if (selectPos > -1) {
                // --- 再次點擊：取消選取 ---
                faceSelection.splice(selectPos, 1);
                bestMatch.isHighlighted = false;
            } else {
                // --- 正常選取：加入清單 ---
                faceSelection.push(idx);
                bestMatch.isHighlighted = "center"; 
                
                if (faceSelection.length === 3) {
                    customFaces.push([...faceSelection, currentFaceColor]);
                    faceSelection = [];
                    currentMolecule.renderObjects.forEach(o => o.isHighlighted = false);
                }
            }
            renderScene();
            return; 
        }

        // --- 以下為原本的混成軌域/離子判定邏輯 ---
        if (currentMolecule.isIonic) {
            if (bestMatch.isRepresentative) {
                if (bestMatch.isHighlighted === "center") clearHighlights();
                else highlightNeighbors(bestMatch);
            } else {
                clearHighlights();
            }
        } else {
            showHybridInfo(bestMatch, screenX, screenY);
        }
    } else {
        hideHybridTooltip();
        if (currentMolecule && currentMolecule.isIonic) clearHighlights();
    }
}

function highlightNeighbors(centerAtom) {
    currentMolecule.renderObjects.forEach(obj => obj.isHighlighted = false);
    centerAtom.isHighlighted = "center"; 
    let count = 0;
    const centerIdx = centerAtom.originalIndex;
    if (currentMolecule.bonds3D) {
        currentMolecule.bonds3D.forEach(bond => {
            let nIdx = -1;
            if (bond[0] === centerIdx) nIdx = bond[1];
            else if (bond[1] === centerIdx) nIdx = bond[0];
            if (nIdx !== -1) {
                const n = currentMolecule.renderObjects.find(obj => obj.type === 'atom' && obj.originalIndex === nIdx);
                if (n) { n.isHighlighted = "neighbor"; count++; }
            }
        });
    }
    const tooltip = document.getElementById('hybrid-label');
    if(tooltip) {
        tooltip.innerHTML = `<div style="text-align:center;"><span style="color:#facc15; font-weight:bold; font-size:1.2em;">${centerAtom.elem}</span><br>配位數: <span style="color:#fff; font-weight:bold; font-size:1.4em;">${count}</span></div>`;
        tooltip.classList.add('show');
    }
    renderScene();
}

function clearHighlights() {
    if(!currentMolecule) return;
    currentMolecule.renderObjects.forEach(obj => obj.isHighlighted = false);
    renderScene();
}

function toggleFaceBuildMode() {
    isFaceBuildMode = !isFaceBuildMode;
    faceSelection = [];
    const btn = document.getElementById('btn-face-mode');
    if (btn) {
        btn.innerHTML = `點擊三點成面: ${isFaceBuildMode ? 'ON' : 'OFF'}`;
        btn.style.background = isFaceBuildMode ? "rgba(253, 224, 71, 0.25)" : "rgba(0, 0, 0, 0.4)";
        btn.style.boxShadow = isFaceBuildMode ? "0 0 15px rgba(253, 224, 71, 0.4)" : "none";
    }
    if(currentMolecule) currentMolecule.renderObjects.forEach(o => o.isHighlighted = false);
    renderScene();
}

function setFaceColor(color) {
    currentFaceColor = color;
    document.querySelectorAll('.face-color-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-color') === color);
    });
}

function clearCustomFaces() {
    customFaces = [];
    faceSelection = [];
    if(currentMolecule) currentMolecule.renderObjects.forEach(o => o.isHighlighted = false);
    renderScene();
}

// 覆寫載入邏輯：換分子時自動清除平面
if (typeof loadMolecule === 'function' && !window._manualFaceWrapped) {
    const _originalLoad = loadMolecule;
    loadMolecule = function(key, variant) {
        customFaces = [];
        faceSelection = [];
        _originalLoad(key, variant);
    };
    window._manualFaceWrapped = true;
}

function findAtomByScreenPos(screenX, screenY) {
    const atomGroups = document.querySelectorAll("g[data-atom-idx]");
    let candidates = [];
    atomGroups.forEach(g => {
        const idx = parseInt(g.getAttribute("data-atom-idx"));
        const atomData = currentMolecule.renderObjects[idx];
        if (!atomData) return;
        const circle = g.querySelector("circle");
        if (!circle) return;
        const rect = circle.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        const dist = Math.hypot(screenX - cx, screenY - cy);
        if (dist < (rect.width / 2 + 10)) {
            const p = project(atomData);
            candidates.push({ atom: atomData, z: p.z, dist: dist });
        }
    });
    if (candidates.length === 0) return null;
    candidates.sort((a, b) => b.z - a.z);
    return candidates[0].atom;
}

// ========== [請替換 showHybridInfo 函式] ==========
function showHybridInfo(atomObj, x, y) {
    const tooltip = document.getElementById('hybrid-label');
    if(!tooltip) return;

    const atomIdx = atomObj.originalIndex;
    let sigmaCount = 0;
    if (currentMolecule.bonds3D) {
        currentMolecule.bonds3D.forEach(b => {
            if (b[0] === atomIdx || b[1] === atomIdx) {
                sigmaCount++;
            }
        });
    }
    
    const lpCount = atomObj.calculatedLP || 0;
    const sum = sigmaCount + lpCount;
    
    // 計算形式電荷數據
    const props = ELEMENT_PROPS[atomObj.elem];
    const ve = props ? props.ve : "?";
    const dots = (lpCount * 2) + (atomObj.radical ? 1 : 0);
    let bondLines = 0;
    if (currentMolecule.bonds3D) {
        currentMolecule.bonds3D.forEach(b => {
            if (b[0] === atomIdx || b[1] === atomIdx) {
                let type = b[2] || "single";
                if (type.includes("triple")) bondLines += 3;
                else if (type.includes("double")) bondLines += 2;
                else if (type === "coordinate") bondLines += 1; 
                else if (type === "coordinate_triple") bondLines += 3;
                else bondLines += 1;
            }
        });
    }

    const fc = atomObj.formalCharge || 0;
    let fcStr = fc > 0 ? `+${fc}` : `${fc}`;
    let fcColor = fc === 0 ? "#9ca3af" : (fc > 0 ? "#f87171" : "#60a5fa");

    // [修改] 計算過程字串：線 -> 鍵
    const calcStr = `<div style="font-size:0.8em; color:#bbb; margin-top:4px; border-top:1px solid #444; padding-top:2px;">(價${ve} - 點${dots} - 鍵${bondLines})</div>`;

    let contentHtml = `<span style="color:var(--accent-yellow);font-size:1.5em;line-height:1.2;font-weight:bold;">${atomObj.elem}</span>`;
    
    // [修改] 調整顯示順序
    if (sigmaCount >= 2) { 
        let hybrid = "";
        let hybridColor = "#ffffff"; 
        if (sum === 2) { hybrid = "sp"; hybridColor = "var(--accent-yellow)"; } 
        else if (sum === 3) { hybrid = "sp²"; hybridColor = "#a3e635"; } 
        else if (sum === 4) { hybrid = "sp³"; hybridColor = "#fbbf24"; } 
        else if (sum === 5) { hybrid = "sp³d"; hybridColor = "#f472b6"; } 
        else if (sum === 6) { hybrid = "sp³d²"; hybridColor = "#818cf8"; } 
        else { hybrid = "-"; }

        // 1. 顯示混成
        contentHtml += `<div style="margin-top:4px;">混成: <span style="color:${hybridColor};font-size:1.2em">${hybrid}</span></div>`;
        
        // 2. 顯示 Sigma + LP 計算 (移到混成下方)
        contentHtml += `<div style="font-size:0.8em;color:#888;margin-top:2px;margin-bottom:6px;">(&sigma;:${sigmaCount} + LP:${lpCount} = ${sum})</div>`;
        
        // 3. 顯示形式電荷 (文字改為 "形式電荷")
        contentHtml += `<div>形式電荷: <span style="color:${fcColor};font-size:1.2em;font-weight:bold">${fcStr}</span></div>`;
        
        // 4. 顯示形式電荷計算公式 (放在最下方)
        contentHtml += calcStr;
        // =====================================

    } else {  
        contentHtml += `<div style="margin-top:4px;">電荷: <span style="color:${fcColor};font-size:1.4em;font-weight:bold">${fcStr}</span></div>`;
        if(atomObj.elem === 'H') contentHtml += `<div style="font-size:0.8em;color:#888;">(1s)</div>`;
        
        // [修改] 計算過程放在最後
        contentHtml += calcStr;
    }

    tooltip.innerHTML = contentHtml;
    tooltip.classList.add('show');
}

function hideHybridTooltip() {
    const tooltip = document.getElementById('hybrid-label');
    if (tooltip) tooltip.classList.remove('show');
}

function setupMobilePanel() {
    const panel = document.querySelector('.controls-area');
    const handle = document.getElementById('mobile-panel-handle');
    
    if(!handle || !panel || window.innerWidth > 768) return;

    // --- 設定參數 ---
    const getPos = () => {
        const H = window.innerHeight;
        return {
            P98: 0,              // 全開
            P70: H * 0.3,        // 露出 70%
            P35: H * 0.65,       // 露出 35%
            PMIN: H - 45         // 最低 (防消失位)
        };
    };

    let p = getPos();
    let startY = 0, startTransY = p.P35, currentTransY = p.P35, isDragging = false;

    // 初始位置設定在 35%
    panel.style.transform = `translateY(${p.P35}px)`;

    // 滑動邏輯
    handle.addEventListener('touchstart', (e) => {
        isDragging = true;
        startY = e.touches[0].clientY;
        const style = window.getComputedStyle(panel);
        const matrix = new WebKitCSSMatrix(style.transform);
        startTransY = matrix.m42;
        panel.style.transition = 'none';
    }, {passive: true});

    window.addEventListener('touchmove', (e) => {
        if(!isDragging) return;
        let newY = startTransY + (e.touches[0].clientY - startY);
        if (newY < 0) newY *= 0.3; // 頂部阻尼
        panel.style.transform = `translateY(${newY}px)`;
        currentTransY = newY;
    }, {passive: true});

    window.addEventListener('touchend', () => {
        if(!isDragging) return;
        isDragging = false;
        panel.style.transition = 'transform 0.5s cubic-bezier(0.19, 1, 0.22, 1)';
        p = getPos();
        const dists = [
            {v: p.P98, d: Math.abs(currentTransY - p.P98)},
            {v: p.P70, d: Math.abs(currentTransY - p.P70)},
            {v: p.P35, d: Math.abs(currentTransY - p.P35)},
            {v: p.PMIN, d: Math.abs(currentTransY - p.PMIN)}
        ];
        const closest = dists.reduce((a, b) => a.d < b.d ? a : b);
        panel.style.transform = `translateY(${closest.v}px)`;
    });

    // 【修正：點擊橫槓跳轉】
    handle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        p = getPos();
        const style = window.getComputedStyle(panel);
        const matrix = new WebKitCSSMatrix(style.transform);
        const curY = matrix.m42;

        panel.style.transition = 'transform 0.5s cubic-bezier(0.19, 1, 0.22, 1)';
        
        let target;
        // 循環判定：底部 -> 35 -> 70 -> 98 -> 回底部
        if (curY > p.P35 + 50) target = p.P35;
        else if (curY > p.P70 + 50) target = p.P70;
        else if (curY > p.P98 + 50) target = p.P98;
        else target = p.PMIN;

        panel.style.transform = `translateY(${target}px)`;
    });
}


// ===============================================
// 1. 系統備份與初始化 (4K 高清電子雲版)
// ===============================================

if (!window._nativeRenderScene) {
    window._nativeRenderScene = window.renderScene;
    window._nativeLoadMolecule = window.loadMolecule;
}

// Orbital UI/code removed: restore native render/load if present
if (window._nativeRenderScene) window.renderScene = window._nativeRenderScene;
if (window._nativeLoadMolecule) window.loadMolecule = window._nativeLoadMolecule;

// initOrbitalUI removed; no delayed init required

// ==========================================
// [系統修復] 解決軌域重疊問題 & 確保畫面清除
// ==========================================

// Orbital rendering removed; restore native renderer if available
if (window._nativeRenderScene) window.renderScene = window._nativeRenderScene;

</script>
<script>
(function(){
    const TRANSLATIONS = {
        zh: {
            'mode-toggle': '模式: 複合',
            'theme-toggle': '主題: 暗色',
            'card-title-input': '輸入化學式',
            'load-btn': '載入',
            'lbl-lp': '顯示孤對電子',
            'lbl-auto-rotate': '自動旋轉',
            'data-card-title': '物質資料',
            'lbl-formula': '化學式',
            'lbl-name': '中文名稱',
            'lbl-shape': '形狀',
            'lbl-angle': '鍵角',
            'lbl-mp': '熔點 (MP)',
            'lbl-bp': '沸點 (BP)',
            'lbl-bonds': '鍵結統計',
            'lbl-mass': '分子量'
        },
        en: {
            'mode-toggle': 'Mode: Composite',
            'theme-toggle': 'Theme: Dark',
            'card-title-input': 'Input Formula',
            'load-btn': 'Load',
            'lbl-lp': 'Show lone pairs',
            'lbl-auto-rotate': 'Auto-rotate',
            'data-card-title': 'Substance Data',
            'lbl-formula': 'Formula',
            'lbl-name': 'Name',
            'lbl-shape': 'Shape',
            'lbl-angle': 'Bond angle',
            'lbl-mp': 'Melting point',
            'lbl-bp': 'Boiling point',
            'lbl-bonds': 'Bond stats',
            'lbl-mass': 'Molar mass'
        }
    };

    function applyLanguage(lang){
        document.documentElement.lang = (lang === 'en') ? 'en' : 'zh-MO';
        const map = TRANSLATIONS[lang] || {};
        Object.keys(map).forEach(id=>{
            const el = document.getElementById(id);
            if(!el) return;
            if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = map[id];
            } else {
                el.textContent = map[id];
            }
        });
        const langBtn = document.getElementById('lang-toggle');
        if(langBtn) langBtn.textContent = (lang === 'zh' ? 'EN' : '中');
        window.__APP_LANG = lang;
    }

        document.addEventListener('DOMContentLoaded', ()=>{
        const saved = localStorage.getItem('app_lang') || (navigator.language && navigator.language.startsWith('en') ? 'en' : 'zh');
        applyLanguage(saved);
        // If a molecule is already loaded, refresh its displayed labels to match language
        try{ if (window.currentKey) loadMolecule(window.currentKey, window.currentVariantKey); }catch(e){}
        const btn = document.getElementById('lang-toggle');
        if(btn){
            btn.addEventListener('click', ()=>{
                const next = (window.__APP_LANG === 'en' ? 'zh' : 'en');
                applyLanguage(next);
                try{ localStorage.setItem('app_lang', next); }catch(e){}
                try{ if (window.currentKey) loadMolecule(window.currentKey, window.currentVariantKey); }catch(e){}
            });
        }
        window.setAppLang = function(lang){ applyLanguage(lang); try{ if (window.currentKey) loadMolecule(window.currentKey, window.currentVariantKey); }catch(e){} };
    });
})();
</script>
<script>
// Recovery: ensure interactions and molecule rendering initialize even if earlier scripts errored
(function(){
    try{
        if (typeof setupInteractions === 'function') setupInteractions();
    } catch(e) { console.error('setupInteractions recovery failed', e); }
    try{
        if (typeof animate === 'function') { try{ animate(); } catch(e){} }
    } catch(e) {}
    try{
        if (typeof loadMolecule === 'function') {
            if (!window.currentKey) loadMolecule('H2O');
            else loadMolecule(window.currentKey, window.currentVariantKey);
        }
    } catch(e) { console.error('loadMolecule recovery failed', e); }
})();
</script>
</body>
<script>
    // Periodic Table Logic
    (function() {
        const elements = [
            // Period 1
            { num: 1, sym: "H", name: "Hydrogen", mass: "1", col: 8, row: 2, cat: "Non-metal" },
            { num: 2, sym: "He", name: "Helium", mass: "4", col: 18, row: 2, cat: "Noble Gas" },
            // Period 2
            { num: 3, sym: "Li", name: "Lithium", mass: "7", col: 1, row: 3, cat: "Alkali Metal" },
            { num: 4, sym: "Be", name: "Beryllium", mass: "9", col: 2, row: 3, cat: "Alkaline Earth" },
            { num: 5, sym: "B", name: "Boron", mass: "11", col: 13, row: 3, cat: "Metalloid" },
            { num: 6, sym: "C", name: "Carbon", mass: "12", col: 14, row: 3, cat: "Non-metal" },
            { num: 7, sym: "N", name: "Nitrogen", mass: "14", col: 15, row: 3, cat: "Non-metal" },
            { num: 8, sym: "O", name: "Oxygen", mass: "16", col: 16, row: 3, cat: "Non-metal" },
            { num: 9, sym: "F", name: "Fluorine", mass: "19", col: 17, row: 3, cat: "Halogen" },
            { num: 10, sym: "Ne", name: "Neon", mass: "20", col: 18, row: 3, cat: "Noble Gas" },
            // Period 3
            { num: 11, sym: "Na", name: "Sodium", mass: "23", col: 1, row: 4, cat: "Alkali Metal" },
            { num: 12, sym: "Mg", name: "Magnesium", mass: "24", col: 2, row: 4, cat: "Alkaline Earth" },
            { num: 13, sym: "Al", name: "Aluminium", mass: "27", col: 13, row: 4, cat: "Post-transition" },
            { num: 14, sym: "Si", name: "Silicon", mass: "28", col: 14, row: 4, cat: "Metalloid" },
            { num: 15, sym: "P", name: "Phosphorus", mass: "31", col: 15, row: 4, cat: "Non-metal" },
            { num: 16, sym: "S", name: "Sulfur", mass: "32", col: 16, row: 4, cat: "Non-metal" },
            { num: 17, sym: "Cl", name: "Chlorine", mass: "35.5", col: 17, row: 4, cat: "Halogen" },
            { num: 18, sym: "Ar", name: "Argon", mass: "40", col: 18, row: 4, cat: "Noble Gas" },
            // Period 4
            { num: 19, sym: "K", name: "Potassium", mass: "39", col: 1, row: 5, cat: "Alkali Metal" },
            { num: 20, sym: "Ca", name: "Calcium", mass: "40", col: 2, row: 5, cat: "Alkaline Earth" },
            { num: 21, sym: "Sc", name: "Scandium", mass: "45", col: 3, row: 5, cat: "Transition Metal" },
            { num: 22, sym: "Ti", name: "Titanium", mass: "48", col: 4, row: 5, cat: "Transition Metal" },
            { num: 23, sym: "V", name: "Vanadium", mass: "51", col: 5, row: 5, cat: "Transition Metal" },
            { num: 24, sym: "Cr", name: "Chromium", mass: "52", col: 6, row: 5, cat: "Transition Metal" },
            { num: 25, sym: "Mn", name: "Manganese", mass: "55", col: 7, row: 5, cat: "Transition Metal" },
            { num: 26, sym: "Fe", name: "Iron", mass: "56", col: 8, row: 5, cat: "Transition Metal" },
            { num: 27, sym: "Co", name: "Cobalt", mass: "59", col: 9, row: 5, cat: "Transition Metal" },
            { num: 28, sym: "Ni", name: "Nickel", mass: "59", col: 10, row: 5, cat: "Transition Metal" },
            { num: 29, sym: "Cu", name: "Copper", mass: "63.5", col: 11, row: 5, cat: "Transition Metal" },
            { num: 30, sym: "Zn", name: "Zinc", mass: "65", col: 12, row: 5, cat: "Transition Metal" },
            { num: 31, sym: "Ga", name: "Gallium", mass: "70", col: 13, row: 5, cat: "Post-transition" },
            { num: 32, sym: "Ge", name: "Germanium", mass: "73", col: 14, row: 5, cat: "Metalloid" },
            { num: 33, sym: "As", name: "Arsenic", mass: "75", col: 15, row: 5, cat: "Metalloid" },
            { num: 34, sym: "Se", name: "Selenium", mass: "79", col: 16, row: 5, cat: "Non-metal" },
            { num: 35, sym: "Br", name: "Bromine", mass: "80", col: 17, row: 5, cat: "Halogen" },
            { num: 36, sym: "Kr", name: "Krypton", mass: "84", col: 18, row: 5, cat: "Noble Gas" },
            // Period 5
            { num: 37, sym: "Rb", name: "Rubidium", mass: "85", col: 1, row: 6, cat: "Alkali Metal" },
            { num: 38, sym: "Sr", name: "Strontium", mass: "88", col: 2, row: 6, cat: "Alkaline Earth" },
            { num: 39, sym: "Y", name: "Yttrium", mass: "89", col: 3, row: 6, cat: "Transition Metal" },
            { num: 40, sym: "Zr", name: "Zirconium", mass: "91", col: 4, row: 6, cat: "Transition Metal" },
            { num: 41, sym: "Nb", name: "Niobium", mass: "93", col: 5, row: 6, cat: "Transition Metal" },
            { num: 42, sym: "Mo", name: "Molybdenum", mass: "96", col: 6, row: 6, cat: "Transition Metal" },
            { num: 43, sym: "Tc", name: "Technetium", mass: "[98]", col: 7, row: 6, cat: "Transition Metal" },
            { num: 44, sym: "Ru", name: "Ruthenium", mass: "101", col: 8, row: 6, cat: "Transition Metal" },
            { num: 45, sym: "Rh", name: "Rhodium", mass: "103", col: 9, row: 6, cat: "Transition Metal" },
            { num: 46, sym: "Pd", name: "Palladium", mass: "106", col: 10, row: 6, cat: "Transition Metal" },
            { num: 47, sym: "Ag", name: "Silver", mass: "108", col: 11, row: 6, cat: "Transition Metal" },
            { num: 48, sym: "Cd", name: "Cadmium", mass: "112", col: 12, row: 6, cat: "Transition Metal" },
            { num: 49, sym: "In", name: "Indium", mass: "115", col: 13, row: 6, cat: "Post-transition" },
            { num: 50, sym: "Sn", name: "Tin", mass: "119", col: 14, row: 6, cat: "Post-transition" },
            { num: 51, sym: "Sb", name: "Antimony", mass: "122", col: 15, row: 6, cat: "Metalloid" },
            { num: 52, sym: "Te", name: "Tellurium", mass: "128", col: 16, row: 6, cat: "Metalloid" },
            { num: 53, sym: "I", name: "Iodine", mass: "127", col: 17, row: 6, cat: "Halogen" },
            { num: 54, sym: "Xe", name: "Xenon", mass: "131", col: 18, row: 6, cat: "Noble Gas" },
            // Period 6
                { num: 55, sym: "Cs", name: "Caesium", mass: "133", col: 1, row: 7, cat: "Alkali Metal" },
                    { num: 56, sym: "Ba", name: "Barium", mass: "137", col: 2, row: 7, cat: "Alkaline Earth" },
                // Lanthanide series (moved to f-block rows) — category stored here
                { num: 57, sym: "La", name: "Lanthanum", mass: "139", col: 3, row: 9, cat: "Lanthanide" },
                { num: 58, sym: "Ce", name: "Cerium", mass: "140", col: 4, row: 9, cat: "Lanthanide" },
                { num: 59, sym: "Pr", name: "Praseodymium", mass: "141", col: 5, row: 9, cat: "Lanthanide" },
                { num: 60, sym: "Nd", name: "Neodymium", mass: "144", col: 6, row: 9, cat: "Lanthanide" },
                { num: 61, sym: "Pm", name: "Promethium", mass: "145", col: 7, row: 9, cat: "Lanthanide" },
                { num: 62, sym: "Sm", name: "Samarium", mass: "150", col: 8, row: 9, cat: "Lanthanide" },
                { num: 63, sym: "Eu", name: "Europium", mass: "152", col: 9, row: 9, cat: "Lanthanide" },
                { num: 64, sym: "Gd", name: "Gadolinium", mass: "157", col: 10, row: 9, cat: "Lanthanide" },
                { num: 65, sym: "Tb", name: "Terbium", mass: "159", col: 11, row: 9, cat: "Lanthanide" },
                { num: 66, sym: "Dy", name: "Dysprosium", mass: "162", col: 12, row: 9, cat: "Lanthanide" },
                { num: 67, sym: "Ho", name: "Holmium", mass: "165", col: 13, row: 9, cat: "Lanthanide" },
                { num: 68, sym: "Er", name: "Erbium", mass: "167", col: 14, row: 9, cat: "Lanthanide" },
                { num: 69, sym: "Tm", name: "Thulium", mass: "169", col: 15, row: 9, cat: "Lanthanide" },
                { num: 70, sym: "Yb", name: "Ytterbium", mass: "173", col: 16, row: 9, cat: "Lanthanide" },
                { num: 71, sym: "Lu", name: "Lutetium", mass: "175", col: 17, row: 9, cat: "Lanthanide" },
                { num: 72, sym: "Hf", name: "Hafnium", mass: "178", col: 4, row: 7, cat: "Transition Metal" },
            { num: 73, sym: "Ta", name: "Tantalum", mass: "181", col: 5, row: 7, cat: "Transition Metal" },
            { num: 74, sym: "W", name: "Tungsten", mass: "184", col: 6, row: 7, cat: "Transition Metal" },
            { num: 75, sym: "Re", name: "Rhenium", mass: "186", col: 7, row: 7, cat: "Transition Metal" },
            { num: 76, sym: "Os", name: "Osmium", mass: "190", col: 8, row: 7, cat: "Transition Metal" },
            { num: 77, sym: "Ir", name: "Iridium", mass: "192", col: 9, row: 7, cat: "Transition Metal" },
            { num: 78, sym: "Pt", name: "Platinum", mass: "195", col: 10, row: 7, cat: "Transition Metal" },
            { num: 79, sym: "Au", name: "Gold", mass: "197", col: 11, row: 7, cat: "Transition Metal" },
            { num: 80, sym: "Hg", name: "Mercury", mass: "201", col: 12, row: 7, cat: "Transition Metal" },
            { num: 81, sym: "Tl", name: "Thallium", mass: "204", col: 13, row: 7, cat: "Post-transition" },
            { num: 82, sym: "Pb", name: "Lead", mass: "207", col: 14, row: 7, cat: "Post-transition" },
            { num: 83, sym: "Bi", name: "Bismuth", mass: "209", col: 15, row: 7, cat: "Post-transition" },
            { num: 84, sym: "Po", name: "Polonium", mass: "[209]", col: 16, row: 7, cat: "Metalloid" },
            { num: 85, sym: "At", name: "Astatine", mass: "[210]", col: 17, row: 7, cat: "Halogen" },
            { num: 86, sym: "Rn", name: "Radon", mass: "[222]", col: 18, row: 7, cat: "Noble Gas" },
            // Period 7
            { num: 87, sym: "Fr", name: "Francium", mass: "[223]", col: 1, row: 8, cat: "Alkali Metal" },
            { num: 88, sym: "Ra", name: "Radium", mass: "[226]", col: 2, row: 8, cat: "Alkaline Earth" },
            // Actinide series (category stored in `elements`)
            { num: 89, sym: "Ac", name: "Actinium", mass: "[227]", col: 3, row: 10, cat: "Actinide" },
            { num: 90, sym: "Th", name: "Thorium", mass: "232", col: 4, row: 10, cat: "Actinide" },
            { num: 91, sym: "Pa", name: "Protactinium", mass: "231", col: 5, row: 10, cat: "Actinide" },
            { num: 92, sym: "U", name: "Uranium", mass: "238", col: 6, row: 10, cat: "Actinide" },
            { num: 93, sym: "Np", name: "Neptunium", mass: "237", col: 7, row: 10, cat: "Actinide" },
            { num: 94, sym: "Pu", name: "Plutonium", mass: "244", col: 8, row: 10, cat: "Actinide" },
            { num: 95, sym: "Am", name: "Americium", mass: "243", col: 9, row: 10, cat: "Actinide" },
            { num: 96, sym: "Cm", name: "Curium", mass: "247", col: 10, row: 10, cat: "Actinide" },
            { num: 97, sym: "Bk", name: "Berkelium", mass: "247", col: 11, row: 10, cat: "Actinide" },
            { num: 98, sym: "Cf", name: "Californium", mass: "251", col: 12, row: 10, cat: "Actinide" },
            { num: 99, sym: "Es", name: "Einsteinium", mass: "252", col: 13, row: 10, cat: "Actinide" },
            { num: 100, sym: "Fm", name: "Fermium", mass: "257", col: 14, row: 10, cat: "Actinide" },
            { num: 101, sym: "Md", name: "Mendelevium", mass: "258", col: 15, row: 10, cat: "Actinide" },
            { num: 102, sym: "No", name: "Nobelium", mass: "259", col: 16, row: 10, cat: "Actinide" },
            { num: 103, sym: "Lr", name: "Lawrencium", mass: "262", col: 17, row: 10, cat: "Actinide" },
            { num: 104, sym: "Rf", name: "Ruther.", mass: "[261]", col: 4, row: 8, cat: "Transition Metal" },
            { num: 105, sym: "Db", name: "Dubnium", mass: "[262]", col: 5, row: 8, cat: "Transition Metal" },
            { num: 106, sym: "Sg", name: "Seaborg.", mass: "[266]", col: 6, row: 8, cat: "Transition Metal" },
            { num: 107, sym: "Bh", name: "Bohrium", mass: "[264]", col: 7, row: 8, cat: "Transition Metal" },
            { num: 108, sym: "Hs", name: "Hassium", mass: "[277]", col: 8, row: 8, cat: "Transition Metal" },
            { num: 109, sym: "Mt", name: "Meitner.", mass: "[268]", col: 9, row: 8, cat: "Unknown" },
            { num: 110, sym: "Ds", name: "Darmst.", mass: "[271]", col: 10, row: 8, cat: "Unknown" },
            { num: 111, sym: "Rg", name: "Roent.", mass: "[272]", col: 11, row: 8, cat: "Unknown" },
        ];

        const container = document.getElementById('table-container');
        if (!container) return;

        // Headers
        const headers = [
            { txt: '1', col: 1 }, { txt: '2', col: 2 },
            { txt: '3', col: 13 }, { txt: '4', col: 14 }, { txt: '5', col: 15 },
            { txt: '6', col: 16 }, { txt: '7', col: 17 }, { txt: '0', col: 18 }
        ];

        headers.forEach(h => {
            const div = document.createElement('div');
            div.className = 'col-header';
            div.innerText = h.txt;
            div.style.gridColumnStart = h.col + 1;
            div.style.gridRowStart = 1; 
            container.appendChild(div);
        });

        // Period Headers (1-7)
        for (let i = 1; i <= 7; i++) {
            const div = document.createElement('div');
            div.className = 'period-header';
            div.innerText = i;
            div.style.gridColumnStart = 1;
            div.style.gridRowStart = i + 1; // Row 1 is group headers
            container.appendChild(div);
        }

        // Generate Element Boxes
        elements.forEach(el => {
            const div = document.createElement('div');
            div.className = 'element';
            
            // Determine Block
            let block = '';
            if (el.sym === 'H' || el.sym === 'He') {
                block = 's-block';
            } else if (el.cat === 'Lanthanide' || el.cat === 'Actinide') {
                block = 'f-block';
            } else if (el.col >= 1 && el.col <= 2) {
                block = 's-block';
            } else if (el.col >= 13 && el.col <= 18) {
                block = 'p-block';
            } else if (el.col >= 3 && el.col <= 12) {
                block = 'd-block';
            } else {
                block = 'Unknown';
            }

            // Add a CSS marker class for f-block elements so we can shift them via CSS
            if (block === 'f-block') div.classList.add('f-block');

            // Determine Color based on Category
            let bgColor = '#f9f9f9';
            const catColors = {
                "Alkali Metal": "#EF9A9A",      // More Red (Red 200)
                "Alkaline Earth": "#FFCC80",    // Lighter Orange
                "Transition Metal": "#FFF59D",  // Lighter Yellow
                "Post-transition": "#B9F6CA",   // Lighter Green
                "Metalloid": "#B3E5FC",         // Lighter Sky Blue
                "Halogen": "#F8BBD0",           // Further Lighter Pink
                "Noble Gas": "#D1C4E9",         // Lighter Purple
                "Lanthanide": "#80DEEA",        // Lighter Cyan
                "Actinide": "#82B1FF",          // Lighter Royal Blue
                "Non-metal": "#90CAF9",         // Lighter Medium Blue
                "Unknown": "#EEEEEE"            // Lighter Grey
            };
            
            if (el.sym === 'H') {
                bgColor = '#E0E0E0'; // Deeper Grey for Hydrogen
            } else if (catColors[el.cat]) {
                bgColor = catColors[el.cat];
            }

            // Store block in element object for modal
            el.block = block;
            el.bgColor = bgColor;

            // Grid Placement
            div.style.gridColumnStart = el.col + 1;
            div.style.gridRowStart = el.row;
            
            // Apply background color
            div.style.backgroundColor = bgColor;

            // HTML Content
            div.innerHTML = `
                <span class="at-mass">${el.mass}</span>
                <span class="symbol">${el.sym}</span>
                <span class="name">${el.name}</span>
                <span class="at-num">${el.num}</span>
            `;

            // Click Event
            div.addEventListener('click', () => openModal(el));

            container.appendChild(div);
        });

        // f-block elements (lanthanides & actinides) are included in `elements` array
        // and will be rendered by the main loop above. No extra appending needed here.

        // Modal Logic
        const modal = document.getElementById('modal');

        function generateOrbitalDiagram(configStr) {
            if (!configStr) return '';
            // Parse config: "1s2 2s2 2p6" -> [{n:1, type:'s', count:2}, ...]
            const parts = configStr.split(' ');
            let html = '<div class="orbital-diagram">';
            
            parts.forEach(part => {
                const match = part.match(/(\d+)([spdf])(\d+)/);
                if (!match) return;
                const n = match[1];
                const type = match[2];
                const count = parseInt(match[3]);
                
                let boxes = 1;
                if (type === 'p') boxes = 3;
                else if (type === 'd') boxes = 5;
                else if (type === 'f') boxes = 7;
                
                // Distribute electrons
                const electrons = new Array(boxes).fill(0);
                for (let i = 0; i < count; i++) {
                    electrons[i % boxes]++;
                }
                
                html += `<div class="orb-group"><div class="orb-boxes">`;
                electrons.forEach(e => {
                    let arrow = '';
                    if (e === 1) arrow = '↿';
                    else if (e === 2) arrow = '↿⇂';
                    html += `<div class="orb-box">${arrow}</div>`;
                });
                html += `</div><div class="orb-label">${n}${type}</div></div>`;
            });
            
            html += '</div>';
            return html;
        }

        function openModal(el) {
            // Find detailed data
            const eData = (typeof ELECTRON_DATA !== 'undefined') ? ELECTRON_DATA.find(e => e.s === el.sym) : null;
            
            const cnName = eData ? eData.cn : '';
            const atomicNum = el.num;
            const mass = el.mass;
            const category = el.cat; 
            
            const stateMap = { "氣體": "Gas", "液體": "Liquid", "固體": "Solid", "未知": "Unknown" };
            const rawState = eData ? eData.state : 'Unknown';
            const state = stateMap[rawState] || rawState;
            
            const mp = eData ? eData.mp : '-';
            const bp = eData ? eData.bp : '-';
            // f-block elements are visually placed on extra rows; presentationally
            // lanthanides belong to period 6 and actinides to period 7.
            let period;
            if (el.cat === 'Lanthanide') period = 6;
            else if (el.cat === 'Actinide') period = 7;
            else period = el.row - 1;
            const group = eData ? (eData.iupac || eData.g) : (el.col > 1 ? el.col - 1 : '-'); // Adjust for period column if using grid col
            const block = el.block;
            
            const rawConfig = eData ? eData.c : '-';
            // Superscript numbers in config
            const config = rawConfig.replace(/(\d+)([spdf])(\d+)/g, '$1$2<sup>$3</sup>');
            
            const boxNotation = generateOrbitalDiagram(rawConfig);

            // Set card background color
            const card = document.querySelector('.viewport-panel[data-tool="Elements"] .info-card');
            if (card) {
                if (el.bgColor) {
                    let hex = el.bgColor.replace('#', '');
                    let r = parseInt(hex.substring(0, 2), 16);
                    let g = parseInt(hex.substring(2, 4), 16);
                    let b = parseInt(hex.substring(4, 6), 16);
                    r = Math.round(r + (255 - r) * 0.7);
                    g = Math.round(g + (255 - g) * 0.7);
                    b = Math.round(b + (255 - b) * 0.7);
                    card.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                } else {
                    card.style.backgroundColor = 'white';
                }

                let displaySym = el.sym;
                if(el.sym.includes('*')) {
                    displaySym = el.sym.replace('*', '');
                }

                // Rebuild Content
                card.innerHTML = `
                    <span class="close-btn" onclick="closeModal()">&times;</span>
                    <div class="card-header">
                        <h2>${el.name} <span class="cn-name">${cnName}</span></h2>
                    </div>
                    <div class="card-symbol">${displaySym}</div>
                    
                    <div class="card-details-grid">
                        <div class="detail-col">
                            <div class="detail-row"><strong>Atomic No.</strong> <span class="detail-val">${atomicNum}</span></div>
                            <div class="detail-row"><strong>Relative Atomic Mass</strong> <span class="detail-val">${mass}</span></div>
                            <div class="detail-row"><strong>Category</strong> <span class="detail-val">${category}</span></div>
                            <div class="detail-row"><strong>rtp State</strong> <span class="detail-val">${state}</span></div>
                        </div>
                        <div class="detail-col">
                            <div class="detail-row"><strong>Melting Point</strong> <span class="detail-val">${mp}</span></div>
                            <div class="detail-row"><strong>Boiling Point</strong> <span class="detail-val">${bp}</span></div>
                            <div class="detail-row"><strong>Period</strong> <span class="detail-val">${period}</span></div>
                            <div class="detail-row"><strong>Group</strong> <span class="detail-val">${group}</span></div>
                            <div class="detail-row"><strong>Block</strong> <span class="detail-val">${block}</span></div>
                        </div>
                    </div>
                    
                    <div class="detail-row" style="margin-top: 10px;"><strong>Electronic Configuration</strong> <span class="detail-val">${config}</span></div>
                    <div class="detail-row" style="flex-direction:column; align-items:center; border-bottom:none;">
                        <strong style="margin-bottom:5px; align-self: flex-start;">Electronic Configuration (Box Notation)</strong>
                        ${boxNotation}
                    </div>
                `;
            }
            modal.style.display = 'flex';
        }

        window.closeModal = function() {
            modal.style.display = 'none';
        }

        // Close when clicking outside card
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // Auto-scale logic for Periodic Table
        function resizePeriodicTable() {
            const table = document.getElementById('table-container');
            const container = document.querySelector('.viewport-panel[data-tool="Elements"] .elements-container');
            if (!table || !container) return;

            // Reset transform to get natural size
            table.style.transform = 'none';
            
            const availableWidth = container.clientWidth;
            // Use full height for calculation, subtract a small margin
            const availableHeight = container.clientHeight - 20; 
            
            // Natural size of the table (approx 18 * 65 + gaps ~ 1250px width)
            // We can measure it directly
            const tableWidth = table.scrollWidth;
            const tableHeight = table.scrollHeight;

            if (tableWidth === 0 || tableHeight === 0) return;

            const scaleX = (availableWidth - 2) / tableWidth; // Minimal horizontal margin
            const scaleY = (availableHeight - 2) / tableHeight; // Minimal vertical margin
            
            // Allow larger enlargement (5.0x) for larger screens
            // Multiply by 0.9 to make it slightly smaller as requested
            let scale = Math.min(scaleX, scaleY, 5.0) * 0.9;
            
            // Apply scale
            // Use translate(-50%, -50%) to center it perfectly if we use absolute positioning + left 50% + top 50%
            // But here we use flexbox centering, so we just need scale.
            // However, transform-origin: center center is key.
            // Add translateY to move it downward slightly (e.g. 5% of height or fixed pixels)
            // Since we are scaling, using pixels might be safer relative to screen.
            // But transform applies after layout.
            // Let's just use margin-top in CSS for the downward movement, and keep transform for scaling.
            table.style.transform = `scale(${scale})`;
            
            // Force re-centering if flexbox isn't enough (sometimes scale affects layout flow)
            // But with flexbox + transform-origin: center, it should be fine.
        }

        // Listen for resize and tool switch
        window.addEventListener('resize', resizePeriodicTable);
        
        // Hook into tool switch to trigger resize when Elements becomes visible
        const originalSwitchTool = window.switchTool; // If exposed, otherwise we use observer
        
        // Use MutationObserver to detect when Elements panel becomes active
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.classList.contains('active') && 
                    mutation.target.getAttribute('data-tool') === 'Elements') {
                    // Wait a tick for layout
                    setTimeout(resizePeriodicTable, 50);
                }
            });
        });
        
        const elementsPanel = document.querySelector('.viewport-panel[data-tool="Elements"]');
        if (elementsPanel) {
            observer.observe(elementsPanel, { attributes: true, attributeFilter: ['class', 'style'] });
        }
        
        // Initial call
        setTimeout(resizePeriodicTable, 100);

    })();
</script>

<script>
/* Equation Balancer Logic */
(function() {
    const input = document.getElementById('eq-input');
    const btn = document.getElementById('btn-balance');
    const errorDiv = document.getElementById('eq-error');
    const resultDiv = document.getElementById('eq-result');
    const typeDiv = document.getElementById('eq-type');

    if(btn) {
        btn.addEventListener('click', handleBalance);
    }
    if(input) {
        input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') handleBalance();
        });
    }

    // Helper functions for Organic Prediction
    const isHalogenoalkane = (f) => {
        if (!f.includes('C') || !f.includes('H')) return false;
        return /(Cl|Br|I)/.test(f);
    };

    const getHalogen = (f) => {
        const m = f.match(/(Cl|Br|I)/);
        return m ? m[0] : null;
    };

    const generateSubstitution = (haloalkane, nucleophile) => {
        const X = getHalogen(haloalkane);
        if (!X) return null;
        
        // Simple string replacement for the halogen
        // Note: This assumes mono-substituted for simplicity or replaces first occurrence
        let product = haloalkane.replace(X, '');
        let byproduct = '';
        
        if (nucleophile === 'OH') {
            product += 'OH';
            byproduct = X + '-';
            return `${haloalkane} + OH- = ${product} + ${byproduct}`;
        } else if (nucleophile === 'CN') {
            product += 'CN';
            byproduct = X + '-';
            return `${haloalkane} + CN- = ${product} + ${byproduct}`;
        } else if (nucleophile === 'NH3') {
            product += 'NH2';
            byproduct = 'NH4' + X; 
            return `${haloalkane} + NH3 = ${product} + ${byproduct}`;
        }
        return null;
    };

    const generateElimination = (haloalkane) => {
        // Try to parse CnHmX
        const match = haloalkane.match(/^C(\d+)H(\d+)(Cl|Br|I)$/);
        if (match) {
            const n = parseInt(match[1]);
            const h = parseInt(match[2]);
            const X = match[3];
            // Alkene is CnH(h-1)
            const alkene = `C${n}H${h-1}`;
            return `${haloalkane} + OH- = ${alkene} + H2O + ${X}-`;
        }
        
        // Handle structural formats like CH3CH2Cl
        if (haloalkane === 'CH3CH2Cl') return `CH3CH2Cl + OH- = CH2=CH2 + H2O + Cl-`;
        if (haloalkane === 'CH3CH2Br') return `CH3CH2Br + OH- = CH2=CH2 + H2O + Br-`;
        if (haloalkane === 'CH3CH2I') return `CH3CH2I + OH- = CH2=CH2 + H2O + I-`;
        
        // Fallback for unparsed but valid looking
        if (haloalkane.endsWith('Cl') || haloalkane.endsWith('Br') || haloalkane.endsWith('I')) {
             // Try to guess alkene by removing HX?
             // Without strict parsing, this is hard. Return null to avoid bad guesses.
             return null;
        }
        return null;
    };

    function predictProducts(eq) {
        const parts = eq.split('+').map(s => s.trim());
        const haloalkane = parts.find(isHalogenoalkane);
        
        if (!haloalkane) return [];
        
        const results = [];
        
        // Check for OH- (or NaOH/KOH)
        if (parts.some(p => p === 'OH-' || p === 'NaOH' || p === 'KOH')) {
            // 1. Substitution (aq)
            const subEq = generateSubstitution(haloalkane, 'OH');
            if (subEq) results.push({ equation: subEq, type: 'substitution_aq', desc: 'Nucleophilic Substitution (aq)' });
            
            // 2. Elimination (eth)
            const elimEq = generateElimination(haloalkane);
            if (elimEq) results.push({ equation: elimEq, type: 'elimination_eth', desc: 'Elimination (eth)' });
        }
        
        // Check for CN-
        if (parts.some(p => p === 'CN-' || p === 'KCN' || p === 'NaCN')) {
            const subEq = generateSubstitution(haloalkane, 'CN');
            if (subEq) results.push({ equation: subEq, type: 'substitution_eth', desc: 'Nucleophilic Substitution (eth)' });
        }
        
        // Check for NH3
        if (parts.some(p => p === 'NH3')) {
            const subEq = generateSubstitution(haloalkane, 'NH3');
            if (subEq) results.push({ equation: subEq, type: 'substitution_eth', desc: 'Nucleophilic Substitution (eth)' });
        }
        
        return results;
    }

    function handleBalance() {
        const eq = input.value.trim();
        errorDiv.textContent = '';
        resultDiv.innerHTML = '';
        typeDiv.textContent = '';
        
        if(!eq) return;

        try {
            let resultsToRender = [];
            
            if (!eq.includes('=')) {
                // Try prediction
                const predictions = predictProducts(eq);
                if (predictions.length > 0) {
                    predictions.forEach(pred => {
                        const res = balanceEquation(pred.equation);
                        resultsToRender.push({ result: res, type: pred.type, desc: pred.desc });
                    });
                } else {
                    // Fallback to normal balance (will likely fail or throw)
                    const res = balanceEquation(eq);
                    resultsToRender.push({ result: res, type: null, desc: null });
                }
            } else {
                const res = balanceEquation(eq);
                resultsToRender.push({ result: res, type: null, desc: null });
            }

            // Render all results
            resultsToRender.forEach((item, index) => {
                if (index > 0) {
                    const sep = document.createElement('div');
                    sep.style.borderTop = '1px dashed rgba(255,255,255,0.2)';
                    sep.style.margin = '20px 0';
                    resultDiv.appendChild(sep);
                }
                
                const container = document.createElement('div');
                // Create a temporary div to render into, then move children
                const tempDiv = document.createElement('div');
                
                // We need to modify renderResult to target a specific element or return HTML
                // Since renderResult writes to resultDiv directly, we need to patch this.
                // Let's temporarily swap resultDiv
                const originalResultDiv = resultDiv;
                
                // Hack: We can't easily change renderResult's target without changing its signature everywhere.
                // But we just changed it to accept type.
                // Let's assume renderResult appends to resultDiv.
                // Wait, renderResult does `resultDiv.innerHTML = ...`. This overwrites.
                
                // I need to change renderResult to return the HTML string instead of setting innerHTML.
                // OR, I can set resultDiv.innerHTML for the LAST one, but that overwrites previous ones.
                
                // Let's modify renderResult to return the HTML string.
                // I will do another edit to renderResult to return string.
            });
            
            // Re-implementing the loop after I fix renderResult
             resultsToRender.forEach((item, index) => {
                if (index > 0) {
                    resultDiv.innerHTML += `<div style="border-top: 1px dashed rgba(255,255,255,0.2); margin: 20px 0;"></div>`;
                }
                
                if (item.desc) {
                    resultDiv.innerHTML += `<div style="color: var(--accent-yellow); font-size: 0.9rem; margin-bottom: 5px;">${item.desc}</div>`;
                }
                
                // Call renderResult which now (will) return string or append?
                // I'll change renderResult to return string.
                const html = renderResult(item.result, item.type); 
                resultDiv.innerHTML += html;
                
                if (!item.type) {
                     const type = identifyReactionType(item.result.left, item.result.right);
                     if(type) {
                        resultDiv.innerHTML += `<div style="margin-top:25px; font-size:1.1rem; color:var(--accent-yellow); font-family:'Noto Serif TC', serif;"><span style="font-weight:bold;">Reaction Type:</span> ${type}</div>`;
                     }
                }
            });

        } catch (e) {
            errorDiv.textContent = e.message || "Could not balance equation.";
        }
    }

    function identifyReactionType(leftParts, rightParts) {
        const left = leftParts.map(p => p.formula);
        const right = rightParts.map(p => p.formula);
        const types = [];
        
        // Helper: Check if formula is exactly an element (e.g. O2, Fe, Cl2)
        const isElement = (f) => /^[A-Z][a-z]?\d*$/.test(f);
        // Helper: Check if organic (contains C and H, OR C and Halogens for fully substituted)
        const isOrganic = (f) => {
            const hasC = /C(?![a-z])/.test(f);
            const hasH = /H(?![a-z])/.test(f);
            if (hasC && hasH) return true;
            // Allow fully halogenated hydrocarbons (e.g. CCl4, C2Br6)
            if (hasC && !hasH && (f.includes('Cl') || f.includes('Br') || f.includes('I') || f.includes('F'))) {
                // Exclude inorganic carbon halides with Oxygen (like COCl2) if desired, but CCl4 is fine.
                if (!f.includes('O')) return true;
            }
            return false;
        };
        // Helper: Get unique elements in a formula
        const getElements = (f) => {
            const matches = f.match(/[A-Z][a-z]?/g);
            return matches ? [...new Set(matches)] : [];
        };
        
        const allFormulas = [...left, ...right];

        // --- Redox Analysis (Disproportionation / Comproportionation) ---
        let isRedox = false;
        let isDisproportionation = false;
        let isComproportionation = false;

        if (allFormulas.some(isElement)) {
            isRedox = true;
        }

        const elementCounts = {}; 
        [...left].forEach(f => {
            getElements(f).forEach(el => {
                if(!elementCounts[el]) elementCounts[el] = { left: 0, right: 0, leftForms: [], rightForms: [] };
                elementCounts[el].left++;
                elementCounts[el].leftForms.push(f);
            });
        });
        [...right].forEach(f => {
            getElements(f).forEach(el => {
                if(!elementCounts[el]) elementCounts[el] = { left: 0, right: 0, leftForms: [], rightForms: [] };
                elementCounts[el].right++;
                elementCounts[el].rightForms.push(f);
            });
        });

        // Special detection for Ammonium Nitrite/Nitrate decomposition (Internal Comproportionation)
        // NH4NO2 -> N2 + H2O
        if (left.length === 1 && (left[0].includes('NH4') && (left[0].includes('NO2') || left[0].includes('NO3')))) {
             if (right.includes('N2') || right.includes('N2O')) {
                 isComproportionation = true;
                 isRedox = true;
             }
        }

        for (const el in elementCounts) {
            // Skip H and O for general redox pattern matching to avoid false positives like Acid-Base
            // (Unless they are in elemental form like O2, H2, which is handled by isElement check above)
            if (el === 'H' || el === 'O') continue;

            const data = elementCounts[el];
            
            // Disproportionation: 1 Reactant -> >=2 Products (e.g. NO2 -> HNO3 + NO)
            if (data.left === 1 && data.right >= 2) {
                // Exclude Carbonates decomposition: Ca(HCO3)2 -> CaCO3 + CO2 + H2O (C is +4 in all)
                if (el === 'C' && data.rightForms.some(f => f.includes('CO3') || f === 'CO2')) continue;
                // Exclude Sulfates: MnSO4 -> K2SO4 + H2SO4 (S stays +6)
                if (el === 'S' && data.leftForms.every(f => f.includes('SO4')) && data.rightForms.every(f => f.includes('SO4'))) continue;
                // Exclude Phosphates
                if (el === 'P' && data.leftForms.every(f => f.includes('PO4')) && data.rightForms.every(f => f.includes('PO4'))) continue;
                // Exclude Nitrates (if not redox N) - e.g. Pb(NO3)2 + ... -> NaNO3 + ... (Simple exchange)
                if (el === 'N' && data.leftForms.every(f => f.includes('NO3')) && data.rightForms.every(f => f.includes('NO3'))) continue;
                // Exclude Ammonia Substitution: NH3 -> Amine + NH4X (N stays -3)
                if (el === 'N' && data.leftForms.every(f => f === 'NH3')) continue;

                isDisproportionation = true;
                isRedox = true;
            }
            
            // Comproportionation: >=2 Reactants -> 1 Product (e.g. KMnO4 + MnSO4 -> MnO2)
            if (data.left >= 2 && data.right === 1) {
                // Exclude Carbon in Organic Synthesis (e.g. Williamson Ether: CH3I + NaOCH2CH3 -> CH3OCH2CH3 + NaI)
                // Carbon appears in 2 reactants and 1 product, but it's usually substitution/addition, not redox comproportionation.
                if (el === 'C' && left.some(isOrganic)) continue;

                isComproportionation = true;
                isRedox = true;
            }
        }

        if (isDisproportionation) types.push("Redox (Disproportionation)");
        else if (isComproportionation) types.push("Redox (Comproportionation)");
        else if (isRedox) types.push("Redox");

        // 2. Combustion / Incomplete Combustion / Oxidation
        let isCombustion = false;
        if (left.includes('O2')) {
            if (left.some(isOrganic)) {
                // Organic + O2
                const rightHasOrganic = right.some(isOrganic);
                
                if (right.includes('CO2') && right.includes('H2O') && !rightHasOrganic) {
                    types.push("Complete Combustion");
                    isCombustion = true;
                } else if ((right.includes('C') || right.includes('CO')) && right.includes('H2O') && !rightHasOrganic) {
                    types.push("Incomplete Combustion");
                    isCombustion = true;
                } else if (rightHasOrganic) {
                    // e.g. Alcohol + O2 -> Aldehyde + H2O
                    types.push("Oxidation");
                    isCombustion = true; 
                } else {
                    // Fallback for other organic oxidations
                    types.push("Combustion");
                    isCombustion = true;
                }
            } else {
                // Inorganic + O2 (e.g. Mg + O2)
                types.push("Combustion");
                isCombustion = true;
            }
            
            // Ensure Redox is present if not already (Combustion is Redox)
            if (!types.some(t => t.includes("Redox"))) types.push("Redox");
        }

        // 3. Synthesis / Addition (A + B -> C)
        if (left.length > 1 && right.length === 1) {
            if (left.some(isOrganic)) {
                // Check for Haloalkane + NH3 -> Salt (Nucleophilic Substitution)
                const hasHaloalkane = left.some(f => isOrganic(f) && /(Cl|Br|I)/.test(f));
                const hasAmmonia = left.includes('NH3');

                if (hasHaloalkane && hasAmmonia) {
                    types.push("Nucleophilic Substitution");
                } else {
                    // Electrophilic Addition (Alkene + X2/HX)
                    if (left.some(f => f === 'Br2' || f === 'Cl2' || f === 'H2' || f.startsWith('H'))) {
                        types.push("Electrophilic Addition");
                    }
                    types.push("Addition");
                }
            } else {
                types.push("Synthesis");
            }
        }

        // 4. Decomposition / Elimination / Cracking (A -> B + C)
        if (left.length === 1 && right.length > 1) {
            types.push("Decomposition");
            
            if (isOrganic(left[0])) {
                types.push("Cracking");
                types.push("Elimination");
            }
        }

        // 5. Displacement (A + BC -> AC + B)
        // Exclude if identified as Combustion/Oxidation to prevent CH4 + O2 = C + H2O being Displacement
        if (left.length === 2 && right.length === 2 && !isCombustion) {
            const leftHasElem = left.some(isElement);
            const rightHasElem = right.some(isElement);
            if (leftHasElem && rightHasElem) {
                types.push("Displacement");
            }
        }

        // 6. Neutralisation (Acid + Base -> Salt + Water)
        const hasWaterProd = right.includes('H2O');
        const hasAcid = left.some(f => f.startsWith('H') && f !== 'H2O' && !f.includes('O2'));
        const hasHydroxide = left.some(f => f.endsWith('OH') || f.includes('OH)'));
        const hasAmmonia = left.includes('NH3');
        
        let isNeutralisation = false;
        
        if (hasAcid) {
            if (hasHydroxide && hasWaterProd) {
                types.push("Double Decomposition (Neutralisation)");
                isNeutralisation = true;
            } else if (hasAmmonia) {
                types.push("Neutralisation");
                isNeutralisation = true;
            }
        }

        // 7. Double Decomposition / Precipitation
        // Solubility Rules Implementation
        const isSoluble = (f) => {
            const elements = getElements(f);
            
            // 1. Always Soluble (No Exceptions listed)
            // Group 1: Li, Na, K, Rb, Cs, Fr
            if (elements.some(e => ['Li', 'Na', 'K', 'Rb', 'Cs', 'Fr'].includes(e))) return true;
            // Ammonium (NH4+)
            if (f.includes('NH4')) return true;
            // Nitrates (NO3-)
            if (f.includes('NO3')) return true;
            // Hydrogencarbonates (HCO3-)
            if (f.includes('HCO3')) return true;
            // Ethanoates (CH3COO- or C2H3O2-)
            if (f.includes('CH3COO') || f.includes('C2H3O2')) return true;

            // 2. Soluble with Exceptions
            
            // Halides (Cl-, Br-, I-) -> Check for Ag, Pb
            // Regex to ensure it's a halide (ends with Cl/Br/I optionally followed by number)
            if (/(Cl|Br|I)\d*$/.test(f)) {
                if (elements.includes('Ag') || elements.includes('Pb')) return false;
                return true;
            }

            // Sulphates (SO4 2-) -> Check for Ca, Ba, Pb
            if (f.includes('SO4')) {
                if (elements.includes('Ca') || elements.includes('Ba') || elements.includes('Pb')) return false;
                return true;
            }

            // 3. Insoluble with Exceptions
            
            // Carbonates (CO3 2-) -> Group 1/NH4 already handled.
            if (f.includes('CO3')) return false;

            // Hydroxides (OH-) -> Group 1/NH4 already handled.
            // Exceptions: Ca, Ba
            // Exclude Organic Alcohols (contain C and H) from this check
            if ((f.endsWith('OH') || f.includes('(OH)')) && !isOrganic(f)) {
                if (elements.includes('Ca') || elements.includes('Ba')) return true;
                return false;
            }

            // Oxides (O2-) -> Group 1/NH4 already handled.
            // Exceptions: Ca, Ba
            // Check if binary oxide (Element + O)
            if (/^[A-Z][a-z]?\d*O\d*$/.test(f)) {
                if (elements.includes('Ca') || elements.includes('Ba')) return true;
                return false;
            }
            
            // Default to soluble if no rule matches
            return true;
        };

        const hasPrecipitate = right.some(f => {
            if (f === 'H2O') return false;
            // Common gases
            if (['CO2', 'SO2', 'NH3', 'H2', 'O2', 'N2', 'Cl2', 'NO', 'NO2'].includes(f)) return false;
            return !isSoluble(f);
        });

        if (left.length === 2 && right.length === 2 && !isRedox && !isCombustion && !isNeutralisation && !left.some(isOrganic)) {
            if (hasPrecipitate) {
                types.push("Double Decomposition (Precipitation)");
            } else {
                types.push("Double Decomposition");
            }
        } else if (hasPrecipitate && !left.some(isOrganic)) {
            // If it's not a standard Double Decomposition (e.g. it's Redox or complex), but forms a precipitate
            types.push("Double Decomposition (Precipitation)");
        }

        // 8. Hydrolysis (Reactant + H2O -> ...)
        // Fix: Exclude if it's Redox (e.g. NO2 + H2O -> HNO3 + NO is Redox, not Hydrolysis)
        if (left.includes('H2O') && right.length >= 2 && !isRedox && !isNeutralisation) {
            types.push("Hydrolysis");
        }

        // 8. Dehydration (Organic -> ... + H2O)
        if (right.includes('H2O') && left.some(isOrganic) && left.length === 1) {
            types.push("Dehydration");
        }

        // 9. Substitution / Elimination (Organic)
        if (left.some(isOrganic) && right.some(isOrganic) && left.length >= 2 && right.length >= 2) {
            // Free Radical: Alkane + Halogen -> Haloalkane + HX
            if (left.some(f => f === 'Cl2' || f === 'Br2' || f === 'F2' || f === 'I2') && right.some(f => f === 'HCl' || f === 'HBr' || f === 'HF' || f === 'HI')) {
                types.push("Free-radical Substitution");
            }
            // Elimination: Haloalkane + Base -> Alkene + H2O + Halide
            else if (left.some(f => /(Cl|Br|I)/.test(f)) && left.some(f => f.includes('OH') || f.includes('O')) && right.includes('H2O')) {
                types.push("Elimination");
            }
            // Nucleophilic: Haloalkane + Nucleophile -> Alcohol/Ether/Nitrile/Amine/Thiol + X-
            // Also covers Halogen Exchange (Finkelstein) and Alcohol -> Haloalkane
            else if (left.some(f => /(Cl|Br|I)/.test(f)) && 
                     right.some(f => f.includes('OH') || f.includes('CN') || f.includes('NH') || f.includes('SH') || (isOrganic(f) && f.includes('O')) || (isOrganic(f) && /(Cl|Br|I)/.test(f)))) {
                types.push("Nucleophilic Substitution");
            }
            // Electrophilic: Benzene + ...
            else if (left.some(f => f === 'C6H6')) {
                types.push("Electrophilic Substitution");
            }
        }

        // 10. Crystallisation (Formation of Hydrate)
        if (right.some(f => f.includes('.'))) {
            types.push("Crystallisation");
        }

        // 11. Ligand Substitution
        const isComplex = (f) => f.startsWith('[') && f.includes(']');
        if (left.some(isComplex) && right.some(isComplex)) {
            types.push("Ligand Substitution");
        }
        
        // Deduplicate and return
        const uniqueTypes = [...new Set(types)];
        return uniqueTypes.length > 0 ? uniqueTypes.join(", ") : "Reaction";
    }

    function renderResult(result, reactionType) {
        // Helper: Check if organic (Local definition for context detection)
        const isOrganic = (f) => {
            const hasC = /C(?![a-z])/.test(f);
            const hasH = /H(?![a-z])/.test(f);
            if (hasC && hasH) return true;
            if (hasC && !hasH && (f.includes('Cl') || f.includes('Br') || f.includes('I') || f.includes('F'))) {
                if (!f.includes('O')) return true;
            }
            return false;
        };

        const leftFormulas = result.left.map(p => p.formula);
        const rightFormulas = result.right.map(p => p.formula);
        
        // Detect context if not provided
        let context = reactionType;
        if (!context) {
             const hasOrganicHalide = leftFormulas.some(f => isOrganic(f) && /(Cl|Br|I)/.test(f));
             const hasCyanide = leftFormulas.some(f => f === 'CN-' || f === 'KCN' || f === 'NaCN');
             const hasAmmonia = leftFormulas.includes('NH3');
             const hasHydrosulfide = leftFormulas.some(f => f === 'SH-' || f === 'KSH' || f === 'NaSH');
             const hasHydroxide = leftFormulas.some(f => f === 'OH-' || f === 'NaOH' || f === 'KOH');
             const hasAlkoxide = leftFormulas.some(f => (f.endsWith('O-') && isOrganic(f)) || ((f.startsWith('Na') || f.startsWith('K')) && f.includes('O') && isOrganic(f)));
             
             if (hasOrganicHalide) {
                 if (hasCyanide) context = 'substitution_eth';
                 else if (hasAmmonia) context = 'substitution_eth';
                 else if (hasHydrosulfide) context = 'substitution_eth';
                 else if (hasAlkoxide) context = 'substitution_eth';
                 else if (hasHydroxide) {
                     // Elimination produces H2O. Substitution produces Alcohol.
                     if (rightFormulas.includes('H2O')) {
                         context = 'elimination_eth';
                     } else {
                         context = 'substitution_aq';
                     }
                 }
             }
        } else if (reactionType.includes('Nucleophilic Substitution')) {
             // If identified as Nucleophilic Substitution, check for specific reagents to set context
             const hasCyanide = leftFormulas.some(f => f.includes('CN'));
             const hasAmmonia = leftFormulas.includes('NH3');
             const hasHydrosulfide = leftFormulas.some(f => f.includes('SH'));
             const hasAlkoxide = leftFormulas.some(f => (f.endsWith('O-') && isOrganic(f)) || ((f.startsWith('Na') || f.startsWith('K')) && f.includes('O') && isOrganic(f)));
             
             if (hasCyanide || hasAmmonia || hasHydrosulfide || hasAlkoxide) {
                 context = 'substitution_eth';
             }
        }

        // Helper to determine state
        const determineState = (f) => {
            // 0. Special Organic Context Overrides
            if (context === 'elimination_eth' && (f === 'OH-' || f === 'NaOH' || f === 'KOH')) return 'eth';
            if (context === 'substitution_eth') {
                if (f === 'CN-' || f === 'KCN' || f === 'NaCN') return 'eth';
                if (f === 'NH3') return 'eth';
                if (f === 'SH-' || f === 'KSH' || f === 'NaSH') return 'eth';
                // Alkoxides
                if ((f.endsWith('O-') && isOrganic(f)) || ((f.startsWith('Na') || f.startsWith('K')) && f.includes('O') && isOrganic(f))) return 'eth';
            }

            // 1. Common Gases
            const gases = ['H2', 'N2', 'O2', 'O3', 'F2', 'Cl2', 'He', 'Ne', 'Ar', 'Kr', 'Xe', 'Rn',
                           'CO', 'CO2', 'SO2', 'SO3', 'NO', 'NO2', 'N2O', 'NH3', 'H2S',
                           'CH4', 'C2H6', 'C3H8', 'C4H10', 'C2H4', 'C3H6', 'C2H2'];
            if (gases.includes(f)) return 'g';

            // 2. Common Liquids
            const liquids = ['H2O', 'Br2', 'Hg', 'C2H5OH', 'CH3OH', 'C6H6', 'l'];
            if (liquids.includes(f)) return 'l';

            // 3. Common Solids (Elements)
            // Single elements that are not gases/liquids are usually solids (Metals, C, S, P)
            if (/^[A-Z][a-z]?$/.test(f) && !gases.includes(f) && !liquids.includes(f)) return 's'; 
            if (['I2', 'C', 'S', 'P', 'P4', 'S8', 'Si', 'SiO2'].includes(f)) return 's';

            // 4. Acids (Default to aq)
            if (f === 'HCl' || f === 'HBr' || f === 'HI' || f === 'HF') return 'aq'; // Usually aq in reactions
            if (f === 'H2SO4' || f === 'HNO3' || f === 'H3PO4' || f === 'HClO4' || f === 'CH3COOH' || f === 'H2CO3' || f === 'H2SO3' || f === 'HNO2') return 'aq';

            // 4.5 Hydrates (Solids)
            if (f.includes('.')) return 's';

            // 5. Solubility Rules
            const getElements = (formula) => {
                const matches = formula.match(/[A-Z][a-z]?/g);
                return matches ? [...new Set(matches)] : [];
            };
            const elements = getElements(f);

            // --- Solubility Logic (Same as identifyReactionType) ---
            // 1. Always Soluble
            if (elements.some(e => ['Li', 'Na', 'K', 'Rb', 'Cs', 'Fr'].includes(e))) return 'aq';
            if (f.includes('NH4')) return 'aq';
            if (f.includes('NO3')) return 'aq';
            if (f.includes('HCO3')) return 'aq';
            if (f.includes('CH3COO') || f.includes('C2H3O2')) return 'aq';

            // 2. Soluble with Exceptions
            // Halides
            if (/(Cl|Br|I)\d*$/.test(f)) {
                if (elements.includes('Ag') || elements.includes('Pb')) return 's';
                return 'aq';
            }
            // Sulphates
            if (f.includes('SO4')) {
                if (elements.includes('Ca') || elements.includes('Ba') || elements.includes('Pb')) return 's';
                return 'aq';
            }

            // 3. Insoluble with Exceptions
            // Carbonates
            if (f.includes('CO3')) return 's'; // Group 1/NH4 handled above
            // Hydroxides
            // Exclude Organic Alcohols (contain C and H) from this check
            if ((f.endsWith('OH') || f.includes('(OH)')) && !(f.includes('C') && f.includes('H'))) {
                if (elements.includes('Ca') || elements.includes('Ba')) return 'aq'; // Slightly soluble -> aq
                return 's';
            }
            // Oxides
            if (/^[A-Z][a-z]?\d*O\d*$/.test(f)) {
                if (elements.includes('Ca') || elements.includes('Ba')) return 's'; // Reacts with water, but as oxide is solid
                return 's';
            }

            // Default for ionic-looking things?
            // If it has metal + non-metal, assume solid if not matched above?
            // Or assume aqueous if not matched?
            // Let's default to 'aq' for unknown salts to be safe, or 's'?
            // Most common salts are soluble.
            return 'aq';
        };

        const formatSide = (parts) => {
            return parts.map(p => {
                const coeffHtml = p.coeff > 1 ? `<span class="chem-coeff">${p.coeff}</span>` : '';
                
                let f = p.formula;
                let base = f;
                let charge = '';
                
                // Check for charge at the end (e.g., 2+, 3-, +, -)
                // We look for a sequence of digits (optional) followed by + or - at the end of the string
                // Also handle unicode minus sign (U+2212) which is common in copy-pasted text
                const chargeMatch = f.match(/^(.*?)(\d*[+\-−]+)$/);
                if (chargeMatch) {
                    base = chargeMatch[1];
                    charge = chargeMatch[2].replace(/−/g, '-'); // Normalize unicode minus
                }
                
                // Subscript numbers in base
                let baseHtml = '';
                if (base.includes('.')) {
                    const split = base.split('.');
                    const salt = split[0];
                    const hydrate = split[1];
                    
                    const saltHtml = salt.replace(/(\d+)/g, '<sub>$1</sub>');
                    
                    // Handle hydrate part: "5H2O" -> "5" is normal, "2" is sub
                    const match = hydrate.match(/^(\d+)(.*)/);
                    let hydrateHtml = '';
                    if (match) {
                        const coef = match[1];
                        const rest = match[2];
                        hydrateHtml = coef + rest.replace(/(\d+)/g, '<sub>$1</sub>');
                    } else {
                        hydrateHtml = hydrate.replace(/(\d+)/g, '<sub>$1</sub>');
                    }
                    
                    baseHtml = `${saltHtml}<sub>.</sub>${hydrateHtml}`;
                } else {
                    baseHtml = base.replace(/(\d+)/g, '<sub>$1</sub>');
                }
                
                // Superscript charge
                const chargeHtml = charge ? `<sup>${charge}</sup>` : '';
                
                const formulaHtml = baseHtml + chargeHtml;
                
                const state = determineState(p.formula);
                return `<span class="chem-formula">${coeffHtml}${formulaHtml}<sub style="font-size:0.8em; color:#dcd0c0;">(${state})</sub></span>`;
            }).join('<span style="margin:0 10px; color:#aaaaaa; font-weight:bold;">+</span>');
        };

        const leftHtml = formatSide(result.left);
        const rightHtml = formatSide(result.right);
        
        let html = `<div class="balanced-eq" style="display:flex; align-items:center; justify-content:center; flex-wrap:wrap;">${leftHtml} <span style="margin:0 15px; color:#aaaaaa; font-size:1.5rem;">➝</span> ${rightHtml}</div>`;

        // Add warning for Ammonia Substitution Salt
        if (reactionType && reactionType.includes('Nucleophilic Substitution') && rightFormulas.length === 1 && leftFormulas.includes('NH3')) {
             html += `<div style="margin-top:5px; font-size:0.85rem; color:#e6a23c;">Note: This equation shows the formation of the ammonium salt. The full substitution reaction typically requires 2NH<sub>3</sub> to form the amine and ammonium halide.</div>`;
        }

        return html;
    }

    function balanceEquation(equationStr) {
        const sides = equationStr.split('=').map(s => s.trim());
        if(sides.length !== 2) throw new Error("Equation must contain exactly one '='");
        
        // Remove leading coefficients from input AND remove all internal spaces and invisible chars
        // Also normalize unicode minus to hyphen
        const cleanFormula = (s) => s.replace(/^\d+/, '')
                                     .replace(/[\s\u200b\u200c\u200d\u200e\u200f]+/g, '')
                                     .replace(/−/g, '-');

        const parseSide = (sideStr) => {
            return sideStr.split('+').map(s => s.trim()).filter(s => s).map(cleanFormula);
        };
        
        const leftMols = parseSide(sides[0]);
        const rightMols = parseSide(sides[1]);
        
        if(leftMols.length === 0 || rightMols.length === 0) throw new Error("Both sides must have compounds");

        const allMols = [...leftMols, ...rightMols];
        const elements = new Set();
        
        const parseFormula = (formula) => {
            // Remove charge part for atom counting (e.g. OH- -> OH, Fe3+ -> Fe)
            // Match end of string charge like 2+, 3-, +, -
            const chargeRegex = /(\d*[+\-−]+)$/;
            const neutralFormula = formula.replace(chargeRegex, '');

            // Inner function for parsing standard molecules
            const parseSimple = (fStr) => {
                const counts = {};
                let i = 0;
                
                function parseGroup() {
                    const groupCounts = {};
                    while (i < fStr.length) {
                        const char = fStr[i];
                        if (char === '(') {
                            i++;
                            const inner = parseGroup();
                            let count = 1;
                            let numStr = '';
                            while (i < fStr.length && /\d/.test(fStr[i])) {
                                numStr += fStr[i];
                                i++;
                            }
                            if (numStr) count = parseInt(numStr);
                            
                            for (let el in inner) {
                                groupCounts[el] = (groupCounts[el] || 0) + inner[el] * count;
                            }
                        } else if (char === ')') {
                            i++;
                            return groupCounts;
                        } else if (/[A-Z]/.test(char)) {
                            let element = char;
                            i++;
                            while (i < fStr.length && /[a-z]/.test(fStr[i])) {
                                element += fStr[i];
                                i++;
                            }
                            let count = 1;
                            let numStr = '';
                            while (i < fStr.length && /\d/.test(fStr[i])) {
                                numStr += fStr[i];
                                i++;
                            }
                            if (numStr) count = parseInt(numStr);
                            groupCounts[element] = (groupCounts[element] || 0) + count;
                        } else {
                            // Skip unknown characters (like charge symbols +, -)
                            i++; 
                        }
                    }
                    return groupCounts;
                }
                return parseGroup();
            };

            // Handle hydrates
            if (neutralFormula.includes('.')) {
                const parts = neutralFormula.split('.');
                const totalCounts = {};
                parts.forEach(part => {
                    let subF = part;
                    let mult = 1;
                    // Check for leading coefficient in hydrate part (e.g. 5H2O)
                    const m = subF.match(/^(\d+)(.*)/);
                    if (m) {
                        mult = parseInt(m[1]);
                        subF = m[2];
                    }
                    const c = parseSimple(subF);
                    for (let k in c) {
                        totalCounts[k] = (totalCounts[k] || 0) + c[k] * mult;
                    }
                });
                return totalCounts;
            } else {
                return parseSimple(neutralFormula);
            }
        };

        const molComps = allMols.map(m => {
            const c = parseFormula(m);
            for(let e in c) elements.add(e);
            return c;
        });

        const elemList = Array.from(elements);
        const colCount = allMols.length;
        const rowCount = elemList.length;

        const matrix = [];
        for(let r=0; r<rowCount; r++) {
            const row = [];
            const el = elemList[r];
            for(let c=0; c<colCount; c++) {
                let val = molComps[c][el] || 0;
                if(c >= leftMols.length) val = -val; 
                row.push(val);
            }
            matrix.push(row);
        }

        const coeffs = solveHomogeneous(matrix);
        if(!coeffs) throw new Error("no solution found");

        return {
            left: leftMols.map((m, i) => ({ formula: m, coeff: coeffs[i] })),
            right: rightMols.map((m, i) => ({ formula: m, coeff: coeffs[leftMols.length + i] }))
        };
    }

    function solveHomogeneous(matrix) {
        const rows = matrix.length;
        const cols = matrix[0].length;
        const m = matrix.map(r => [...r]);
        
        let pivotRow = 0;
        const pivotCols = [];

        for (let j = 0; j < cols && pivotRow < rows; j++) {
            let sel = pivotRow;
            while (sel < rows && Math.abs(m[sel][j]) < 1e-9) sel++;
            
            if (sel === rows) continue;
            
            [m[pivotRow], m[sel]] = [m[sel], m[pivotRow]];
            pivotCols.push(j);
            
            const pivotVal = m[pivotRow][j];
            for(let k=j; k<cols; k++) m[pivotRow][k] /= pivotVal;
            
            for(let i=0; i<rows; i++) {
                if(i !== pivotRow) {
                    const factor = m[i][j];
                    for(let k=j; k<cols; k++) m[i][k] -= factor * m[pivotRow][k];
                }
            }
            pivotRow++;
        }

        const isPivot = new Array(cols).fill(false);
        pivotCols.forEach(c => isPivot[c] = true);
        const freeCols = [];
        for(let c=0; c<cols; c++) if(!isPivot[c]) freeCols.push(c);
        
        if(freeCols.length === 0) return null; 
        
        const solution = new Array(cols).fill(0);
        const freeVarIndex = freeCols[freeCols.length - 1];
        solution[freeVarIndex] = 1;
        
        for(let i=pivotRow-1; i>=0; i--) {
            let pCol = -1;
            for(let c=0; c<cols; c++) {
                if(Math.abs(m[i][c]) > 1e-9) { 
                    pCol = c;
                    break;
                }
            }
            if(pCol === -1) continue;
            
            let sum = 0;
            for(let k=pCol+1; k<cols; k++) {
                sum += m[i][k] * solution[k];
            }
            solution[pCol] = -sum;
        }
        
        let maxDenom = 1;
        const epsilon = 1e-6;
        
        const toFraction = (val) => {
            let bestD = 1;
            let minErr = Math.abs(val - Math.round(val));
            for(let d=1; d<=1000; d++) {
                let n = Math.round(val * d);
                let err = Math.abs(val - n/d);
                if(err < minErr) {
                    minErr = err;
                    bestD = d;
                }
                if(err < 1e-9) break;
            }
            return bestD;
        };
        
        let lcm = 1;
        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
        const getLcm = (a, b) => (a * b) / gcd(a, b);
        
        solution.forEach(v => {
            if(Math.abs(v) > epsilon) {
                const d = toFraction(v);
                lcm = getLcm(lcm, d);
            }
        });
        
        const intSolution = solution.map(v => Math.round(v * lcm));
        const overallGcd = intSolution.reduce((acc, val) => gcd(acc, val), intSolution[0]);
        const finalSolution = intSolution.map(v => v / overallGcd);
        
        if(finalSolution.some(v => v <= 0)) return null;
        
        return finalSolution;
    }
})();
</script>
</body>
</html>